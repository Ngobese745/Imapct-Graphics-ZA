import 'dart:ui';
import 'dart:io';
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter/foundation.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'package:intl/intl.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:firebase_storage/firebase_storage.dart';
// Web platform support for webview
// import 'package:webview_flutter_web/webview_flutter_web.dart'; // Temporarily disabled for iOS compatibility
import 'firebase_options.dart';
import 'services/auth_service.dart';
import 'services/firebase_service.dart';
import 'services/paystack_service.dart';
import 'services/split_payment_service.dart';
import 'services/gold_tier_trial_service.dart';
import 'screens/paystack_payment_screen.dart';
import 'screens/split_payment_screen.dart';
import 'screens/gold_tier_subscription_screen.dart';
import 'screens/invoice_screen.dart';
import 'screens/chat_support_screen.dart';
import 'screens/admin_support_screen.dart';
import 'screens/my_orders_screen.dart';
import 'screens/profile_screen.dart';
import 'screens/about_us_screen.dart';
import 'screens/suggestion_screen.dart';
import 'screens/admin_suggestions_screen.dart';
import 'screens/resources_docs_screen.dart';
import 'screens/package_management_screen.dart';
import 'screens/consultation_request_screen.dart';
import 'screens/admin_consultation_chat_screen.dart';
import 'services/notification_service.dart';
import 'services/notification_count_service.dart';
import 'services/delayed_subscription_service.dart';
import 'services/app_initialization_service.dart';
import 'screens/smooth_loading_screen.dart';
import 'services/monthly_credit_service.dart';
import 'services/referral_service.dart';
import 'services/loyalty_reward_service.dart';
import 'services/google_signin_config.dart';
import 'services/email_service.dart';
import 'services/marketing_service.dart';
import 'services/ad_reward_service.dart';
import 'widgets/proposal_details_dialog.dart';
import 'widgets/whatsapp_dialog.dart';
import 'package:share_plus/share_plus.dart';
import 'package:url_launcher/url_launcher.dart';
import 'services/link_preview_service.dart';
// import 'screens/admin_dashboard_screen.dart';
// import 'screens/auth_screen.dart'; // Removed duplicate AuthScreen
// import 'screens/dashboard_screen.dart'; // Removed duplicate DashboardScreen

// Global theme notifier for app-wide theme switching
ValueNotifier<ThemeMode> themeModeNotifier = ValueNotifier(ThemeMode.dark);

// Responsive design utilities
class ResponsiveUtils {
  static bool isMobile(BuildContext context) =>
      MediaQuery.of(context).size.width < 600;
  static bool isTablet(BuildContext context) =>
      MediaQuery.of(context).size.width >= 600 &&
      MediaQuery.of(context).size.width < 900;
  static bool isDesktop(BuildContext context) =>
      MediaQuery.of(context).size.width >= 900;

  // Additional breakpoint for very small screens
  static bool isVerySmallScreen(BuildContext context) =>
      MediaQuery.of(context).size.width < 400;

  static double getScreenWidth(BuildContext context) =>
      MediaQuery.of(context).size.width;
  static double getScreenHeight(BuildContext context) =>
      MediaQuery.of(context).size.height;

  // Responsive padding
  static EdgeInsets getScreenPadding(BuildContext context) {
    if (isVerySmallScreen(context)) {
      return const EdgeInsets.all(12.0);
    } else if (isMobile(context)) {
      return const EdgeInsets.all(16.0);
    } else if (isTablet(context)) {
      return const EdgeInsets.all(24.0);
    } else {
      return const EdgeInsets.all(32.0);
    }
  }

  // Responsive font sizes
  static double getTitleFontSize(BuildContext context) {
    if (isVerySmallScreen(context)) return 18.0;
    if (isMobile(context)) return 20.0;
    if (isTablet(context)) return 24.0;
    return 28.0;
  }

  static double getBodyFontSize(BuildContext context) {
    if (isVerySmallScreen(context)) return 13.0;
    if (isMobile(context)) return 14.0;
    if (isTablet(context)) return 16.0;
    return 18.0;
  }

  static double getSmallFontSize(BuildContext context) {
    if (isMobile(context)) return 12.0;
    if (isTablet(context)) return 14.0;
    return 16.0;
  }

  // Responsive spacing
  static double getSpacing(BuildContext context) {
    if (isMobile(context)) return 8.0;
    if (isTablet(context)) return 12.0;
    return 16.0;
  }

  // Responsive card padding
  static EdgeInsets getCardPadding(BuildContext context) {
    if (isVerySmallScreen(context)) return const EdgeInsets.all(12.0);
    if (isMobile(context)) return const EdgeInsets.all(16.0);
    if (isTablet(context)) return const EdgeInsets.all(20.0);
    return const EdgeInsets.all(24.0);
  }

  // Responsive button height
  static double getButtonHeight(BuildContext context) {
    if (isMobile(context)) return 48.0;
    if (isTablet(context)) return 56.0;
    return 64.0;
  }

  // Responsive icon sizes
  static double getIconSize(BuildContext context) {
    if (isMobile(context)) return 20.0;
    if (isTablet(context)) return 24.0;
    return 28.0;
  }

  // Responsive container max width
  static double getMaxWidth(BuildContext context) {
    if (isVerySmallScreen(context)) return double.infinity;
    if (isMobile(context)) return double.infinity;
    if (isTablet(context)) return 600.0;
    return 800.0;
  }
}

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  print('ðŸš€ STARTING IMPACT GRAPHICS ZA v2.0 - PRODUCTION VERSION');
  print(
    'ðŸ“± Features: Enhanced Splash Screen, Daily Ad Rewards, Priority Services',
  );

  // Initialize WebView platform for web (conditionally imported)
  if (kIsWeb) {
    try {
      // Dynamic import to avoid iOS compilation issues
      // WebViewPlatform.instance = WebWebViewPlatform();
      print(
        'Web platform detected - webview initialization skipped for iOS compatibility',
      );
    } catch (e) {
      print('Web platform initialization error: $e');
    }
  }

  // Initialize Firebase
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  // Set preferred orientations based on device type
  await SystemChrome.setPreferredOrientations([
    DeviceOrientation.portraitUp,
    DeviceOrientation.portraitDown,
    // Allow landscape for tablets and larger devices (will be controlled in app)
    DeviceOrientation.landscapeLeft,
    DeviceOrientation.landscapeRight,
  ]);

  runApp(const ImpactGraphicsApp());
}

/// Handle Paystack webhook for subscription payments
Future<void> handlePaystackWebhook(Map<String, dynamic> webhookData) async {
  try {
    print('=== PAYSTACK WEBHOOK RECEIVED ===');
    print('Webhook data: $webhookData');

    final result = await MonthlyCreditService.processPaystackWebhook(
      webhookData,
    );

    if (result['success']) {
      print('Webhook processed successfully: ${result['message']}');
    } else {
      print('Webhook processing failed: ${result['message']}');
    }
  } catch (e) {
    print('Error handling Paystack webhook: $e');
  }
}

class ImpactGraphicsApp extends StatefulWidget {
  const ImpactGraphicsApp({super.key});

  @override
  State<ImpactGraphicsApp> createState() => _ImpactGraphicsAppState();
}

class _ImpactGraphicsAppState extends State<ImpactGraphicsApp>
    with TickerProviderStateMixin {
  late AppInitializationService _initService;

  @override
  void initState() {
    super.initState();
    _initService = AppInitializationService.instance;
    _initService.initializeApp();

    // Initialize Ad Reward Service
    AdRewardService().initialize();

    // Set up WhatsApp notification callback
    NotificationService.setWhatsAppCallback((notificationData) {
      _showWhatsAppDialog(notificationData);
    });

    // Check for pending WhatsApp notifications after initialization
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _checkPendingWhatsAppNotification();
    });
  }

  // Check for pending WhatsApp notifications
  void _checkPendingWhatsAppNotification() {
    final notification = NotificationService.getPendingWhatsAppNotification();
    if (notification != null) {
      _showWhatsAppDialog(notification);
    }
  }

  // Show WhatsApp dialog for payment success
  void _showWhatsAppDialog(Map<String, dynamic> notificationData) {
    final whatsAppMessage =
        notificationData['whatsAppMessage']?.toString() ?? '';

    // Default WhatsApp number for Impact Graphics ZA
    const whatsappNumber =
        '0683675755'; // You can change this to the actual business number

    WhatsAppDialog.show(
      context: context,
      title: 'Share Project Details',
      message: whatsAppMessage,
      phoneNumber: whatsappNumber,
      onClose: () {
        print('WhatsApp dialog closed');
      },
    );
  }

  void _setOrientationConstraints(BuildContext context) {
    // Get screen dimensions
    final mediaQuery = MediaQuery.of(context);
    final shortestSide = mediaQuery.size.shortestSide;

    // Define small mobile device threshold (phones)
    // Devices with shortest side < 600 are considered small mobile devices
    if (shortestSide < 600) {
      // Lock to portrait for small mobile devices
      SystemChrome.setPreferredOrientations([
        DeviceOrientation.portraitUp,
        DeviceOrientation.portraitDown,
      ]);
    } else {
      // Allow rotation for tablets and larger devices
      SystemChrome.setPreferredOrientations([
        DeviceOrientation.portraitUp,
        DeviceOrientation.portraitDown,
        DeviceOrientation.landscapeLeft,
        DeviceOrientation.landscapeRight,
      ]);
    }
  }

  @override
  Widget build(BuildContext context) {
    // Control orientation based on device size
    _setOrientationConstraints(context);

    final ThemeData lightTheme = ThemeData(
      useMaterial3: true,
      brightness: Brightness.light,
      colorScheme: ColorScheme.fromSeed(
        seedColor: const Color(0xFFC62828),
        brightness: Brightness.light,
      ),
      primaryColor: const Color(0xFFC62828),
      scaffoldBackgroundColor: const Color(0xFFF9F9F9),
      dividerColor: Colors.black12,
      cardColor: Colors.white,
      shadowColor: Colors.black.withOpacity(0.06),
      appBarTheme: const AppBarTheme(
        backgroundColor: Colors.transparent,
        elevation: 0,
        iconTheme: IconThemeData(color: Color(0xFF333333)),
        titleTextStyle: TextStyle(
          color: Color(0xFF333333),
          fontSize: 18,
          fontWeight: FontWeight.w600,
        ),
      ),
      bottomNavigationBarTheme: const BottomNavigationBarThemeData(
        backgroundColor: Colors.white,
        selectedItemColor: Color(0xFFC62828),
        unselectedItemColor: Color(0xFF666666),
        type: BottomNavigationBarType.fixed,
        selectedLabelStyle: TextStyle(fontSize: 12),
        unselectedLabelStyle: TextStyle(fontSize: 12),
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: const Color(0xFFC62828),
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          elevation: 0,
        ),
      ),
      textButtonTheme: TextButtonThemeData(
        style: TextButton.styleFrom(foregroundColor: const Color(0xFFC62828)),
      ),
      fontFamily: 'Roboto',
    );

    final ThemeData darkTheme = ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      colorScheme: ColorScheme.fromSeed(
        seedColor: const Color(0xFF8B0000),
        brightness: Brightness.dark,
      ),
      primaryColor: const Color(0xFF8B0000),
      scaffoldBackgroundColor: const Color(0xFF1A1A1A),
      dividerColor: Colors.white10,
      bottomNavigationBarTheme: const BottomNavigationBarThemeData(
        backgroundColor: Color(0xFF2A2A2A),
        selectedItemColor: Color(0xFF8B0000),
        unselectedItemColor: Colors.white70,
        type: BottomNavigationBarType.fixed,
        selectedLabelStyle: TextStyle(fontSize: 12),
        unselectedLabelStyle: TextStyle(fontSize: 12),
      ),
      fontFamily: 'Roboto',
    );

    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => AuthService()),
        ChangeNotifierProvider(create: (_) => _initService),
      ],
      child: ValueListenableBuilder<ThemeMode>(
        valueListenable: themeModeNotifier,
        builder: (context, themeMode, _) {
          return MaterialApp(
            title: 'Impact Graphics ZA v2.0',
            debugShowCheckedModeBanner: false,
            theme: lightTheme,
            darkTheme: darkTheme,
            themeMode: themeMode,
            home: Consumer<AppInitializationService>(
              builder: (context, initService, child) {
                if (initService.isInitializing) {
                  return const SmoothLoadingScreen();
                }

                return Consumer<AuthService>(
                  builder: (context, authService, child) {
                    if (authService.isAuthenticated) {
                      // Check if user is admin using AuthService
                      if (authService.isAdmin) {
                        print(
                          'Main App: Redirecting admin user to AdminDashboardScreen',
                        );
                        return const AdminDashboardScreen();
                      } else {
                        print(
                          'Main App: Redirecting regular user to DashboardScreen',
                        );
                        return const DashboardScreen();
                      }
                    }
                    return const GuestScreen();
                  },
                );
              },
            ),
          );
        },
      ),
    );
  }
}

class CustomLogo extends StatelessWidget {
  final double size;

  const CustomLogo({super.key, this.size = 120});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: size,
      height: size,
      decoration: BoxDecoration(
        shape: BoxShape.circle,
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.3),
            blurRadius: 15,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: ClipOval(
        child: Image.asset(
          'assets/images/logo.png',
          width: size,
          height: size,
          fit: BoxFit.cover,
          errorBuilder: (context, error, stackTrace) {
            // Fallback if image is not found
            return Container(
              width: size,
              height: size,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: const Color(0xFF6B6B6B),
              ),
              child: const Icon(Icons.brush, size: 50, color: Colors.white),
            );
          },
        ),
      ),
    );
  }
}

// Custom painter for diagonal stripes background
class DiagonalStripesPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.white.withOpacity(0.1)
      ..strokeWidth = 2;

    const stripeSpacing = 8.0;
    final diagonalLength = size.width * 1.5;

    for (double i = -diagonalLength; i < diagonalLength; i += stripeSpacing) {
      canvas.drawLine(
        Offset(i, 0),
        Offset(i + diagonalLength, diagonalLength),
        paint,
      );
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen>
    with TickerProviderStateMixin {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isPasswordVisible = false;
  bool _isLoading = false;
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  // Responsive variables
  bool isMobile = false;
  bool isTablet = false;
  bool isDesktop = false;
  bool isLandscape = false;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    );
    _glowAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );
    _glowController.repeat(reverse: true);
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  void _handleLogin() async {
    if (_formKey.currentState?.validate() ?? false) {
      setState(() {
        _isLoading = true;
      });

      try {
        // Firebase Email/Password Authentication
        final userCredential = await FirebaseAuth.instance
            .signInWithEmailAndPassword(
              email: _emailController.text.trim(),
              password: _passwordController.text,
            );

        setState(() {
          _isLoading = false;
        });

        if (userCredential.user != null) {
          // Check if email is admin email
          final email = _emailController.text.toLowerCase();
          if (email.endsWith('@impactgraphicsza.co.za')) {
            // Navigate to admin dashboard for admin emails
            Navigator.of(context).pushReplacement(
              MaterialPageRoute(
                builder: (context) => const AdminDashboardScreen(),
              ),
            );
          } else {
            // Navigate to regular dashboard for other users
            Navigator.of(context).pushReplacement(
              MaterialPageRoute(builder: (context) => const DashboardScreen()),
            );
          }
        }
      } on FirebaseAuthException catch (e) {
        setState(() {
          _isLoading = false;
        });

        String errorMessage = 'An error occurred during login';
        if (e.code == 'user-not-found') {
          errorMessage = 'No user found with this email address';
        } else if (e.code == 'wrong-password') {
          errorMessage = 'Incorrect password';
        } else if (e.code == 'invalid-email') {
          errorMessage = 'Invalid email address';
        } else if (e.code == 'user-disabled') {
          errorMessage = 'This account has been disabled';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(errorMessage),
            backgroundColor: const Color(0xFF8B0000),
          ),
        );
      } catch (e) {
        setState(() {
          _isLoading = false;
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Login failed: ${e.toString()}'),
            backgroundColor: const Color(0xFF8B0000),
          ),
        );
      }
    }
  }

  void _handleGoogleSignIn() async {
    setState(() {
      _isLoading = true;
    });

    try {
      print('Starting Google Sign-In...');

      // Validate Google Sign-In configuration
      if (!GoogleSignInConfig.isConfigurationValid()) {
        throw Exception('Google Sign-In configuration is invalid');
      }

      final GoogleSignIn googleSignIn = GoogleSignInConfig.getGoogleSignIn();
      final GoogleSignInAccount? googleUser = await googleSignIn.signIn();

      if (googleUser == null) {
        print('Google Sign-In was cancelled by user');
        setState(() {
          _isLoading = false;
        });
        return;
      }

      print('Google Sign-In successful for: ${googleUser.email}');

      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;
      print('Google authentication completed');

      final credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      print('Signing in with Firebase...');
      final userCredential = await FirebaseAuth.instance.signInWithCredential(
        credential,
      );
      print('Firebase sign-in successful');

      setState(() {
        _isLoading = false;
      });

      if (userCredential.user != null) {
        // Check if email is admin email
        final email = userCredential.user!.email?.toLowerCase() ?? '';
        if (email.endsWith('@impactgraphicsza.co.za')) {
          Navigator.of(context).pushReplacement(
            MaterialPageRoute(
              builder: (context) => const AdminDashboardScreen(),
            ),
          );
        } else {
          Navigator.of(context).pushReplacement(
            MaterialPageRoute(builder: (context) => const DashboardScreen()),
          );
        }
      }
    } catch (e) {
      print('Google Sign-In error: $e');
      setState(() {
        _isLoading = false;
      });

      String errorMessage = 'Google sign-in failed';
      if (e.toString().contains('network')) {
        errorMessage = 'Network error. Please check your internet connection.';
      } else if (e.toString().contains('cancelled')) {
        errorMessage = 'Sign-in was cancelled';
      } else if (e.toString().contains('popup')) {
        errorMessage =
            'Sign-in popup was blocked. Please allow popups and try again.';
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(errorMessage),
          backgroundColor: const Color(0xFF8B0000),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // Update responsive variables
    isMobile = ResponsiveUtils.isMobile(context);
    isTablet = ResponsiveUtils.isTablet(context);
    isDesktop = ResponsiveUtils.isDesktop(context);
    isLandscape = MediaQuery.of(context).orientation == Orientation.landscape;

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: SafeArea(
          child: isLandscape ? _buildLandscapeLayout() : _buildPortraitLayout(),
        ),
      ),
    );
  }

  Widget _buildLandscapeLayout() {
    return Row(
      children: [
        // Left Panel - Logo and Branding
        Expanded(
          flex: isMobile ? 1 : 2,
          child: Container(
            padding: EdgeInsets.all(isMobile ? 16 : 32),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              mainAxisSize: MainAxisSize.min,
              children: [
                CustomLogo(size: isMobile ? 80 : 120),
                SizedBox(height: isMobile ? 12 : 20),
                Text(
                  'Welcome Back',
                  style: TextStyle(
                    fontSize: isMobile ? 24 : 32,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: isMobile ? 6 : 10),
                Text(
                  'Sign in to your account',
                  style: TextStyle(
                    fontSize: isMobile ? 16 : 18,
                    color: Colors.white70,
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: isMobile ? 16 : 24),
                // Additional branding content for landscape
                Container(
                  padding: EdgeInsets.all(isMobile ? 12 : 20),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: Colors.white.withOpacity(0.2)),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.person_add,
                        color: const Color(0xFFFFD700),
                        size: isMobile ? 24 : 32,
                      ),
                      SizedBox(height: isMobile ? 6 : 10),
                      Text(
                        'Join Our Community',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: isMobile ? 14 : 16,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      SizedBox(height: isMobile ? 3 : 5),
                      Text(
                        'Access premium design services and exclusive features',
                        style: TextStyle(
                          color: Colors.white70,
                          fontSize: isMobile ? 12 : 14,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
        // Right Panel - Login Form
        Expanded(
          flex: isMobile ? 3 : 2,
          child: Container(
            padding: EdgeInsets.all(isMobile ? 16 : 24),
            child: Center(
              child: SingleChildScrollView(
                child: Form(key: _formKey, child: _buildLoginForm()),
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPortraitLayout() {
    return SingleChildScrollView(
      padding: ResponsiveUtils.getScreenPadding(context),
      child: Form(
        key: _formKey,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Logo and Title Section
            Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                SizedBox(
                  height: isMobile
                      ? 20
                      : isTablet
                      ? 40
                      : 60,
                ),
                CustomLogo(
                  size: isMobile
                      ? 80
                      : isTablet
                      ? 100
                      : 120,
                ),
                SizedBox(
                  height: isMobile
                      ? 20
                      : isTablet
                      ? 30
                      : 40,
                ),
                Text(
                  'Welcome Back',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 8),
                Text(
                  'Sign in to your account',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    color: Colors.white70,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),

            SizedBox(
              height: isMobile
                  ? 30
                  : isTablet
                  ? 40
                  : 50,
            ),

            // Login Form
            _buildLoginForm(),
          ],
        ),
      ),
    );
  }

  Widget _buildLoginForm() {
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          constraints: BoxConstraints(
            maxWidth: ResponsiveUtils.getMaxWidth(context),
          ),
          margin: (isTablet || isDesktop) && !isLandscape
              ? const EdgeInsets.symmetric(horizontal: 20)
              : EdgeInsets.zero,
          padding: ResponsiveUtils.getCardPadding(context),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: Color.lerp(
                Theme.of(context).brightness == Brightness.dark
                    ? Colors.white.withOpacity(0.08)
                    : Colors.black.withOpacity(0.06),
                const Color(0xFF8B0000).withOpacity(0.6),
                _glowAnimation.value,
              )!,
              width: 1.5 + (_glowAnimation.value * 0.5),
            ),
            gradient: LinearGradient(
              colors: [
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.06 : 0.4,
                ),
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.02 : 0.2,
                ),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 30,
                offset: const Offset(0, 10),
              ),
              BoxShadow(
                color: const Color(
                  0xFF8B0000,
                ).withOpacity(_glowAnimation.value * 0.3),
                blurRadius: 20 + (_glowAnimation.value * 10),
                offset: const Offset(0, 0),
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'Welcome Back',
                style: TextStyle(
                  fontSize: isLandscape
                      ? 20
                      : ResponsiveUtils.getTitleFontSize(context),
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                ),
                textAlign: TextAlign.center,
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
              const SizedBox(height: 8),
              Text(
                'Sign in to your account',
                style: TextStyle(
                  fontSize: isLandscape
                      ? 14
                      : ResponsiveUtils.getBodyFontSize(context),
                  color: Colors.white70,
                ),
                textAlign: TextAlign.center,
                overflow: TextOverflow.ellipsis,
                maxLines: 1,
              ),
              SizedBox(
                height: isLandscape
                    ? 16
                    : (isMobile
                          ? 16
                          : isTablet
                          ? 24
                          : 32),
              ),

              // Email Field
              TextFormField(
                controller: _emailController,
                keyboardType: TextInputType.emailAddress,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Email',
                  labelStyle: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                    fontSize: isLandscape
                        ? 14
                        : ResponsiveUtils.getBodyFontSize(context),
                  ),
                  prefixIcon: Icon(
                    Icons.email,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                    size: isLandscape
                        ? 18
                        : ResponsiveUtils.getIconSize(context),
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                  contentPadding: EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: isLandscape
                        ? 12
                        : (isMobile
                              ? 12
                              : isTablet
                              ? 16
                              : 20),
                  ),
                  isDense: isLandscape || isMobile,
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter your email';
                  }
                  if (!RegExp(
                    r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$',
                  ).hasMatch(value)) {
                    return 'Please enter a valid email';
                  }
                  return null;
                },
              ),

              SizedBox(height: isLandscape ? 16 : 24),

              // Password Field
              TextFormField(
                controller: _passwordController,
                obscureText: !_isPasswordVisible,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Password',
                  labelStyle: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                    fontSize: isLandscape
                        ? 14
                        : ResponsiveUtils.getBodyFontSize(context),
                  ),
                  prefixIcon: Icon(
                    Icons.lock,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                    size: isLandscape
                        ? 18
                        : ResponsiveUtils.getIconSize(context),
                  ),
                  suffixIcon: IconButton(
                    icon: Icon(
                      _isPasswordVisible
                          ? Icons.visibility
                          : Icons.visibility_off,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      size: isLandscape
                          ? 18
                          : ResponsiveUtils.getIconSize(context),
                    ),
                    onPressed: () {
                      setState(() {
                        _isPasswordVisible = !_isPasswordVisible;
                      });
                    },
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(16),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                  contentPadding: EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: isLandscape
                        ? 12
                        : (isMobile
                              ? 12
                              : isTablet
                              ? 16
                              : 20),
                  ),
                  isDense: isLandscape || isMobile,
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter your password';
                  }
                  if (value.length < 6) {
                    return 'Password must be at least 6 characters';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 8),

              // Forgot Password
              Align(
                alignment: Alignment.centerRight,
                child: TextButton(
                  onPressed: () {
                    // Handle forgot password
                  },
                  child: Text(
                    'Forgot Password?',
                    style: TextStyle(
                      color: const Color(0xFF8B0000),
                      fontSize: isLandscape
                          ? 12
                          : ResponsiveUtils.getSmallFontSize(context),
                    ),
                  ),
                ),
              ),

              SizedBox(height: isLandscape ? 12 : 12),

              // Login Button
              SizedBox(
                width: double.infinity,
                height: isLandscape
                    ? 44
                    : (isMobile
                          ? 48
                          : isTablet
                          ? 56
                          : 64),
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _handleLogin,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    elevation: 0,
                  ),
                  child: _isLoading
                      ? SizedBox(
                          width: isLandscape
                              ? 18
                              : ResponsiveUtils.getIconSize(context),
                          height: isLandscape
                              ? 18
                              : ResponsiveUtils.getIconSize(context),
                          child: const CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              Colors.white,
                            ),
                          ),
                        )
                      : Text(
                          'Sign In',
                          style: TextStyle(
                            fontSize: isLandscape
                                ? 16
                                : ResponsiveUtils.getBodyFontSize(context),
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),

              const SizedBox(height: 8),

              // Divider
              Row(
                children: [
                  const Expanded(child: Divider(color: Colors.white30)),
                  Padding(
                    padding: EdgeInsets.symmetric(
                      horizontal: isLandscape ? 12 : (isMobile ? 16 : 24),
                    ),
                    child: Text(
                      'OR',
                      style: TextStyle(
                        color: Colors.white70,
                        fontSize: isLandscape
                            ? 12
                            : ResponsiveUtils.getSmallFontSize(context),
                      ),
                    ),
                  ),
                  const Expanded(child: Divider(color: Colors.white30)),
                ],
              ),

              SizedBox(height: isLandscape ? 12 : 16),

              // Continue as Guest
              SizedBox(
                width: double.infinity,
                height: isLandscape
                    ? 44
                    : ResponsiveUtils.getButtonHeight(context),
                child: OutlinedButton(
                  onPressed: _isLoading
                      ? null
                      : () {
                          Navigator.of(context).pushReplacement(
                            MaterialPageRoute(
                              builder: (context) => const GuestScreen(),
                            ),
                          );
                        },
                  style: OutlinedButton.styleFrom(
                    side: const BorderSide(color: Colors.white30),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: Text(
                    'Continue as Guest',
                    style: TextStyle(
                      fontSize: isLandscape
                          ? 14
                          : ResponsiveUtils.getBodyFontSize(context),
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),

              SizedBox(height: isLandscape ? 12 : 16),

              // Social Login Buttons
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton.icon(
                      onPressed: _isLoading ? null : _handleGoogleSignIn,
                      icon: Icon(
                        FontAwesomeIcons.google,
                        size: isLandscape
                            ? 16
                            : (ResponsiveUtils.getIconSize(context) - 4),
                      ),
                      label: Text(
                        'Google',
                        style: TextStyle(
                          fontSize: isLandscape
                              ? 12
                              : ResponsiveUtils.getBodyFontSize(context),
                        ),
                      ),
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.white,
                        side: const BorderSide(color: Colors.white30),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        padding: EdgeInsets.symmetric(
                          vertical: isLandscape ? 12 : (isTablet ? 16 : 20),
                        ),
                      ),
                    ),
                  ),
                ],
              ),

              SizedBox(
                height: isLandscape
                    ? 16
                    : (isMobile
                          ? 24
                          : isTablet
                          ? 32
                          : 40),
              ),

              // Sign Up Link
              Wrap(
                alignment: WrapAlignment.center,
                crossAxisAlignment: WrapCrossAlignment.center,
                children: [
                  Text(
                    "Don't have an account? ",
                    style: TextStyle(
                      color: Colors.white70,
                      fontSize: isLandscape
                          ? 12
                          : ResponsiveUtils.getBodyFontSize(context),
                    ),
                  ),
                  TextButton(
                    onPressed: () {
                      Navigator.of(context).push(
                        MaterialPageRoute(
                          builder: (context) => const SignUpScreen(),
                        ),
                      );
                    },
                    child: Text(
                      'Sign Up',
                      style: TextStyle(
                        color: const Color(0xFF8B0000),
                        fontWeight: FontWeight.bold,
                        fontSize: isLandscape
                            ? 12
                            : ResponsiveUtils.getBodyFontSize(context),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }
}

class SignUpScreen extends StatefulWidget {
  const SignUpScreen({super.key});

  @override
  State<SignUpScreen> createState() => _SignUpScreenState();
}

class _SignUpScreenState extends State<SignUpScreen>
    with TickerProviderStateMixin {
  final _formKey = GlobalKey<FormState>();
  final _firstNameController = TextEditingController();
  final _lastNameController = TextEditingController();
  final _emailController = TextEditingController();
  final _phoneController = TextEditingController();
  final _referralCodeController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  bool _isPasswordVisible = false;
  bool _isConfirmPasswordVisible = false;
  bool _isLoading = false;
  bool _agreeToTerms = false;
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  // Responsive variables
  bool isMobile = false;
  bool isTablet = false;
  bool isDesktop = false;
  bool isLandscape = false;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    );
    _glowAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );
    _glowController.repeat(reverse: true);
  }

  @override
  void dispose() {
    _firstNameController.dispose();
    _lastNameController.dispose();
    _emailController.dispose();
    _phoneController.dispose();
    _referralCodeController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  void _handleSignUp() async {
    if (_formKey.currentState!.validate() && _agreeToTerms) {
      setState(() {
        _isLoading = true;
      });

      try {
        // Firebase Email/Password Authentication
        final userCredential = await FirebaseAuth.instance
            .createUserWithEmailAndPassword(
              email: _emailController.text.trim(),
              password: _passwordController.text,
            );

        if (userCredential.user != null) {
          // Create user profile in Firestore
          await FirebaseService.createUserProfile(
            uid: userCredential.user!.uid,
            name:
                '${_firstNameController.text.trim()} ${_lastNameController.text.trim()}',
            email: _emailController.text.trim(),
            role: 'user',
            phone: _phoneController.text.trim(),
            provider: 'email',
          );

          // Send welcome notification
          await NotificationService.sendWelcomeNotification(
            userId: userCredential.user!.uid,
            userName:
                '${_firstNameController.text.trim()} ${_lastNameController.text.trim()}',
          );

          // Process referral if referral code was provided
          if (_referralCodeController.text.trim().isNotEmpty) {
            await ReferralService.checkAndProcessReferral(
              userId: userCredential.user!.uid,
              userName:
                  '${_firstNameController.text.trim()} ${_lastNameController.text.trim()}',
              userEmail: _emailController.text.trim(),
              referralCode: _referralCodeController.text.trim(),
            );
          }

          setState(() {
            _isLoading = false;
          });

          // Check if email is admin email
          final email = _emailController.text.toLowerCase();
          if (email.endsWith('@impactgraphicsza.co.za')) {
            // Navigate to admin dashboard for admin emails
            Navigator.of(context).pushAndRemoveUntil(
              MaterialPageRoute(
                builder: (context) => const AdminDashboardScreen(),
              ),
              (route) => false,
            );
          } else {
            // Navigate to regular dashboard for other users
            Navigator.of(context).pushAndRemoveUntil(
              MaterialPageRoute(builder: (context) => const DashboardScreen()),
              (route) => false,
            );
          }
        }
      } on FirebaseAuthException catch (e) {
        setState(() {
          _isLoading = false;
        });

        String errorMessage = 'An error occurred during sign up';
        if (e.code == 'weak-password') {
          errorMessage = 'The password provided is too weak';
        } else if (e.code == 'email-already-in-use') {
          errorMessage = 'An account already exists for this email';
        } else if (e.code == 'invalid-email') {
          errorMessage = 'Invalid email address';
        }

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(errorMessage),
            backgroundColor: const Color(0xFF8B0000),
          ),
        );
      } catch (e) {
        setState(() {
          _isLoading = false;
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Sign up failed: ${e.toString()}'),
            backgroundColor: const Color(0xFF8B0000),
          ),
        );
      }
    } else if (!_agreeToTerms) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please agree to the Terms & Conditions'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
    }
  }

  void _handleGoogleSignUp() async {
    setState(() {
      _isLoading = true;
    });

    try {
      print('Starting Google Sign-Up...');

      // Validate Google Sign-In configuration
      if (!GoogleSignInConfig.isConfigurationValid()) {
        throw Exception('Google Sign-In configuration is invalid');
      }

      final GoogleSignIn googleSignIn = GoogleSignInConfig.getGoogleSignIn();
      final GoogleSignInAccount? googleUser = await googleSignIn.signIn();

      if (googleUser == null) {
        print('Google Sign-Up was cancelled by user');
        setState(() {
          _isLoading = false;
        });
        return;
      }

      print('Google Sign-Up successful for: ${googleUser.email}');

      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;
      print('Google authentication completed');

      final credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      print('Signing up with Firebase...');
      final userCredential = await FirebaseAuth.instance.signInWithCredential(
        credential,
      );
      print('Firebase sign-up successful');

      if (userCredential.user != null) {
        print('Creating user profile...');
        // Create user profile in Firestore
        await FirebaseService.createUserProfile(
          uid: userCredential.user!.uid,
          name: googleUser.displayName ?? '',
          email: userCredential.user!.email ?? '',
          role: 'user',
          phone: userCredential.user!.phoneNumber,
          provider: 'google',
        );

        print('Sending welcome notification...');
        // Send welcome notification
        await NotificationService.sendWelcomeNotification(
          userId: userCredential.user!.uid,
          userName: googleUser.displayName ?? 'User',
        );

        setState(() {
          _isLoading = false;
        });

        // Check if email is admin email
        final email = userCredential.user!.email?.toLowerCase() ?? '';
        if (email.endsWith('@impactgraphicsza.co.za')) {
          Navigator.of(context).pushAndRemoveUntil(
            MaterialPageRoute(
              builder: (context) => const AdminDashboardScreen(),
            ),
            (route) => false,
          );
        } else {
          Navigator.of(context).pushAndRemoveUntil(
            MaterialPageRoute(builder: (context) => const DashboardScreen()),
            (route) => false,
          );
        }
      }
    } catch (e) {
      print('Google Sign-Up error: $e');
      setState(() {
        _isLoading = false;
      });

      String errorMessage = 'Google sign-up failed';
      if (e.toString().contains('network')) {
        errorMessage = 'Network error. Please check your internet connection.';
      } else if (e.toString().contains('cancelled')) {
        errorMessage = 'Sign-up was cancelled';
      } else if (e.toString().contains('popup')) {
        errorMessage =
            'Sign-up popup was blocked. Please allow popups and try again.';
      } else if (e.toString().contains('already')) {
        errorMessage =
            'An account with this email already exists. Please sign in instead.';
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(errorMessage),
          backgroundColor: const Color(0xFF8B0000),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // Update responsive variables
    isMobile = ResponsiveUtils.isMobile(context);
    isTablet = ResponsiveUtils.isTablet(context);
    isDesktop = ResponsiveUtils.isDesktop(context);
    isLandscape = MediaQuery.of(context).orientation == Orientation.landscape;

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: null,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: SafeArea(
          child: isLandscape ? _buildLandscapeLayout() : _buildPortraitLayout(),
        ),
      ),
    );
  }

  Widget _buildLandscapeLayout() {
    return Row(
      children: [
        // Left Panel - Logo and Branding
        Expanded(
          flex: isMobile ? 1 : 2,
          child: Container(
            padding: EdgeInsets.all(isMobile ? 16 : 32),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              mainAxisSize: MainAxisSize.min,
              children: [
                CustomLogo(size: isMobile ? 80 : 120),
                SizedBox(height: isMobile ? 12 : 20),
                Text(
                  'Create Account',
                  style: TextStyle(
                    fontSize: isMobile ? 24 : 32,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: isMobile ? 6 : 10),
                Text(
                  'Join Impact Graphics ZA today',
                  style: TextStyle(
                    fontSize: isMobile ? 16 : 18,
                    color: Colors.white70,
                  ),
                  textAlign: TextAlign.center,
                ),
                SizedBox(height: isMobile ? 16 : 24),
                // Additional branding content for landscape
                Container(
                  padding: EdgeInsets.all(isMobile ? 12 : 20),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: Colors.white.withOpacity(0.2)),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.person_add,
                        color: const Color(0xFFFFD700),
                        size: isMobile ? 24 : 32,
                      ),
                      SizedBox(height: isMobile ? 6 : 10),
                      Text(
                        'Join Our Community',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: isMobile ? 14 : 16,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      SizedBox(height: isMobile ? 3 : 5),
                      Text(
                        'Access premium design services and exclusive features',
                        style: TextStyle(
                          color: Colors.white70,
                          fontSize: isMobile ? 12 : 14,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
        // Right Panel - Sign Up Form
        Expanded(
          flex: isMobile ? 3 : 2,
          child: Container(
            padding: EdgeInsets.all(isMobile ? 16 : 24),
            child: Center(
              child: SingleChildScrollView(
                child: Form(key: _formKey, child: _buildLoginForm()),
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPortraitLayout() {
    return SingleChildScrollView(
      padding: ResponsiveUtils.getScreenPadding(context),
      child: Form(
        key: _formKey,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Logo and Title Section
            Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                SizedBox(
                  height: isMobile
                      ? 20
                      : isTablet
                      ? 40
                      : 60,
                ),
                CustomLogo(
                  size: isMobile
                      ? 80
                      : isTablet
                      ? 100
                      : 120,
                ),
                SizedBox(
                  height: isMobile
                      ? 20
                      : isTablet
                      ? 30
                      : 40,
                ),
                Text(
                  'Create Account',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 8),
                Text(
                  'Join Impact Graphics ZA today',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    color: Colors.white70,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),

            SizedBox(
              height: isMobile
                  ? 30
                  : isTablet
                  ? 40
                  : 50,
            ),

            // Sign Up Form
            _buildLoginForm(),
          ],
        ),
      ),
    );
  }

  Widget _buildLoginForm() {
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          constraints: BoxConstraints(
            maxWidth: ResponsiveUtils.getMaxWidth(context),
          ),
          margin: (isTablet || isDesktop) && !isLandscape
              ? const EdgeInsets.symmetric(horizontal: 20)
              : EdgeInsets.zero,
          padding: ResponsiveUtils.getCardPadding(context),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: Color.lerp(
                Theme.of(context).brightness == Brightness.dark
                    ? Colors.white.withOpacity(0.08)
                    : Colors.black.withOpacity(0.06),
                const Color(0xFF8B0000).withOpacity(0.6),
                _glowAnimation.value,
              )!,
              width: 1.5 + (_glowAnimation.value * 0.5),
            ),
            gradient: LinearGradient(
              colors: [
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.06 : 0.4,
                ),
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.02 : 0.2,
                ),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 30,
                offset: const Offset(0, 10),
              ),
              BoxShadow(
                color: const Color(
                  0xFF8B0000,
                ).withOpacity(_glowAnimation.value * 0.3),
                blurRadius: 20 + (_glowAnimation.value * 10),
                offset: const Offset(0, 0),
              ),
            ],
          ),
          child: Column(
            children: [
              // Name Fields Row
              Row(
                children: [
                  Expanded(
                    child: TextFormField(
                      controller: _firstNameController,
                      style: const TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'First Name',
                        labelStyle: const TextStyle(color: Colors.white70),
                        prefixIcon: const Icon(
                          Icons.person,
                          color: Colors.white70,
                        ),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.1),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.1),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: const BorderSide(
                            color: Color(0xFF8B0000),
                            width: 2,
                          ),
                        ),
                        filled: true,
                        fillColor: Colors.white.withOpacity(0.05),
                      ),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please enter your first name';
                        }
                        return null;
                      },
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: TextFormField(
                      controller: _lastNameController,
                      style: const TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Last Name',
                        labelStyle: const TextStyle(color: Colors.white70),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: const BorderSide(color: Colors.white30),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: const BorderSide(color: Colors.white30),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                          borderSide: const BorderSide(
                            color: Color(0xFF8B0000),
                            width: 2,
                          ),
                        ),
                        filled: true,
                        fillColor: Colors.white.withOpacity(0.05),
                      ),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Please enter your last name';
                        }
                        return null;
                      },
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 20),

              // Email Field
              TextFormField(
                controller: _emailController,
                keyboardType: TextInputType.emailAddress,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Email',
                  labelStyle: const TextStyle(color: Colors.white70),
                  prefixIcon: const Icon(Icons.email, color: Colors.white70),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter your email';
                  }
                  if (!RegExp(
                    r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$',
                  ).hasMatch(value)) {
                    return 'Please enter a valid email';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 20),

              // Phone Field
              TextFormField(
                controller: _phoneController,
                keyboardType: TextInputType.phone,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Phone Number',
                  labelStyle: const TextStyle(color: Colors.white70),
                  prefixIcon: const Icon(Icons.phone, color: Colors.white70),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(color: Colors.white30),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(color: Colors.white30),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter your phone number';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 20),

              // Referral Code Field (Optional)
              TextFormField(
                controller: _referralCodeController,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Referral Code (Optional)',
                  labelStyle: const TextStyle(color: Colors.white70),
                  prefixIcon: const Icon(
                    Icons.card_giftcard,
                    color: Colors.white70,
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(color: Colors.white30),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(color: Colors.white30),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                ),
              ),

              const SizedBox(height: 20),

              // Password Field
              TextFormField(
                controller: _passwordController,
                obscureText: !_isPasswordVisible,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Password',
                  labelStyle: const TextStyle(color: Colors.white70),
                  prefixIcon: const Icon(Icons.lock, color: Colors.white70),
                  suffixIcon: IconButton(
                    icon: Icon(
                      _isPasswordVisible
                          ? Icons.visibility
                          : Icons.visibility_off,
                      color: Colors.white70,
                      size: ResponsiveUtils.getIconSize(context),
                    ),
                    onPressed: () {
                      setState(() {
                        _isPasswordVisible = !_isPasswordVisible;
                      });
                    },
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter a password';
                  }
                  if (value.length < 8) {
                    return 'Password must be at least 8 characters';
                  }
                  if (!RegExp(
                    r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)',
                  ).hasMatch(value)) {
                    return 'Password must contain uppercase, lowercase & number';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 20),

              // Confirm Password Field
              TextFormField(
                controller: _confirmPasswordController,
                obscureText: !_isConfirmPasswordVisible,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: 'Confirm Password',
                  labelStyle: const TextStyle(color: Colors.white70),
                  prefixIcon: const Icon(
                    Icons.lock_outline,
                    color: Colors.white70,
                  ),
                  suffixIcon: IconButton(
                    icon: Icon(
                      _isConfirmPasswordVisible
                          ? Icons.visibility
                          : Icons.visibility_off,
                      color: Colors.white70,
                      size: ResponsiveUtils.getIconSize(context),
                    ),
                    onPressed: () {
                      setState(() {
                        _isConfirmPasswordVisible = !_isConfirmPasswordVisible;
                      });
                    },
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                      color: Colors.white.withOpacity(0.1),
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: const BorderSide(
                      color: Color(0xFF8B0000),
                      width: 2,
                    ),
                  ),
                  filled: true,
                  fillColor: Colors.white.withOpacity(0.05),
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please confirm your password';
                  }
                  if (value != _passwordController.text) {
                    return 'Passwords do not match';
                  }
                  return null;
                },
              ),

              const SizedBox(height: 20),

              // Terms and Conditions
              Row(
                children: [
                  Checkbox(
                    value: _agreeToTerms,
                    onChanged: (value) {
                      setState(() {
                        _agreeToTerms = value ?? false;
                      });
                    },
                    activeColor: const Color(0xFF8B0000),
                    checkColor: Colors.white,
                  ),
                  Expanded(
                    child: GestureDetector(
                      onTap: () {
                        setState(() {
                          _agreeToTerms = !_agreeToTerms;
                        });
                      },
                      child: RichText(
                        text: const TextSpan(
                          style: TextStyle(color: Colors.white70, fontSize: 14),
                          children: [
                            TextSpan(text: 'I agree to the '),
                            TextSpan(
                              text: 'Terms & Conditions',
                              style: TextStyle(
                                color: Color(0xFF8B0000),
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            TextSpan(text: ' and '),
                            TextSpan(
                              text: 'Privacy Policy',
                              style: TextStyle(
                                color: Color(0xFF8B0000),
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 24),

              // Sign Up Button
              SizedBox(
                width: double.infinity,
                height: 50,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _handleSignUp,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    elevation: 0,
                  ),
                  child: _isLoading
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              Colors.white,
                            ),
                          ),
                        )
                      : const Text(
                          'Create Account',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                ),
              ),

              const SizedBox(height: 24),

              // Divider
              Row(
                children: [
                  const Expanded(child: Divider(color: Colors.white30)),
                  Padding(
                    padding: EdgeInsets.symmetric(
                      horizontal: ResponsiveUtils.getSpacing(context) * 2,
                    ),
                    child: Text(
                      'OR',
                      style: TextStyle(
                        color: Colors.white70,
                        fontSize: ResponsiveUtils.getSmallFontSize(context),
                      ),
                    ),
                  ),
                  const Expanded(child: Divider(color: Colors.white30)),
                ],
              ),

              const SizedBox(height: 32),

              // Social Sign Up Buttons
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton.icon(
                      onPressed: _isLoading ? null : _handleGoogleSignUp,
                      icon: const Icon(FontAwesomeIcons.google, size: 18),
                      label: const Text('Google'),
                      style: OutlinedButton.styleFrom(
                        foregroundColor: Colors.white,
                        side: const BorderSide(color: Colors.white30),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        padding: const EdgeInsets.symmetric(vertical: 12),
                      ),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 32),

              // Sign In Link
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text(
                    'Already have an account? ',
                    style: TextStyle(color: Colors.white70),
                  ),
                  TextButton(
                    onPressed: () {
                      Navigator.of(context).pushReplacement(
                        MaterialPageRoute(
                          builder: (context) => const LoginScreen(),
                        ),
                      );
                    },
                    child: const Text(
                      'Sign In',
                      style: TextStyle(
                        color: Color(0xFF8B0000),
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildEnhancedLandscapeForm() {
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          constraints: BoxConstraints(
            maxWidth: ResponsiveUtils.getMaxWidth(context),
          ),
          padding: ResponsiveUtils.getCardPadding(context),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: Color.lerp(
                Theme.of(context).brightness == Brightness.dark
                    ? Colors.white.withOpacity(0.08)
                    : Colors.black.withOpacity(0.06),
                const Color(0xFF8B0000).withOpacity(0.6),
                _glowAnimation.value,
              )!,
              width: 1.5 + (_glowAnimation.value * 0.5),
            ),
            gradient: LinearGradient(
              colors: [
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.06 : 0.4,
                ),
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.02 : 0.2,
                ),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 30,
                offset: const Offset(0, 10),
              ),
              BoxShadow(
                color: const Color(
                  0xFF8B0000,
                ).withOpacity(_glowAnimation.value * 0.3),
                blurRadius: 20 + (_glowAnimation.value * 10),
                offset: const Offset(0, 0),
              ),
            ],
          ),
          child: Column(
            children: [
              // Enhanced Header
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      const Color(0xFF8B0000).withOpacity(0.1),
                      const Color(0xFF8B0000).withOpacity(0.05),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: const Color(0xFF8B0000).withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Icon(
                        Icons.person_add,
                        color: Color(0xFF8B0000),
                        size: 24,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Text(
                      'Create Your Account',
                      style: TextStyle(
                        fontSize: isMobile ? 18 : 20,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Two Column Layout for Form Fields
              Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Left Column
                  Expanded(
                    child: Column(
                      children: [
                        // Name Fields
                        Row(
                          children: [
                            Expanded(
                              child: _buildEnhancedTextField(
                                controller: _firstNameController,
                                label: 'First Name',
                                icon: Icons.person,
                                validator: (value) {
                                  if (value == null || value.isEmpty) {
                                    return 'Please enter your first name';
                                  }
                                  return null;
                                },
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: _buildEnhancedTextField(
                                controller: _lastNameController,
                                label: 'Last Name',
                                icon: Icons.person_outline,
                                validator: (value) {
                                  if (value == null || value.isEmpty) {
                                    return 'Please enter your last name';
                                  }
                                  return null;
                                },
                              ),
                            ),
                          ],
                        ),

                        const SizedBox(height: 16),

                        // Email Field
                        _buildEnhancedTextField(
                          controller: _emailController,
                          label: 'Email Address',
                          icon: Icons.email,
                          keyboardType: TextInputType.emailAddress,
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Please enter your email';
                            }
                            if (!RegExp(
                              r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$',
                            ).hasMatch(value)) {
                              return 'Please enter a valid email';
                            }
                            return null;
                          },
                        ),

                        const SizedBox(height: 16),

                        // Phone Field
                        _buildEnhancedTextField(
                          controller: _phoneController,
                          label: 'Phone Number',
                          icon: Icons.phone,
                          keyboardType: TextInputType.phone,
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Please enter your phone number';
                            }
                            return null;
                          },
                        ),

                        const SizedBox(height: 16),

                        // Referral Code Field (Optional)
                        _buildEnhancedTextField(
                          controller: _referralCodeController,
                          label: 'Referral Code (Optional)',
                          icon: Icons.card_giftcard,
                          keyboardType: TextInputType.text,
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(width: 20),

                  // Right Column
                  Expanded(
                    child: Column(
                      children: [
                        // Password Field
                        _buildEnhancedTextField(
                          controller: _passwordController,
                          label: 'Password',
                          icon: Icons.lock,
                          isPassword: true,
                          isPasswordVisible: _isPasswordVisible,
                          onPasswordToggle: () {
                            setState(() {
                              _isPasswordVisible = !_isPasswordVisible;
                            });
                          },
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Please enter a password';
                            }
                            if (value.length < 8) {
                              return 'Password must be at least 8 characters';
                            }
                            if (!RegExp(
                              r'^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)',
                            ).hasMatch(value)) {
                              return 'Password must contain uppercase, lowercase & number';
                            }
                            return null;
                          },
                        ),

                        const SizedBox(height: 16),

                        // Confirm Password Field
                        _buildEnhancedTextField(
                          controller: _confirmPasswordController,
                          label: 'Confirm Password',
                          icon: Icons.lock_outline,
                          isPassword: true,
                          isPasswordVisible: _isConfirmPasswordVisible,
                          onPasswordToggle: () {
                            setState(() {
                              _isConfirmPasswordVisible =
                                  !_isConfirmPasswordVisible;
                            });
                          },
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Please confirm your password';
                            }
                            if (value != _passwordController.text) {
                              return 'Passwords do not match';
                            }
                            return null;
                          },
                        ),

                        const SizedBox(height: 16),

                        // Password Strength Indicator
                        _buildPasswordStrengthIndicator(),
                      ],
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 24),

              // Enhanced Terms and Conditions
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.05),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: Colors.white.withOpacity(0.1)),
                ),
                child: Row(
                  children: [
                    Checkbox(
                      value: _agreeToTerms,
                      onChanged: (value) {
                        setState(() {
                          _agreeToTerms = value ?? false;
                        });
                      },
                      activeColor: const Color(0xFF8B0000),
                      checkColor: Colors.white,
                    ),
                    Expanded(
                      child: GestureDetector(
                        onTap: () {
                          setState(() {
                            _agreeToTerms = !_agreeToTerms;
                          });
                        },
                        child: RichText(
                          text: const TextSpan(
                            style: TextStyle(
                              color: Colors.white70,
                              fontSize: 14,
                            ),
                            children: [
                              TextSpan(text: 'I agree to the '),
                              TextSpan(
                                text: 'Terms & Conditions',
                                style: TextStyle(
                                  color: Color(0xFF8B0000),
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              TextSpan(text: ' and '),
                              TextSpan(
                                text: 'Privacy Policy',
                                style: TextStyle(
                                  color: Color(0xFF8B0000),
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Enhanced Sign Up Button
              SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _handleSignUp,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    elevation: 0,
                  ),
                  child: _isLoading
                      ? const SizedBox(
                          width: 24,
                          height: 24,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              Colors.white,
                            ),
                          ),
                        )
                      : Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            const Icon(Icons.person_add, size: 20),
                            const SizedBox(width: 8),
                            Text(
                              'Create Account',
                              style: TextStyle(
                                fontSize: isMobile ? 16 : 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                ),
              ),

              const SizedBox(height: 20),

              // Enhanced Social Sign Up
              Column(
                children: [
                  Row(
                    children: [
                      const Expanded(child: Divider(color: Colors.white30)),
                      Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 16),
                        child: Text(
                          'OR SIGN UP WITH',
                          style: TextStyle(
                            color: Colors.white70,
                            fontSize: 12,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                      const Expanded(child: Divider(color: Colors.white30)),
                    ],
                  ),

                  const SizedBox(height: 16),

                  Row(
                    children: [
                      Expanded(
                        child: _buildSocialButton(
                          icon: FontAwesomeIcons.google,
                          label: 'Google',
                          onPressed: () {
                            // Handle Google sign up
                          },
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: _buildSocialButton(
                          icon: FontAwesomeIcons.facebook,
                          label: 'Facebook',
                          onPressed: () {
                            // Handle Facebook sign up
                          },
                        ),
                      ),
                    ],
                  ),
                ],
              ),

              const SizedBox(height: 24),

              // Enhanced Sign In Link
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.05),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Text(
                      'Already have an account? ',
                      style: TextStyle(color: Colors.white70),
                    ),
                    TextButton(
                      onPressed: () {
                        Navigator.of(context).pushReplacement(
                          MaterialPageRoute(
                            builder: (context) => const LoginScreen(),
                          ),
                        );
                      },
                      child: const Text(
                        'Sign In',
                        style: TextStyle(
                          color: Color(0xFF8B0000),
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildEnhancedTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    TextInputType? keyboardType,
    bool isPassword = false,
    bool isPasswordVisible = false,
    VoidCallback? onPasswordToggle,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: keyboardType,
      obscureText: isPassword && !isPasswordVisible,
      style: const TextStyle(color: Colors.white),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: Colors.white70),
        prefixIcon: Icon(icon, color: Colors.white70),
        suffixIcon: isPassword
            ? IconButton(
                icon: Icon(
                  isPasswordVisible ? Icons.visibility : Icons.visibility_off,
                  color: Colors.white70,
                ),
                onPressed: onPasswordToggle,
              )
            : null,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.1)),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: Colors.white.withOpacity(0.1)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: Color(0xFF8B0000), width: 2),
        ),
        filled: true,
        fillColor: Colors.white.withOpacity(0.05),
        contentPadding: const EdgeInsets.symmetric(
          horizontal: 16,
          vertical: 12,
        ),
      ),
      validator: validator,
    );
  }

  Widget _buildPasswordStrengthIndicator() {
    final password = _passwordController.text;
    double strength = 0.0;
    String message = '';
    Color color = Colors.grey;

    if (password.isNotEmpty) {
      if (password.length >= 8) strength += 0.25;
      if (RegExp(r'[a-z]').hasMatch(password)) strength += 0.25;
      if (RegExp(r'[A-Z]').hasMatch(password)) strength += 0.25;
      if (RegExp(r'\d').hasMatch(password)) strength += 0.25;

      if (strength <= 0.25) {
        message = 'Weak';
        color = Colors.red;
      } else if (strength <= 0.5) {
        message = 'Fair';
        color = Colors.orange;
      } else if (strength <= 0.75) {
        message = 'Good';
        color = Colors.yellow;
      } else {
        message = 'Strong';
        color = Colors.green;
      }
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Password Strength',
          style: TextStyle(
            color: Colors.white70,
            fontSize: 12,
            fontWeight: FontWeight.w600,
          ),
        ),
        const SizedBox(height: 4),
        LinearProgressIndicator(
          value: strength,
          backgroundColor: Colors.white.withOpacity(0.1),
          valueColor: AlwaysStoppedAnimation<Color>(color),
        ),
        const SizedBox(height: 4),
        Text(
          message,
          style: TextStyle(
            color: color,
            fontSize: 10,
            fontWeight: FontWeight.w600,
          ),
        ),
      ],
    );
  }

  Widget _buildSocialButton({
    required IconData icon,
    required String label,
    required VoidCallback onPressed,
  }) {
    return OutlinedButton.icon(
      onPressed: onPressed,
      icon: Icon(icon, size: 18),
      label: Text(label),
      style: OutlinedButton.styleFrom(
        foregroundColor: Colors.white,
        side: const BorderSide(color: Colors.white30),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        padding: const EdgeInsets.symmetric(vertical: 12),
      ),
    );
  }
}

class UpdatesScreen extends StatefulWidget {
  final VoidCallback? onBackPressed;

  const UpdatesScreen({super.key, this.onBackPressed});

  @override
  State<UpdatesScreen> createState() => _UpdatesScreenState();
}

class _UpdatesScreenState extends State<UpdatesScreen> {
  String? _currentUserId;

  // Responsive variables
  bool isMobile = false;
  bool isTablet = false;
  bool isDesktop = false;
  bool isLandscape = false;

  @override
  void initState() {
    super.initState();
    _loadCurrentUser();
  }

  void _loadCurrentUser() {
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser != null) {
      setState(() {
        _currentUserId = currentUser.uid;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    // Update responsive variables
    isMobile = ResponsiveUtils.isMobile(context);
    isTablet = ResponsiveUtils.isTablet(context);
    isDesktop = ResponsiveUtils.isDesktop(context);
    isLandscape = MediaQuery.of(context).orientation == Orientation.landscape;

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: null,
      body: Stack(
        children: [
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  const Color(0xFF8B0000),
                  Theme.of(context).brightness == Brightness.dark
                      ? const Color(0xFF1A1A1A)
                      : const Color(0xFFF5F5F5),
                ],
              ),
            ),
            child: SafeArea(
              child: _currentUserId == null
                  ? _buildEmptyState()
                  : StreamBuilder(
                      stream: FirebaseService.getUpdatesStream(_currentUserId!),
                      builder: (context, snapshot) {
                        if (snapshot.hasError) {
                          return _buildErrorState(snapshot.error.toString());
                        }

                        if (snapshot.connectionState ==
                            ConnectionState.waiting) {
                          return _buildLoadingState();
                        }

                        final updates = snapshot.data?.docs ?? [];

                        if (updates.isEmpty) {
                          return _buildEmptyState();
                        }

                        return Column(
                          children: [
                            // Updates title with back button (landscape) and mark all read button
                            Padding(
                              padding: ResponsiveUtils.getScreenPadding(
                                context,
                              ),
                              child: Row(
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceBetween,
                                children: [
                                  Row(
                                    children: [
                                      if (isLandscape)
                                        IconButton(
                                          icon: Icon(
                                            Icons.arrow_back,
                                            size: ResponsiveUtils.getIconSize(
                                              context,
                                            ),
                                            color:
                                                Theme.of(context).brightness ==
                                                    Brightness.dark
                                                ? Colors.white
                                                : Colors.black87,
                                          ),
                                          onPressed: widget.onBackPressed,
                                          tooltip: 'Back to Dashboard',
                                        ),
                                      Text(
                                        'Updates',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getTitleFontSize(
                                                context,
                                              ),
                                          fontWeight: FontWeight.bold,
                                          color:
                                              Theme.of(context).brightness ==
                                                  Brightness.dark
                                              ? Colors.white
                                              : Colors.black87,
                                        ),
                                      ),
                                    ],
                                  ),
                                  IconButton(
                                    icon: Icon(
                                      Icons.mark_email_read,
                                      size: ResponsiveUtils.getIconSize(
                                        context,
                                      ),
                                    ),
                                    onPressed: () async {
                                      if (_currentUserId != null) {
                                        try {
                                          // Mark all notifications as read using NotificationCountService
                                          await NotificationCountService.markAllNotificationsAsReadForUser(
                                            _currentUserId!,
                                          );

                                          // Show success message
                                          if (mounted) {
                                            ScaffoldMessenger.of(
                                              context,
                                            ).showSnackBar(
                                              const SnackBar(
                                                content: Text(
                                                  'All notifications marked as read',
                                                ),
                                                backgroundColor: Color(
                                                  0xFF8B0000,
                                                ),
                                                duration: Duration(seconds: 2),
                                              ),
                                            );
                                          }
                                        } catch (e) {
                                          print(
                                            'Error marking all as read: $e',
                                          );
                                          if (mounted) {
                                            ScaffoldMessenger.of(
                                              context,
                                            ).showSnackBar(
                                              SnackBar(
                                                content: Text(
                                                  'Error: ${e.toString()}',
                                                ),
                                                backgroundColor: Colors.red,
                                              ),
                                            );
                                          }
                                        }
                                      }
                                    },
                                    tooltip: 'Mark all as read',
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                  ),
                                ],
                              ),
                            ),
                            // Updates list
                            Expanded(
                              child: ListView.builder(
                                padding: ResponsiveUtils.getScreenPadding(
                                  context,
                                ),
                                itemCount: updates.length,
                                itemBuilder: (context, index) {
                                  final updateDoc = updates[index];
                                  final updateData =
                                      updateDoc.data() as Map<String, dynamic>;
                                  final update = UpdateItem.fromFirestore(
                                    updateDoc.id,
                                    updateData,
                                  );
                                  return _buildUpdateCard(update);
                                },
                              ),
                            ),
                          ],
                        );
                      },
                    ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildUpdateCard(UpdateItem update) {
    return Container(
      margin: EdgeInsets.only(bottom: ResponsiveUtils.getSpacing(context) * 2),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0)),
        boxShadow: Theme.of(context).brightness == Brightness.dark
            ? null
            : [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 2),
                ),
              ],
      ),
      child: InkWell(
        onTap: () async {
          // Mark notification as read in Firestore
          if (!update.isRead) {
            await NotificationCountService.markNotificationAsRead(update.id);
          }

          _showUpdateDialog(update);
        },
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: ResponsiveUtils.getCardPadding(context),
          child: Row(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Update type icon
              Container(
                padding: EdgeInsets.all(ResponsiveUtils.getSpacing(context)),
                decoration: BoxDecoration(
                  color: _getUpdateTypeColor(update.type).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Icon(
                  _getUpdateTypeIcon(update.type),
                  color: _getUpdateTypeColor(update.type),
                  size: ResponsiveUtils.getIconSize(context),
                ),
              ),
              SizedBox(width: ResponsiveUtils.getSpacing(context) * 2),

              // Update content
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Expanded(
                          child: Text(
                            update.title,
                            style: TextStyle(
                              fontSize: ResponsiveUtils.getBodyFontSize(
                                context,
                              ),
                              fontWeight: update.isRead
                                  ? FontWeight.w500
                                  : FontWeight.bold,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white
                                  : Colors.black87,
                            ),
                          ),
                        ),
                        if (!update.isRead)
                          Container(
                            width: 8,
                            height: 8,
                            decoration: const BoxDecoration(
                              color: Color(0xFF8B0000),
                              shape: BoxShape.circle,
                            ),
                          ),
                      ],
                    ),
                    SizedBox(height: ResponsiveUtils.getSpacing(context)),
                    Text(
                      update.message,
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getSmallFontSize(context),
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white70
                            : Colors.black54,
                        height: 1.4,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    SizedBox(height: ResponsiveUtils.getSpacing(context) * 1.5),
                    Text(
                      _formatTimestamp(update.timestamp),
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getSmallFontSize(context) - 2,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white54
                            : Colors.black38,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildErrorState(String error) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(40),
            decoration: BoxDecoration(
              color: Colors.red.withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(
              Icons.error_outline,
              size: ResponsiveUtils.getIconSize(context) * 3,
              color: Colors.red,
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context) * 3),
          Text(
            'Error Loading Updates',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleFontSize(context),
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
          Text(
            'Unable to load updates at this time',
            style: TextStyle(
              fontSize: ResponsiveUtils.getBodyFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(40),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(
                const Color(0xFF8B0000),
              ),
              strokeWidth: 3,
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context) * 3),
          Text(
            'Loading Updates...',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleFontSize(context),
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
          Text(
            'Please wait while we fetch your latest updates',
            style: TextStyle(
              fontSize: ResponsiveUtils.getBodyFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: EdgeInsets.all(ResponsiveUtils.getSpacing(context) * 3),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(
              Icons.notifications_none,
              size: ResponsiveUtils.getIconSize(context) * 3,
              color: const Color(0xFF8B0000),
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context) * 3),
          Text(
            'No Updates Yet',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleFontSize(context),
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
          Text(
            'You\'ll see all your updates and notifications here',
            style: TextStyle(
              fontSize: ResponsiveUtils.getBodyFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Color _getUpdateTypeColor(UpdateType type) {
    switch (type) {
      case UpdateType.order:
        return const Color(0xFF8B0000);
      case UpdateType.project:
        return const Color(0xFF8B0000);
      case UpdateType.service:
        return Colors.blue;
      case UpdateType.payment:
        return Colors.green;
      case UpdateType.system:
        return Colors.orange;
      case UpdateType.loyalty:
        return const Color(0xFFFFD700);
      case UpdateType.portfolio:
        return Colors.purple;
    }
  }

  IconData _getUpdateTypeIcon(UpdateType type) {
    switch (type) {
      case UpdateType.order:
        return Icons.shopping_bag;
      case UpdateType.project:
        return Icons.work;
      case UpdateType.service:
        return Icons.add_circle;
      case UpdateType.payment:
        return Icons.payment;
      case UpdateType.system:
        return Icons.system_update;
      case UpdateType.loyalty:
        return Icons.star;
      case UpdateType.portfolio:
        return Icons.photo_library;
    }
  }

  String _formatTimestamp(DateTime timestamp) {
    final now = DateTime.now();
    final difference = now.difference(timestamp);

    if (difference.inMinutes < 60) {
      return '${difference.inMinutes}m ago';
    } else if (difference.inHours < 24) {
      return '${difference.inHours}h ago';
    } else if (difference.inDays < 7) {
      return '${difference.inDays}d ago';
    } else {
      return '${timestamp.day}/${timestamp.month}/${timestamp.year}';
    }
  }

  void _handleNotificationNavigation(UpdateItem update) {
    print('=== NAVIGATING FROM NOTIFICATION ===');
    print('Update type: ${update.type}');
    print('Order ID: ${update.orderId}');
    print('Title: ${update.title}');

    // Close the dialog first
    Navigator.of(context).pop();

    // Navigate based on update type and available data
    switch (update.type) {
      case UpdateType.order:
      case UpdateType.project:
      case UpdateType.service:
        if (update.orderId != null) {
          // Navigate to specific order details
          print('Navigating to order details: ${update.orderId}');
          _navigateToOrderDetails(update.orderId!);
        } else {
          // Navigate to orders screen
          print('No orderId found, navigating to orders screen');
          _navigateToOrdersScreen();
        }
        break;
      case UpdateType.payment:
        // Always navigate to wallet for payment notifications
        print('Payment notification, navigating to wallet');
        _navigateToWalletScreen();
        break;
      case UpdateType.loyalty:
        // Navigate to wallet screen for loyalty points
        print('Navigating to wallet for loyalty points');
        _navigateToWalletScreen();
        break;
      case UpdateType.portfolio:
        // Navigate to Services Hub portfolio tab using callback
        print('Navigating to Services Hub portfolio');
        NotificationService.navigateToPortfolio();
        break;
      case UpdateType.system:
      default:
        // For system updates, just close the dialog (already closed above)
        print('System update, no additional navigation');
        break;
    }
  }

  bool _isOrderAccepted(UpdateItem update) {
    // Check if this is an order acceptance notification
    return (update.action == 'order_accepted' ||
            update.orderStatus == 'accepted') &&
        update.type == UpdateType.order;
  }

  bool _isPortfolioUpdate(UpdateItem update) {
    // Check if this is a portfolio update notification
    return update.type == UpdateType.portfolio ||
        update.action == 'view_portfolio';
  }

  bool _isPaymentNotification(UpdateItem update) {
    // Check if this is a payment notification
    print('=== CHECKING IF PAYMENT NOTIFICATION ===');
    print('Update Type: ${update.type}');
    print('Update Action: ${update.action}');
    print('Is Payment Type: ${update.type == UpdateType.payment}');
    print(
      'Is Payment Action: ${update.action == 'payment_successful' || update.action == 'payment_success_with_whatsapp'}',
    );

    final isPayment =
        update.type == UpdateType.payment ||
        update.action == 'payment_successful' ||
        update.action == 'payment_success_with_whatsapp';

    print('Final Result: $isPayment');
    return isPayment;
  }

  void _navigateToCart() {
    print('Navigating to cart for payment');
    Navigator.of(context).pop(); // Close dialog
    // Navigate to Cart screen
    Navigator.of(
      context,
    ).push(MaterialPageRoute(builder: (context) => const CartScreen()));
  }

  Future<void> _viewInvoice(UpdateItem update) async {
    print('Navigating to invoice screen');
    Navigator.of(context).pop(); // Close dialog

    // Extract transaction details from update data
    final transactionId = update.data?['transactionId'] ?? 'N/A';
    final amount = (update.data?['amount'] as num?)?.toDouble() ?? 0.0;
    final orderNumber = update.data?['orderNumber'];

    // Get current user information from Firebase
    final currentUser = FirebaseAuth.instance.currentUser;
    final userName = currentUser?.displayName ?? 'Customer';
    final userEmail = currentUser?.email ?? 'customer@example.com';
    final userPhone = currentUser?.phoneNumber;

    // Navigate to Invoice screen
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => InvoiceScreen(
          transactionId: transactionId,
          customerName: userName,
          customerEmail: userEmail,
          serviceName: update.title
              .replaceAll('Payment Successful! ðŸ’³', '')
              .trim(),
          amount: amount,
          status: 'COMPLETED',
          date: update.timestamp,
          reference: transactionId,
          phone: userPhone,
          orderNumber: orderNumber,
        ),
      ),
    );
  }

  void _openPortfolioLink(UpdateItem update) async {
    print('Opening portfolio link');
    Navigator.of(context).pop(); // Close dialog

    // Extract portfolio image URL from the data
    String? portfolioUrl = update.data?['portfolioImage'];

    if (portfolioUrl != null && portfolioUrl.isNotEmpty) {
      try {
        // Import url_launcher for opening URLs
        final Uri url = Uri.parse(portfolioUrl);
        if (await canLaunchUrl(url)) {
          await launchUrl(url, mode: LaunchMode.externalApplication);
        } else {
          print('Could not launch $url');
          // Fallback to Services Hub if URL can't be opened
          Navigator.of(context).push(
            MaterialPageRoute(builder: (context) => const ServiceHubScreen()),
          );
        }
      } catch (e) {
        print('Error opening portfolio link: $e');
        // Fallback to Services Hub if there's an error
        Navigator.of(context).push(
          MaterialPageRoute(builder: (context) => const ServiceHubScreen()),
        );
      }
    } else {
      print('No portfolio URL found, navigating to Services Hub');
      // Fallback to Services Hub if no URL is available
      Navigator.of(
        context,
      ).push(MaterialPageRoute(builder: (context) => const ServiceHubScreen()));
    }
  }

  void _navigateToOrderDetails(String orderId) async {
    try {
      // Navigate to orders screen with the specific order ID
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => MyOrdersScreen(orderId: orderId),
        ),
      );
    } catch (e) {
      print('Error navigating to order details: $e');
      // Fallback: navigate to orders screen
      _navigateToOrdersScreen();
    }
  }

  void _navigateToOrdersScreen() {
    // Navigate to orders screen
    Navigator.of(
      context,
    ).push(MaterialPageRoute(builder: (context) => MyOrdersScreen()));
  }

  void _navigateToWalletScreen() {
    // Navigate to wallet screen
    Navigator.of(
      context,
    ).push(MaterialPageRoute(builder: (context) => WalletScreen()));
  }

  void _showUpdateDialog(UpdateItem update) {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          elevation: 0,
          backgroundColor: Colors.transparent,
          child: Container(
            constraints: const BoxConstraints(maxWidth: 400),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF2A2A2A)
                  : Colors.white,
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.2),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Header with gradient background
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(24),
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [Color(0xFF8B0000), Color(0xFFC62828)],
                    ),
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(20),
                      topRight: Radius.circular(20),
                    ),
                  ),
                  child: Row(
                    children: [
                      // Icon
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: update.type == UpdateType.system
                            ? _buildImpactLogo(size: 24)
                            : Icon(
                                _getUpdateTypeIcon(update.type),
                                color: Colors.white,
                                size: 24,
                              ),
                      ),
                      const SizedBox(width: 16),
                      // Title and type
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              update.title,
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 8,
                                vertical: 4,
                              ),
                              decoration: BoxDecoration(
                                color: Colors.white.withOpacity(0.2),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Text(
                                update.type
                                    .toString()
                                    .split('.')
                                    .last
                                    .toUpperCase(),
                                style: const TextStyle(
                                  color: Colors.white,
                                  fontSize: 10,
                                  fontWeight: FontWeight.w600,
                                  letterSpacing: 0.5,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      // Close button
                      IconButton(
                        onPressed: () => Navigator.of(context).pop(),
                        icon: const Icon(Icons.close, color: Colors.white),
                        style: IconButton.styleFrom(
                          backgroundColor: Colors.white.withOpacity(0.2),
                        ),
                      ),
                    ],
                  ),
                ),
                // Content
                Padding(
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    children: [
                      Text(
                        update.message,
                        style: TextStyle(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : const Color(0xFF333333),
                          fontSize: 16,
                          height: 1.5,
                        ),
                        textAlign: TextAlign.left,
                      ),
                      const SizedBox(height: 24),
                      // Action buttons
                      Row(
                        children: [
                          Expanded(
                            child: OutlinedButton(
                              onPressed: () => Navigator.of(context).pop(),
                              style: OutlinedButton.styleFrom(
                                side: BorderSide(
                                  color: Theme.of(context).primaryColor,
                                ),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                              child: Text(
                                'Close',
                                style: TextStyle(
                                  color: Theme.of(context).primaryColor,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: ElevatedButton(
                              onPressed: () {
                                if (_isOrderAccepted(update)) {
                                  _navigateToCart();
                                } else if (_isPortfolioUpdate(update)) {
                                  _openPortfolioLink(update);
                                } else if (_isPaymentNotification(update)) {
                                  _viewInvoice(update);
                                } else {
                                  _handleNotificationNavigation(update);
                                }
                              },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: _isOrderAccepted(update)
                                    ? const Color(0xFF00AA00)
                                    : _isPortfolioUpdate(update)
                                    ? Colors.red
                                    : _isPaymentNotification(update)
                                    ? const Color(
                                        0xFF00AA00,
                                      ) // Green for payment
                                    : Theme.of(context).primaryColor,
                                foregroundColor: Colors.white,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    _isOrderAccepted(update)
                                        ? Icons.shopping_cart_checkout
                                        : _isPortfolioUpdate(update)
                                        ? Icons.open_in_new
                                        : _isPaymentNotification(update)
                                        ? Icons.receipt_long
                                        : Icons.arrow_forward,
                                    size: 18,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    _isOrderAccepted(update)
                                        ? 'Checkout'
                                        : _isPortfolioUpdate(update)
                                        ? 'Visit Project'
                                        : _isPaymentNotification(update)
                                        ? 'View Invoice'
                                        : 'View Details',
                                    style: const TextStyle(
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildImpactLogo({double size = 24}) {
    return SizedBox(
      width: size,
      height: size,
      child: Image.asset(
        'assets/images/logo.png',
        width: size,
        height: size,
        fit: BoxFit.contain,
      ),
    );
  }
}

enum UpdateType { project, service, payment, system, loyalty, order, portfolio }

class UpdateItem {
  final String id;
  final String title;
  final String message;
  final UpdateType type;
  final DateTime timestamp;
  bool isRead;
  final String? orderId;
  final String? clientId;
  final String? orderStatus;
  final String? action;
  final Map<String, dynamic>? data;

  UpdateItem({
    required this.id,
    required this.title,
    required this.message,
    required this.type,
    required this.timestamp,
    this.isRead = false,
    this.orderId,
    this.clientId,
    this.orderStatus,
    this.action,
    this.data,
  });

  factory UpdateItem.fromFirestore(String id, Map<String, dynamic> data) {
    // Extract orderId from either direct field or nested data field
    String? orderId = data['orderId'];
    if (orderId == null && data['data'] is Map) {
      orderId = (data['data'] as Map<String, dynamic>)['orderId'];
    }

    // Extract clientId from either direct field or nested data field
    String? clientId = data['clientId'];
    if (clientId == null && data['data'] is Map) {
      clientId = (data['data'] as Map<String, dynamic>)['clientId'];
    }

    // Extract order status from nested data field
    String? orderStatus;
    if (data['data'] is Map) {
      orderStatus = (data['data'] as Map<String, dynamic>)['status'];
    }

    // Extract action from either direct field or nested data field
    String? action = data['action'];

    print('=== UPDATE ITEM FROM FIRESTORE ===');
    print('ID: $id');
    print('Title: ${data['title']}');
    print('Type: ${data['type']}');
    print('OrderId (direct): ${data['orderId']}');
    print(
      'OrderId (nested): ${data['data'] is Map ? (data['data'] as Map<String, dynamic>)['orderId'] : 'N/A'}',
    );
    print('Final orderId: $orderId');
    print('Order Status: $orderStatus');
    print('Action: $action');
    print('Data: $data');

    return UpdateItem(
      id: id,
      title: data['title'] ?? '',
      message: data['message'] ?? '',
      type: _stringToUpdateType(data['type'] ?? 'system'),
      timestamp: (data['createdAt'] as dynamic)?.toDate() ?? DateTime.now(),
      isRead: data['isRead'] ?? false,
      orderId: orderId,
      clientId: clientId,
      orderStatus: orderStatus,
      action: action,
      data: data['data'] is Map ? data['data'] as Map<String, dynamic> : null,
    );
  }

  static UpdateType _stringToUpdateType(String type) {
    switch (type.toLowerCase()) {
      case 'project':
        return UpdateType.project;
      case 'service':
        return UpdateType.service;
      case 'payment':
      case 'payment_success': // Handle payment success notifications
        return UpdateType.payment;
      case 'loyalty':
        return UpdateType.loyalty;
      case 'order':
        return UpdateType.order;
      case 'portfolio':
      case 'portfolio_update': // Handle portfolio update notifications
        return UpdateType.portfolio;
      default:
        return UpdateType.system;
    }
  }
}

class User {
  final String id;
  final String name;
  final String email;
  final String? phone;
  final String role;
  final bool isActive;
  final DateTime createdAt;
  final DateTime? lastLogin;
  final String? referralCode;
  final int loyaltyPoints;
  final bool isSilverTier;
  final bool isGoldTier;

  User({
    required this.id,
    required this.name,
    required this.email,
    this.phone,
    required this.role,
    required this.isActive,
    required this.createdAt,
    this.lastLogin,
    this.referralCode,
    this.loyaltyPoints = 0,
    this.isSilverTier = false,
    this.isGoldTier = false,
  });

  factory User.fromFirestore(String id, Map<String, dynamic> data) {
    return User(
      id: id,
      name: data['name'] ?? '',
      email: data['email'] ?? '',
      phone: data['phone'],
      role: data['role'] ?? 'user',
      isActive: data['isActive'] ?? true,
      createdAt: (data['createdAt'] as dynamic)?.toDate() ?? DateTime.now(),
      lastLogin: (data['lastLogin'] as dynamic)?.toDate(),
      referralCode: data['referralCode'],
      loyaltyPoints: (data['loyaltyPoints'] as num?)?.toInt() ?? 0,
      isSilverTier: data['isSilverTier'] ?? false,
      isGoldTier: data['isGoldTier'] ?? false,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'name': name,
      'email': email,
      'phone': phone,
      'role': role,
      'isActive': isActive,
      'createdAt': createdAt,
      'lastLogin': lastLogin,
      'referralCode': referralCode,
      'loyaltyPoints': loyaltyPoints,
      'isSilverTier': isSilverTier,
      'isGoldTier': isGoldTier,
    };
  }
}

class Client {
  final String id;
  final String name;
  final String contact;
  final String email;
  final String phone;
  final String address;
  final String status;
  final int totalOrders;
  final double totalSpent;
  final DateTime? lastOrder;
  final DateTime createdAt;
  final DateTime updatedAt;

  Client({
    required this.id,
    required this.name,
    required this.contact,
    required this.email,
    required this.phone,
    required this.address,
    required this.status,
    required this.totalOrders,
    required this.totalSpent,
    this.lastOrder,
    required this.createdAt,
    required this.updatedAt,
  });

  factory Client.fromFirestore(String id, Map<String, dynamic> data) {
    return Client(
      id: id,
      name: data['name'] ?? '',
      contact: data['contact'] ?? '',
      email: data['email'] ?? '',
      phone: data['phone'] ?? '',
      address: data['address'] ?? '',
      status: data['status'] ?? 'Active',
      totalOrders: (data['totalOrders'] as num?)?.toInt() ?? 0,
      totalSpent: (data['totalSpent'] as num?)?.toDouble() ?? 0.0,
      lastOrder: (data['lastOrder'] as dynamic)?.toDate(),
      createdAt: (data['createdAt'] as dynamic)?.toDate() ?? DateTime.now(),
      updatedAt: (data['updatedAt'] as dynamic)?.toDate() ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'name': name,
      'contact': contact,
      'email': email,
      'phone': phone,
      'address': address,
      'status': status,
      'totalOrders': totalOrders,
      'totalSpent': totalSpent,
      'lastOrder': lastOrder,
      'createdAt': createdAt,
      'updatedAt': updatedAt,
    };
  }
}

class CartScreen extends StatefulWidget {
  const CartScreen({super.key});

  @override
  State<CartScreen> createState() => _CartScreenState();
}

class _CartScreenState extends State<CartScreen> with TickerProviderStateMixin {
  String? _userId;
  bool _isCheckoutCollapsed = false;
  late AnimationController _animationController;
  late Animation<double> _slideAnimation;

  @override
  void initState() {
    super.initState();
    _userId = FirebaseAuth.instance.currentUser?.uid;
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _slideAnimation = Tween<double>(begin: 1.0, end: 0.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _animationController.dispose();
    super.dispose();
  }

  void _toggleCheckoutCollapse() {
    setState(() {
      _isCheckoutCollapsed = !_isCheckoutCollapsed;
      if (_isCheckoutCollapsed) {
        _animationController.forward();
      } else {
        _animationController.reverse();
      }
    });
  }

  void _updateQuantity(String id, int newQuantity) async {
    if (newQuantity > 0 && _userId != null) {
      await CartService.updateQuantity(id, newQuantity, _userId!);
    }
  }

  void _removeItem(String id) async {
    if (_userId != null) {
      print('=== CART: Starting removal process for item $id ===');

      // Remove item from cart
      await CartService.removeItem(id, _userId!);
      print('=== CART: Item removed from cart successfully ===');

      // Also cancel the corresponding order in admin dashboard
      await _cancelOrderFromCart(id);
      print('=== CART: Order cancellation process completed ===');
    }
  }

  Future<void> _cancelOrderFromCart(String cartItemId) async {
    try {
      print('=== CART: Cancelling order for cart item $cartItemId ===');
      print('=== CART: Looking for pending orders for user $_userId ===');

      // Find all pending orders for this user
      // Use a simpler query to avoid composite index issues
      final ordersSnapshot = await FirebaseFirestore.instance
          .collection('orders')
          .where('userId', isEqualTo: _userId)
          .orderBy('createdAt', descending: true)
          .get();

      // Filter pending orders on the client side
      final pendingOrders = ordersSnapshot.docs.where((doc) {
        final data = doc.data();
        return data['status'] == 'pending';
      }).toList();

      print(
        '=== CART: Found ${pendingOrders.length} pending orders out of ${ordersSnapshot.docs.length} total orders ===',
      );

      if (pendingOrders.isEmpty) {
        print('=== CART: No pending orders found to cancel ===');
        return;
      }

      // Cancel the most recent pending order (most likely the one just removed from cart)
      final mostRecentOrder = pendingOrders.first;
      final orderId = mostRecentOrder.id;
      final orderData = mostRecentOrder.data();
      final serviceName = orderData['serviceName'] ?? 'Unknown Service';
      final orderPrice = (orderData['finalPrice'] ?? orderData['price'] ?? 0.0)
          .toDouble();

      print(
        '=== CART: Cancelling most recent order: $orderId for service $serviceName (R$orderPrice) ===',
      );

      // Cancel the order
      await FirebaseService.cancelOrder(
        orderId,
        reason: 'Removed from cart by user',
      );

      // Send notification to admin
      await NotificationService.sendAdminNotification(
        title: 'Order Cancelled',
        body: 'User removed order from cart: $serviceName',
        action: 'order_cancelled',
        data: {
          'orderId': orderId,
          'reason': 'Removed from cart',
          'userId': _userId!,
        },
      );

      // Send notification to user
      await NotificationService.sendNotificationToUser(
        userId: _userId!,
        title: 'Order Removed',
        body:
            'Your $serviceName order has been removed from cart and cancelled.',
        type: 'order',
        action: 'order_cancelled',
        data: {'orderId': orderId, 'serviceName': serviceName},
      );

      print('=== CART: Successfully cancelled order $orderId ===');
    } catch (e) {
      print('=== CART: Error cancelling order from cart: $e ===');
      print('=== CART: Stack trace: ${StackTrace.current} ===');
      // Don't fail the cart removal if order cancellation fails
    }
  }

  // Checkout and payment processing
  Future<void> _processCheckout(
    List<CartItem> items,
    double totalAmount,
  ) async {
    try {
      // Get user information
      final user = FirebaseAuth.instance.currentUser;
      if (user?.email == null || _userId == null) {
        _handleFailedPayment('User information not available');
        return;
      }

      // Show loading dialog
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return const AlertDialog(
            backgroundColor: Color(0xFF2A2A2A),
            content: Row(
              children: [
                CircularProgressIndicator(color: Color(0xFF8B0000)),
                SizedBox(width: 20),
                Text(
                  'Processing payment...',
                  style: TextStyle(color: Colors.white),
                ),
              ],
            ),
          );
        },
      );

      // Process split payment
      final splitResult = await SplitPaymentService.processSplitPayment(
        totalAmount: totalAmount,
        userId: _userId!,
        userEmail: user!.email!,
        userName: user.displayName ?? 'User',
        userPhone: user.phoneNumber ?? '',
        cartItems: items,
      );

      // Close loading dialog
      Navigator.of(context).pop();

      if (!splitResult.success) {
        _handleFailedPayment(splitResult.error ?? 'Payment failed');
        return;
      }

      // Handle different payment scenarios
      if (splitResult.isWalletOnly) {
        // Wallet payment only - complete immediately
        await CartService.clearCart(_userId!);

        await NotificationService.sendPaymentNotification(
          userId: _userId!,
          transactionId: 'WALLET-${DateTime.now().millisecondsSinceEpoch}',
          status: 'successful',
          amount: totalAmount,
        );

        _showSuccessMessage(
          'Payment completed using wallet funds! Cart cleared.',
        );
      } else if (splitResult.isPaystackOnly) {
        // Paystack payment only - navigate to payment screen
        final result = await Navigator.of(context).push(
          MaterialPageRoute(
            builder: (context) => PaystackPaymentScreen(
              cartItems: items,
              totalAmount: totalAmount,
              userEmail: user.email!,
              userName: user.displayName,
              userPhone: user.phoneNumber,
              paymentType: 'cart',
            ),
          ),
        );

        if (result == true) {
          await CartService.clearCart(_userId!);
          await NotificationService.sendPaymentNotification(
            userId: _userId!,
            transactionId: 'PAYSTACK-${DateTime.now().millisecondsSinceEpoch}',
            status: 'successful',
            amount: totalAmount,
          );
          _showSuccessMessage('Payment completed successfully! Cart cleared.');
        }
      } else if (splitResult.isSplitPayment) {
        // Split payment - navigate to split payment screen
        final result = await Navigator.of(context).push(
          MaterialPageRoute(
            builder: (context) => SplitPaymentScreen(
              paystackAuthorizationUrl: splitResult.paystackAuthorizationUrl!,
              paystackReference: splitResult.paystackReference!,
              paystackAmount: splitResult.paystackAmount,
              walletAmount: splitResult.walletAmount,
              totalAmount: totalAmount,
              userId: _userId!,
              userEmail: user.email!,
              userName: user.displayName ?? 'User',
              userPhone: user.phoneNumber ?? '',
              cartItems: items,
            ),
          ),
        );

        if (result == true) {
          _showSuccessMessage(
            'Split payment completed successfully! Cart cleared.',
          );
        }
      }
    } catch (e) {
      // Close loading dialog if still open
      if (Navigator.of(context).canPop()) {
        Navigator.of(context).pop();
      }
      _handleFailedPayment('Payment processing error: $e');
    }
  }

  void _showSuccessMessage(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  Future<Map<String, dynamic>> _processCardPayment(
    List<CartItem> items,
    double totalAmount,
  ) async {
    try {
      // For card payments, we need to show a card input form
      // In a real implementation, you would integrate with Yoco's card payment SDK
      // For now, we'll simulate the card payment process

      // Show card input dialog
      final cardResult = await _showCardInputDialog(totalAmount);
      if (cardResult == null) {
        return {'success': false, 'error': 'Card payment cancelled'};
      }

      // Simulate payment processing
      await Future.delayed(const Duration(seconds: 2));

      return {
        'success': true,
        'transaction_id': 'txn_${DateTime.now().millisecondsSinceEpoch}',
        'amount': totalAmount,
        'method': 'card',
        'card_last4': cardResult['last4'],
      };
    } catch (e) {
      return {'success': false, 'error': 'Card payment error: $e'};
    }
  }

  Future<Map<String, dynamic>?> _showCardInputDialog(double amount) async {
    final cardNumberController = TextEditingController();
    final expiryController = TextEditingController();
    final cvvController = TextEditingController();
    final nameController = TextEditingController();

    return showDialog<Map<String, dynamic>>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Card Payment'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text('Amount: R${amount.toStringAsFixed(2)}'),
            const SizedBox(height: 16),
            TextField(
              controller: cardNumberController,
              decoration: const InputDecoration(
                labelText: 'Card Number',
                border: OutlineInputBorder(),
              ),
              keyboardType: TextInputType.number,
              maxLength: 16,
            ),
            const SizedBox(height: 8),
            Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: expiryController,
                    decoration: const InputDecoration(
                      labelText: 'MM/YY',
                      border: OutlineInputBorder(),
                    ),
                    keyboardType: TextInputType.number,
                    maxLength: 5,
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: TextField(
                    controller: cvvController,
                    decoration: const InputDecoration(
                      labelText: 'CVV',
                      border: OutlineInputBorder(),
                    ),
                    keyboardType: TextInputType.number,
                    maxLength: 4,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 8),
            TextField(
              controller: nameController,
              decoration: const InputDecoration(
                labelText: 'Cardholder Name',
                border: OutlineInputBorder(),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () {
              if (cardNumberController.text.isNotEmpty &&
                  expiryController.text.isNotEmpty &&
                  cvvController.text.isNotEmpty &&
                  nameController.text.isNotEmpty) {
                Navigator.of(context).pop({
                  'last4': cardNumberController.text.substring(
                    cardNumberController.text.length - 4,
                  ),
                  'expiry': expiryController.text,
                  'name': nameController.text,
                });
              }
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
            ),
            child: const Text('Pay'),
          ),
        ],
      ),
    );
  }

  Future<Map<String, dynamic>> _processBankTransfer(
    List<CartItem> items,
    double totalAmount,
  ) async {
    try {
      // Generate bank transfer details
      final transferDetails = {
        'bank_name': 'Standard Bank',
        'account_number': '1234567890',
        'account_name': 'Impact Graphics ZA',
        'reference': 'IGZ-${DateTime.now().millisecondsSinceEpoch}',
        'amount': totalAmount,
      };

      // Show bank transfer details to user
      await _showBankTransferDetails(transferDetails);

      // For bank transfers, we don't need to call Yoco API
      // The payment is considered successful when user confirms they'll make the transfer
      return {
        'success': true,
        'transaction_id': 'bt_${DateTime.now().millisecondsSinceEpoch}',
        'amount': totalAmount,
        'method': 'bank_transfer',
        'transfer_details': transferDetails,
        'status':
            'pending_confirmation', // Bank transfers need manual confirmation
      };
    } catch (e) {
      return {'success': false, 'error': 'Bank transfer error: $e'};
    }
  }

  Future<Map<String, dynamic>> _processInstantEFT(
    List<CartItem> items,
    double totalAmount,
  ) async {
    try {
      // In a real implementation, you would integrate with Yoco's Instant EFT
      await Future.delayed(
        const Duration(seconds: 2),
      ); // Simulate processing time

      return {
        'success': true,
        'transaction_id': 'eft_${DateTime.now().millisecondsSinceEpoch}',
        'amount': totalAmount,
        'method': 'instant_eft',
      };
    } catch (e) {
      return {'success': false, 'error': 'Instant EFT error: $e'};
    }
  }

  Future<void> _showBankTransferDetails(Map<String, dynamic> details) async {
    await showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Bank Transfer Details'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Bank: ${details['bank_name']}'),
            Text('Account Number: ${details['account_number']}'),
            Text('Account Name: ${details['account_name']}'),
            Text('Reference: ${details['reference']}'),
            Text('Amount: R${details['amount'].toStringAsFixed(2)}'),
            const SizedBox(height: 16),
            const Text(
              'Please use the reference number when making the transfer. '
              'Your order will be processed once payment is confirmed.',
              style: TextStyle(fontSize: 12, color: Colors.grey),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  }

  Future<void> _handleSuccessfulPayment(
    List<CartItem> items,
    Map<String, dynamic> paymentResult,
  ) async {
    try {
      final paymentMethod = paymentResult['method'];
      final status = paymentResult['status'] ?? 'completed';
      final userId = FirebaseAuth.instance.currentUser?.uid;

      // Handle different payment methods
      if (paymentMethod == 'bank_transfer' &&
          status == 'pending_confirmation') {
        // For bank transfers, don't clear cart yet - wait for manual confirmation
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text(
              'Bank transfer details provided. Please complete the transfer and contact us for confirmation.',
            ),
            backgroundColor: Colors.blue,
          ),
        );
        return;
      }

      // Update order status for each item
      for (final item in items) {
        if (item.orderId != null) {
          // Yoco payment service removed - using Paystack only
        }
      }

      // Send payment notification
      if (userId != null && status == 'completed') {
        await NotificationService.sendPaymentNotification(
          userId: userId,
          transactionId: paymentResult['transaction_id'],
          status: 'successful',
          amount: paymentResult['amount'],
        );

        // Process referral earnings
        await ReferralService.processReferralPurchase(
          referredUserId: userId,
          purchaseAmount: paymentResult['amount'],
        );
      }

      // Clear cart items that were paid for (only for immediate payments)
      if (status == 'completed' && _userId != null) {
        for (final item in items) {
          await CartService.removeItem(item.id, _userId!);
        }
      }

      // Show success message
      String successMessage = 'Payment successful!';
      if (paymentMethod == 'card') {
        successMessage += ' Transaction ID: ${paymentResult['transaction_id']}';
        if (paymentResult['card_last4'] != null) {
          successMessage += ' (Card ending in ${paymentResult['card_last4']})';
        }
      } else if (paymentMethod == 'instant_eft') {
        successMessage += ' EFT completed successfully!';
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(successMessage), backgroundColor: Colors.green),
      );

      // Navigate back to dashboard for immediate payments
      if (status == 'completed') {
        Navigator.of(context).pop();
      }
    } catch (e) {
      print('Error handling successful payment: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Payment successful but error updating order: $e'),
          backgroundColor: Colors.orange,
        ),
      );
    }
  }

  void _handleFailedPayment(String error) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Payment failed: $error'),
        backgroundColor: Colors.red,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_userId == null) {
      return Scaffold(
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
        appBar: AppBar(
          title: Text(
            'Shopping Cart',
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          backgroundColor: Colors.transparent,
          elevation: 0,
          leading: IconButton(
            icon: Icon(
              Icons.arrow_back,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
            onPressed: () => Navigator.of(context).pop(),
          ),
        ),
        body: const Center(child: Text('Please log in to view your cart')),
      );
    }

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      appBar: AppBar(
        title: Text(
          'Shopping Cart',
          style: TextStyle(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.white
                : Colors.black87,
          ),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      body: StreamBuilder<List<CartItem>>(
        stream: CartService.getCartItemsStream(_userId!),
        builder: (context, snapshot) {
          if (snapshot.hasError) {
            return Center(child: Text('Error: ${snapshot.error}'));
          }

          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator());
          }

          final cartItems = snapshot.data ?? [];

          return Stack(
            children: [
              cartItems.isEmpty
                  ? _buildEmptyCart()
                  : Column(
                      children: [
                        Expanded(
                          child: ListView.builder(
                            padding: ResponsiveUtils.getScreenPadding(context),
                            itemCount: cartItems.length,
                            itemBuilder: (context, index) {
                              final item = cartItems[index];
                              return _buildCartItem(item);
                            },
                          ),
                        ),
                        _buildCheckoutSection(),
                      ],
                    ),
            ],
          );
        },
      ),
    );
  }

  Widget _buildCartItem(CartItem item) {
    // Determine if item is greyed out based on status
    final isGreyedOut =
        item.orderStatus == 'pending' || item.orderStatus == 'declined';
    // Get status color and text
    Color statusColor;

    switch (item.orderStatus) {
      case 'pending':
        statusColor = Colors.orange;
        break;
      case 'accepted':
        statusColor = Colors.green;
        break;
      case 'declined':
        statusColor = Colors.red;
        break;
      default:
        statusColor = Colors.grey;
    }

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isGreyedOut
            ? (Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : Colors.grey.shade100)
            : (Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF2A2A2A)
                  : Colors.white),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: statusColor.withOpacity(0.3), width: 1),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              color: const Color(0xFF8B0000).withOpacity(0.1),
            ),
            child: const Icon(Icons.brush, color: Color(0xFF8B0000), size: 40),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  item.name,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  item.description,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getSmallFontSize(context),
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                  ),
                ),
                const SizedBox(height: 8),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      item.budget != null
                          ? 'Budget: ${item.budget}'
                          : 'R${item.price.toStringAsFixed(2)}',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getBodyFontSize(context),
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.amber
                            : const Color(0xFF8B0000),
                      ),
                    ),
                    Row(
                      children: [
                        IconButton(
                          onPressed: () =>
                              _updateQuantity(item.id, item.quantity - 1),
                          icon: const Icon(Icons.remove_circle_outline),
                          color: const Color(0xFF8B0000),
                        ),
                        Text(
                          '${item.quantity}',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        IconButton(
                          onPressed: () =>
                              _updateQuantity(item.id, item.quantity + 1),
                          icon: const Icon(Icons.add_circle_outline),
                          color: const Color(0xFF8B0000),
                        ),
                      ],
                    ),
                  ],
                ),
              ],
            ),
          ),
          IconButton(
            onPressed: () => _removeItem(item.id),
            icon: const Icon(Icons.delete_outline),
            color: Colors.red,
          ),
        ],
      ),
    );
  }

  Widget _buildCheckoutSection() {
    return StreamBuilder<List<CartItem>>(
      stream: CartService.getCartItemsStream(_userId!),
      builder: (context, snapshot) {
        final cartItems = snapshot.data ?? [];

        // Check if any orders are pending or declined
        final hasPendingOrders = cartItems.any(
          (item) => item.orderStatus == 'pending',
        );
        final hasDeclinedOrders = cartItems.any(
          (item) => item.orderStatus == 'declined',
        );
        final hasAcceptedOrders = cartItems.any(
          (item) => item.orderStatus == 'accepted',
        );

        // Calculate total price for accepted orders only
        final acceptedItems = cartItems
            .where((item) => item.orderStatus == 'accepted')
            .toList();
        final subtotal = acceptedItems.fold<double>(
          0.0,
          (sum, item) => sum + item.price,
        );

        // Check if user has Gold Tier subscription for 10% discount
        return StreamBuilder<DocumentSnapshot>(
          stream: FirebaseFirestore.instance
              .collection('users')
              .doc(_userId)
              .snapshots(),
          builder: (context, userSnapshot) {
            final userData = userSnapshot.data?.data() as Map<String, dynamic>?;
            final isGoldTierActive = userData?['goldTierActive'] ?? false;
            final goldTierStatus = userData?['goldTierStatus'] ?? 'inactive';
            final hasGoldTierDiscount =
                isGoldTierActive && goldTierStatus == 'active';

            // Calculate discount and final total
            final discountAmount = hasGoldTierDiscount ? subtotal * 0.10 : 0.0;
            final totalPrice = subtotal - discountAmount;

            // Determine button state and message
            bool isButtonEnabled = hasAcceptedOrders;
            String buttonText = hasAcceptedOrders
                ? 'Proceed to Checkout'
                : 'No Orders Ready';
            String statusMessage = '';

            if (hasPendingOrders && hasAcceptedOrders) {
              statusMessage =
                  'Some orders are pending approval. You can checkout accepted orders now.';
            } else if (hasPendingOrders && !hasAcceptedOrders) {
              statusMessage =
                  'Your orders are being reviewed. We will get back to you soon!';
            } else if (hasDeclinedOrders) {
              statusMessage =
                  'Some of your orders have been declined. Please review and update.';
            }

            return Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: Theme.of(context).brightness == Brightness.dark
                    ? const Color(0xFF2A2A2A)
                    : Colors.white,
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(20),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 10,
                    offset: const Offset(0, -2),
                  ),
                ],
              ),
              child: Column(
                children: [
                  // Collapse handle
                  GestureDetector(
                    onTap: _toggleCheckoutCollapse,
                    child: Container(
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(vertical: 8),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            _isCheckoutCollapsed
                                ? Icons.keyboard_arrow_up
                                : Icons.keyboard_arrow_down,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                            size: 24,
                          ),
                        ],
                      ),
                    ),
                  ),
                  // Collapsible content
                  AnimatedBuilder(
                    animation: _slideAnimation,
                    builder: (context, child) {
                      return SizeTransition(
                        sizeFactor: _slideAnimation,
                        child: Column(
                          children: [
                            // Status message
                            if (statusMessage.isNotEmpty) ...[
                              Container(
                                padding: const EdgeInsets.all(12),
                                decoration: BoxDecoration(
                                  color: hasPendingOrders && hasAcceptedOrders
                                      ? Colors.blue.withOpacity(0.1)
                                      : hasPendingOrders
                                      ? Colors.orange.withOpacity(0.1)
                                      : hasDeclinedOrders
                                      ? Colors.red.withOpacity(0.1)
                                      : Colors.grey.withOpacity(0.1),
                                  borderRadius: BorderRadius.circular(8),
                                  border: Border.all(
                                    color: hasPendingOrders && hasAcceptedOrders
                                        ? Colors.blue.withOpacity(0.3)
                                        : hasPendingOrders
                                        ? Colors.orange.withOpacity(0.3)
                                        : hasDeclinedOrders
                                        ? Colors.red.withOpacity(0.3)
                                        : Colors.grey.withOpacity(0.3),
                                  ),
                                ),
                                child: Row(
                                  children: [
                                    Icon(
                                      hasPendingOrders && hasAcceptedOrders
                                          ? Icons.info
                                          : hasPendingOrders
                                          ? Icons.schedule
                                          : hasDeclinedOrders
                                          ? Icons.cancel
                                          : Icons.info,
                                      color:
                                          hasPendingOrders && hasAcceptedOrders
                                          ? Colors.blue
                                          : hasPendingOrders
                                          ? Colors.orange
                                          : hasDeclinedOrders
                                          ? Colors.red
                                          : Colors.grey,
                                      size: 20,
                                    ),
                                    const SizedBox(width: 8),
                                    Expanded(
                                      child: Text(
                                        statusMessage,
                                        style: TextStyle(
                                          color:
                                              hasPendingOrders &&
                                                  hasAcceptedOrders
                                              ? Colors.blue
                                              : hasPendingOrders
                                              ? Colors.orange
                                              : hasDeclinedOrders
                                              ? Colors.red
                                              : Colors.grey,
                                          fontSize: 14,
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(height: 16),
                            ],

                            // Gold Tier discount info
                            if (hasGoldTierDiscount && subtotal > 0) ...[
                              Container(
                                padding: const EdgeInsets.all(12),
                                decoration: BoxDecoration(
                                  color: const Color(
                                    0xFF4CAF50,
                                  ).withOpacity(0.1),
                                  borderRadius: BorderRadius.circular(8),
                                  border: Border.all(
                                    color: const Color(
                                      0xFF4CAF50,
                                    ).withOpacity(0.3),
                                  ),
                                ),
                                child: Row(
                                  children: [
                                    const Icon(
                                      Icons.star,
                                      color: Color(0xFF4CAF50),
                                      size: 20,
                                    ),
                                    const SizedBox(width: 8),
                                    Expanded(
                                      child: Text(
                                        'Gold Tier 10% Discount Applied!',
                                        style: const TextStyle(
                                          color: Color(0xFF4CAF50),
                                          fontSize: 14,
                                          fontWeight: FontWeight.w600,
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(height: 12),
                            ],

                            // Payment method info
                            Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? const Color(0xFF333333)
                                    : Colors.grey[100],
                                borderRadius: BorderRadius.circular(8),
                                border: Border.all(
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? const Color(0xFF444444)
                                      : Colors.grey[300]!,
                                ),
                              ),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Row(
                                    children: [
                                      const Icon(
                                        Icons.account_balance_wallet,
                                        color: Color(0xFF2196F3),
                                        size: 20,
                                      ),
                                      const SizedBox(width: 8),
                                      Text(
                                        'Payment Method',
                                        style: TextStyle(
                                          color:
                                              Theme.of(context).brightness ==
                                                  Brightness.dark
                                              ? Colors.white
                                              : Colors.black87,
                                          fontSize: 14,
                                          fontWeight: FontWeight.w600,
                                        ),
                                      ),
                                    ],
                                  ),
                                  const SizedBox(height: 8),
                                  Text(
                                    'Wallet funds will be used first, then card payment for remaining amount.',
                                    style: TextStyle(
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white70
                                          : Colors.black54,
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(height: 12),
                          ],
                        ),
                      );
                    },
                  ),

                  // Always visible: Price breakdown and button
                  Column(
                    children: [
                      // Subtotal
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            'Subtotal:',
                            style: TextStyle(
                              fontSize: 16,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white70
                                  : Colors.black54,
                            ),
                          ),
                          Text(
                            'R${subtotal.toStringAsFixed(2)}',
                            style: TextStyle(
                              fontSize: 16,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white70
                                  : Colors.black54,
                            ),
                          ),
                        ],
                      ),

                      // Discount (if applicable)
                      if (hasGoldTierDiscount && discountAmount > 0) ...[
                        const SizedBox(height: 4),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Text(
                              'Gold Tier Discount (10%):',
                              style: TextStyle(
                                fontSize: 16,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? const Color(0xFF4CAF50)
                                    : const Color(0xFF2E7D32),
                              ),
                            ),
                            Text(
                              '-R${discountAmount.toStringAsFixed(2)}',
                              style: TextStyle(
                                fontSize: 16,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? const Color(0xFF4CAF50)
                                    : const Color(0xFF2E7D32),
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ],
                        ),
                      ],

                      const SizedBox(height: 8),

                      // Divider
                      Container(
                        height: 1,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white24
                            : Colors.black12,
                      ),

                      const SizedBox(height: 8),

                      // Total
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            'Total:',
                            style: TextStyle(
                              fontSize: ResponsiveUtils.getTitleFontSize(
                                context,
                              ),
                              fontWeight: FontWeight.bold,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white
                                  : Colors.black87,
                            ),
                          ),
                          Text(
                            'R${totalPrice.toStringAsFixed(2)}',
                            style: TextStyle(
                              fontSize: ResponsiveUtils.getTitleFontSize(
                                context,
                              ),
                              fontWeight: FontWeight.bold,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.amber
                                  : const Color(0xFF8B0000),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                  const SizedBox(height: 20),

                  // Checkout button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      onPressed: isButtonEnabled
                          ? () async {
                              await _processCheckout(acceptedItems, totalPrice);
                            }
                          : null,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: Text(
                        buttonText,
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }

  Widget _buildEmptyCart() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(40),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: const Icon(
              Icons.shopping_cart_outlined,
              size: 80,
              color: Color(0xFF8B0000),
            ),
          ),
          const SizedBox(height: 24),
          Text(
            'Your cart is empty',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleFontSize(context),
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Add some services to get started',
            style: TextStyle(
              fontSize: ResponsiveUtils.getBodyFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
          ),
          const SizedBox(height: 32),
          ElevatedButton(
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(
                  builder: (context) => const ServiceHubScreen(),
                ),
              );
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: const Text(
              'Browse Services',
              style: TextStyle(color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }
}

class CartItem {
  final String id;
  final String name;
  final String description;
  final double price;
  int quantity;
  final String image;
  final String? budget;
  final String? serviceId;
  final String? projectDescription;
  final String? orderId;
  final String? orderStatus;
  final DateTime timestamp;
  final bool? isPriority;
  final double? priorityFee;

  CartItem({
    required this.id,
    required this.name,
    required this.description,
    required this.price,
    required this.quantity,
    required this.image,
    this.budget,
    this.serviceId,
    this.projectDescription,
    this.orderId,
    this.orderStatus,
    DateTime? timestamp,
    this.isPriority,
    this.priorityFee,
  }) : timestamp = timestamp ?? DateTime.now();

  // Factory method to create CartItem from Firestore document
  factory CartItem.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    return CartItem(
      id: data['id'] ?? '',
      name: data['name'] ?? '',
      description: data['description'] ?? '',
      price: (data['price'] ?? 0.0).toDouble(),
      quantity: data['quantity'] ?? 1,
      image: data['image'] ?? '',
      budget: data['budget'],
      serviceId: data['serviceId'],
      projectDescription: data['projectDescription'],
      orderId: data['orderId'],
      orderStatus: data['orderStatus'] ?? 'pending',
      timestamp: data['timestamp'] != null
          ? (data['timestamp'] as Timestamp).toDate()
          : DateTime.now(),
      isPriority: data['isPriority'],
      priorityFee: data['priorityFee'] != null
          ? (data['priorityFee'] as num).toDouble()
          : null,
    );
  }
}

// Global Cart Service with Firestore Integration
class CartService {
  static final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // Get cart items stream for real-time updates
  static Stream<List<CartItem>> getCartItemsStream(String userId) {
    return _firestore
        .collection('carts')
        .doc(userId)
        .collection('items')
        .snapshots()
        .map(
          (snapshot) =>
              snapshot.docs.map((doc) => CartItem.fromFirestore(doc)).toList(),
        );
  }

  // Add item to cart in Firestore
  static Future<void> addItem(CartItem item, String userId) async {
    final cartDoc = _firestore.collection('carts').doc(userId);
    final itemDoc = cartDoc.collection('items').doc(item.id);

    await itemDoc.set({
      'id': item.id,
      'name': item.name,
      'description': item.description,
      'price': item.price,
      'quantity': item.quantity,
      'image': item.image,
      'budget': item.budget,
      'serviceId': item.serviceId,
      'projectDescription': item.projectDescription,
      'orderId': item.orderId,
      'orderStatus': item.orderStatus ?? 'pending',
      'timestamp': FieldValue.serverTimestamp(),
    });
  }

  // Remove item from cart in Firestore
  static Future<void> removeItem(String itemId, String userId) async {
    await _firestore
        .collection('carts')
        .doc(userId)
        .collection('items')
        .doc(itemId)
        .delete();
  }

  // Remove declined orders from cart
  static Future<void> removeDeclinedOrders(String userId) async {
    final declinedItems = await _firestore
        .collection('carts')
        .doc(userId)
        .collection('items')
        .where('orderStatus', isEqualTo: 'declined')
        .get();

    for (var doc in declinedItems.docs) {
      await doc.reference.delete();
    }
  }

  // Update item quantity in Firestore
  static Future<void> updateQuantity(
    String itemId,
    int quantity,
    String userId,
  ) async {
    await _firestore
        .collection('carts')
        .doc(userId)
        .collection('items')
        .doc(itemId)
        .update({'quantity': quantity});
  }

  // Update cart item with order ID
  static Future<void> updateCartItemOrderId(
    String itemId,
    String orderId,
    String userId,
  ) async {
    await _firestore
        .collection('carts')
        .doc(userId)
        .collection('items')
        .doc(itemId)
        .update({'orderId': orderId});
  }

  // Clear cart in Firestore
  static Future<void> clearCart(String userId) async {
    final cartDoc = _firestore.collection('carts').doc(userId);
    final itemsSnapshot = await cartDoc.collection('items').get();

    final batch = _firestore.batch();
    for (var doc in itemsSnapshot.docs) {
      batch.delete(doc.reference);
    }
    await batch.commit();
  }

  // Get total price from cart items
  static double calculateTotalPrice(List<CartItem> items) {
    return items.fold(0, (sum, item) => sum + (item.price * item.quantity));
  }

  // Get item count from cart items
  static int getItemCount(List<CartItem> items) {
    return items.length;
  }
}

class ReferralScreen extends StatefulWidget {
  const ReferralScreen({super.key});

  @override
  State<ReferralScreen> createState() => _ReferralScreenState();
}

class _ReferralScreenState extends State<ReferralScreen> {
  String? _currentUserId;
  String? _referralCode;

  // Responsive variables
  bool isMobile = false;
  bool isTablet = false;
  bool isDesktop = false;
  bool isLandscape = false;

  @override
  void initState() {
    super.initState();
    _loadCurrentUser();
  }

  void _loadCurrentUser() {
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser != null) {
      setState(() {
        _currentUserId = currentUser.uid;
      });
      _generateOrGetReferralCode();
    }
  }

  Future<void> _generateOrGetReferralCode() async {
    if (_currentUserId == null) return;

    try {
      final code = await ReferralService.generateReferralCode(_currentUserId!);
      setState(() {
        _referralCode = code;
      });
    } catch (e) {
      print('Error generating referral code: $e');
      // Fallback to a default code
      setState(() {
        _referralCode =
            'IMPACT${DateTime.now().millisecondsSinceEpoch.toString().substring(8)}';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    // Update responsive variables
    isMobile = ResponsiveUtils.isMobile(context);
    isTablet = ResponsiveUtils.isTablet(context);
    isDesktop = ResponsiveUtils.isDesktop(context);
    isLandscape = MediaQuery.of(context).orientation == Orientation.landscape;

    return Scaffold(
      appBar: AppBar(
        title: Text(
          'Referrals',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.white,
            fontSize: ResponsiveUtils.getTitleFontSize(context),
          ),
        ),
        backgroundColor: const Color(0xFF8B0000),
        elevation: 0,
        iconTheme: const IconThemeData(color: Colors.white),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: SafeArea(child: _buildResponsiveLayout()),
      ),
    );
  }

  Widget _buildResponsiveLayout() {
    if (isLandscape && (isTablet || isDesktop)) {
      return Row(
        children: [
          // Left panel - Stats and Code
          Expanded(
            flex: 2,
            child: SingleChildScrollView(
              padding: ResponsiveUtils.getScreenPadding(context),
              child: Column(
                children: [
                  _buildStatsSection(),
                  SizedBox(height: ResponsiveUtils.getSpacing(context)),
                  _buildReferralCodeSection(),
                ],
              ),
            ),
          ),
          // Right panel - List
          Expanded(flex: 3, child: _buildReferralsList()),
        ],
      );
    } else {
      return SingleChildScrollView(
        padding: ResponsiveUtils.getScreenPadding(context),
        child: Column(
          children: [
            _buildStatsSection(),
            SizedBox(height: ResponsiveUtils.getSpacing(context)),
            _buildReferralCodeSection(),
            SizedBox(height: ResponsiveUtils.getSpacing(context)),
            _buildReferralsList(),
          ],
        ),
      );
    }
  }

  Widget _buildStatsSection() {
    if (_currentUserId == null) {
      return Row(
        children: [
          Expanded(
            child: _buildStatCard(
              'Total Referrals',
              '0',
              Icons.people,
              Colors.blue,
            ),
          ),
          SizedBox(width: ResponsiveUtils.getSpacing(context)),
          Expanded(
            child: _buildStatCard(
              'Total Earnings',
              'R0',
              Icons.monetization_on,
              Colors.green,
            ),
          ),
        ],
      );
    }

    return Row(
      children: [
        Expanded(
          child: StreamBuilder<QuerySnapshot>(
            stream: ReferralService.getUserReferrals(_currentUserId!),
            builder: (context, snapshot) {
              if (snapshot.hasData) {
                final referrals = snapshot.data!.docs;
                return _buildStatCard(
                  'Total Referrals',
                  referrals.length.toString(),
                  Icons.people,
                  Colors.blue,
                );
              }
              return _buildStatCard(
                'Total Referrals',
                '0',
                Icons.people,
                Colors.blue,
              );
            },
          ),
        ),
        SizedBox(width: ResponsiveUtils.getSpacing(context)),
        Expanded(
          child: StreamBuilder<QuerySnapshot>(
            stream: ReferralService.getCompletedReferrals(_currentUserId!),
            builder: (context, snapshot) {
              if (snapshot.hasData) {
                double totalEarnings = 0.0;
                for (var doc in snapshot.data!.docs) {
                  final data = doc.data() as Map<String, dynamic>;
                  totalEarnings += (data['earnings'] ?? 0.0).toDouble();
                }
                return _buildStatCard(
                  'Total Earnings',
                  'R${totalEarnings.toStringAsFixed(0)}',
                  Icons.monetization_on,
                  Colors.green,
                );
              }
              return _buildStatCard(
                'Total Earnings',
                'R0',
                Icons.monetization_on,
                Colors.green,
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildReferralCodeSection() {
    return Container(
      width: double.infinity,
      padding: ResponsiveUtils.getCardPadding(context),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A).withOpacity(0.9)
            : Colors.white.withOpacity(0.95),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFF8B0000).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: EdgeInsets.all(isMobile ? 6 : 8),
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Text(
                  'ðŸŽ',
                  style: TextStyle(fontSize: isMobile ? 20 : 24),
                ),
              ),
              SizedBox(width: ResponsiveUtils.getSpacing(context)),
              Text(
                'Your Referral Code',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleFontSize(context),
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white
                      : Colors.black87,
                ),
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
          Container(
            padding: EdgeInsets.symmetric(
              horizontal: ResponsiveUtils.getSpacing(context),
              vertical: isMobile ? 8 : 12,
            ),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  const Color(0xFF8B0000).withOpacity(0.1),
                  const Color(0xFF8B0000).withOpacity(0.05),
                ],
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: const Color(0xFF8B0000).withOpacity(0.3),
                width: 1,
              ),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  _referralCode ?? 'Loading...',
                  style: TextStyle(
                    fontSize: isMobile ? 18 : 24,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? const Color(0xFFFFD700)
                        : const Color(0xFF8B0000),
                    letterSpacing: 2,
                  ),
                ),
                IconButton(
                  onPressed: () {
                    if (_referralCode != null) {
                      Clipboard.setData(ClipboardData(text: _referralCode!));
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text('Referral code copied to clipboard!'),
                          backgroundColor: Color(0xFF8B0000),
                        ),
                      );
                    }
                  },
                  icon: Icon(
                    Icons.copy,
                    color: const Color(0xFF8B0000),
                    size: ResponsiveUtils.getIconSize(context),
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
          Text(
            'Share this code with friends and earn up to 15% off on their first purchase!',
            style: TextStyle(
              fontSize: ResponsiveUtils.getBodyFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
            textAlign: TextAlign.center,
          ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
          Row(
            children: [
              Expanded(
                child: ElevatedButton.icon(
                  onPressed: () {
                    if (_referralCode != null) {
                      _shareReferralCode();
                    }
                  },
                  icon: Icon(
                    Icons.share,
                    size: ResponsiveUtils.getIconSize(context),
                  ),
                  label: Text(
                    'Share Code',
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getBodyFontSize(context),
                    ),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    minimumSize: Size(
                      0,
                      ResponsiveUtils.getButtonHeight(context),
                    ),
                  ),
                ),
              ),
              SizedBox(width: ResponsiveUtils.getSpacing(context)),
              Expanded(
                child: ElevatedButton.icon(
                  onPressed: _showTermsDialog,
                  icon: Icon(
                    Icons.info_outline,
                    size: ResponsiveUtils.getIconSize(context),
                  ),
                  label: Text(
                    'Terms',
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getBodyFontSize(context),
                    ),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.transparent,
                    foregroundColor: const Color(0xFF8B0000),
                    side: const BorderSide(color: Color(0xFF8B0000)),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    minimumSize: Size(
                      0,
                      ResponsiveUtils.getButtonHeight(context),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildReferralsList() {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Padding(
            padding: ResponsiveUtils.getCardPadding(context),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  'Recent Referrals',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
                TextButton(
                  onPressed: () {
                    // View all referrals
                  },
                  child: Text(
                    'View All',
                    style: TextStyle(
                      color: const Color(0xFF8B0000),
                      fontWeight: FontWeight.bold,
                      fontSize: ResponsiveUtils.getBodyFontSize(context),
                    ),
                  ),
                ),
              ],
            ),
          ),
          if (_currentUserId != null)
            StreamBuilder<QuerySnapshot>(
              stream: ReferralService.getUserReferrals(_currentUserId!),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(
                    child: Padding(
                      padding: EdgeInsets.all(20),
                      child: CircularProgressIndicator(
                        color: Color(0xFF8B0000),
                      ),
                    ),
                  );
                }

                if (snapshot.hasError) {
                  return Center(
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Text(
                        'Error loading referrals: ${snapshot.error}',
                        style: const TextStyle(color: Colors.red),
                      ),
                    ),
                  );
                }

                if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                  return Center(
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Column(
                        children: [
                          Icon(
                            Icons.people_outline,
                            size: 64,
                            color: Colors.grey[400],
                          ),
                          const SizedBox(height: 16),
                          Text(
                            'No referrals yet',
                            style: TextStyle(
                              fontSize: 18,
                              color: Colors.grey[600],
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Text(
                            'Share your referral code to start earning!',
                            style: TextStyle(
                              fontSize: 14,
                              color: Colors.grey[500],
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ],
                      ),
                    ),
                  );
                }

                final referrals = snapshot.data!.docs.map((doc) {
                  final data = doc.data() as Map<String, dynamic>;
                  return Referral(
                    id: doc.id,
                    name: data['referredUserName'] ?? 'Unknown',
                    email: data['referredUserEmail'] ?? '',
                    status: _stringToReferralStatus(
                      data['status'] ?? 'pending',
                    ),
                    date:
                        (data['createdAt'] as Timestamp?)?.toDate() ??
                        DateTime.now(),
                    earnings: (data['earnings'] ?? 0.0).toDouble(),
                  );
                }).toList();

                // Sort referrals by creation date (newest first)
                referrals.sort((a, b) => b.date.compareTo(a.date));

                // Limit to 10 most recent referrals
                final limitedReferrals = referrals.take(10).toList();

                return Column(
                  children: limitedReferrals
                      .map((referral) => _buildReferralItem(referral))
                      .toList(),
                );
              },
            )
          else
            const Center(
              child: Padding(
                padding: EdgeInsets.all(20),
                child: Text(
                  'Please log in to view referrals',
                  style: TextStyle(color: Colors.grey),
                ),
              ),
            ),
          SizedBox(height: ResponsiveUtils.getSpacing(context)),
        ],
      ),
    );
  }

  Widget _buildStatCard(
    String title,
    String value,
    IconData icon,
    Color color,
  ) {
    return Container(
      padding: ResponsiveUtils.getCardPadding(context),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A).withOpacity(0.8)
            : Colors.white.withOpacity(0.9),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withOpacity(0.3), width: 1),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          Icon(icon, color: color, size: ResponsiveUtils.getIconSize(context)),
          SizedBox(height: ResponsiveUtils.getSpacing(context) / 2),
          Text(
            value,
            style: TextStyle(
              fontSize: isMobile ? 20 : 24,
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
            textAlign: TextAlign.center,
          ),
          SizedBox(height: 4),
          Text(
            title,
            style: TextStyle(
              fontSize: ResponsiveUtils.getSmallFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildReferralItem(Referral referral) {
    return Container(
      margin: EdgeInsets.symmetric(
        horizontal: ResponsiveUtils.getSpacing(context),
        vertical: ResponsiveUtils.getSpacing(context) / 2,
      ),
      padding: ResponsiveUtils.getCardPadding(context),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: _getStatusColor(referral.status).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            padding: EdgeInsets.all(isMobile ? 6 : 8),
            decoration: BoxDecoration(
              color: _getStatusColor(referral.status).withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              _getStatusIcon(referral.status),
              color: _getStatusColor(referral.status),
              size: ResponsiveUtils.getIconSize(context),
            ),
          ),
          SizedBox(width: ResponsiveUtils.getSpacing(context)),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  referral.name,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: 4),
                Text(
                  referral.email,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getSmallFontSize(context),
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: 4),
                Text(
                  _formatDate(referral.date),
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getSmallFontSize(context) - 2,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white60
                        : Colors.black45,
                  ),
                ),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Container(
                padding: EdgeInsets.symmetric(
                  horizontal: isMobile ? 6 : 8,
                  vertical: 4,
                ),
                decoration: BoxDecoration(
                  color: _getStatusColor(referral.status).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: _getStatusColor(referral.status).withOpacity(0.3),
                    width: 1,
                  ),
                ),
                child: Text(
                  _getStatusText(referral.status),
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getSmallFontSize(context) - 2,
                    fontWeight: FontWeight.w600,
                    color: _getStatusColor(referral.status),
                  ),
                ),
              ),
              SizedBox(height: 4),
              if (referral.earnings > 0)
                Text(
                  'R${referral.earnings.toStringAsFixed(2)}',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: Colors.green,
                  ),
                ),
            ],
          ),
        ],
      ),
    );
  }

  Color _getStatusColor(ReferralStatus status) {
    switch (status) {
      case ReferralStatus.pending:
        return Colors.orange;
      case ReferralStatus.completed:
        return Colors.green;
      case ReferralStatus.cancelled:
        return Colors.red;
    }
  }

  IconData _getStatusIcon(ReferralStatus status) {
    switch (status) {
      case ReferralStatus.pending:
        return Icons.pending;
      case ReferralStatus.completed:
        return Icons.check_circle;
      case ReferralStatus.cancelled:
        return Icons.cancel;
    }
  }

  String _getStatusText(ReferralStatus status) {
    switch (status) {
      case ReferralStatus.pending:
        return 'Pending';
      case ReferralStatus.completed:
        return 'Completed';
      case ReferralStatus.cancelled:
        return 'Cancelled';
    }
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final difference = now.difference(date);

    if (difference.inDays == 0) {
      return 'Today';
    } else if (difference.inDays == 1) {
      return 'Yesterday';
    } else if (difference.inDays < 7) {
      return '${difference.inDays} days ago';
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }

  ReferralStatus _stringToReferralStatus(String status) {
    switch (status.toLowerCase()) {
      case 'completed':
        return ReferralStatus.completed;
      case 'cancelled':
        return ReferralStatus.cancelled;
      case 'pending':
      default:
        return ReferralStatus.pending;
    }
  }

  void _shareReferralCode() {
    if (_referralCode == null) return;

    final shareText =
        '''
ðŸŽ‰ Join Impact Graphics ZA and get 15% off your first purchase!

Use my referral code: $_referralCode

Download the app and start your creative journey with us!

#ImpactGraphicsZA #Referral #CreativeDesign
''';

    Share.share(shareText);
  }

  void _showTermsDialog() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF1E1E1E),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(15),
          ),
          title: const Text(
            'Referral Program Terms & Conditions',
            style: TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
              fontSize: 20,
            ),
          ),
          content: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: const [
                Text(
                  '1. Eligibility:',
                  style: TextStyle(
                    color: Colors.white70,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 5),
                Text(
                  'The Impact Graphics ZA Referral Program is open to all registered users. You must be 18 years or older to participate.',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
                SizedBox(height: 15),
                Text(
                  '2. Referral Rewards:',
                  style: TextStyle(
                    color: Colors.white70,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 5),
                Text(
                  'You earn R10 for each new user who registers using your referral code. The reward is credited to your wallet immediately upon successful registration.',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
                SizedBox(height: 15),
                Text(
                  '3. Referral Code Usage:',
                  style: TextStyle(
                    color: Colors.white70,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 5),
                Text(
                  'Your unique referral code can be shared with friends, family, and colleagues. The referred person must be a new customer to Impact Graphics ZA and must use your referral code during registration.',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
                SizedBox(height: 15),
                Text(
                  '4. Earning Payouts:',
                  style: TextStyle(
                    color: Colors.white70,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 5),
                Text(
                  'Referral earnings are credited to your wallet immediately and can be used for purchases or withdrawn. Payouts are processed monthly via EFT or other specified methods.',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
                SizedBox(height: 15),
                Text(
                  '5. Prohibited Actions:',
                  style: TextStyle(
                    color: Colors.white70,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 5),
                Text(
                  'Self-referrals, fraudulent activities, or spamming are strictly prohibited and will result in disqualification from the program and forfeiture of all earnings.',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
                SizedBox(height: 15),
                Text(
                  '6. Program Changes:',
                  style: TextStyle(
                    color: Colors.white70,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                SizedBox(height: 5),
                Text(
                  'Impact Graphics ZA reserves the right to modify or terminate the referral program at any time without prior notice.',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
              ],
            ),
          ),
          actions: <Widget>[
            TextButton(
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: const Text(
                'Close',
                style: TextStyle(color: Color(0xFF8B0000), fontSize: 16),
              ),
            ),
          ],
        );
      },
    );
  }
}

class Referral {
  final String id;
  final String name;
  final String email;
  final ReferralStatus status;
  final DateTime date;
  final double earnings;

  Referral({
    required this.id,
    required this.name,
    required this.email,
    required this.status,
    required this.date,
    required this.earnings,
  });
}

enum ReferralStatus { pending, completed, cancelled }

class OrdersScreen extends StatefulWidget {
  const OrdersScreen({super.key});

  @override
  State<OrdersScreen> createState() => _OrdersScreenState();
}

class _OrdersScreenState extends State<OrdersScreen> {
  String? _currentUserId;

  @override
  void initState() {
    super.initState();
    _loadCurrentUser();
  }

  void _loadCurrentUser() {
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser != null) {
      setState(() {
        _currentUserId = currentUser.uid;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text(
          'My Orders',
          style: TextStyle(fontWeight: FontWeight.bold, color: Colors.white),
        ),
        backgroundColor: const Color(0xFF8B0000),
        elevation: 0,
        iconTheme: const IconThemeData(color: Colors.white),
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: _currentUserId == null
            ? _buildEmptyState()
            : StreamBuilder(
                stream: FirebaseService.getOrdersStream(_currentUserId!),
                builder: (context, snapshot) {
                  if (snapshot.hasError) {
                    return _buildErrorState(snapshot.error.toString());
                  }

                  if (snapshot.connectionState == ConnectionState.waiting) {
                    return _buildLoadingState();
                  }

                  final orders =
                      snapshot.data?.docs.map((doc) {
                        final data = doc.data() as Map<String, dynamic>;
                        return Order.fromFirestore(doc.id, data);
                      }).toList() ??
                      [];

                  // Sort orders by date (newest first)
                  orders.sort((a, b) => b.date.compareTo(a.date));

                  if (orders.isEmpty) {
                    return _buildEmptyState();
                  }

                  return Column(
                    children: [
                      // Stats Cards
                      Container(
                        padding: const EdgeInsets.all(16),
                        child: Row(
                          children: [
                            Expanded(
                              child: _buildStatCard(
                                'Total Orders',
                                orders.length.toString(),
                                Icons.shopping_bag,
                                Colors.blue,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: _buildStatCard(
                                'Pending',
                                orders
                                    .where(
                                      (order) =>
                                          order.status == OrderStatus.pending,
                                    )
                                    .length
                                    .toString(),
                                Icons.pending,
                                Colors.orange,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: _buildStatCard(
                                'Completed',
                                orders
                                    .where(
                                      (order) =>
                                          order.status == OrderStatus.completed,
                                    )
                                    .length
                                    .toString(),
                                Icons.check_circle,
                                Colors.green,
                              ),
                            ),
                          ],
                        ),
                      ),
                      // Orders List
                      Expanded(
                        child: Container(
                          decoration: BoxDecoration(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? const Color(0xFF2A2A2A)
                                : Colors.white,
                            borderRadius: const BorderRadius.vertical(
                              top: Radius.circular(20),
                            ),
                          ),
                          child: ListView.builder(
                            padding: const EdgeInsets.all(16),
                            itemCount: orders.length,
                            itemBuilder: (context, index) {
                              final order = orders[index];
                              return _buildOrderCard(order);
                            },
                          ),
                        ),
                      ),
                    ],
                  );
                },
              ),
      ),
    );
  }

  Widget _buildStatCard(
    String title,
    String value,
    IconData icon,
    Color color,
  ) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A).withOpacity(0.8)
            : Colors.white.withOpacity(0.9),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withOpacity(0.3), width: 1),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(
            value,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          const SizedBox(height: 2),
          Text(
            title,
            style: TextStyle(
              fontSize: 11,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildOrderCard(Order order) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: _getStatusColor(order.status).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: InkWell(
        onTap: () => _showOrderDetails(order),
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          order.title,
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: const Color(0xFF8B0000).withOpacity(0.1),
                            borderRadius: BorderRadius.circular(6),
                            border: Border.all(
                              color: const Color(0xFF8B0000).withOpacity(0.3),
                              width: 1,
                            ),
                          ),
                          child: Text(
                            order.orderNumber,
                            style: const TextStyle(
                              fontSize: 10,
                              fontWeight: FontWeight.w600,
                              color: Colors.white,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 8,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      color: _getStatusColor(order.status).withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: _getStatusColor(order.status).withOpacity(0.3),
                        width: 1,
                      ),
                    ),
                    child: Text(
                      _getStatusText(order.status),
                      style: TextStyle(
                        fontSize: 12,
                        fontWeight: FontWeight.w600,
                        color: _getStatusColor(order.status),
                      ),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),
              Text(
                order.description,
                style: TextStyle(
                  fontSize: 14,
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white70
                      : Colors.black54,
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
              const SizedBox(height: 12),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  Text(
                    order.id,
                    style: TextStyle(
                      fontSize: 12,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white60
                          : Colors.black45,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),
              Row(
                children: [
                  Icon(
                    Icons.calendar_today,
                    size: 14,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white60
                        : Colors.black45,
                  ),
                  const SizedBox(width: 4),
                  Text(
                    _formatDate(order.date),
                    style: TextStyle(
                      fontSize: 12,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white60
                          : Colors.black45,
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Color _getStatusColor(OrderStatus status) {
    switch (status) {
      case OrderStatus.pending:
        return Colors.orange;
      case OrderStatus.inProgress:
        return Colors.blue;
      case OrderStatus.completed:
        return Colors.green;
      case OrderStatus.cancelled:
        return Colors.red;
      case OrderStatus.declined:
        return Colors.red;
    }
  }

  Color _getServiceCategoryColor(String orderTitle) {
    // Check for Graphic Design services (Yellow)
    if (orderTitle.toLowerCase().contains('logo') ||
        orderTitle.toLowerCase().contains('business card') ||
        orderTitle.toLowerCase().contains('brochure') ||
        orderTitle.toLowerCase().contains('poster') ||
        orderTitle.toLowerCase().contains('graphic')) {
      return const Color(0xFFFFD700); // Yellow
    }
    // Check for Digital Marketing services (Blue)
    else if (orderTitle.toLowerCase().contains('social media') ||
        orderTitle.toLowerCase().contains('google ads') ||
        orderTitle.toLowerCase().contains('marketing')) {
      return const Color(0xFF2196F3); // Blue
    }
    // Check for Web Development services (Green)
    else if (orderTitle.toLowerCase().contains('website') ||
        orderTitle.toLowerCase().contains('web') ||
        orderTitle.toLowerCase().contains('e-commerce')) {
      return const Color(0xFF4CAF50); // Green
    }
    // Check for print-related orders (Orange)
    else if (orderTitle.toLowerCase().contains('print') ||
        orderTitle.toLowerCase().contains('flyer') ||
        orderTitle.toLowerCase().contains('banner')) {
      return const Color(0xFFFF9800); // Orange
    }
    // Default color for unknown services
    return const Color(0xFF8B0000); // Red
  }

  String _getStatusText(OrderStatus status) {
    switch (status) {
      case OrderStatus.pending:
        return 'Pending';
      case OrderStatus.inProgress:
        return 'In Progress';
      case OrderStatus.completed:
        return 'Completed';
      case OrderStatus.cancelled:
        return 'Cancelled';
      case OrderStatus.declined:
        return 'Declined';
    }
  }

  String _formatDate(DateTime date) {
    return '${date.day}/${date.month}/${date.year}';
  }

  void _showOrderDetails(Order order) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (BuildContext context) {
        return Container(
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                Theme.of(context).brightness == Brightness.dark
                    ? const Color(0xFF2A2A2A).withOpacity(0.95)
                    : Colors.white.withOpacity(0.95),
                Theme.of(context).brightness == Brightness.dark
                    ? const Color(0xFF1A1A1A).withOpacity(0.95)
                    : Colors.grey.shade50.withOpacity(0.95),
              ],
            ),
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
            border: Border.all(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white.withOpacity(0.1)
                  : Colors.black.withOpacity(0.1),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 20,
                spreadRadius: 5,
                offset: const Offset(0, 10),
              ),
              BoxShadow(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white.withOpacity(0.05)
                    : Colors.white.withOpacity(0.8),
                blurRadius: 10,
                spreadRadius: 2,
                offset: const Offset(0, -5),
              ),
            ],
          ),
          child: Column(
            children: [
              // Handle
              Container(
                margin: const EdgeInsets.only(top: 12),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),

              // Header with morphic effect
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      const Color(0xFF8B0000).withOpacity(0.8),
                      const Color(0xFF8B0000).withOpacity(0.6),
                    ],
                  ),
                  boxShadow: [
                    BoxShadow(
                      color: const Color(0xFF8B0000).withOpacity(0.3),
                      blurRadius: 10,
                      spreadRadius: 2,
                      offset: const Offset(0, 5),
                    ),
                  ],
                ),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: const Icon(
                        Icons.receipt_long,
                        color: Colors.white,
                        size: 24,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Order Details',
                            style: const TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 8,
                              vertical: 4,
                            ),
                            decoration: BoxDecoration(
                              color: Colors.white.withOpacity(0.2),
                              borderRadius: BorderRadius.circular(6),
                            ),
                            child: Text(
                              order.orderNumber,
                              style: const TextStyle(
                                fontSize: 12,
                                fontWeight: FontWeight.w600,
                                color: Colors.white,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.of(context).pop(),
                      icon: const Icon(
                        Icons.close,
                        color: Colors.white,
                        size: 20,
                      ),
                    ),
                  ],
                ),
              ),

              // Content with morphic styling
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Order Status Section
                      _buildMorphicSectionHeader('Order Status'),
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              _getStatusColor(order.status).withOpacity(0.1),
                              _getStatusColor(order.status).withOpacity(0.05),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: _getStatusColor(
                              order.status,
                            ).withOpacity(0.3),
                            width: 1,
                          ),
                          boxShadow: [
                            BoxShadow(
                              color: _getStatusColor(
                                order.status,
                              ).withOpacity(0.1),
                              blurRadius: 8,
                              spreadRadius: 1,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(8),
                              decoration: BoxDecoration(
                                color: _getStatusColor(
                                  order.status,
                                ).withOpacity(0.2),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Icon(
                                _getStatusIcon(order.status),
                                color: _getStatusColor(order.status),
                                size: 20,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Text(
                              _getStatusText(order.status),
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: _getStatusColor(order.status),
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 20),

                      // Order Information Section
                      _buildMorphicSectionHeader('Order Information'),
                      _buildMorphicInfoRow('Order Number', order.orderNumber),
                      _buildMorphicInfoRow('Order ID', order.id),
                      _buildMorphicInfoRow(
                        'Order Date',
                        _formatDate(order.date),
                      ),
                      _buildMorphicInfoRow('Service', order.title),
                      _buildMorphicInfoRow('Description', order.description),
                      const SizedBox(height: 12),
                      Text(
                        'Items:',
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          fontSize: 16,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black87,
                        ),
                      ),
                      const SizedBox(height: 8),
                      ...order.items.map(
                        (item) => Container(
                          margin: const EdgeInsets.only(bottom: 6),
                          padding: const EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white.withOpacity(0.05)
                                : Colors.grey.withOpacity(0.05),
                            borderRadius: BorderRadius.circular(6),
                            border: Border.all(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white.withOpacity(0.1)
                                  : Colors.grey.withOpacity(0.2),
                              width: 1,
                            ),
                          ),
                          child: Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.all(4),
                                decoration: BoxDecoration(
                                  color: const Color(
                                    0xFF4CAF50,
                                  ).withOpacity(0.2),
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: const Icon(
                                  Icons.check,
                                  color: Color(0xFF4CAF50),
                                  size: 14,
                                ),
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: Text(
                                  item,
                                  style: TextStyle(
                                    fontSize: 14,
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                      const SizedBox(height: 20),

                      // Payment Details Section
                      _buildMorphicSectionHeader('Payment Details'),
                      _buildMorphicInfoRow('Payment Method', 'Credit Card'),
                      StreamBuilder<DocumentSnapshot>(
                        stream: FirebaseService.ordersCollection
                            .doc(order.id)
                            .snapshots(),
                        builder: (context, snapshot) {
                          String paymentStatus = 'Pending Payment';
                          if (snapshot.hasData && snapshot.data!.exists) {
                            final orderData =
                                snapshot.data!.data() as Map<String, dynamic>;

                            // Check paymentStatus field first (this is the correct field)
                            final paymentStatusField =
                                orderData['paymentStatus'];
                            if (paymentStatusField != null) {
                              switch (paymentStatusField) {
                                case 'completed':
                                  paymentStatus = 'Paid';
                                  break;
                                case 'pending':
                                  paymentStatus = 'Pending Payment';
                                  break;
                                case 'failed':
                                  paymentStatus = 'Payment Failed';
                                  break;
                                case 'refunded':
                                  paymentStatus = 'Refunded';
                                  break;
                                default:
                                  paymentStatus = 'Pending Payment';
                              }
                            } else {
                              // Fallback to order status if paymentStatus field doesn't exist
                              final status = orderData['status'] ?? 'pending';
                              switch (status) {
                                case 'completed':
                                  paymentStatus = 'Paid';
                                  break;
                                case 'accepted':
                                case 'in_progress':
                                  paymentStatus = 'Pending Payment';
                                  break;
                                case 'pending':
                                  paymentStatus = 'Pending Payment';
                                  break;
                                case 'declined':
                                  paymentStatus = 'Declined';
                                  break;
                                default:
                                  paymentStatus = 'Pending Payment';
                              }
                            }
                          }
                          return _buildMorphicInfoRow(
                            'Payment Status',
                            paymentStatus,
                          );
                        },
                      ),
                      StreamBuilder<DocumentSnapshot>(
                        stream: FirebaseService.ordersCollection
                            .doc(order.id)
                            .snapshots(),
                        builder: (context, snapshot) {
                          String transactionId = 'TXN-${order.id}';
                          if (snapshot.hasData && snapshot.data!.exists) {
                            final orderData =
                                snapshot.data!.data() as Map<String, dynamic>;
                            final actualTransactionId =
                                orderData['transactionId'];
                            if (actualTransactionId != null &&
                                actualTransactionId.isNotEmpty) {
                              transactionId = actualTransactionId;
                            }
                          }
                          return _buildMorphicInfoRow(
                            'Transaction ID',
                            transactionId,
                          );
                        },
                      ),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              _getServiceCategoryColor(
                                order.title,
                              ).withOpacity(0.1),
                              _getServiceCategoryColor(
                                order.title,
                              ).withOpacity(0.05),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: _getServiceCategoryColor(
                              order.title,
                            ).withOpacity(0.3),
                            width: 1,
                          ),
                          boxShadow: [
                            BoxShadow(
                              color: _getServiceCategoryColor(
                                order.title,
                              ).withOpacity(0.1),
                              blurRadius: 8,
                              spreadRadius: 1,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(8),
                                  decoration: BoxDecoration(
                                    color: _getServiceCategoryColor(
                                      order.title,
                                    ).withOpacity(0.2),
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: Icon(
                                    Icons.account_balance_wallet,
                                    color: _getServiceCategoryColor(
                                      order.title,
                                    ),
                                    size: 20,
                                  ),
                                ),
                                const SizedBox(width: 12),
                                Text(
                                  'Total Amount:',
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 16,
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white
                                        : Colors.black87,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8),
                            Align(
                              alignment: Alignment.centerRight,
                              child: StreamBuilder<DocumentSnapshot>(
                                stream: FirebaseService.ordersCollection
                                    .doc(order.id)
                                    .snapshots(),
                                builder: (context, snapshot) {
                                  if (snapshot.hasData &&
                                      snapshot.data!.exists) {
                                    final orderData =
                                        snapshot.data!.data()
                                            as Map<String, dynamic>;
                                    final currentAmount =
                                        orderData['finalPrice'] ??
                                        orderData['price'] ??
                                        order.amount;
                                    return Text(
                                      'R${currentAmount.toStringAsFixed(2)}',
                                      style: TextStyle(
                                        fontSize: 20,
                                        fontWeight: FontWeight.bold,
                                        color: _getServiceCategoryColor(
                                          order.title,
                                        ),
                                      ),
                                    );
                                  } else {
                                    return Text(
                                      'R${order.amount.toStringAsFixed(2)}',
                                      style: TextStyle(
                                        fontSize: 20,
                                        fontWeight: FontWeight.bold,
                                        color: _getServiceCategoryColor(
                                          order.title,
                                        ),
                                      ),
                                    );
                                  }
                                },
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 20),

                      // Order Timeline Section
                      _buildMorphicSectionHeader('Order Timeline'),
                      _buildOrderTimelineSection(order),
                      const SizedBox(height: 20),
                    ],
                  ),
                ),
              ),

              // Actions with morphic styling
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      Colors.transparent,
                      const Color(0xFF8B0000).withOpacity(0.1),
                    ],
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                  ),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: TextButton(
                        onPressed: () => Navigator.of(context).pop(),
                        style: TextButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                            side: BorderSide(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white.withOpacity(0.2)
                                  : Colors.black.withOpacity(0.2),
                            ),
                          ),
                        ),
                        child: Text(
                          'Close',
                          style: TextStyle(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton.icon(
                        onPressed: () async {
                          Navigator.of(context).pop();
                          // Launch WhatsApp with order details
                          await _launchWhatsApp(order);
                        },

                        label: const Text(
                          'WhatsApp',
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(
                            0xFF25D366,
                          ), // WhatsApp green
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                          elevation: 2,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Text(
        title,
        style: TextStyle(
          fontSize: 16,
          fontWeight: FontWeight.bold,
          color: Theme.of(context).brightness == Brightness.dark
              ? Colors.white
              : Colors.black87,
        ),
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 100,
            child: Text(
              '$label:',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white70
                    : Colors.black54,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(
                fontSize: 14,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white
                    : Colors.black87,
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Launch WhatsApp with order details
  Future<void> _launchWhatsApp(Order order) async {
    try {
      // Create the WhatsApp message with order details
      final message =
          'Hi! I need to send pictures for my order: ${order.orderNumber}\n\n'
          'Order ID: ${order.id}\n'
          'Service: ${order.title}\n'
          'Status: ${order.status}\n\n'
          'Please let me know how to send the pictures for this order.';

      // WhatsApp phone number (replace with your business number)
      const phoneNumber =
          '27683675755'; // Impact Graphics ZA WhatsApp business number

      // Create the WhatsApp URL
      final whatsappUrl =
          'https://wa.me/$phoneNumber?text=${Uri.encodeComponent(message)}';

      // Launch the URL
      final Uri url = Uri.parse(whatsappUrl);

      if (await canLaunchUrl(url)) {
        await launchUrl(url, mode: LaunchMode.externalApplication);

        // Show success message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Opening WhatsApp for order ${order.orderNumber}'),
            backgroundColor: const Color(0xFF25D366), // WhatsApp green
            duration: const Duration(seconds: 2),
          ),
        );
      } else {
        // Show error message if WhatsApp can't be launched
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Could not open WhatsApp. Please install WhatsApp and try again.',
            ),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 3),
          ),
        );
      }
    } catch (e) {
      // Show error message if something goes wrong
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error opening WhatsApp: $e'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  Widget _buildTimelineItem(
    String title,
    String date,
    IconData icon,
    Color color,
    bool isCompleted,
  ) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        children: [
          Container(
            width: 32,
            height: 32,
            decoration: BoxDecoration(
              color: isCompleted ? color : Colors.grey.withOpacity(0.3),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(
              icon,
              color: isCompleted ? Colors.white : Colors.grey,
              size: 16,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: isCompleted
                        ? (Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black87)
                        : Colors.grey,
                  ),
                ),
                Text(
                  date,
                  style: TextStyle(
                    fontSize: 12,
                    color: isCompleted
                        ? (Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54)
                        : Colors.grey,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  IconData _getStatusIcon(OrderStatus status) {
    switch (status) {
      case OrderStatus.pending:
        return Icons.pending;
      case OrderStatus.inProgress:
        return Icons.work;
      case OrderStatus.completed:
        return Icons.check_circle;
      case OrderStatus.cancelled:
        return Icons.cancel;
      case OrderStatus.declined:
        return Icons.cancel;
    }
  }

  Widget _buildMorphicSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        children: [
          Container(
            width: 4,
            height: 20,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  const Color(0xFF8B0000),
                  const Color(0xFF8B0000).withOpacity(0.6),
                ],
              ),
              borderRadius: BorderRadius.circular(2),
            ),
          ),
          const SizedBox(width: 8),
          Text(
            title,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMorphicInfoRow(String label, String value) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? Colors.white.withOpacity(0.05)
            : Colors.grey.withOpacity(0.05),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: Theme.of(context).brightness == Brightness.dark
              ? Colors.white.withOpacity(0.1)
              : Colors.grey.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 100,
            child: Text(
              '$label:',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white70
                    : Colors.black54,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(
                fontSize: 14,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white
                    : Colors.black87,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMorphicTimelineItem(
    String title,
    String date,
    IconData icon,
    Color color,
    bool isCompleted,
  ) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            isCompleted
                ? color.withOpacity(0.1)
                : (Theme.of(context).brightness == Brightness.dark
                      ? Colors.white.withOpacity(0.05)
                      : Colors.grey.withOpacity(0.05)),
            isCompleted
                ? color.withOpacity(0.05)
                : (Theme.of(context).brightness == Brightness.dark
                      ? Colors.white.withOpacity(0.02)
                      : Colors.grey.withOpacity(0.02)),
          ],
        ),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: isCompleted
              ? color.withOpacity(0.3)
              : (Theme.of(context).brightness == Brightness.dark
                    ? Colors.white.withOpacity(0.1)
                    : Colors.grey.withOpacity(0.2)),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: isCompleted ? color.withOpacity(0.1) : Colors.transparent,
            blurRadius: 8,
            spreadRadius: 1,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  isCompleted ? color : Colors.grey.withOpacity(0.3),
                  isCompleted
                      ? color.withOpacity(0.8)
                      : Colors.grey.withOpacity(0.2),
                ],
              ),
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: isCompleted
                      ? color.withOpacity(0.3)
                      : Colors.transparent,
                  blurRadius: 8,
                  spreadRadius: 2,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: Icon(
              icon,
              color: isCompleted ? Colors.white : Colors.grey,
              size: 18,
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: isCompleted
                        ? (Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black87)
                        : Colors.grey,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  date,
                  style: TextStyle(
                    fontSize: 14,
                    color: isCompleted
                        ? (Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54)
                        : Colors.grey,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(40),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: const Icon(
              Icons.shopping_bag_outlined,
              size: 80,
              color: Color(0xFF8B0000),
            ),
          ),
          const SizedBox(height: 24),
          Text(
            'No orders yet',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleFontSize(context),
              fontWeight: FontWeight.bold,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Your orders will appear here once you place them',
            style: TextStyle(
              fontSize: ResponsiveUtils.getBodyFontSize(context),
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 32),
          ElevatedButton(
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(
                  builder: (context) => const ServiceHubScreen(),
                ),
              );
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: const Text(
              'Browse Services',
              style: TextStyle(color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLoadingState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          CircularProgressIndicator(
            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF8B0000)),
          ),
          SizedBox(height: 16),
          Text(
            'Loading orders...',
            style: TextStyle(color: Colors.white, fontSize: 16),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState(String error) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(40),
            decoration: BoxDecoration(
              color: Colors.red.withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: const Icon(Icons.error_outline, size: 80, color: Colors.red),
          ),
          const SizedBox(height: 24),
          const Text(
            'Error loading orders',
            style: TextStyle(
              color: Colors.white,
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            error,
            style: const TextStyle(color: Colors.white70, fontSize: 14),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: () {
              setState(() {});
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: const Text('Retry', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  Widget _buildOrderTimelineSection(Order order) {
    return StreamBuilder<DocumentSnapshot>(
      stream: FirebaseFirestore.instance
          .collection('users')
          .doc(_currentUserId)
          .snapshots(),
      builder: (context, userSnapshot) {
        if (!userSnapshot.hasData) {
          return _buildTimelineItems(order);
        }

        final userData = userSnapshot.data!.data() as Map<String, dynamic>?;
        final isGoldTierActive = userData?['goldTierActive'] ?? false;
        final goldTierStatus = userData?['goldTierStatus'] ?? 'inactive';
        final isGoldTier = isGoldTierActive && goldTierStatus == 'active';

        if (isGoldTier) {
          // Gold tier users can see the full timeline
          return _buildTimelineItems(order);
        } else {
          // Silver tier users see blurred timeline with upgrade prompt
          return _buildBlurredTimelineWithUpgrade(order);
        }
      },
    );
  }

  Widget _buildTimelineItems(Order order) {
    return Column(
      children: [
        _buildMorphicTimelineItem(
          'Order Placed',
          _formatDate(order.date),
          Icons.shopping_cart,
          Colors.green,
          true,
        ),
        _buildMorphicTimelineItem(
          'Payment Confirmed',
          _formatDate(order.date.add(const Duration(minutes: 5))),
          Icons.payment,
          Colors.blue,
          true,
        ),
        _buildMorphicTimelineItem(
          'In Progress',
          order.status == OrderStatus.inProgress ||
                  order.status == OrderStatus.completed
              ? _formatDate(order.date.add(const Duration(days: 1)))
              : 'Pending',
          Icons.work,
          Colors.orange,
          order.status == OrderStatus.inProgress ||
              order.status == OrderStatus.completed,
        ),
        _buildMorphicTimelineItem(
          'Completed',
          order.status == OrderStatus.completed
              ? _formatDate(order.date.add(const Duration(days: 3)))
              : 'Pending',
          Icons.check_circle,
          Colors.green,
          order.status == OrderStatus.completed,
        ),
      ],
    );
  }

  Widget _buildBlurredTimelineWithUpgrade(Order order) {
    return Container(
      height: 200, // Fixed height to match timeline
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: const Color(0xFFFFD700).withOpacity(0.3),
          width: 2,
        ),
      ),
      child: Center(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: const Color(0xFFFFD700).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: const Color(0xFFFFD700).withOpacity(0.3),
                  ),
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    const Icon(Icons.lock, color: Color(0xFFFFD700), size: 40),
                    const SizedBox(height: 8),
                    const Text(
                      'Order Timeline Locked',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 6),
                    const Text(
                      'Upgrade to Gold Tier to unlock\ndetailed order tracking',
                      textAlign: TextAlign.center,
                      style: TextStyle(color: Colors.white70, fontSize: 12),
                    ),
                    const SizedBox(height: 12),
                    ElevatedButton.icon(
                      onPressed: () async {
                        Navigator.of(context).pop(); // Close order details

                        // Get current user data
                        final currentUser = FirebaseAuth.instance.currentUser;
                        if (currentUser != null) {
                          final userDoc = await FirebaseFirestore.instance
                              .collection('users')
                              .doc(currentUser.uid)
                              .get();

                          if (userDoc.exists) {
                            final userData =
                                userDoc.data() as Map<String, dynamic>;
                            Navigator.of(context).push(
                              MaterialPageRoute(
                                builder: (context) =>
                                    GoldTierSubscriptionScreen(
                                      userId: currentUser.uid,
                                      userEmail: currentUser.email ?? '',
                                      userName: userData['name'] ?? 'User',
                                    ),
                              ),
                            );
                          }
                        }
                      },
                      icon: const Icon(
                        Icons.star,
                        color: Colors.white,
                        size: 16,
                      ),
                      label: const Text(
                        'Upgrade to Gold Tier',
                        style: TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                          fontSize: 12,
                        ),
                      ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFFFFD700),
                        foregroundColor: Colors.black,
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 8,
                        ),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class WhatsAppIcon extends StatelessWidget {
  final double size;
  final Color? color;

  const WhatsAppIcon({super.key, required this.size, this.color});

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      width: size,
      height: size,
      child: CustomPaint(
        painter: WhatsAppIconPainter(color: color ?? Colors.white),
      ),
    );
  }
}

class WhatsAppIconPainter extends CustomPainter {
  final Color color;

  WhatsAppIconPainter({required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    // WhatsApp green color
    final whatsappGreen = const Color(0xFF25D366);

    // Draw the speech bubble with the exact WhatsApp shape
    final bubblePaint = Paint()
      ..color = whatsappGreen
      ..style = PaintingStyle.fill;

    final center = Offset(size.width / 2, size.height / 2);
    final radius = size.width * 0.45;

    // Main bubble (circle)
    final bubblePath = Path();
    bubblePath.addOval(Rect.fromCircle(center: center, radius: radius));

    // Tail (pointing down-left)
    final tailPath = Path();
    final tailStart = Offset(
      center.dx - radius * 0.25,
      center.dy + radius * 0.55,
    );
    final tailEnd = Offset(
      center.dx - radius * 0.05,
      center.dy + radius * 0.75,
    );
    final tailTop = Offset(
      center.dx - radius * 0.45,
      center.dy + radius * 0.65,
    );

    tailPath.moveTo(tailStart.dx, tailStart.dy);
    tailPath.lineTo(tailEnd.dx, tailEnd.dy);
    tailPath.lineTo(tailTop.dx, tailTop.dy);
    tailPath.close();

    bubblePath.addPath(tailPath, Offset.zero);
    canvas.drawPath(bubblePath, bubblePaint);

    // Draw the phone icon inside (white)
    final phonePaint = Paint()
      ..color = Colors.white
      ..style = PaintingStyle.fill;

    final phoneCenter = Offset(center.dx, center.dy);
    final phoneWidth = size.width * 0.22;
    final phoneHeight = size.height * 0.28;

    // Phone body (rounded rectangle)
    final phoneRect = RRect.fromRectAndRadius(
      Rect.fromCenter(
        center: phoneCenter,
        width: phoneWidth,
        height: phoneHeight,
      ),
      Radius.circular(phoneWidth * 0.25),
    );

    // Phone handle (smaller rounded rectangle)
    final handleRect = RRect.fromRectAndRadius(
      Rect.fromCenter(
        center: Offset(phoneCenter.dx, phoneCenter.dy + phoneHeight * 0.35),
        width: phoneWidth * 0.55,
        height: phoneHeight * 0.35,
      ),
      Radius.circular(phoneWidth * 0.18),
    );

    // Draw phone parts
    canvas.drawRRect(phoneRect, phonePaint);
    canvas.drawRRect(handleRect, phonePaint);
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}

class Order {
  final String id;
  final String orderNumber;
  final String title;
  final OrderStatus status;
  final double amount;
  final DateTime date;
  final String description;
  final List<String> items;

  Order({
    required this.id,
    required this.orderNumber,
    required this.title,
    required this.status,
    required this.amount,
    required this.date,
    required this.description,
    required this.items,
  });

  factory Order.fromFirestore(String id, Map<String, dynamic> data) {
    return Order(
      id: id,
      orderNumber: data['orderNumber'] ?? 'N/A',
      title: data['title'] ?? data['serviceName'] ?? 'Unknown Service',
      status: _stringToOrderStatus(data['status'] ?? 'pending'),
      amount: (data['amount'] ?? data['finalPrice'] ?? 0.0).toDouble(),
      date: (data['createdAt'] as dynamic)?.toDate() ?? DateTime.now(),
      description: data['description'] ?? data['projectDescription'] ?? '',
      items: List<String>.from(data['items'] ?? []),
    );
  }

  static OrderStatus _stringToOrderStatus(String status) {
    switch (status.toLowerCase()) {
      case 'inprogress':
        return OrderStatus.inProgress;
      case 'completed':
        return OrderStatus.completed;
      case 'cancelled':
        return OrderStatus.cancelled;
      case 'declined':
        return OrderStatus.declined;
      default:
        return OrderStatus.pending;
    }
  }
}

enum OrderStatus { pending, inProgress, completed, cancelled, declined }

// Old WalletScreen implementation removed - now using enhanced version from wallet_screen.dart

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: null,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: Column(
          children: [
            // Custom transparent header
            SafeArea(
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Row(
                  children: [
                    // Back button for landscape mode
                    if (MediaQuery.of(context).orientation ==
                        Orientation.landscape)
                      IconButton(
                        onPressed: () => Navigator.of(context).pushReplacement(
                          MaterialPageRoute(
                            builder: (context) => const DashboardScreen(),
                          ),
                        ),
                        icon: const Icon(
                          Icons.arrow_back,
                          color: Colors.white,
                          size: 28,
                        ),
                        style: IconButton.styleFrom(
                          backgroundColor: Colors.white.withOpacity(0.1),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                      ),
                    if (MediaQuery.of(context).orientation ==
                        Orientation.landscape)
                      const SizedBox(width: 16),
                    const Expanded(
                      child: Text(
                        'Wallet',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                  ],
                ),
              ),
            ),
            Container(
              width: double.infinity,
              margin: const EdgeInsets.all(16),
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  colors: [Color(0xFF8B0000), Color(0xFFB22222)],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                ),
                borderRadius: BorderRadius.circular(20),
                boxShadow: [
                  BoxShadow(
                    color: const Color(0xFF8B0000).withOpacity(0.3),
                    blurRadius: 15,
                    offset: const Offset(0, 8),
                  ),
                ],
              ),
              child: Column(
                children: [
                  const Text(
                    'Available Balance',
                    style: TextStyle(color: Colors.white70, fontSize: 16),
                  ),
                  const SizedBox(height: 8),
                  StreamBuilder<double>(
                    stream: _getWalletBalanceStream(),
                    builder: (context, snapshot) {
                      if (snapshot.connectionState == ConnectionState.waiting) {
                        return const CircularProgressIndicator(
                          valueColor: AlwaysStoppedAnimation<Color>(
                            Colors.white,
                          ),
                        );
                      }

                      final balance = snapshot.data ?? 0.0;
                      return Text(
                        'R${balance.toStringAsFixed(2)}',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 32,
                          fontWeight: FontWeight.bold,
                        ),
                      );
                    },
                  ),
                  const SizedBox(height: 20),
                  ElevatedButton.icon(
                    onPressed: () {
                      _showWalletFundingDialog();
                    },
                    icon: const Icon(Icons.add),
                    label: const Text('Add Funds'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.white,
                      foregroundColor: const Color(0xFF8B0000),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                  ),
                  const SizedBox(height: 12),
                  _buildEnhancedAdButton(),
                ],
              ),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              child: Text(
                'Recent Transactions',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleFontSize(context),
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white
                      : Colors.black87,
                ),
              ),
            ),
            Expanded(
              child: _currentUserId == null
                  ? const Center(child: CircularProgressIndicator())
                  : StreamBuilder<QuerySnapshot>(
                      stream: FirebaseService.getTransactionsStream(
                        _currentUserId!,
                      ),
                      builder: (context, snapshot) {
                        if (snapshot.hasError) {
                          return Center(
                            child: Text(
                              'Error loading transactions: ${snapshot.error}',
                              style: const TextStyle(color: Colors.red),
                            ),
                          );
                        }

                        if (snapshot.connectionState ==
                            ConnectionState.waiting) {
                          return const Center(
                            child: CircularProgressIndicator(),
                          );
                        }

                        final transactions =
                            snapshot.data?.docs.map((doc) {
                              final data = doc.data() as Map<String, dynamic>;
                              return Transaction.fromFirestore(doc.id, data);
                            }).toList() ??
                            [];

                        // Sort transactions by date (newest first)
                        transactions.sort((a, b) => b.date.compareTo(a.date));

                        if (transactions.isEmpty) {
                          return const Center(
                            child: Text(
                              'No transactions yet',
                              style: TextStyle(
                                color: Colors.grey,
                                fontSize: 16,
                              ),
                            ),
                          );
                        }

                        return ListView.builder(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          itemCount: transactions.length,
                          itemBuilder: (context, index) {
                            final transaction = transactions[index];
                            return _buildTransactionItem(transaction);
                          },
                        );
                      },
                    ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTransactionItem(Transaction transaction) {
    return InkWell(
      onTap: () => _navigateToInvoice(transaction),
      borderRadius: BorderRadius.circular(12),
      child: Container(
        margin: const EdgeInsets.only(bottom: 12),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 4,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: transaction.type == TransactionType.credit
                    ? Colors.green.withOpacity(0.1)
                    : Colors.red.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                transaction.type == TransactionType.credit
                    ? Icons.arrow_downward
                    : Icons.arrow_upward,
                color: transaction.type == TransactionType.credit
                    ? Colors.green
                    : Colors.red,
                size: 20,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    transaction.description,
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getBodyFontSize(context),
                      fontWeight: FontWeight.w600,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white
                          : Colors.black87,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    _formatDate(transaction.date),
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getSmallFontSize(context),
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                    ),
                  ),
                  if (transaction.reference != null) ...[
                    const SizedBox(height: 2),
                    Row(
                      children: [
                        Icon(
                          Icons.tag,
                          size: 12,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white54
                              : Colors.black38,
                        ),
                        const SizedBox(width: 4),
                        Expanded(
                          child: Text(
                            'Ref: ${transaction.reference}',
                            style: TextStyle(
                              fontSize: 11,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white54
                                  : Colors.black38,
                            ),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                  ],
                ],
              ),
            ),
            const SizedBox(width: 12),
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  '${transaction.type == TransactionType.credit ? '+' : '-'}R${transaction.amount.toStringAsFixed(2)}',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    fontWeight: FontWeight.bold,
                    color: transaction.type == TransactionType.credit
                        ? Colors.green
                        : Colors.red,
                  ),
                ),
                const SizedBox(height: 6),
                // Invoice button
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 8,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000).withOpacity(0.15),
                    borderRadius: BorderRadius.circular(6),
                    border: Border.all(
                      color: const Color(0xFF8B0000).withOpacity(0.3),
                    ),
                  ),
                  child: const Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.receipt_long,
                        size: 12,
                        color: Color(0xFF8B0000),
                      ),
                      SizedBox(width: 4),
                      Text(
                        'Invoice',
                        style: TextStyle(
                          color: Color(0xFF8B0000),
                          fontSize: 11,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  void _navigateToInvoice(Transaction transaction) {
    // Get current user from Firebase Auth
    final currentUser = FirebaseAuth.instance.currentUser;

    // Determine invoice status based on transaction type
    String invoiceStatus;
    String serviceName;

    switch (transaction.invoiceType ?? transaction.type.toString()) {
      case 'payment':
      case 'debit':
        invoiceStatus = 'PAID';
        serviceName = transaction.description.replaceAll('Payment for ', '');
        break;
      case 'refund':
        invoiceStatus = 'REFUNDED';
        serviceName = transaction.description;
        break;
      case 'wallet_funding':
        invoiceStatus = 'COMPLETED';
        serviceName = 'Wallet Top-Up';
        break;
      case 'credit':
      case 'ad_reward':
        invoiceStatus = 'COMPLETED';
        serviceName = transaction.description;
        break;
      default:
        invoiceStatus = 'COMPLETED';
        serviceName = transaction.description;
    }

    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => InvoiceScreen(
          transactionId: transaction.transactionId ?? transaction.id,
          customerName: currentUser?.displayName ?? 'Customer',
          customerEmail: currentUser?.email ?? 'customer@example.com',
          serviceName: serviceName,
          amount: transaction.amount,
          status: invoiceStatus,
          date: transaction.date,
          reference:
              transaction.reference ??
              transaction.transactionId ??
              transaction.id,
          phone: currentUser?.phoneNumber,
          orderNumber: transaction.orderNumber,
        ),
      ),
    );
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final difference = now.difference(date);

    if (difference.inDays == 0) {
      return 'Today';
    } else if (difference.inDays == 1) {
      return 'Yesterday';
    } else if (difference.inDays < 7) {
      return '${difference.inDays} days ago';
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }

  Future<void> _watchAdForCredit() async {
    final adRewardService = AdRewardService();

    // Check if AdMob is supported on this platform
    if (!adRewardService.isSupported) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Ads are only available on mobile devices (iOS/Android)',
          ),
          backgroundColor: Colors.orange,
          duration: Duration(seconds: 4),
        ),
      );
      return;
    }

    // Check if ad is ready
    if (!adRewardService.isRewardedAdReady) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Ad is loading... Please try again in a few seconds'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    try {
      // Show the rewarded ad
      final success = await adRewardService.showRewardedAd(
        onRewardEarned: (rewardAmount) async {
          print('ðŸŽ¯ REWARD EARNED - Amount: R$rewardAmount');

          // Credit wallet directly
          final credited = await adRewardService.creditWalletForAdReward(
            rewardAmount,
          );

          if (credited) {
            print('âœ… Wallet credited successfully!');

            // Show success message
            if (mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(
                    'ðŸŽ‰ R${rewardAmount.toStringAsFixed(2)} added to your wallet!',
                  ),
                  backgroundColor: const Color(0xFF00AA00),
                  duration: const Duration(seconds: 3),
                ),
              );
            }
          } else {
            print('âŒ Failed to credit wallet');

            // Show error message
            if (mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(
                  content: Text('Failed to credit wallet. Please try again.'),
                  backgroundColor: Colors.red,
                ),
              );
            }
          }
        },
        onAdClosed: () {
          print('Ad closed');
        },
      );

      if (!success) {
        print('âŒ Ad reward not earned');
      }
    } catch (e) {
      print('âŒ Error showing ad: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error showing ad: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Widget _buildEnhancedAdButton() {
    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0.0, end: 1.0),
      duration: const Duration(milliseconds: 1500),
      builder: (context, value, child) {
        return Transform.scale(
          scale: 1.0 + (0.05 * (0.5 - (value - 0.5).abs())),
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              gradient: LinearGradient(
                colors: [
                  Color.lerp(
                    const Color(0xFF00C853),
                    const Color(0xFF00E676),
                    value,
                  )!,
                  Color.lerp(
                    const Color(0xFF00E676),
                    const Color(0xFF69F0AE),
                    value,
                  )!,
                  Color.lerp(
                    const Color(0xFF00C853),
                    const Color(0xFF00E676),
                    1 - value,
                  )!,
                ],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              boxShadow: [
                BoxShadow(
                  color: const Color(0xFF00E676).withOpacity(0.6),
                  blurRadius: 20,
                  spreadRadius: 2,
                  offset: const Offset(0, 4),
                ),
                BoxShadow(
                  color: Colors.black.withOpacity(0.3),
                  blurRadius: 10,
                  offset: const Offset(0, 6),
                ),
              ],
            ),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                borderRadius: BorderRadius.circular(16),
                onTap: () {
                  _watchAdForCredit();
                },
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 28,
                    vertical: 18,
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Container(
                        padding: const EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.3),
                          shape: BoxShape.circle,
                        ),
                        child: const Icon(
                          Icons.play_circle_fill,
                          color: Colors.white,
                          size: 28,
                        ),
                      ),
                      const SizedBox(width: 14),
                      Flexible(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Flexible(
                                  child: const Text(
                                    'ðŸŽ FREE R1!',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 11,
                                      fontWeight: FontWeight.w900,
                                      letterSpacing: 0.6,
                                    ),
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                ),
                                const SizedBox(width: 4),
                                Container(
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 5,
                                    vertical: 2,
                                  ),
                                  decoration: BoxDecoration(
                                    color: Colors.yellow.shade700,
                                    borderRadius: BorderRadius.circular(6),
                                  ),
                                  child: const Text(
                                    'NEW',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 8,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 4),
                            const Text(
                              'Watch Ad â€¢ Earn R1 Instantly',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 15,
                                fontWeight: FontWeight.bold,
                                letterSpacing: 0.3,
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(width: 12),
                      Container(
                        padding: const EdgeInsets.all(6),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Icon(
                          Icons.arrow_forward,
                          color: Color(0xFF00C853),
                          size: 20,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        );
      },
      onEnd: () {
        // Restart animation for continuous pulsing effect
        if (mounted) {
          setState(() {});
        }
      },
    );
  }

  void _showWalletFundingDialog() {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return WalletFundingDialog(
          onPaymentSuccess: (amount) async {
            // Payment success - transaction will be created by PaystackPaymentScreen after verification
            // No need to create transaction here as PaystackPaymentScreen handles it

            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(
                  'Successfully added R${amount.toStringAsFixed(2)} to your wallet!',
                ),
                backgroundColor: Colors.green,
                duration: const Duration(seconds: 4),
              ),
            );
          },
          onPaymentFailed: () {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Payment failed. Please try again.'),
                backgroundColor: Colors.red,
                duration: Duration(seconds: 4),
              ),
            );
          },
        );
      },
    );
  }
}

class Transaction {
  final String id;
  final TransactionType type;
  final double amount;
  final String description;
  final DateTime date;
  final String? orderId;
  final String? orderNumber;
  final String? reference;
  final String? transactionId;
  final String? invoiceType;

  Transaction({
    required this.id,
    required this.type,
    required this.amount,
    required this.description,
    required this.date,
    this.orderId,
    this.orderNumber,
    this.reference,
    this.transactionId,
    this.invoiceType,
  });

  factory Transaction.fromFirestore(String id, Map<String, dynamic> data) {
    final String transactionType = data['type'] ?? '';

    // Determine if this is a credit (money IN) or debit (money OUT)
    final bool isCredit =
        transactionType == 'credit' ||
        transactionType == 'refund' ||
        transactionType == 'wallet_funding' ||
        transactionType == 'ad_reward';

    return Transaction(
      id: id,
      type: isCredit ? TransactionType.credit : TransactionType.debit,
      amount: (data['amount'] as num).toDouble(),
      description: data['description'] ?? '',
      date: (data['createdAt'] as dynamic)?.toDate() ?? DateTime.now(),
      orderId: data['orderId'],
      orderNumber: data['orderNumber'],
      reference: data['reference'] ?? data['transactionId'],
      transactionId: data['transactionId'],
      invoiceType: data['invoiceType'] ?? data['type'],
    );
  }
}

enum TransactionType { credit, debit }

class ServiceHubScreen extends StatefulWidget {
  final int initialTab;

  const ServiceHubScreen({super.key, this.initialTab = 0});

  @override
  State<ServiceHubScreen> createState() => _ServiceHubScreenState();
}

class _ServiceHubScreenState extends State<ServiceHubScreen>
    with TickerProviderStateMixin {
  final PageController _packagePageController = PageController(
    initialPage: 1,
  ); // Start with Growth (index 1)
  int _currentPackagePage = 1;
  late TabController _tabController;
  String? _currentUserId;

  // Helper function to check if a service supports priority processing
  bool _isGraphicsService(String serviceName) {
    return serviceName == 'Logo Design' ||
        serviceName == 'Business Card Design' ||
        serviceName == 'Brochure Design' ||
        serviceName == 'Poster Design';
  }

  // Service likes tracking
  final Set<String> _likedServices = <String>{};

  final List<MarketingPackage> _marketingPackages = [
    MarketingPackage(
      id: '1',
      name: 'Starter',
      icon: 'â­',
      price: 500.00,
      originalPrice: 500.00,
      period: 'month',
      isPopular: false,
      features: [
        'Basic Social Media Management',
        '5 Graphic Designs/month',
        'Content Creation',
        'Email Support',
      ],
      color: const Color(0xFF8B0000),
      description: 'Perfect for small businesses',
      savings: 'Best value',
      bestFor: 'Small Businesses',
      setupFee: 1500.00,
    ),
    MarketingPackage(
      id: '2',
      name: 'Growth',
      icon: 'ðŸš€',
      price: 800.00,
      originalPrice: 800.00,
      period: 'month',
      isPopular: true,
      features: [
        'Advanced Social Media Management',
        '10 Graphic Designs/month',
        'Content Strategy',
        'Basic SEO',
        'Priority Support',
      ],
      color: const Color(0xFF8B0000),
      description: 'Ideal for growing businesses',
      savings: 'Most popular',
      bestFor: 'Growing Businesses',
      setupFee: 3000.00,
    ),
    MarketingPackage(
      id: '3',
      name: 'Premium',
      icon: 'ðŸ‘‘',
      price: 1500.00,
      originalPrice: 1500.00,
      period: 'month',
      isPopular: false,
      features: [
        'Full Social Media Management',
        'Unlimited Graphic Designs',
        'Advanced SEO & SEM',
        '24/7 Priority Support',
        'Website Maintenance',
      ],
      color: const Color(0xFF8B0000),
      description: 'Complete marketing solution',
      savings: 'Premium choice',
      bestFor: 'Established Businesses',
      setupFee: 5000.00,
    ),
  ];

  // Budget and cart state
  final TextEditingController _budgetController = TextEditingController();
  final TextEditingController _projectDescriptionController =
      TextEditingController();
  bool _isBudgetFilled = false;

  // Auto-refresh timer for portfolio
  Timer? _portfolioRefreshTimer;

  @override
  void initState() {
    super.initState();
    _currentUserId = FirebaseAuth.instance.currentUser?.uid;
    _tabController = TabController(length: 3, vsync: this);
    // Set the initial tab if specified
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (widget.initialTab > 0 && widget.initialTab < _tabController.length) {
        _tabController.animateTo(widget.initialTab);
      }
    });

    // Add budget controller listener
    _budgetController.addListener(() {
      setState(() {
        _isBudgetFilled = _budgetController.text.trim().isNotEmpty;
      });
    });

    // Set up auto-refresh timer for portfolio (refreshes every 30 seconds)
    _portfolioRefreshTimer = Timer.periodic(const Duration(seconds: 30), (
      timer,
    ) {
      if (mounted && _tabController.index == 2) {
        // Only refresh if we're on the Portfolio tab (index 2)
        setState(() {});
      }
    });
  }

  final List<ServiceCategory> _developmentCategories = [
    ServiceCategory(
      id: 'dev1',
      name: 'Web Development',
      description: 'Custom website and web application development',
      icon: Icons.web,
      color: const Color(0xFF2196F3),
      services: [
        Service(
          id: 'dev1',
          name: 'Custom Website',
          description: 'Professional website development with modern design',
          price: 2500.00,
          duration: '2-3 weeks',
          features: [
            'Responsive design',
            'SEO optimized',
            'Content management',
            'Contact forms',
          ],
        ),
        Service(
          id: 'dev2',
          name: 'E-commerce Website',
          description: 'Online store with payment integration',
          price: 4500.00,
          duration: '3-4 weeks',
          features: [
            'Payment gateway',
            'Inventory management',
            'Order tracking',
            'Admin panel',
          ],
        ),
        Service(
          id: 'dev3',
          name: 'Web Application',
          description: 'Custom web application development',
          price: 8000.00,
          duration: '4-6 weeks',
          features: [
            'Custom functionality',
            'Database design',
            'User authentication',
            'API integration',
          ],
        ),
      ],
    ),
    ServiceCategory(
      id: 'dev4',
      name: 'Website Design',
      description: 'Modern website design and development',
      icon: Icons.web,
      color: const Color(0xFF4CAF50),
      services: [
        Service(
          id: 'dev4',
          name: 'Website Design',
          description: 'Custom website design and development',
          price: 1299.00,
          duration: '2-3 weeks',
          features: [
            'Responsive design',
            'SEO optimized',
            'Content management',
            'Hosting setup',
          ],
        ),
        Service(
          id: 'dev5',
          name: 'E-commerce Website',
          description: 'Online store development',
          price: 1999.00,
          duration: '3-4 weeks',
          features: [
            'Payment integration',
            'Inventory management',
            'Order tracking',
            'Admin panel',
          ],
        ),
      ],
    ),
    ServiceCategory(
      id: 'dev5',
      name: 'Mobile Development',
      description: 'iOS and Android mobile application development',
      icon: Icons.phone_android,
      color: const Color(0xFF4CAF50),
      services: [
        Service(
          id: 'dev6',
          name: 'iOS App Development',
          description: 'Native iOS application development',
          price: 6000.00,
          duration: '6-8 weeks',
          features: [
            'Native iOS',
            'App Store submission',
            'Push notifications',
            'Offline functionality',
          ],
        ),
        Service(
          id: 'dev7',
          name: 'Android App Development',
          description: 'Native Android application development',
          price: 5500.00,
          duration: '6-8 weeks',
          features: [
            'Native Android',
            'Google Play submission',
            'Push notifications',
            'Offline functionality',
          ],
        ),
        Service(
          id: 'dev8',
          name: 'Cross-platform App',
          description: 'Flutter/React Native cross-platform development',
          price: 7000.00,
          duration: '8-10 weeks',
          features: [
            'iOS & Android',
            'Single codebase',
            'Native performance',
            'Custom UI/UX',
          ],
        ),
      ],
    ),
  ];

  final List<ServiceCategory> _serviceCategories = [
    ServiceCategory(
      id: '1',
      name: 'Graphic Design',
      description: 'Professional graphic design services',
      icon: Icons.brush,
      color: const Color(0xFFFFD700),
      services: [
        Service(
          id: '1',
          name: 'Logo Design',
          description: 'Custom logo design with 3 revisions',
          price: 299.00,
          duration: '3-5 days',
          features: [
            '3 revisions',
            'Source files',
            'Multiple formats',
            'Brand guidelines',
          ],
        ),
        Service(
          id: '2',
          name: 'Business Card Design',
          description: 'Professional business card design',
          price: 99.00,
          duration: '1-2 days',
          features: [
            'Print-ready files',
            'Multiple designs',
            'Quick turnaround',
          ],
        ),
        Service(
          id: '3',
          name: 'Brochure Design',
          description: 'Marketing brochure and flyer design',
          price: 199.00,
          duration: '2-3 days',
          features: [
            'Print-ready files',
            'Multiple layouts',
            'Professional design',
          ],
        ),
        Service(
          id: '4',
          name: 'Poster Design',
          description: 'Eye-catching poster and banner design',
          price: 249.00,
          duration: '2-4 days',
          features: [
            'High-resolution files',
            'Multiple sizes',
            'Print-ready format',
            'Creative concepts',
          ],
        ),
      ],
    ),
    ServiceCategory(
      id: '2',
      name: 'Digital Marketing',
      description: 'Comprehensive digital marketing solutions',
      icon: Icons.trending_up,
      color: const Color(0xFF2196F3),
      services: [
        Service(
          id: '5',
          name: 'Social Media Management',
          description: 'Complete social media management',
          price: 599.00,
          duration: 'Ongoing',
          features: [
            'Content creation',
            'Daily posting',
            'Analytics reports',
            'Engagement management',
          ],
        ),
        Service(
          id: '6',
          name: 'Google Ads Campaign',
          description: 'Professional Google Ads management',
          price: 399.00,
          duration: 'Ongoing',
          features: [
            'Campaign setup',
            'Keyword research',
            'Performance tracking',
            'Monthly reports',
          ],
        ),
      ],
    ),
  ];

  @override
  void dispose() {
    _packagePageController.dispose();
    _tabController.dispose();
    _budgetController.dispose();
    _projectDescriptionController.dispose();
    _portfolioRefreshTimer?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: null,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: Column(
          children: [
            // Custom Header
            SafeArea(
              child: Padding(
                padding: const EdgeInsets.only(
                  top: 0,
                  left: 20,
                  right: 20,
                  bottom: 0,
                ),
                child: Row(
                  children: [
                    IconButton(
                      icon: const Icon(Icons.arrow_back, color: Colors.white),
                      onPressed: () => Navigator.of(context).pop(),
                    ),
                    const Expanded(
                      child: Text(
                        'Service Hub',
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                    const SizedBox(width: 48), // Balance the back button
                  ],
                ),
              ),
            ),
            // Enhanced Floating Tab Bar
            Container(
              margin: const EdgeInsets.only(
                top: 0,
                left: 20,
                right: 20,
                bottom: 20,
              ),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Theme.of(context).brightness == Brightness.dark
                        ? const Color(0xFF2A2A2A).withOpacity(0.95)
                        : Colors.white.withOpacity(0.95),
                    Theme.of(context).brightness == Brightness.dark
                        ? const Color(0xFF1A1A1A).withOpacity(0.95)
                        : const Color(0xFFF8F9FA).withOpacity(0.95),
                  ],
                ),
                borderRadius: BorderRadius.circular(30),
                border: Border.all(
                  color: const Color(0xFF8B0000).withOpacity(0.2),
                  width: 1.5,
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.15),
                    blurRadius: 20,
                    offset: const Offset(0, 8),
                    spreadRadius: 2,
                  ),
                  BoxShadow(
                    color: const Color(0xFF8B0000).withOpacity(0.1),
                    blurRadius: 15,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: TabBar(
                controller: _tabController,
                indicator: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [const Color(0xFF8B0000), const Color(0xFFB22222)],
                  ),
                  borderRadius: BorderRadius.circular(30),
                  boxShadow: [
                    BoxShadow(
                      color: const Color(0xFF8B0000).withOpacity(0.4),
                      blurRadius: 12,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                indicatorSize: TabBarIndicatorSize.tab,
                labelColor: Colors.white,
                unselectedLabelColor:
                    Theme.of(context).brightness == Brightness.dark
                    ? Colors.white60
                    : Colors.black45,
                labelStyle: const TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 0.5,
                ),
                unselectedLabelStyle: const TextStyle(
                  fontSize: 15,
                  fontWeight: FontWeight.w600,
                  letterSpacing: 0.3,
                ),
                dividerColor: Colors.transparent,
                tabs: [
                  Tab(
                    child: Icon(
                      Icons.trending_up,
                      size: 18,
                      color: _tabController.index == 0 ? Colors.white : null,
                    ),
                  ),
                  Tab(
                    child: Icon(
                      Icons.code,
                      size: 18,
                      color: _tabController.index == 1 ? Colors.white : null,
                    ),
                  ),
                  Tab(
                    child: Icon(
                      Icons.work,
                      size: 18,
                      color: _tabController.index == 2 ? Colors.white : null,
                    ),
                  ),
                ],
              ),
            ),

            // Tab Content
            Expanded(
              child: TabBarView(
                controller: _tabController,
                children: [
                  // Marketing Tab
                  SingleChildScrollView(
                    child: Column(
                      children: [
                        // Header Section
                        Container(
                          padding: const EdgeInsets.all(20),
                          child: Column(
                            children: [
                              Text(
                                'Our Marketing Services',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getTitleFontSize(
                                    context,
                                  ),
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 16),
                              Text(
                                'Impact Graphics offers a full suite of marketing services to help your brand stand out and grow.',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getBodyFontSize(
                                    context,
                                  ),
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                ),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 16),
                              Container(
                                padding: const EdgeInsets.all(16),
                                decoration: BoxDecoration(
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? const Color(0xFF2A2A2A).withOpacity(0.8)
                                      : Colors.white.withOpacity(0.9),
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(
                                    color: const Color(
                                      0xFF8B0000,
                                    ).withOpacity(0.2),
                                    width: 1,
                                  ),
                                ),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    _buildMarketingServiceItem(
                                      'Graphics Design:',
                                      'Logos, posters, banners, business cards, and more.',
                                    ),
                                    _buildMarketingServiceItem(
                                      'Social Media Management:',
                                      'Content creation, scheduling, analytics, and engagement.',
                                    ),
                                    _buildMarketingServiceItem(
                                      'Motion Graphics:',
                                      'Animated videos, explainer videos, and dynamic visuals.',
                                    ),
                                    _buildMarketingServiceItem(
                                      'Video Editing:',
                                      'Professional editing for promos, ads, and social content.',
                                    ),
                                    _buildMarketingServiceItem(
                                      'And More:',
                                      'Brand strategy, campaign management, digital advertising, and more!',
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(height: 16),
                              Text(
                                'Choose a package below or contact us for a custom solution.',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getBodyFontSize(
                                    context,
                                  ),
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                ),
                                textAlign: TextAlign.center,
                              ),
                            ],
                          ),
                        ),

                        // Marketing Packages Section
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 20),
                          child: Column(
                            children: [
                              // Marketing Packages Header
                              Text(
                                'Marketing Packages',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getTitleFontSize(
                                    context,
                                  ),
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 8),
                              Text(
                                'Choose the best plan for your business growth',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getBodyFontSize(
                                    context,
                                  ),
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                ),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 20),

                              // Package Cards - Conditional Layout
                              Builder(
                                builder: (context) {
                                  final isLandscape =
                                      MediaQuery.of(context).orientation ==
                                      Orientation.landscape;

                                  if (isLandscape) {
                                    // Landscape: Show all packages in a Row
                                    return SizedBox(
                                      height:
                                          350, // Reduced height for landscape
                                      child: Row(
                                        children: _marketingPackages.map((
                                          package,
                                        ) {
                                          return Expanded(
                                            child: Container(
                                              margin:
                                                  const EdgeInsets.symmetric(
                                                    horizontal:
                                                        6, // Reduced margin
                                                    vertical:
                                                        8, // Reduced margin
                                                  ),
                                              child: _buildLandscapePackageCard(
                                                package,
                                                true, // All cards are "active" in landscape
                                              ),
                                            ),
                                          );
                                        }).toList(),
                                      ),
                                    );
                                  } else {
                                    // Portrait: Keep the original PageView
                                    return SizedBox(
                                      height: 480,
                                      child: PageView.builder(
                                        controller: _packagePageController,
                                        onPageChanged: (index) {
                                          setState(() {
                                            _currentPackagePage = index;
                                          });
                                        },
                                        itemCount: _marketingPackages.length,
                                        itemBuilder: (context, index) {
                                          final package =
                                              _marketingPackages[index];
                                          final isActive =
                                              index == _currentPackagePage;
                                          return AnimatedContainer(
                                            duration: const Duration(
                                              milliseconds: 300,
                                            ),
                                            margin: EdgeInsets.symmetric(
                                              horizontal: isActive ? 16 : 32,
                                              vertical: isActive ? 20 : 40,
                                            ),
                                            child: _buildPackageCard(
                                              package,
                                              isActive,
                                            ),
                                          );
                                        },
                                      ),
                                    );
                                  }
                                },
                              ),

                              // Page Indicator - Only show in portrait mode
                              Builder(
                                builder: (context) {
                                  final isLandscape =
                                      MediaQuery.of(context).orientation ==
                                      Orientation.landscape;

                                  if (isLandscape) {
                                    // No page indicator needed in landscape
                                    return const SizedBox.shrink();
                                  } else {
                                    // Show page indicator in portrait
                                    return Container(
                                      padding: const EdgeInsets.symmetric(
                                        vertical: 20,
                                      ),
                                      child: Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.center,
                                        children: List.generate(
                                          _marketingPackages.length,
                                          (index) {
                                            return AnimatedContainer(
                                              duration: const Duration(
                                                milliseconds: 300,
                                              ),
                                              margin:
                                                  const EdgeInsets.symmetric(
                                                    horizontal: 4,
                                                  ),
                                              width:
                                                  index == _currentPackagePage
                                                  ? 24
                                                  : 8,
                                              height: 8,
                                              decoration: BoxDecoration(
                                                color:
                                                    index == _currentPackagePage
                                                    ? const Color(0xFF8B0000)
                                                    : Colors.grey.withOpacity(
                                                        0.3,
                                                      ),
                                                borderRadius:
                                                    BorderRadius.circular(4),
                                              ),
                                            );
                                          },
                                        ),
                                      ),
                                    );
                                  }
                                },
                              ),
                            ],
                          ),
                        ),

                        // Divider
                        Container(
                          margin: const EdgeInsets.symmetric(
                            horizontal: 20,
                            vertical: 10,
                          ),
                          child: Divider(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white10
                                : Colors.black12,
                            thickness: 1,
                          ),
                        ),

                        // Consultation Card for Marketing
                        Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 20,
                            vertical: 16,
                          ),
                          child: _buildServiceHubConsultationCard('marketing'),
                        ),

                        // Service Categories Header
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 20,
                            vertical: 10,
                          ),
                          child: Text(
                            'Individual Services',
                            style: TextStyle(
                              fontSize: ResponsiveUtils.getTitleFontSize(
                                context,
                              ),
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        ),

                        // Service Categories
                        ListView.builder(
                          shrinkWrap: true,
                          physics: const NeverScrollableScrollPhysics(),
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          itemCount: _serviceCategories.length,
                          itemBuilder: (context, index) {
                            final category = _serviceCategories[index];
                            return _buildServiceCategory(category);
                          },
                        ),
                      ],
                    ),
                  ),

                  // Development Tab
                  SingleChildScrollView(
                    child: Column(
                      children: [
                        // Development Header Section
                        Container(
                          padding: const EdgeInsets.all(20),
                          child: Column(
                            children: [
                              Text(
                                'Our Development Services',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getTitleFontSize(
                                    context,
                                  ),
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 16),
                              Text(
                                'Professional web and mobile development services to bring your digital ideas to life.',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getBodyFontSize(
                                    context,
                                  ),
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                ),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 24),
                              // Cost Information Section
                              Container(
                                padding: const EdgeInsets.all(16),
                                decoration: BoxDecoration(
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? const Color(0xFF2A2A2A)
                                      : Colors.white,
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(
                                    color: const Color(
                                      0xFF8B0000,
                                    ).withOpacity(0.3),
                                    width: 1,
                                  ),
                                ),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Row(
                                      children: [
                                        Icon(
                                          Icons.info_outline,
                                          color: const Color(0xFF8B0000),
                                          size: 20,
                                        ),
                                        const SizedBox(width: 8),
                                        Text(
                                          'Cost Information',
                                          style: TextStyle(
                                            fontSize:
                                                ResponsiveUtils.getBodyFontSize(
                                                  context,
                                                ),
                                            fontWeight: FontWeight.bold,
                                            color:
                                                Theme.of(context).brightness ==
                                                    Brightness.dark
                                                ? Colors.white
                                                : Colors.black87,
                                          ),
                                        ),
                                      ],
                                    ),
                                    const SizedBox(height: 12),
                                    Text(
                                      'The average cost can range widely based on complexity. Simple apps may cost between ZAR 30,000 to ZAR 50,000, while medium-complexity apps can range from ZAR 50,000 to ZAR 300,000. High-complexity apps may exceed ZAR 500,000.',
                                      style: TextStyle(
                                        fontSize:
                                            ResponsiveUtils.getSmallFontSize(
                                              context,
                                            ),
                                        color:
                                            Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? Colors.white70
                                            : Colors.black54,
                                        height: 1.5,
                                      ),
                                      textAlign: TextAlign.left,
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),

                        // Consultation Card for Development
                        Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 20,
                            vertical: 16,
                          ),
                          child: _buildServiceHubConsultationCard(
                            'development',
                          ),
                        ),

                        // Development Service Categories
                        ListView.builder(
                          shrinkWrap: true,
                          physics: const NeverScrollableScrollPhysics(),
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          itemCount: _developmentCategories.length,
                          itemBuilder: (context, index) {
                            final category = _developmentCategories[index];
                            return _buildServiceCategory(
                              category,
                              isDevelopment: true,
                            );
                          },
                        ),
                      ],
                    ),
                  ),

                  // Resources Tab (Shared Links)
                  _buildUserResourcesTab(),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // User Portfolio Tab (Client Work Showcase)
  Widget _buildUserResourcesTab() {
    return RefreshIndicator(
      onRefresh: () async {
        // Force refresh by rebuilding
        setState(() {});
        await Future.delayed(const Duration(milliseconds: 500));
      },
      color: const Color(0xFF8B0000),
      child: SingleChildScrollView(
        physics: const AlwaysScrollableScrollPhysics(),
        child: Column(
          children: [
            // Header Section
            Container(
              padding: const EdgeInsets.only(
                left: 20,
                right: 20,
                top: 20,
                bottom: 4,
              ),
              child: Column(
                children: [
                  Text(
                    'Our Portfolio',
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getTitleFontSize(context),
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Explore our client work and see the quality of our creative solutions.',
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getBodyFontSize(context),
                      color: Colors.white70,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 8),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.refresh, size: 14, color: Colors.white54),
                      const SizedBox(width: 4),
                      Text(
                        'Pull down to refresh',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.white54,
                          fontStyle: FontStyle.italic,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
            // Portfolio Links List
            _buildUserPortfolioList(),
          ],
        ),
      ),
    );
  }

  Widget _buildUserPortfolioList() {
    return Container(
      padding: const EdgeInsets.only(left: 20, right: 20, top: 4, bottom: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Real-time portfolio links from Firebase
          StreamBuilder<List<Map<String, dynamic>>>(
            stream: FirebaseService.getSharedLinksStream(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(
                      Color(0xFF8B0000),
                    ),
                  ),
                );
              }

              if (snapshot.hasError) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(
                        Icons.error_outline,
                        color: Colors.red,
                        size: 48,
                      ),
                      const SizedBox(height: 16),
                      Text(
                        'Error loading portfolio: ${snapshot.error}',
                        style: const TextStyle(color: Colors.red),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }

              final links = snapshot.data ?? [];

              if (links.isEmpty) {
                return const Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.work, color: Colors.white54, size: 48),
                      SizedBox(height: 16),
                      Text(
                        'Portfolio coming soon',
                        style: TextStyle(color: Colors.white54, fontSize: 16),
                      ),
                      SizedBox(height: 8),
                      Text(
                        'We\'re working on showcasing our amazing client work',
                        style: TextStyle(color: Colors.white38, fontSize: 14),
                      ),
                    ],
                  ),
                );
              }

              return ListView.builder(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: links.length,
                itemBuilder: (context, index) {
                  final link = links[index];
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 16),
                    child: _buildUserPortfolioCard(link),
                  );
                },
              );
            },
          ),
        ],
      ),
    );
  }

  // Show portfolio item details dialog
  void _showPortfolioItemDialog(Map<String, dynamic> link) {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        child: Container(
          width: MediaQuery.of(context).size.width * 0.9,
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                const Color(0xFF2A2A2A).withOpacity(0.95),
                const Color(0xFF1A1A1A).withOpacity(0.95),
              ],
            ),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: const Color(0xFF8B0000).withOpacity(0.3),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: Column(
            children: [
              // Header
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.1),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(20),
                    topRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Icon(Icons.work, color: const Color(0xFF8B0000), size: 24),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        link['title'] ?? 'Client Project',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(
                        Icons.close,
                        color: Colors.white70,
                        size: 24,
                      ),
                    ),
                  ],
                ),
              ),

              // Content
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Image
                      // Image with auto-sizing
                      if (link['image'] != null && link['image'].isNotEmpty)
                        Container(
                          width: double.infinity,
                          constraints: const BoxConstraints(
                            minHeight: 150,
                            maxHeight: 300,
                          ),
                          margin: const EdgeInsets.only(bottom: 20),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(16),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.3),
                                blurRadius: 15,
                                offset: const Offset(0, 6),
                              ),
                            ],
                          ),
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(16),
                            child: Image.network(
                              link['image'],
                              width: double.infinity,
                              fit: BoxFit.cover,
                              errorBuilder: (context, error, stackTrace) {
                                return Container(
                                  height: 200,
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        const Color(0xFF1A1A1A),
                                        const Color(0xFF2A2A2A),
                                      ],
                                    ),
                                  ),
                                  child: const Center(
                                    child: Column(
                                      mainAxisAlignment:
                                          MainAxisAlignment.center,
                                      children: [
                                        Icon(
                                          Icons.broken_image,
                                          color: Colors.white54,
                                          size: 48,
                                        ),
                                        SizedBox(height: 8),
                                        Text(
                                          'Image not available',
                                          style: TextStyle(
                                            color: Colors.white54,
                                            fontSize: 14,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                );
                              },
                              loadingBuilder:
                                  (context, child, loadingProgress) {
                                    if (loadingProgress == null) return child;
                                    return Container(
                                      height: 200,
                                      decoration: BoxDecoration(
                                        gradient: LinearGradient(
                                          begin: Alignment.topLeft,
                                          end: Alignment.bottomRight,
                                          colors: [
                                            const Color(0xFF1A1A1A),
                                            const Color(0xFF2A2A2A),
                                          ],
                                        ),
                                      ),
                                      child: const Center(
                                        child: CircularProgressIndicator(
                                          valueColor:
                                              AlwaysStoppedAnimation<Color>(
                                                Color(0xFF8B0000),
                                              ),
                                        ),
                                      ),
                                    );
                                  },
                            ),
                          ),
                        )
                      else
                        Container(
                          width: double.infinity,
                          height: 200,
                          margin: const EdgeInsets.only(bottom: 20),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(16),
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [
                                const Color(0xFF1A1A1A),
                                const Color(0xFF2A2A2A),
                              ],
                            ),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.3),
                                blurRadius: 15,
                                offset: const Offset(0, 6),
                              ),
                            ],
                          ),
                          child: const Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.work,
                                  color: Colors.white54,
                                  size: 48,
                                ),
                                SizedBox(height: 8),
                                Text(
                                  'No image available',
                                  style: TextStyle(
                                    color: Colors.white54,
                                    fontSize: 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      // Site name
                      Row(
                        children: [
                          Icon(
                            Icons.link,
                            color: const Color(0xFF8B0000),
                            size: 20,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            link['siteName'] ?? 'Client Work',
                            style: const TextStyle(
                              color: Colors.white70,
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 16),

                      // Description
                      if (link['description'] != null &&
                          link['description'].isNotEmpty)
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Project Description',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Text(
                              link['description'],
                              style: const TextStyle(
                                color: Colors.white70,
                                fontSize: 14,
                                height: 1.5,
                              ),
                            ),
                            const SizedBox(height: 20),
                          ],
                        ),
                    ],
                  ),
                ),
              ),

              // Action buttons
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF1A1A1A).withOpacity(0.5),
                  borderRadius: const BorderRadius.only(
                    bottomLeft: Radius.circular(20),
                    bottomRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () => Navigator.pop(context),
                        style: OutlinedButton.styleFrom(
                          side: const BorderSide(color: Color(0xFF8B0000)),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: Text(
                          'Close',
                          style: TextStyle(
                            color: const Color(0xFF8B0000),
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.pop(context);
                          _launchUrl(link['url'] ?? '');
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: const Text(
                          'Visit Project',
                          style: TextStyle(fontWeight: FontWeight.w600),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildUserPortfolioCard(Map<String, dynamic> link) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF2A2A2A).withOpacity(0.9),
            const Color(0xFF1A1A1A).withOpacity(0.9),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFF8B0000).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () => _showPortfolioItemDialog(link),
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header with work icon and admin menu
              Row(
                children: [
                  Icon(Icons.work, color: const Color(0xFF8B0000), size: 20),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      link['siteName'] ?? 'Client Work',
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  // Admin edit menu (only show for admin users)
                  if (AuthService.instance?.isAdmin == true)
                    PopupMenuButton<String>(
                      icon: Icon(
                        Icons.more_vert,
                        color: Colors.white70,
                        size: 16,
                      ),
                      onSelected: (value) {
                        switch (value) {
                          case 'edit':
                            _showEditPortfolioDialog(link);
                            break;
                          case 'delete':
                            _showDeletePortfolioDialog(link);
                            break;
                        }
                      },
                      itemBuilder: (context) => [
                        PopupMenuItem(
                          value: 'edit',
                          child: Row(
                            children: [
                              Icon(Icons.edit, size: 16, color: Colors.white70),
                              SizedBox(width: 8),
                              Text('Edit'),
                            ],
                          ),
                        ),
                        PopupMenuItem(
                          value: 'delete',
                          child: Row(
                            children: [
                              Icon(Icons.delete, size: 16, color: Colors.red),
                              SizedBox(width: 8),
                              Text(
                                'Delete',
                                style: TextStyle(color: Colors.red),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                ],
              ),
              const SizedBox(height: 12),

              // Image and content row
              Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Portfolio image
                  Container(
                    width: 80,
                    height: 80,
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(8),
                      color: const Color(0xFF1A1A1A),
                    ),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(8),
                      child: link['image'] != null && link['image'].isNotEmpty
                          ? Image.network(
                              link['image'],
                              width: 80,
                              height: 80,
                              fit: BoxFit.cover,
                              errorBuilder: (context, error, stackTrace) {
                                return const Icon(
                                  Icons.work,
                                  color: Colors.white54,
                                  size: 32,
                                );
                              },
                              loadingBuilder:
                                  (context, child, loadingProgress) {
                                    if (loadingProgress == null) return child;
                                    return const Center(
                                      child: CircularProgressIndicator(
                                        valueColor:
                                            AlwaysStoppedAnimation<Color>(
                                              Color(0xFF8B0000),
                                            ),
                                        strokeWidth: 2,
                                      ),
                                    );
                                  },
                            )
                          : const Icon(
                              Icons.work,
                              color: Colors.white54,
                              size: 32,
                            ),
                    ),
                  ),
                  const SizedBox(width: 12),

                  // Title and description
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          link['title'] ?? 'Client Project',
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                        ),
                        const SizedBox(height: 4),
                        Text(
                          link['description'] ??
                              'View our client work and creative solutions',
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 14,
                          ),
                          maxLines: 3,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _launchUrl(String url) async {
    try {
      final Uri uri = Uri.parse(url);
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
      } else {
        print('Could not launch $url');
      }
    } catch (e) {
      print('Error launching URL: $e');
    }
  }

  // Show edit portfolio dialog
  void _showEditPortfolioDialog(Map<String, dynamic> link) {
    // Only allow admin users to edit portfolio items
    if (AuthService.instance?.isAdmin != true) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Only administrators can edit portfolio items'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }
    final titleController = TextEditingController(text: link['title'] ?? '');
    final descriptionController = TextEditingController(
      text: link['description'] ?? '',
    );
    final urlController = TextEditingController(text: link['url'] ?? '');
    final imageController = TextEditingController(text: link['image'] ?? '');

    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        child: Container(
          width: MediaQuery.of(context).size.width * 0.9,
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                const Color(0xFF2A2A2A).withOpacity(0.95),
                const Color(0xFF1A1A1A).withOpacity(0.95),
              ],
            ),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: const Color(0xFF8B0000).withOpacity(0.3),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: Column(
            children: [
              // Header
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.1),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(20),
                    topRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Icon(Icons.edit, color: const Color(0xFF8B0000), size: 24),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Edit Portfolio Item',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.of(context).pop(),
                      icon: const Icon(Icons.close, color: Colors.white70),
                    ),
                  ],
                ),
              ),
              // Form
              Expanded(
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: SingleChildScrollView(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildFormField(
                          'Title',
                          titleController,
                          'Enter portfolio item title',
                        ),
                        const SizedBox(height: 16),
                        _buildFormField(
                          'Description',
                          descriptionController,
                          'Enter description',
                          maxLines: 3,
                        ),
                        const SizedBox(height: 16),
                        _buildFormField('URL', urlController, 'Enter URL'),
                        const SizedBox(height: 16),
                        _buildFormField(
                          'Image URL',
                          imageController,
                          'Enter image URL',
                        ),
                      ],
                    ),
                  ),
                ),
              ),
              // Footer with buttons
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF1A1A1A).withOpacity(0.8),
                  borderRadius: const BorderRadius.only(
                    bottomLeft: Radius.circular(20),
                    bottomRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () => Navigator.of(context).pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey.withOpacity(0.3),
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: const Text('Cancel'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () async {
                          if (titleController.text.isNotEmpty &&
                              urlController.text.isNotEmpty) {
                            await _updatePortfolioItem(link['id'], {
                              'title': titleController.text,
                              'description': descriptionController.text,
                              'url': urlController.text,
                              'image': imageController.text,
                              'updatedAt':
                                  DateTime.now().millisecondsSinceEpoch,
                            });
                            Navigator.of(context).pop();
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text(
                                  'Portfolio item updated successfully',
                                ),
                                backgroundColor: Color(0xFF4CAF50),
                              ),
                            );
                          } else {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text('Title and URL are required'),
                                backgroundColor: Colors.red,
                              ),
                            );
                          }
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: const Text('Update'),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // Show delete portfolio dialog
  void _showDeletePortfolioDialog(Map<String, dynamic> link) {
    // Only allow admin users to delete portfolio items
    if (AuthService.instance?.isAdmin != true) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Only administrators can delete portfolio items'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Delete Portfolio Item',
          style: TextStyle(color: Colors.white),
        ),
        content: Text(
          'Are you sure you want to delete "${link['title'] ?? 'this portfolio item'}"? This action cannot be undone.',
          style: const TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () async {
              await _deletePortfolioItem(link['id']);
              Navigator.of(context).pop();
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(
                  content: Text('Portfolio item deleted successfully'),
                  backgroundColor: Color(0xFF4CAF50),
                ),
              );
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              foregroundColor: Colors.white,
            ),
            child: const Text('Delete'),
          ),
        ],
      ),
    );
  }

  // Build form field helper
  Widget _buildFormField(
    String label,
    TextEditingController controller,
    String hint, {
    int maxLines = 1,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 16,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          maxLines: maxLines,
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: TextStyle(color: Colors.white54),
            filled: true,
            fillColor: const Color(0xFF1A1A1A).withOpacity(0.8),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: BorderSide(color: Colors.white.withOpacity(0.2)),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: BorderSide(color: Colors.white.withOpacity(0.2)),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: Color(0xFF8B0000)),
            ),
          ),
        ),
      ],
    );
  }

  // Update portfolio item in Firebase
  Future<void> _updatePortfolioItem(
    String id,
    Map<String, dynamic> data,
  ) async {
    try {
      await FirebaseService.updateSharedLink(id, data);
    } catch (e) {
      print('Error updating portfolio item: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error updating portfolio item: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Delete portfolio item from Firebase
  Future<void> _deletePortfolioItem(String id) async {
    try {
      await FirebaseService.deleteSharedLink(id);
    } catch (e) {
      print('Error deleting portfolio item: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error deleting portfolio item: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Widget _buildServiceCategory(
    ServiceCategory category, {
    bool isDevelopment = false,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 20),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          // Category Header
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: category.color.withOpacity(0.1),
              borderRadius: const BorderRadius.vertical(
                top: Radius.circular(16),
              ),
            ),
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: category.color,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Icon(category.icon, color: Colors.white, size: 24),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        category.name,
                        style: TextStyle(
                          fontSize: ResponsiveUtils.getTitleFontSize(context),
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black87,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        category.description,
                        style: TextStyle(
                          fontSize: ResponsiveUtils.getBodyFontSize(context),
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          // Services List
          ListView.builder(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            itemCount: category.services.length,
            itemBuilder: (context, index) {
              final service = category.services[index];
              return _buildServiceItem(
                service,
                category.color,
                isDevelopment: isDevelopment,
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildServiceItem(
    Service service,
    Color categoryColor, {
    bool isDevelopment = false,
  }) {
    return Container(
      margin: const EdgeInsets.all(16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF1A1A1A)
            : const Color(0xFFF8F9FA),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: categoryColor.withOpacity(0.2), width: 1),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      service.name,
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getBodyFontSize(context),
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white
                            : Colors.black87,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      service.description,
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getSmallFontSize(context),
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white70
                            : Colors.black54,
                      ),
                    ),
                  ],
                ),
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Text(
                    isDevelopment
                        ? 'from R${service.price.toStringAsFixed(2)}'
                        : 'R${service.price.toStringAsFixed(2)}',
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getBodyFontSize(context),
                      fontWeight: FontWeight.bold,
                      color: categoryColor,
                    ),
                  ),
                  Text(
                    service.duration,
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getSmallFontSize(context),
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                    ),
                  ),
                ],
              ),
            ],
          ),
          const SizedBox(height: 12),
          // Features
          Wrap(
            spacing: 8,
            runSpacing: 4,
            children: service.features.map((feature) {
              return Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: categoryColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  feature,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getSmallFontSize(context) - 2,
                    color: categoryColor,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              );
            }).toList(),
          ),
          const SizedBox(height: 16),
          // Action Buttons Row
          Row(
            children: [
              // View Details Button
              Expanded(
                child: OutlinedButton(
                  onPressed: () {
                    // Handle view details
                    _showServiceDetails(service, categoryColor);
                  },
                  style: OutlinedButton.styleFrom(
                    foregroundColor: categoryColor,
                    side: BorderSide(color: categoryColor),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                  ),
                  child: const Text('View Details'),
                ),
              ),
              const SizedBox(width: 8),
              // Like Button
              Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  color: categoryColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: categoryColor.withOpacity(0.3)),
                ),
                child: IconButton(
                  onPressed: () {
                    _toggleServiceLike(service.id);
                  },
                  icon: Icon(
                    _isServiceLiked(service.id)
                        ? Icons.favorite
                        : Icons.favorite_border,
                    color: _isServiceLiked(service.id)
                        ? Colors.red
                        : categoryColor,
                    size: 20,
                  ),
                ),
              ),
              const SizedBox(width: 8),
              // Share Button
              Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  color: categoryColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: categoryColor.withOpacity(0.3)),
                ),
                child: IconButton(
                  onPressed: () {
                    _shareService(service);
                  },
                  icon: Icon(Icons.share, color: categoryColor, size: 20),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  void _showServiceDetails(Service service, Color categoryColor) {
    int selectedPictureCount = 0;
    double totalPrice = service.price;
    bool isPrioritySelected = false;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (BuildContext context, StateSetter setState) {
          return Container(
            height: MediaQuery.of(context).size.height * 0.8,
            decoration: BoxDecoration(
              color: Theme.of(context).scaffoldBackgroundColor,
              borderRadius: const BorderRadius.vertical(
                top: Radius.circular(20),
              ),
            ),
            child: Column(
              children: [
                // Handle
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.grey.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
                Expanded(
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(20),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          service.name,
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getTitleFontSize(context),
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          service.description,
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                          ),
                        ),
                        const SizedBox(height: 20),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Price',
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getSmallFontSize(
                                      context,
                                    ),
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                  ),
                                ),
                                Text(
                                  'R${totalPrice.toStringAsFixed(2)}',
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getTitleFontSize(
                                      context,
                                    ),
                                    fontWeight: FontWeight.bold,
                                    color: categoryColor,
                                  ),
                                ),
                              ],
                            ),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.end,
                              children: [
                                Text(
                                  'Duration',
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getSmallFontSize(
                                      context,
                                    ),
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                  ),
                                ),
                                Text(
                                  service.duration,
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getBodyFontSize(
                                      context,
                                    ),
                                    fontWeight: FontWeight.bold,
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white
                                        : Colors.black87,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                        const SizedBox(height: 24),
                        Text(
                          'What\'s Included',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 12),
                        ...service.features.map(
                          (feature) => Padding(
                            padding: const EdgeInsets.only(bottom: 8),
                            child: Row(
                              children: [
                                const Icon(
                                  Icons.check_circle,
                                  color: Color(0xFF4CAF50),
                                  size: 20,
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Text(
                                    feature,
                                    style: TextStyle(
                                      fontSize: ResponsiveUtils.getBodyFontSize(
                                        context,
                                      ),
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white70
                                          : Colors.black54,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                        const SizedBox(height: 24),

                        // Picture Count Pricing (for Poster Design)
                        if (service.name == 'Poster Design') ...[
                          Container(
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? const Color(0xFF2A2A2A).withOpacity(0.8)
                                  : Colors.orange.shade50,
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: const Color(0xFFFFD700).withOpacity(0.3),
                                width: 1,
                              ),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Row(
                                  children: [
                                    Icon(
                                      Icons.photo_library,
                                      color: const Color(0xFFFFD700),
                                      size: 20,
                                    ),
                                    const SizedBox(width: 8),
                                    Text(
                                      'Picture Count Pricing',
                                      style: TextStyle(
                                        fontSize:
                                            ResponsiveUtils.getBodyFontSize(
                                              context,
                                            ),
                                        fontWeight: FontWeight.bold,
                                        color:
                                            Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? Colors.white
                                            : Colors.black87,
                                      ),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 12),
                                Row(
                                  children: [
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            'Base Price (0-6 pictures)',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getSmallFontSize(
                                                    context,
                                                  ),
                                              color:
                                                  Theme.of(
                                                        context,
                                                      ).brightness ==
                                                      Brightness.dark
                                                  ? Colors.white70
                                                  : Colors.black54,
                                            ),
                                          ),
                                          Text(
                                            'R250.00',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getBodyFontSize(
                                                    context,
                                                  ),
                                              fontWeight: FontWeight.bold,
                                              color: const Color(0xFFFFD700),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            'Additional pictures',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getSmallFontSize(
                                                    context,
                                                  ),
                                              color:
                                                  Theme.of(
                                                        context,
                                                      ).brightness ==
                                                      Brightness.dark
                                                  ? Colors.white70
                                                  : Colors.black54,
                                            ),
                                          ),
                                          Text(
                                            'R50.00 each',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getBodyFontSize(
                                                    context,
                                                  ),
                                              fontWeight: FontWeight.bold,
                                              color: const Color(0xFFFFD700),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 16),

                                // Picture Count Selector
                                Row(
                                  children: [
                                    Text(
                                      'Number of Pictures:',
                                      style: TextStyle(
                                        fontSize:
                                            ResponsiveUtils.getBodyFontSize(
                                              context,
                                            ),
                                        fontWeight: FontWeight.w600,
                                        color:
                                            Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? Colors.white
                                            : Colors.black87,
                                      ),
                                    ),
                                    const Spacer(),
                                    Container(
                                      decoration: BoxDecoration(
                                        color:
                                            Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? const Color(0xFF1A1A1A)
                                            : Colors.white,
                                        borderRadius: BorderRadius.circular(8),
                                        border: Border.all(
                                          color: const Color(
                                            0xFFFFD700,
                                          ).withOpacity(0.5),
                                          width: 1,
                                        ),
                                      ),
                                      child: Row(
                                        mainAxisSize: MainAxisSize.min,
                                        children: [
                                          IconButton(
                                            onPressed: selectedPictureCount > 0
                                                ? () {
                                                    setState(() {
                                                      selectedPictureCount--;
                                                      if (selectedPictureCount <=
                                                          6) {
                                                        totalPrice = 250.0;
                                                      } else {
                                                        totalPrice =
                                                            250.0 +
                                                            (selectedPictureCount -
                                                                    6) *
                                                                50.0;
                                                      }
                                                    });
                                                  }
                                                : null,
                                            icon: Icon(
                                              Icons.remove,
                                              color: selectedPictureCount > 0
                                                  ? const Color(0xFFFFD700)
                                                  : Colors.grey,
                                              size: 20,
                                            ),
                                          ),
                                          Container(
                                            padding: const EdgeInsets.symmetric(
                                              horizontal: 16,
                                            ),
                                            child: Text(
                                              selectedPictureCount.toString(),
                                              style: TextStyle(
                                                fontSize: 16,
                                                fontWeight: FontWeight.bold,
                                                color:
                                                    Theme.of(
                                                          context,
                                                        ).brightness ==
                                                        Brightness.dark
                                                    ? Colors.white
                                                    : Colors.black87,
                                              ),
                                            ),
                                          ),
                                          IconButton(
                                            onPressed: () {
                                              setState(() {
                                                selectedPictureCount++;
                                                if (selectedPictureCount <= 6) {
                                                  totalPrice = 250.0;
                                                } else {
                                                  totalPrice =
                                                      250.0 +
                                                      (selectedPictureCount -
                                                              6) *
                                                          50.0;
                                                }
                                              });
                                            },
                                            icon: const Icon(
                                              Icons.add,
                                              color: Color(0xFFFFD700),
                                              size: 20,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ),

                                const SizedBox(height: 12),

                                // Total Price Display
                                Container(
                                  padding: const EdgeInsets.all(12),
                                  decoration: BoxDecoration(
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? const Color(0xFF1A1A1A)
                                        : Colors.white,
                                    borderRadius: BorderRadius.circular(8),
                                    border: Border.all(
                                      color: const Color(
                                        0xFFFFD700,
                                      ).withOpacity(0.3),
                                      width: 1,
                                    ),
                                  ),
                                  child: Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      Text(
                                        'Total Price:',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getBodyFontSize(
                                                context,
                                              ),
                                          fontWeight: FontWeight.bold,
                                          color:
                                              Theme.of(context).brightness ==
                                                  Brightness.dark
                                              ? Colors.white
                                              : Colors.black87,
                                        ),
                                      ),
                                      Text(
                                        'R${totalPrice.toStringAsFixed(2)}',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getTitleFontSize(
                                                context,
                                              ),
                                          fontWeight: FontWeight.bold,
                                          color: const Color(0xFFFFD700),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 24),
                        ],

                        // Priority Checkbox (for Graphics Design services)
                        if (_isGraphicsService(service.name)) ...[
                          Container(
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? const Color(0xFF2A2A2A).withOpacity(0.8)
                                  : Colors.red.shade50,
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: Colors.red.withOpacity(0.3),
                                width: 1,
                              ),
                            ),
                            child: Row(
                              children: [
                                Checkbox(
                                  value: isPrioritySelected,
                                  onChanged: (value) {
                                    setState(() {
                                      isPrioritySelected = value ?? false;
                                      // Update total price based on service type
                                      if (service.name == 'Poster Design') {
                                        // For Poster Design, recalculate based on picture count
                                        if (selectedPictureCount <= 6) {
                                          totalPrice = 250.0;
                                        } else {
                                          totalPrice =
                                              250.0 +
                                              (selectedPictureCount - 6) * 50.0;
                                        }
                                      } else {
                                        // For other graphics services, use base price
                                        totalPrice = service.price;
                                      }
                                      // Add priority fee if selected
                                      if (isPrioritySelected) {
                                        totalPrice += 100.0;
                                      }
                                    });
                                  },
                                  activeColor: Colors.red,
                                  checkColor: Colors.white,
                                ),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Row(
                                        children: [
                                          Icon(
                                            Icons.priority_high,
                                            color: Colors.red,
                                            size: 20,
                                          ),
                                          const SizedBox(width: 8),
                                          Text(
                                            'Priority Processing',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getBodyFontSize(
                                                    context,
                                                  ),
                                              fontWeight: FontWeight.bold,
                                              color:
                                                  Theme.of(
                                                        context,
                                                      ).brightness ==
                                                      Brightness.dark
                                                  ? Colors.white
                                                  : Colors.black87,
                                            ),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 4),
                                      Text(
                                        'Get your ${service.name.toLowerCase()} completed in 1-2 days instead of standard delivery time',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getSmallFontSize(
                                                context,
                                              ),
                                          color:
                                              Theme.of(context).brightness ==
                                                  Brightness.dark
                                              ? Colors.white70
                                              : Colors.black54,
                                        ),
                                      ),
                                      const SizedBox(height: 8),
                                      Text(
                                        'Priority Fee: +R100.00',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getSmallFontSize(
                                                context,
                                              ),
                                          fontWeight: FontWeight.bold,
                                          color: Colors.red,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 24),
                        ],

                        // Budget Field
                        Text(
                          'Your Budget (Optional)',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 4,
                          ),
                          decoration: BoxDecoration(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? const Color(0xFF2A2A2A)
                                : Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(
                              color: const Color(0xFF8B0000).withOpacity(0.3),
                              width: 1,
                            ),
                          ),
                          child: TextField(
                            controller: _budgetController,
                            onChanged: (value) {
                              setState(() {
                                // This will trigger a rebuild and update the button state
                              });
                            },
                            decoration: InputDecoration(
                              hintText: 'Enter your budget (e.g., R5000)',
                              hintStyle: TextStyle(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white54
                                    : Colors.black45,
                              ),
                              border: InputBorder.none,
                              prefixIcon: Icon(
                                Icons.account_balance_wallet,
                                color: categoryColor,
                                size: 20,
                              ),
                            ),
                            style: TextStyle(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white
                                  : Colors.black87,
                            ),
                          ),
                        ),

                        const SizedBox(height: 24),

                        // Description Field
                        Text(
                          'Project Description *',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 4,
                          ),
                          decoration: BoxDecoration(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? const Color(0xFF2A2A2A)
                                : Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(
                              color: categoryColor.withOpacity(0.3),
                              width: 1,
                            ),
                          ),
                          child: TextField(
                            controller: _projectDescriptionController,
                            maxLines: 4,
                            decoration: InputDecoration(
                              hintText:
                                  'Describe your project requirements, goals, and any specific details (required)...',
                              hintStyle: TextStyle(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white54
                                    : Colors.black45,
                              ),
                              border: InputBorder.none,
                              prefixIcon: Padding(
                                padding: const EdgeInsets.only(bottom: 40),
                                child: Icon(
                                  Icons.description,
                                  color: categoryColor,
                                  size: 20,
                                ),
                              ),
                            ),
                            style: TextStyle(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white
                                  : Colors.black87,
                            ),
                          ),
                        ),

                        const SizedBox(height: 32),
                        Row(
                          children: [
                            // Add to Cart Button
                            Expanded(
                              child: SizedBox(
                                height: 50,
                                child: ElevatedButton.icon(
                                  onPressed: () {
                                    Navigator.of(context).pop();
                                    _addToCart(
                                      service,
                                      pictureCount: selectedPictureCount,
                                      calculatedPrice: totalPrice,
                                      isPriority: isPrioritySelected,
                                    );
                                  },
                                  icon: const Icon(
                                    Icons.shopping_cart,
                                    color: Colors.white,
                                  ),
                                  label: const Text(
                                    'Add to Cart',
                                    style: TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.bold,
                                      color: Colors.white,
                                    ),
                                  ),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: const Color(0xFF8B0000),
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(12),
                                    ),
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            // Pay Now Button
                            Expanded(
                              child: SizedBox(
                                height: 50,
                                child: ElevatedButton(
                                  onPressed:
                                      _budgetController.text.trim().isNotEmpty
                                      ? null
                                      : () {
                                          Navigator.of(context).pop();
                                          _navigateToPaystackPayment(
                                            service,
                                            categoryColor,
                                            isPriority: isPrioritySelected,
                                            calculatedPrice: totalPrice,
                                          );
                                        },
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor:
                                        _budgetController.text.trim().isNotEmpty
                                        ? Colors.grey.shade400
                                        : categoryColor,
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(12),
                                    ),
                                  ),
                                  child: Text(
                                    'Pay Now',
                                    style: TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.bold,
                                      color:
                                          _budgetController.text
                                              .trim()
                                              .isNotEmpty
                                          ? Colors.grey.shade600
                                          : Colors.white,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  // Helper method to check if a service is liked
  bool _isServiceLiked(String serviceId) {
    return _likedServices.contains(serviceId);
  }

  // Helper method to toggle service like
  void _toggleServiceLike(String serviceId) {
    setState(() {
      if (_likedServices.contains(serviceId)) {
        _likedServices.remove(serviceId);
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Removed from favorites'),
            duration: Duration(seconds: 1),
            backgroundColor: Colors.grey,
          ),
        );
      } else {
        _likedServices.add(serviceId);
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Added to favorites'),
            duration: Duration(seconds: 1),
            backgroundColor: Colors.red,
          ),
        );
      }
    });
  }

  // Helper method to share service
  void _shareService(Service service) {
    final shareText =
        '''
ðŸŽ¨ ${service.name}

${service.description}

ðŸ’° Price: R${service.price.toStringAsFixed(2)}
â±ï¸ Duration: ${service.duration}

âœ¨ Features:
${service.features.map((feature) => 'â€¢ $feature').join('\n')}

Get this service from Impact Graphics ZA!
ðŸ“± Download our app or visit: https://impactgraphicsza.co.za
    ''';

    // Use the share_plus package to share
    Share.share(
      shareText,
      subject: 'Check out ${service.name} from Impact Graphics ZA',
    );
  }

  void _addToCart(
    Service service, {
    int pictureCount = 0,
    double calculatedPrice = 0.0,
    bool isPriority = false,
  }) async {
    // Get budget and project description from controllers
    final budget = _budgetController.text.trim();
    final projectDescription = _projectDescriptionController.text.trim();

    // Validate project description
    if (projectDescription.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text(
            'Please describe your project requirements before adding to cart',
          ),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    // Determine price - use calculated price for Poster Design, budget if provided, otherwise use service price
    double finalPrice = calculatedPrice > 0 ? calculatedPrice : service.price;

    // For Poster Design, use the calculated totalPrice based on picture count
    if (service.name == 'Poster Design') {
      finalPrice = calculatedPrice;
    }

    if (budget.isNotEmpty) {
      try {
        // Remove currency symbols and convert to double
        final budgetValue = double.parse(
          budget.replaceAll(RegExp(r'[^\d.]'), ''),
        );
        finalPrice = budgetValue;
      } catch (e) {
        print('Error parsing budget: $e');
        // Keep calculated price if budget parsing fails
      }
    }

    // Add to cart first (this should always work)
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser != null) {
      // Create cart item first
      final cartItem = CartItem(
        id: DateTime.now().millisecondsSinceEpoch.toString(),
        name: service.name,
        description: service.description,
        price: finalPrice,
        quantity: 1,
        image: 'assets/images/logo.png', // Default image
        budget: budget.isNotEmpty ? budget : null,
        serviceId: service.id,
        projectDescription: projectDescription,
        orderId: null, // Will be set after order creation
        orderStatus: 'pending',
        // Add priority information for Graphics Design services
        isPriority: _isGraphicsService(service.name) ? isPriority : false,
        priorityFee: _isGraphicsService(service.name) && isPriority
            ? 100.0
            : 0.0,
      );

      try {
        await CartService.addItem(cartItem, currentUser.uid);
        print('Cart item added successfully');
      } catch (e) {
        print('Error adding to cart: $e');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Failed to add item to cart: $e'),
            backgroundColor: Color(0xFF8B0000),
          ),
        );
        return;
      }

      // Try to create order in Firestore (this might fail due to permissions)
      try {
        final orderData = {
          'userId': currentUser.uid,
          'customerName': currentUser.displayName ?? 'Unknown Customer',
          'customerEmail': currentUser.email ?? 'No email',
          'serviceId': service.id,
          'serviceName': service.name,
          'title': service.name, // Add title field for order display
          'serviceDescription': service.description,
          'projectDescription': projectDescription,
          'originalPrice': service.price,
          'finalPrice': finalPrice,
          'budget': budget.isNotEmpty ? budget : null,
          // Add priority information for Graphics Design services
          if (_isGraphicsService(service.name)) ...{
            'isPriority': isPriority,
            'priorityFee': isPriority ? 100.0 : 0.0,
          },
          // Add picture count information for Poster Design
          if (service.name == 'Poster Design') ...{
            'pictureCount': pictureCount,
            'basePrice': 250.0,
            'additionalPricePerPicture': 50.0,
          },
          'status': 'pending',
          'createdAt': FieldValue.serverTimestamp(),
          'updatedAt': FieldValue.serverTimestamp(),
        };

        final orderId = await FirebaseService.createOrder(orderData);
        print('Order created in Firestore with ID: $orderId');

        // Update cart item with order ID
        try {
          await CartService.updateCartItemOrderId(
            cartItem.id,
            orderId,
            currentUser.uid,
          );
          print('Cart item updated with order ID: $orderId');
        } catch (e) {
          print('Error updating cart item with order ID: $e');
        }

        // Send notification to admin about new order
        await NotificationService.sendNewOrderNotificationToAdmin(
          orderId: orderId,
          customerName: currentUser.displayName ?? 'Customer',
          serviceName: service.name,
          amount: finalPrice,
        );

        // Create transaction for the order
        await FirebaseService.createTransaction(
          userId: currentUser.uid,
          type: 'debit',
          amount: finalPrice,
          description: 'Payment for ${service.name}',
          orderId: orderId,
        );

        // Add loyalty points for the purchase (10 points per purchase)
        await FirebaseService.addLoyaltyPoints(currentUser.uid, 10);

        // Check for loyalty reward after adding points
        await _checkLoyaltyReward(currentUser.uid);

        // Send loyalty points notification
        await NotificationService.sendLoyaltyPointsNotification(
          userId: currentUser.uid,
          pointsEarned: 10,
          totalPoints: 110, // This would be fetched from user profile
        );

        // Create update notification for admin
        String orderMessage = '${service.name} order created';
        if (service.name == 'Poster Design' && pictureCount > 0) {
          orderMessage +=
              ' with $pictureCount pictures (${budget.isNotEmpty ? 'budget: $budget' : 'price: R${finalPrice.toStringAsFixed(2)}'})';
        } else {
          orderMessage +=
              ' with ${budget.isNotEmpty ? 'budget: $budget' : 'price: R${finalPrice.toStringAsFixed(2)}'}';
        }

        await FirebaseService.createUpdate(
          title: 'New Order Created',
          message: orderMessage,
          type: 'order_created',
          userId: currentUser.uid,
          orderId: orderId,
        );

        // Send single notification to user about cart addition
        await NotificationService.sendNotificationToUser(
          userId: currentUser.uid,
          title: 'Order Added to Cart! ðŸ›’',
          body:
              'Your ${service.name} order has been added to cart successfully.',
          type: 'order',
          action: 'order_added',
          data: {
            'orderId': orderId,
            'serviceName': service.name,
            'amount': finalPrice,
          },
        );
      } catch (e) {
        print('Error creating order: $e');
        // Cart item was added successfully, but order creation failed
        // This is okay - the user can still proceed with the cart item
      }
    }

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          '${service.name} added to cart${budget.isNotEmpty ? ' with budget: $budget' : ''}',
        ),
        backgroundColor: const Color(0xFF8B0000),
        action: SnackBarAction(
          label: 'View Cart',
          textColor: Colors.white,
          onPressed: () {
            Navigator.of(context).pop(); // Close current dialog
            Navigator.of(
              context,
            ).push(MaterialPageRoute(builder: (context) => const CartScreen()));
          },
        ),
      ),
    );

    // Clear fields after adding to cart
    _budgetController.clear();
    _projectDescriptionController.clear();
  }

  void _navigateToPaystackPayment(
    Service service,
    Color categoryColor, {
    bool isPriority = false,
    double calculatedPrice = 0.0,
  }) async {
    // Get user information
    final userProfile = AuthService.instance?.userProfile;
    if (userProfile == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please log in to make a payment'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    // Get user ID from Firebase Auth
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please log in to make a payment'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    final userId = currentUser.uid;
    final userEmail = userProfile['email'] as String?;
    final userName = userProfile['name'] as String?;
    final userPhone = userProfile['phone'] as String?;

    if (userEmail == null || userName == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('User information incomplete. Please try again.'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    // Get budget and project description
    final budget = _budgetController.text.trim();
    final projectDescription = _projectDescriptionController.text.trim();

    // Determine final price - use budget if provided, otherwise use service price
    double finalPrice = calculatedPrice > 0 ? calculatedPrice : service.price;
    if (budget.isNotEmpty) {
      try {
        final budgetValue = double.parse(
          budget.replaceAll(RegExp(r'[^\d.]'), ''),
        );
        finalPrice = budgetValue;
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Invalid budget amount. Using service price.'),
            backgroundColor: Color(0xFF8B0000),
          ),
        );
      }
    }

    // Apply Gold Tier discount if applicable
    final isGoldTierActive = userProfile['goldTierActive'] ?? false;
    final goldTierStatus = userProfile['goldTierStatus'] ?? 'inactive';
    final hasGoldTierDiscount = isGoldTierActive && goldTierStatus == 'active';

    if (hasGoldTierDiscount) {
      final discountAmount = finalPrice * 0.10;
      finalPrice = finalPrice - discountAmount;
    }

    // Create cart item for the service
    final cartItem = CartItem(
      id: 'service_${service.name.toLowerCase().replaceAll(' ', '_')}_${DateTime.now().millisecondsSinceEpoch}',
      name: service.name,
      price: finalPrice,
      quantity: 1,
      description: projectDescription,
      budget: budget.isNotEmpty ? budget : null,
      image: 'assets/images/logo.png', // Use default image for services
    );

    // Show loading dialog
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return const AlertDialog(
          backgroundColor: Color(0xFF2A2A2A),
          content: Row(
            children: [
              CircularProgressIndicator(color: Color(0xFF8B0000)),
              SizedBox(width: 20),
              Text(
                'Processing payment...',
                style: TextStyle(color: Colors.white),
              ),
            ],
          ),
        );
      },
    );

    // Process split payment
    final splitResult = await SplitPaymentService.processSplitPayment(
      totalAmount: finalPrice,
      userId: userId,
      userEmail: userEmail,
      userName: userName,
      userPhone: userPhone ?? '',
      cartItems: [cartItem],
    );

    // Close loading dialog
    Navigator.of(context).pop();

    if (!splitResult.success) {
      _handleFailedPayment(splitResult.error ?? 'Payment failed');
      return;
    }

    // Handle different payment scenarios
    if (splitResult.isWalletOnly) {
      // Wallet payment only - complete immediately

      // Create order in Firestore after successful payment
      String? orderId;
      try {
        final currentUser = FirebaseAuth.instance.currentUser;
        if (currentUser != null) {
          final orderData = {
            'userId': currentUser.uid,
            'customerName': currentUser.displayName ?? 'Unknown Customer',
            'customerEmail': currentUser.email ?? 'No email',
            'serviceId': service.id,
            'serviceName': service.name,
            'title': service.name, // Add title field for order display
            'serviceDescription': service.description,
            'projectDescription': projectDescription,
            'originalPrice': service.price,
            'finalPrice': finalPrice,
            'budget': budget.isNotEmpty ? budget : null,
            // Add priority information for Graphics Design services
            if (_isGraphicsService(service.name)) ...{
              'isPriority': isPriority,
              'priorityFee': isPriority ? 100.0 : 0.0,
            },
            'status':
                'pending', // Set to pending for admin review, payment already completed
            'paymentStatus':
                'completed', // Track that payment is already completed
            'createdAt': FieldValue.serverTimestamp(),
            'updatedAt': FieldValue.serverTimestamp(),
          };

          orderId = await FirebaseService.createOrder(orderData);
          print('Order created in Firestore with ID: $orderId');

          // Send notification to admin about new order
          await NotificationService.sendNewOrderNotificationToAdmin(
            orderId: orderId,
            customerName: currentUser.displayName ?? 'Customer',
            serviceName: service.name,
            amount: finalPrice,
          );

          // Create transaction for the order
          await FirebaseService.createTransaction(
            userId: currentUser.uid,
            type: 'debit',
            amount: finalPrice,
            description: 'Payment for ${service.name}',
            orderId: orderId,
          );

          // Add loyalty points for the purchase (10 points per purchase)
          await FirebaseService.addLoyaltyPoints(currentUser.uid, 10);

          // Check for loyalty reward after adding points
          await _checkLoyaltyReward(currentUser.uid);

          // Send loyalty points notification
          await NotificationService.sendLoyaltyPointsNotification(
            userId: currentUser.uid,
            pointsEarned: 10,
            totalPoints: 110, // This would be fetched from user profile
          );

          // Create update notification for admin
          await FirebaseService.createUpdate(
            title: 'New Order Created',
            message:
                '${service.name} order created with ${budget.isNotEmpty ? 'budget: $budget' : 'price: R${finalPrice.toStringAsFixed(2)}'}',
            type: 'order',
            orderId: orderId,
            userId: currentUser.uid,
          );

          // Send notification to user
          await NotificationService.sendPaymentNotification(
            userId: currentUser.uid,
            transactionId: 'ORDER-$orderId',
            status: 'successful',
            amount: finalPrice,
          );
        }
      } catch (e) {
        print('Error creating order: $e');
      }

      await NotificationService.sendPaymentNotification(
        userId: userId,
        transactionId: 'WALLET-${DateTime.now().millisecondsSinceEpoch}',
        status: 'successful',
        amount: finalPrice,
      );

      _showSuccessMessage('Payment completed using wallet funds!');
    } else if (splitResult.isPaystackOnly) {
      // Paystack payment only - navigate to payment screen
      final result = await Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => PaystackPaymentScreen(
            cartItems: [cartItem],
            totalAmount: finalPrice,
            userEmail: userEmail,
            userName: userName,
            userPhone: userPhone ?? '',
            userId: userId,
            paymentType: 'cart',
          ),
        ),
      );

      if (result == true) {
        await NotificationService.sendPaymentNotification(
          userId: userId,
          transactionId: 'PAYSTACK-${DateTime.now().millisecondsSinceEpoch}',
          status: 'successful',
          amount: finalPrice,
        );
        _showSuccessMessage('Payment completed successfully!');
      }
    } else if (splitResult.isSplitPayment) {
      // Split payment - navigate to split payment screen
      final result = await Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => SplitPaymentScreen(
            paystackAuthorizationUrl: splitResult.paystackAuthorizationUrl!,
            paystackReference: splitResult.paystackReference!,
            paystackAmount: splitResult.paystackAmount,
            walletAmount: splitResult.walletAmount,
            totalAmount: finalPrice,
            userId: userId,
            userEmail: userEmail,
            userName: userName,
            userPhone: userPhone ?? '',
            cartItems: [cartItem],
          ),
        ),
      );

      if (result == true) {
        _showSuccessMessage('Split payment completed successfully!');
      }
    }
  }

  void _handleFailedPayment(String errorMessage) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(errorMessage),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 5),
      ),
    );
  }

  void _showYocoPaymentDialog(Service service, Color categoryColor) async {
    // Get user information
    final userProfile = AuthService.instance?.userProfile;
    if (userProfile == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please log in to make a payment'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    // Get user ID from Firebase Auth
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please log in to make a payment'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    final userId = currentUser.uid;
    final userEmail = userProfile['email'] as String?;
    final userName = userProfile['name'] as String?;
    final userPhone = userProfile['phone'] as String?;

    if (userEmail == null || userName == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('User information incomplete. Please try again.'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
      return;
    }

    // Get budget and project description
    final budget = _budgetController.text.trim();
    final projectDescription = _projectDescriptionController.text.trim();

    // Determine final price - use budget if provided, otherwise use service price
    double finalPrice = service.price;
    if (budget.isNotEmpty) {
      try {
        final budgetValue = double.parse(
          budget.replaceAll(RegExp(r'[^\d.]'), ''),
        );
        finalPrice = budgetValue;
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Invalid budget amount. Using service price.'),
            backgroundColor: Color(0xFF8B0000),
          ),
        );
      }
    }

    // Apply Gold Tier discount if applicable
    final isGoldTierActive = userProfile['goldTierActive'] ?? false;
    final goldTierStatus = userProfile['goldTierStatus'] ?? 'inactive';
    final hasGoldTierDiscount = isGoldTierActive && goldTierStatus == 'active';

    if (hasGoldTierDiscount) {
      final discountAmount = finalPrice * 0.10;
      finalPrice = finalPrice - discountAmount;
    }

    // Create cart item for the service
    final cartItem = CartItem(
      id: 'service_${service.name.toLowerCase().replaceAll(' ', '_')}_${DateTime.now().millisecondsSinceEpoch}',
      name: service.name,
      price: finalPrice,
      quantity: 1,
      description: projectDescription,
      budget: budget.isNotEmpty ? budget : null,
      image: 'assets/images/logo.png', // Use default image for services
    );

    try {
      // Show loading dialog
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return AlertDialog(
            backgroundColor: const Color(0xFF2A2A2A),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const CircularProgressIndicator(color: Color(0xFF8B0000)),
                const SizedBox(height: 16),
                Text(
                  'Processing Payment...',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  'R${finalPrice.toStringAsFixed(2)} for ${service.name}',
                  style: const TextStyle(color: Colors.white70, fontSize: 14),
                ),
              ],
            ),
          );
        },
      );

      // Process split payment
      final splitResult = await SplitPaymentService.processSplitPayment(
        totalAmount: finalPrice,
        userId: userId,
        userEmail: userEmail,
        userName: userName,
        userPhone: userPhone ?? '',
        cartItems: [cartItem],
      );

      // Close loading dialog
      Navigator.of(context).pop();

      if (splitResult.success) {
        if (splitResult.isWalletOnly) {
          // Wallet payment only - complete immediately

          // Create order in Firestore after successful payment
          String? orderId;
          try {
            final currentUser = FirebaseAuth.instance.currentUser;
            if (currentUser != null) {
              final orderData = {
                'userId': currentUser.uid,
                'customerName': currentUser.displayName ?? 'Unknown Customer',
                'customerEmail': currentUser.email ?? 'No email',
                'serviceId': service.id,
                'serviceName': service.name,
                'title': service.name, // Add title field for order display
                'serviceDescription': service.description,
                'projectDescription': projectDescription,
                'originalPrice': service.price,
                'finalPrice': finalPrice,
                'budget': budget.isNotEmpty ? budget : null,
                // Note: Priority information not available in this payment method
                'status':
                    'pending', // Set to pending for admin review, payment already completed
                'paymentStatus':
                    'completed', // Track that payment is already completed
                'createdAt': FieldValue.serverTimestamp(),
                'updatedAt': FieldValue.serverTimestamp(),
              };

              orderId = await FirebaseService.createOrder(orderData);
              print('Order created in Firestore with ID: $orderId');

              // Send notification to admin about new order
              await NotificationService.sendNewOrderNotificationToAdmin(
                orderId: orderId,
                customerName: currentUser.displayName ?? 'Customer',
                serviceName: service.name,
                amount: finalPrice,
              );

              // Create transaction for the order
              await FirebaseService.createTransaction(
                userId: currentUser.uid,
                type: 'debit',
                amount: finalPrice,
                description: 'Payment for ${service.name}',
                orderId: orderId,
              );

              // Add loyalty points for the purchase (10 points per purchase)
              await FirebaseService.addLoyaltyPoints(currentUser.uid, 10);

              // Check for loyalty reward after adding points
              await _checkLoyaltyReward(currentUser.uid);

              // Send loyalty points notification
              await NotificationService.sendLoyaltyPointsNotification(
                userId: currentUser.uid,
                pointsEarned: 10,
                totalPoints: 110, // This would be fetched from user profile
              );

              // Create update notification for admin
              await FirebaseService.createUpdate(
                title: 'New Order Created',
                message:
                    '${service.name} order created with ${budget.isNotEmpty ? 'budget: $budget' : 'price: R${finalPrice.toStringAsFixed(2)}'}',
                type: 'order_created',
                userId: currentUser.uid,
                orderId: orderId,
              );

              // Create update notification for user
              await FirebaseService.createUpdate(
                title: 'Order Created',
                message:
                    'Your ${service.name} order has been created successfully.',
                type: 'order_created',
                userId: currentUser.uid,
                orderId: orderId,
              );
            }
          } catch (e) {
            print('Error creating order: $e');
          }

          await NotificationService.sendPaymentNotification(
            userId: userId,
            transactionId: 'WALLET-${DateTime.now().millisecondsSinceEpoch}',
            status: 'successful',
            amount: finalPrice,
          );

          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Payment completed using wallet funds!'),
              backgroundColor: Color(0xFF4CAF50),
            ),
          );
        } else if (splitResult.isPaystackOnly) {
          // Paystack payment only - navigate to payment screen
          final result = await Navigator.of(context).push(
            MaterialPageRoute(
              builder: (context) => PaystackPaymentScreen(
                cartItems: [cartItem],
                totalAmount: finalPrice,
                userEmail: userEmail,
                userName: userName,
                userPhone: userPhone ?? '',
                userId: userId,
                paymentType: 'cart',
              ),
            ),
          );

          if (result == true) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Payment completed successfully!'),
                backgroundColor: Color(0xFF4CAF50),
              ),
            );
          }
        } else if (splitResult.isSplitPayment) {
          // Split payment - navigate to split payment screen
          final result = await Navigator.of(context).push(
            MaterialPageRoute(
              builder: (context) => SplitPaymentScreen(
                paystackAuthorizationUrl: splitResult.paystackAuthorizationUrl!,
                paystackReference: splitResult.paystackReference!,
                paystackAmount: splitResult.paystackAmount,
                walletAmount: splitResult.walletAmount,
                totalAmount: finalPrice,
                userId: userId,
                userEmail: userEmail,
                userName: userName,
                userPhone: userPhone ?? '',
                cartItems: [cartItem],
              ),
            ),
          );

          if (result == true) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Split payment completed successfully!'),
                backgroundColor: Color(0xFF4CAF50),
              ),
            );
          }
        }
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              splitResult.error ?? 'Payment failed. Please try again.',
            ),
            backgroundColor: const Color(0xFF8B0000),
          ),
        );
      }
    } catch (e) {
      // Close loading dialog if still open
      if (Navigator.of(context).canPop()) {
        Navigator.of(context).pop();
      }
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Payment processing error: $e'),
          backgroundColor: const Color(0xFF8B0000),
        ),
      );
    }
  }

  Widget _buildPackageCard(MarketingPackage package, bool isActive) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(20),
        border: Border.all(
          color: package.isPopular
              ? const Color(0xFF8B0000)
              : const Color(0xFF8B0000).withOpacity(0.3),
          width: package.isPopular ? 2 : 1.5,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(isActive ? 0.25 : 0.15),
            blurRadius: isActive ? 25 : 15,
            offset: Offset(0, isActive ? 12 : 8),
            spreadRadius: isActive ? 2 : 1,
          ),
        ],
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF2A2A2A)
                : Colors.white,
            Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF1A1A1A)
                : const Color(0xFFF8F9FA),
          ],
        ),
      ),
      child: Column(
        children: [
          // Popular Badge
          if (package.isPopular)
            Container(
              width: double.infinity,
              padding: const EdgeInsets.symmetric(vertical: 8),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    const Color(0xFF8B0000).withOpacity(0.9),
                    const Color(0xFFB22222).withOpacity(0.8),
                  ],
                ),
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(20),
                ),
                boxShadow: [
                  BoxShadow(
                    color: const Color(0xFF8B0000).withOpacity(0.3),
                    blurRadius: 8,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text('ðŸ”¥', style: TextStyle(fontSize: 16)),
                  const SizedBox(width: 8),
                  Text(
                    'Most Popular',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: ResponsiveUtils.getSmallFontSize(context),
                    ),
                  ),
                ],
              ),
            ),

          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(8),
              child: Column(
                children: [
                  // Package Name
                  Text(
                    package.name,
                    style: TextStyle(
                      fontSize: ResponsiveUtils.getTitleFontSize(context),
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),

                  const SizedBox(height: 4),

                  // Pricing
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 6,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          const Color(0xFF8B0000).withOpacity(0.1),
                          const Color(0xFF8B0000).withOpacity(0.05),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.2),
                        width: 1,
                      ),
                    ),
                    child: Column(
                      children: [
                        Text(
                          'R${package.setupFee.toStringAsFixed(0)}',
                          style: TextStyle(
                            fontSize: 36,
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? const Color(0xFFFFD700) // Gold in dark mode
                                : const Color(0xFF8B0000), // Red in light mode
                          ),
                        ),
                        Text(
                          'Setup Fee',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getSmallFontSize(context),
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'R${package.price.toStringAsFixed(0)}/${package.period}',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            fontWeight: FontWeight.w600,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                        Text(
                          'Ongoing',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getSmallFontSize(context),
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 4),

                  // Features List
                  Expanded(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.start,
                      mainAxisSize: MainAxisSize.min,
                      children: package.features.map((feature) {
                        return Padding(
                          padding: const EdgeInsets.only(bottom: 4),
                          child: Row(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Container(
                                margin: const EdgeInsets.only(top: 2),
                                padding: const EdgeInsets.all(2),
                                decoration: const BoxDecoration(
                                  color: Color(0xFF4CAF50),
                                  shape: BoxShape.circle,
                                ),
                                child: const Icon(
                                  Icons.check,
                                  color: Colors.white,
                                  size: 12,
                                ),
                              ),
                              const SizedBox(width: 8),
                              Expanded(
                                child: Text(
                                  feature,
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getSmallFontSize(
                                      context,
                                    ),
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                    height: 1.3,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                        );
                      }).toList(),
                    ),
                  ),

                  // Get Started Button inside the card
                  const SizedBox(height: 8),
                  SizedBox(
                    width: double.infinity,
                    height: 40,
                    child: ElevatedButton.icon(
                      onPressed: () {
                        _selectPackage(package);
                      },
                      icon: const Text('ðŸš€', style: TextStyle(fontSize: 14)),
                      label: const Text(
                        'Get Started',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Compact landscape version of package card
  Widget _buildLandscapePackageCard(MarketingPackage package, bool isActive) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: package.isPopular
              ? const Color(0xFF8B0000)
              : const Color(0xFF8B0000).withOpacity(0.3),
          width: package.isPopular ? 2 : 1.5,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.15),
            blurRadius: 15,
            offset: const Offset(0, 8),
            spreadRadius: 1,
          ),
        ],
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF2A2A2A)
                : Colors.white,
            Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF1A1A1A)
                : const Color(0xFFF8F9FA),
          ],
        ),
      ),
      child: Column(
        children: [
          // Popular Badge - Compact
          if (package.isPopular)
            Container(
              width: double.infinity,
              padding: const EdgeInsets.symmetric(vertical: 6),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    const Color(0xFF8B0000).withOpacity(0.9),
                    const Color(0xFFB22222).withOpacity(0.8),
                  ],
                ),
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(16),
                ),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text('ðŸ”¥', style: TextStyle(fontSize: 12)),
                  const SizedBox(width: 4),
                  Text(
                    'Popular',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 11,
                    ),
                  ),
                ],
              ),
            ),

          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(12),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  // Package Name & Icon
                  Column(
                    children: [
                      Text(package.icon, style: const TextStyle(fontSize: 24)),
                      const SizedBox(height: 4),
                      Text(
                        package.name,
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),

                  // Compact Pricing
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          const Color(0xFF8B0000).withOpacity(0.1),
                          const Color(0xFF8B0000).withOpacity(0.05),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.2),
                        width: 1,
                      ),
                    ),
                    child: Column(
                      children: [
                        Text(
                          'R${package.setupFee.toStringAsFixed(0)}',
                          style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? const Color(0xFFFFD700)
                                : const Color(0xFF8B0000),
                          ),
                        ),
                        Text(
                          'Setup',
                          style: TextStyle(
                            fontSize: 10,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                          ),
                        ),
                        Text(
                          'R${package.price.toStringAsFixed(0)}/${package.period}',
                          style: TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.w600,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.black87,
                          ),
                        ),
                      ],
                    ),
                  ),

                  // Compact Features - Show only first 3
                  Column(
                    children: package.features.take(3).map((feature) {
                      return Padding(
                        padding: const EdgeInsets.only(bottom: 2),
                        child: Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(1),
                              decoration: const BoxDecoration(
                                color: Color(0xFF4CAF50),
                                shape: BoxShape.circle,
                              ),
                              child: const Icon(
                                Icons.check,
                                color: Colors.white,
                                size: 8,
                              ),
                            ),
                            const SizedBox(width: 4),
                            Expanded(
                              child: Text(
                                feature,
                                style: TextStyle(
                                  fontSize: 10,
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  height: 1.2,
                                ),
                                maxLines: 1,
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                          ],
                        ),
                      );
                    }).toList(),
                  ),

                  // Compact Get Started Button
                  SizedBox(
                    width: double.infinity,
                    height: 32,
                    child: ElevatedButton(
                      onPressed: () {
                        _selectPackage(package);
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(6),
                        ),
                      ),
                      child: const Text(
                        'Get Started',
                        style: TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Service Hub Consultation Card Builder
  Widget _buildServiceHubConsultationCard(String serviceType) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [Color(0xFF8B0000), Color(0xFFB22222)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: const Color(0xFF8B0000).withOpacity(0.3),
            blurRadius: 12,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Icon(
                  Icons.chat_bubble_outline,
                  color: Colors.white,
                  size: 28,
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Need a Custom Quote?',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      'Chat with our team in real-time',
                      style: TextStyle(
                        fontSize: 14,
                        color: Colors.white.withOpacity(0.9),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Text(
            'Get personalized $serviceType solutions tailored to your business needs. '
            'Our experts are ready to discuss your project and provide a detailed quote.',
            style: TextStyle(
              fontSize: 14,
              color: Colors.white.withOpacity(0.95),
              height: 1.5,
            ),
          ),
          const SizedBox(height: 16),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: [
              _buildServiceHubConsultationFeature('Free Consultation'),
              _buildServiceHubConsultationFeature('Custom Quote'),
              _buildServiceHubConsultationFeature('Live Chat'),
            ],
          ),
          const SizedBox(height: 20),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(
                    builder: (context) =>
                        ConsultationRequestScreen(serviceType: serviceType),
                  ),
                );
              },
              icon: const Icon(Icons.chat, size: 20),
              label: const Text(
                'Start Consultation',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
              ),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.white,
                foregroundColor: const Color(0xFF8B0000),
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                elevation: 0,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildServiceHubConsultationFeature(String text) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.2),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white.withOpacity(0.3)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          const Icon(Icons.check_circle, color: Color(0xFFFFD700), size: 14),
          const SizedBox(width: 4),
          Text(
            text,
            style: const TextStyle(
              fontSize: 12,
              color: Colors.white,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMarketingServiceItem(String title, String description) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            margin: const EdgeInsets.only(top: 2),
            padding: const EdgeInsets.all(2),
            decoration: const BoxDecoration(
              color: Color(0xFF8B0000),
              shape: BoxShape.circle,
            ),
            child: const Icon(Icons.check, color: Colors.white, size: 12),
          ),
          const SizedBox(width: 8),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  description,
                  style: TextStyle(
                    fontSize: 13,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _selectPackage(MarketingPackage package) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: Text(
            'Select ${package.name}',
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
            ),
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'You\'ve selected the ${package.name} package with R${package.setupFee.toStringAsFixed(0)} setup fee and R${package.price.toStringAsFixed(0)}/${package.period} ongoing.',
                style: TextStyle(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white70
                      : Colors.black54,
                ),
              ),
              const SizedBox(height: 16),
              Text(
                'This package includes:',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white
                      : Colors.black87,
                ),
              ),
              const SizedBox(height: 8),
              ...package.features
                  .take(3)
                  .map(
                    (feature) => Padding(
                      padding: const EdgeInsets.only(bottom: 4),
                      child: Row(
                        children: [
                          const Icon(
                            Icons.check,
                            color: Color(0xFF4CAF50),
                            size: 16,
                          ),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              feature,
                              style: TextStyle(
                                fontSize: 14,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
              if (package.features.length > 3)
                Text(
                  '... and ${package.features.length - 3} more features',
                  style: TextStyle(
                    fontSize: 12,
                    fontStyle: FontStyle.italic,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                  ),
                ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('Cancel', style: TextStyle(color: Colors.grey)),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.of(context).pop();
                _showSubscriptionAgreement(package);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              child: const Text(
                'Continue',
                style: TextStyle(color: Colors.white),
              ),
            ),
          ],
        );
      },
    );
  }

  void _showSubscriptionAgreement(MarketingPackage package) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: Row(
            children: [
              const Icon(Icons.description, color: Color(0xFF8B0000), size: 24),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  'Subscription Agreement',
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
          content: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                // Package Summary
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000).withOpacity(0.1),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: const Color(0xFF8B0000).withOpacity(0.3),
                    ),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        '${package.name} Package',
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF8B0000),
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Setup Fee: R${package.setupFee.toStringAsFixed(0)}',
                        style: TextStyle(
                          fontSize: 14,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54,
                        ),
                      ),
                      Text(
                        'Monthly Fee: R${package.price.toStringAsFixed(0)}',
                        style: TextStyle(
                          fontSize: 14,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 16),

                // Terms and Conditions
                const Text(
                  'Terms and Conditions',
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 8),

                const Text(
                  'By proceeding with this subscription, you agree to the following terms:',
                  style: TextStyle(fontSize: 14),
                ),
                const SizedBox(height: 12),

                _buildAgreementItem(
                  'â€¢ Setup fee is charged immediately upon subscription',
                ),
                _buildAgreementItem(
                  'â€¢ Monthly fees are charged automatically on the same date each month',
                ),
                _buildAgreementItem(
                  'â€¢ Subscription can be cancelled with 30 days notice',
                ),
                _buildAgreementItem(
                  'â€¢ All services are subject to our standard terms of service',
                ),
                _buildAgreementItem(
                  'â€¢ Payment will be processed securely through Paystack',
                ),
                _buildAgreementItem(
                  'â€¢ You will receive email confirmations for all transactions',
                ),

                const SizedBox(height: 16),

                // Important Notice
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.orange.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.orange.withOpacity(0.3)),
                  ),
                  child: Row(
                    children: [
                      const Icon(Icons.warning, color: Colors.orange, size: 20),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          'Please review all terms before proceeding. By clicking "I Agree", you confirm that you have read and understood these terms.',
                          style: TextStyle(
                            fontSize: 12,
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('Cancel', style: TextStyle(color: Colors.grey)),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.of(context).pop();
                _processSubscriptionPayment(package);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              child: const Text(
                'I Agree',
                style: TextStyle(color: Colors.white),
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildAgreementItem(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 6),
      child: Text(
        text,
        style: TextStyle(
          fontSize: 13,
          color: Theme.of(context).brightness == Brightness.dark
              ? Colors.white70
              : Colors.black54,
        ),
      ),
    );
  }

  void _processSubscriptionPayment(MarketingPackage package) async {
    try {
      // Show loading dialog
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return AlertDialog(
            backgroundColor: Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF2A2A2A)
                : Colors.white,
            content: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const CircularProgressIndicator(color: Color(0xFF8B0000)),
                const SizedBox(height: 16),
                Text(
                  'Setting up your ${package.name} subscription...',
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
              ],
            ),
          );
        },
      );

      // Get current user
      final currentUser = FirebaseAuth.instance.currentUser;
      if (currentUser == null) {
        Navigator.of(context).pop(); // Close loading dialog
        _showErrorMessage('Please log in to subscribe');
        return;
      }

      // Get user data
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser.uid)
          .get();

      if (!userDoc.exists) {
        Navigator.of(context).pop(); // Close loading dialog
        _showErrorMessage('User data not found');
        return;
      }

      final userData = userDoc.data() as Map<String, dynamic>;
      final userEmail = userData['email'] ?? currentUser.email ?? '';
      final userName = userData['name'] ?? currentUser.displayName ?? 'User';

      // Create setup fee transaction only (no delayed subscription yet)
      final setupFeeReference = PaystackService.instance.generateReference();
      final setupFeeTransaction = await PaystackService.instance
          .createTransaction(
            email: userEmail,
            amount: PaystackService.instance.convertToKobo(package.setupFee),
            reference: setupFeeReference,
            firstName: userName.split(' ').first,
            lastName: userName.split(' ').length > 1
                ? userName.split(' ').sublist(1).join(' ')
                : 'Name',
          );

      Navigator.of(context).pop(); // Close loading dialog

      if (setupFeeTransaction != null &&
          setupFeeTransaction['status'] == true) {
        // Navigate to payment screen
        final result = await Navigator.of(context).push(
          MaterialPageRoute(
            builder: (context) => PaystackPaymentScreen(
              cartItems: [], // Empty cart for subscription setup fee
              totalAmount: package.setupFee,
              userEmail: userEmail,
              userName: userName,
              userPhone: userData['phone'] ?? '',
              userId: currentUser.uid,
              paymentType: 'subscription',
            ),
          ),
        );

        // Handle payment result
        if (result == true) {
          // Payment was successful, create delayed subscription
          await _handleSubscriptionPaymentSuccess(
            package: package,
            userEmail: userEmail,
            userName: userName,
            reference: setupFeeReference,
            setupFeeReference: setupFeeReference,
          );
        }
      } else {
        _showErrorMessage('Failed to create payment transaction');
      }
    } catch (e) {
      Navigator.of(context).pop(); // Close loading dialog
      _showErrorMessage('Error: $e');
    }
  }

  Future<Map<String, dynamic>> _createPaystackSubscription({
    required MarketingPackage package,
    required String userEmail,
    required String userName,
  }) async {
    try {
      print('=== CREATING SUBSCRIPTION WITH NEW FLOW ===');
      print('Package: ${package.name}');
      print('Setup Fee: R${package.setupFee.toStringAsFixed(2)}');
      print('Monthly Fee: R${package.price.toStringAsFixed(2)}');

      // Step 1: Process setup fee as normal payment
      final setupFeeReference = PaystackService.instance.generateReference();
      final setupFeeTransaction = await PaystackService.instance
          .createTransaction(
            email: userEmail,
            amount: PaystackService.instance.convertToKobo(package.setupFee),
            reference: setupFeeReference,
            firstName: userName.split(' ').first,
            lastName: userName.split(' ').length > 1
                ? userName.split(' ').sublist(1).join(' ')
                : 'Name',
          );

      if (setupFeeTransaction == null ||
          setupFeeTransaction['status'] != true) {
        return {
          'success': false,
          'message': 'Failed to create setup fee transaction',
        };
      }

      print('Setup fee transaction created successfully');

      // Step 2: Create delayed subscription (monthly starts in 30 days)
      final currentUser = FirebaseAuth.instance.currentUser;
      if (currentUser == null) {
        return {'success': false, 'message': 'User not authenticated'};
      }

      final delayedSubscriptionResult =
          await DelayedSubscriptionService.createDelayedSubscription(
            userId: currentUser.uid,
            userEmail: userEmail,
            userName: userName,
            packageName: package.name,
            monthlyAmount: package.price,
            setupFee: package.setupFee,
            setupFeeReference: setupFeeReference,
          );

      if (!delayedSubscriptionResult['success']) {
        return {
          'success': false,
          'message': delayedSubscriptionResult['message'],
        };
      }

      print('Delayed subscription created successfully');

      // Update user profile with active package
      await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser.uid)
          .update({
            'activePackage': package.name,
            'updatedAt': FieldValue.serverTimestamp(),
          });

      return {
        'success': true,
        'subscriptionId': delayedSubscriptionResult['subscriptionId'],
        'message':
            'Setup fee payment initiated. Monthly subscription will start in 30 days.',
        'customerId': delayedSubscriptionResult['customerId'],
        'planId': delayedSubscriptionResult['planId'],
        'activationDate': delayedSubscriptionResult['activationDate'],
        'authorizationUrl': setupFeeTransaction['data']['authorization_url'],
        'setupFee': package.setupFee,
      };
    } catch (e) {
      print('Error creating subscription: $e');
      return {'success': false, 'message': 'Failed to create subscription: $e'};
    }
  }

  void _showSuccessMessage(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: const Color(0xFF4CAF50),
        duration: const Duration(seconds: 3),
      ),
    );
  }

  void _showErrorMessage(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: const Color(0xFFF44336),
        duration: const Duration(seconds: 3),
      ),
    );
  }

  Future<void> _handleSubscriptionPaymentSuccess({
    required MarketingPackage package,
    required String userEmail,
    required String userName,
    required String reference,
    required String setupFeeReference,
  }) async {
    try {
      print('=== HANDLING SUBSCRIPTION PAYMENT SUCCESS ===');
      print('Package: ${package.name}');
      print('Setup Fee: R${package.setupFee.toStringAsFixed(2)}');
      print('Monthly Fee: R${package.price.toStringAsFixed(2)}');

      // Get current user
      final currentUser = FirebaseAuth.instance.currentUser;
      if (currentUser == null) {
        _showErrorMessage('User not authenticated');
        return;
      }

      // Create delayed subscription (monthly starts in 30 days)
      final delayedSubscriptionResult =
          await DelayedSubscriptionService.createDelayedSubscription(
            userId: currentUser.uid,
            userEmail: userEmail,
            userName: userName,
            packageName: package.name,
            monthlyAmount: package.price,
            setupFee: package.setupFee,
            setupFeeReference: setupFeeReference,
          );

      if (!delayedSubscriptionResult['success']) {
        _showErrorMessage(delayedSubscriptionResult['message']);
        return;
      }

      print('Delayed subscription created successfully');

      // Update user profile with active package
      await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser.uid)
          .update({
            'activePackage': package.name,
            'updatedAt': FieldValue.serverTimestamp(),
          });

      // Show success message
      _showSuccessMessage(
        '${package.name} subscription activated! Monthly billing starts in 30 days.',
      );

      // Send notification
      await NotificationService.sendNotificationToUser(
        userId: currentUser.uid,
        title: 'Package Activated! ðŸŽ‰',
        body: 'Your ${package.name} package has been activated successfully!',
        type: 'upgrade',
        action: 'package_activated',
      );
    } catch (e) {
      print('Error handling subscription payment success: $e');
      _showErrorMessage('Failed to activate subscription: $e');
    }
  }

  /// Check if user is eligible for loyalty reward
  Future<void> _checkLoyaltyReward(String userId) async {
    try {
      final rewardResult =
          await LoyaltyRewardService.checkAndProcessLoyaltyReward(userId);

      if (rewardResult['success']) {
        print('ðŸŽ‰ Loyalty reward processed: ${rewardResult['rewardService']}');

        // Show success message to user
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                'ðŸŽ‰ Congratulations! You\'ve earned a free ${rewardResult['rewardService']} for reaching 2000 loyalty points!',
              ),
              backgroundColor: Colors.green,
              duration: const Duration(seconds: 5),
            ),
          );
        }
      }
    } catch (e) {
      print('Error checking loyalty reward: $e');
    }
  }
}

class ServiceCategory {
  final String id;
  final String name;
  final String description;
  final IconData icon;
  final Color color;
  final List<Service> services;

  ServiceCategory({
    required this.id,
    required this.name,
    required this.description,
    required this.icon,
    required this.color,
    required this.services,
  });
}

class Service {
  final String id;
  final String name;
  final String description;
  final double price;
  final String duration;
  final List<String> features;

  Service({
    required this.id,
    required this.name,
    required this.description,
    required this.price,
    required this.duration,
    required this.features,
  });
}

class MarketingPackage {
  final String id;
  final String name;
  final String icon;
  final double price;
  final double originalPrice;
  final String period;
  final bool isPopular;
  final List<String> features;
  final Color color;
  final String description;
  final String savings;
  final String bestFor;
  final double setupFee;

  MarketingPackage({
    required this.id,
    required this.name,
    required this.icon,
    required this.price,
    required this.originalPrice,
    required this.period,
    required this.isPopular,
    required this.features,
    required this.color,
    this.description = '',
    this.savings = '',
    this.bestFor = '',
    this.setupFee = 0.0,
  });
}

class MarketingServiceModel {
  final String id;
  final String name;
  final String description;
  final double price;
  final String period;
  final IconData icon;
  final List<String> features;

  MarketingServiceModel({
    required this.id,
    required this.name,
    required this.description,
    required this.price,
    required this.period,
    required this.icon,
    required this.features,
  });
}

class GuestScreen extends StatefulWidget {
  const GuestScreen({super.key});

  @override
  State<GuestScreen> createState() => _GuestScreenState();
}

class _GuestScreenState extends State<GuestScreen> {
  final int _currentIndex = 0;
  final GlobalKey<ScaffoldState> _scaffoldKey = GlobalKey<ScaffoldState>();

  // Responsive variables
  bool isMobile = false;
  bool isTablet = false;
  bool isDesktop = false;
  bool isLandscape = false;

  @override
  Widget build(BuildContext context) {
    // Update responsive variables
    isMobile = ResponsiveUtils.isMobile(context);
    isTablet = ResponsiveUtils.isTablet(context);
    isDesktop = ResponsiveUtils.isDesktop(context);
    isLandscape = MediaQuery.of(context).orientation == Orientation.landscape;

    return Scaffold(
      key: _scaffoldKey,
      backgroundColor: Colors.transparent,
      drawer: isLandscape ? null : _buildDrawer(),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              const Color(0xFF8B0000),
              Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF1A1A1A)
                  : const Color(0xFFF5F5F5),
            ],
          ),
        ),
        child: ValueListenableBuilder<ThemeMode>(
          valueListenable: themeModeNotifier,
          builder: (context, themeMode, child) {
            return SafeArea(
              child: isLandscape
                  ? _buildLandscapeLayout()
                  : CustomScrollView(
                      slivers: [
                        // Header Section (scrolls with content)
                        SliverToBoxAdapter(
                          child: Container(
                            padding: ResponsiveUtils.getScreenPadding(context),
                            child: Column(
                              children: [
                                // Top Row with Menu, Profile, and Refresh
                                Row(
                                  crossAxisAlignment: CrossAxisAlignment.center,
                                  children: [
                                    // Profile Picture
                                    Container(
                                      width: isMobile
                                          ? 32
                                          : isTablet
                                          ? 40
                                          : 48,
                                      height: isMobile
                                          ? 32
                                          : isTablet
                                          ? 40
                                          : 48,
                                      decoration: BoxDecoration(
                                        shape: BoxShape.circle,
                                        color: const Color(0xFF8B0000),
                                      ),
                                      child: Icon(
                                        Icons.person,
                                        color: Colors.white,
                                        size: isMobile
                                            ? 18
                                            : isTablet
                                            ? 22
                                            : 24,
                                      ),
                                    ),
                                    SizedBox(
                                      width:
                                          ResponsiveUtils.getSpacing(context) *
                                          1.5,
                                    ),
                                    // Profile Info
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            'Guest User',
                                            style: TextStyle(
                                              color:
                                                  Theme.of(
                                                        context,
                                                      ).brightness ==
                                                      Brightness.dark
                                                  ? Colors.white
                                                  : Colors.black87,
                                              fontSize:
                                                  ResponsiveUtils.getBodyFontSize(
                                                    context,
                                                  ),
                                              fontWeight: FontWeight.bold,
                                            ),
                                          ),
                                          Text(
                                            'Limited Access Mode',
                                            style: TextStyle(
                                              color:
                                                  Theme.of(
                                                        context,
                                                      ).brightness ==
                                                      Brightness.dark
                                                  ? Colors.white70
                                                  : Colors.black54,
                                              fontSize:
                                                  ResponsiveUtils.getSmallFontSize(
                                                    context,
                                                  ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                    // Menu Button
                                    IconButton(
                                      onPressed: () {
                                        _scaffoldKey.currentState!.openDrawer();
                                      },
                                      icon: Icon(
                                        Icons.menu,
                                        color:
                                            Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? Colors.white
                                            : Colors.black87,
                                        size: ResponsiveUtils.getIconSize(
                                          context,
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                                SizedBox(
                                  height:
                                      ResponsiveUtils.getSpacing(context) * 2,
                                ),

                                // Welcome Banner
                                Container(
                                  width: double.infinity,
                                  padding: ResponsiveUtils.getCardPadding(
                                    context,
                                  ),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        const Color(0xFF8B0000),
                                        const Color(0xFFC62828),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(20),
                                    boxShadow: [
                                      BoxShadow(
                                        color: const Color(
                                          0xFF8B0000,
                                        ).withOpacity(0.3),
                                        blurRadius: 15,
                                        offset: const Offset(0, 8),
                                      ),
                                    ],
                                  ),
                                  child: Column(
                                    children: [
                                      Row(
                                        children: [
                                          Container(
                                            padding: const EdgeInsets.all(12),
                                            decoration: BoxDecoration(
                                              color: Colors.white.withOpacity(
                                                0.2,
                                              ),
                                              borderRadius:
                                                  BorderRadius.circular(12),
                                            ),
                                            child: Icon(
                                              Icons.star,
                                              color: Colors.white,
                                              size: ResponsiveUtils.getIconSize(
                                                context,
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 16),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(
                                                  'Welcome to Impact Graphics!',
                                                  style: TextStyle(
                                                    fontSize:
                                                        ResponsiveUtils.getBodyFontSize(
                                                          context,
                                                        ),
                                                    fontWeight: FontWeight.bold,
                                                    color: Colors.white,
                                                  ),
                                                ),
                                                Text(
                                                  'Unlock Premium Features',
                                                  style: TextStyle(
                                                    fontSize:
                                                        ResponsiveUtils.getSmallFontSize(
                                                          context,
                                                        ),
                                                    color: Colors.white
                                                        .withOpacity(0.9),
                                                  ),
                                                ),
                                              ],
                                            ),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 16),
                                      Text(
                                        'Join thousands of satisfied customers and get exclusive access to our premium services, order tracking, wallet features, and more!',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getBodyFontSize(
                                                context,
                                              ),
                                          color: Colors.white.withOpacity(0.95),
                                          height: 1.4,
                                        ),
                                      ),
                                      const SizedBox(height: 20),
                                      Row(
                                        children: [
                                          Expanded(
                                            child: ElevatedButton(
                                              onPressed: () {
                                                Navigator.of(
                                                  context,
                                                ).pushReplacement(
                                                  MaterialPageRoute(
                                                    builder: (context) =>
                                                        const SignUpScreen(),
                                                  ),
                                                );
                                              },
                                              style: ElevatedButton.styleFrom(
                                                backgroundColor: Colors.white,
                                                foregroundColor: const Color(
                                                  0xFF8B0000,
                                                ),
                                                shape: RoundedRectangleBorder(
                                                  borderRadius:
                                                      BorderRadius.circular(12),
                                                ),
                                                padding: EdgeInsets.symmetric(
                                                  vertical: isMobile ? 12 : 16,
                                                ),
                                              ),
                                              child: Text(
                                                'Create Account',
                                                style: TextStyle(
                                                  fontSize:
                                                      ResponsiveUtils.getBodyFontSize(
                                                        context,
                                                      ),
                                                  fontWeight: FontWeight.bold,
                                                ),
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 12),
                                          Expanded(
                                            child: OutlinedButton(
                                              onPressed: () {
                                                Navigator.of(
                                                  context,
                                                ).pushReplacement(
                                                  MaterialPageRoute(
                                                    builder: (context) =>
                                                        const LoginScreen(),
                                                  ),
                                                );
                                              },
                                              style: OutlinedButton.styleFrom(
                                                side: const BorderSide(
                                                  color: Colors.white,
                                                  width: 2,
                                                ),
                                                foregroundColor: Colors.white,
                                                shape: RoundedRectangleBorder(
                                                  borderRadius:
                                                      BorderRadius.circular(12),
                                                ),
                                                padding: EdgeInsets.symmetric(
                                                  vertical: isMobile ? 12 : 16,
                                                ),
                                              ),
                                              child: Text(
                                                'Sign In',
                                                style: TextStyle(
                                                  fontSize:
                                                      ResponsiveUtils.getBodyFontSize(
                                                        context,
                                                      ),
                                                  fontWeight: FontWeight.bold,
                                                ),
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ),
                                SizedBox(
                                  height:
                                      ResponsiveUtils.getSpacing(context) * 2,
                                ),

                                // Premium Features Preview
                                Container(
                                  width: double.infinity,
                                  padding: ResponsiveUtils.getCardPadding(
                                    context,
                                  ),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? const Color(
                                                0xFF2A2A2A,
                                              ).withOpacity(0.9)
                                            : Colors.white.withOpacity(0.95),
                                        Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? const Color(
                                                0xFF1A1A1A,
                                              ).withOpacity(0.9)
                                            : Colors.white.withOpacity(0.9),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(20),
                                    border: Border.all(
                                      color: const Color(
                                        0xFF8B0000,
                                      ).withOpacity(0.2),
                                      width: 1,
                                    ),
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.black.withOpacity(0.1),
                                        blurRadius: 15,
                                        offset: const Offset(0, 6),
                                      ),
                                    ],
                                  ),
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Row(
                                        children: [
                                          Container(
                                            padding: const EdgeInsets.all(8),
                                            decoration: BoxDecoration(
                                              color: const Color(
                                                0xFF8B0000,
                                              ).withOpacity(0.1),
                                              borderRadius:
                                                  BorderRadius.circular(8),
                                            ),
                                            child: Icon(
                                              Icons.diamond,
                                              color: const Color(0xFF8B0000),
                                              size: ResponsiveUtils.getIconSize(
                                                context,
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 12),
                                          Text(
                                            'Premium Features',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getTitleFontSize(
                                                    context,
                                                  ),
                                              fontWeight: FontWeight.w900,
                                              color:
                                                  Theme.of(
                                                        context,
                                                      ).brightness ==
                                                      Brightness.dark
                                                  ? Colors.white
                                                  : Colors.black87,
                                            ),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 16),
                                      _buildFeatureItem(
                                        'Order Tracking',
                                        'Track your orders in real-time',
                                      ),
                                      _buildFeatureItem(
                                        'Wallet & Payments',
                                        'Secure payment processing',
                                      ),
                                      _buildFeatureItem(
                                        'Analytics Dashboard',
                                        'View detailed insights',
                                      ),
                                      _buildFeatureItem(
                                        'Personalized Offers',
                                        'Exclusive deals and discounts',
                                      ),
                                      _buildFeatureItem(
                                        'Priority Support',
                                        '24/7 customer service',
                                      ),
                                      _buildFeatureItem(
                                        'Loyalty Rewards',
                                        'Earn points on every purchase',
                                      ),
                                    ],
                                  ),
                                ),
                                SizedBox(
                                  height:
                                      ResponsiveUtils.getSpacing(context) * 2,
                                ),

                                // Available Services Section
                                Row(
                                  children: [
                                    Container(
                                      padding: const EdgeInsets.all(8),
                                      decoration: BoxDecoration(
                                        color: const Color(
                                          0xFF8B0000,
                                        ).withOpacity(0.1),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      child: Icon(
                                        Icons.explore,
                                        color: const Color(0xFF8B0000),
                                        size: ResponsiveUtils.getIconSize(
                                          context,
                                        ),
                                      ),
                                    ),
                                    const SizedBox(width: 12),
                                    Text(
                                      'Explore Our Services',
                                      style: TextStyle(
                                        fontSize:
                                            ResponsiveUtils.getTitleFontSize(
                                              context,
                                            ),
                                        fontWeight: FontWeight.bold,
                                        color:
                                            Theme.of(context).brightness ==
                                                Brightness.dark
                                            ? Colors.white
                                            : Colors.black87,
                                      ),
                                    ),
                                  ],
                                ),
                                SizedBox(
                                  height: ResponsiveUtils.getSpacing(context),
                                ),

                                // Service Hub and Cart Cards Row
                                Row(
                                  children: [
                                    Expanded(child: _buildServiceHubCard()),
                                    SizedBox(
                                      width: ResponsiveUtils.getSpacing(
                                        context,
                                      ),
                                    ),
                                    Expanded(child: _buildCartCard()),
                                  ],
                                ),
                                SizedBox(
                                  height: ResponsiveUtils.getSpacing(context),
                                ),

                                // Referral Card
                                _buildReferralCard(),
                                SizedBox(
                                  height:
                                      ResponsiveUtils.getSpacing(context) * 2,
                                ),

                                // Call to Action Card
                                Container(
                                  width: double.infinity,
                                  padding: ResponsiveUtils.getCardPadding(
                                    context,
                                  ),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        const Color(
                                          0xFF8B0000,
                                        ).withOpacity(0.1),
                                        const Color(
                                          0xFFC62828,
                                        ).withOpacity(0.05),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(20),
                                    border: Border.all(
                                      color: const Color(
                                        0xFF8B0000,
                                      ).withOpacity(0.3),
                                      width: 2,
                                    ),
                                    boxShadow: [
                                      BoxShadow(
                                        color: const Color(
                                          0xFF8B0000,
                                        ).withOpacity(0.2),
                                        blurRadius: 10,
                                        offset: const Offset(0, 4),
                                      ),
                                    ],
                                  ),
                                  child: Column(
                                    children: [
                                      Row(
                                        children: [
                                          Container(
                                            padding: const EdgeInsets.all(10),
                                            decoration: BoxDecoration(
                                              color: const Color(0xFF8B0000),
                                              borderRadius:
                                                  BorderRadius.circular(12),
                                            ),
                                            child: Icon(
                                              Icons.rocket_launch,
                                              color: Colors.white,
                                              size: ResponsiveUtils.getIconSize(
                                                context,
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 16),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(
                                                  'Ready to Get Started?',
                                                  style: TextStyle(
                                                    fontSize:
                                                        ResponsiveUtils.getBodyFontSize(
                                                          context,
                                                        ),
                                                    fontWeight: FontWeight.bold,
                                                    color:
                                                        Theme.of(
                                                              context,
                                                            ).brightness ==
                                                            Brightness.dark
                                                        ? Colors.white
                                                        : Colors.black87,
                                                  ),
                                                ),
                                                Text(
                                                  'Create your account now!',
                                                  style: TextStyle(
                                                    fontSize:
                                                        ResponsiveUtils.getSmallFontSize(
                                                          context,
                                                        ),
                                                    color:
                                                        Theme.of(
                                                              context,
                                                            ).brightness ==
                                                            Brightness.dark
                                                        ? Colors.white70
                                                        : Colors.black54,
                                                  ),
                                                ),
                                              ],
                                            ),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 16),
                                      Text(
                                        'Join our community and unlock the full potential of Impact Graphics. Get started in less than 2 minutes!',
                                        style: TextStyle(
                                          fontSize:
                                              ResponsiveUtils.getBodyFontSize(
                                                context,
                                              ),
                                          color:
                                              Theme.of(context).brightness ==
                                                  Brightness.dark
                                              ? Colors.white70
                                              : Colors.black54,
                                          height: 1.4,
                                        ),
                                        textAlign: TextAlign.center,
                                      ),
                                      const SizedBox(height: 20),
                                      SizedBox(
                                        width: double.infinity,
                                        child: ElevatedButton.icon(
                                          onPressed: () {
                                            Navigator.of(
                                              context,
                                            ).pushReplacement(
                                              MaterialPageRoute(
                                                builder: (context) =>
                                                    const LoginScreen(),
                                              ),
                                            );
                                          },
                                          icon: Icon(
                                            Icons.person_add,
                                            size: ResponsiveUtils.getIconSize(
                                              context,
                                            ),
                                          ),
                                          label: Text(
                                            'Create Free Account',
                                            style: TextStyle(
                                              fontSize:
                                                  ResponsiveUtils.getBodyFontSize(
                                                    context,
                                                  ),
                                              fontWeight: FontWeight.bold,
                                            ),
                                          ),
                                          style: ElevatedButton.styleFrom(
                                            backgroundColor: const Color(
                                              0xFF8B0000,
                                            ),
                                            foregroundColor: Colors.white,
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(12),
                                            ),
                                            padding: EdgeInsets.symmetric(
                                              vertical: isMobile ? 14 : 18,
                                            ),
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
            );
          },
        ),
      ),
      bottomNavigationBar: null,
    );
  }

  Widget _buildFeatureItem(String title, String description) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        children: [
          Container(
            width: 8,
            height: 8,
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000),
              shape: BoxShape.circle,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getBodyFontSize(context),
                    fontWeight: FontWeight.w600,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
                Text(
                  description,
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getSmallFontSize(context),
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildServiceHubCard() {
    return InkWell(
      onTap: () {
        Navigator.of(context).push(
          MaterialPageRoute(builder: (context) => const ServiceHubScreen()),
        );
      },
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: const Color(0xFF8B0000),
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            if (Theme.of(context).brightness == Brightness.light)
              BoxShadow(
                color: Colors.black.withOpacity(0.08),
                blurRadius: 18,
                offset: const Offset(0, 8),
              ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: const Icon(Icons.store, color: Colors.white, size: 20),
                ),
                const Spacer(),
                const Icon(
                  Icons.arrow_forward_ios,
                  color: Colors.white,
                  size: 14,
                ),
              ],
            ),
            const SizedBox(height: 12),
            const Text(
              'Service Hub',
              style: TextStyle(
                color: Colors.white,
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 4),
            const Text(
              'Browse Services',
              style: TextStyle(color: Colors.white70, fontSize: 12),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCartCard() {
    return InkWell(
      onTap: () {
        Navigator.of(
          context,
        ).push(MaterialPageRoute(builder: (context) => const CartScreen()));
      },
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: const Color(0xFF8B0000),
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            if (Theme.of(context).brightness == Brightness.light)
              BoxShadow(
                color: Colors.black.withOpacity(0.08),
                blurRadius: 18,
                offset: const Offset(0, 8),
              ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: const Icon(
                    Icons.shopping_cart,
                    color: Colors.white,
                    size: 20,
                  ),
                ),
                const Spacer(),
                const Icon(
                  Icons.arrow_forward_ios,
                  color: Colors.white,
                  size: 14,
                ),
              ],
            ),
            const SizedBox(height: 12),
            const Text(
              'Cart',
              style: TextStyle(
                color: Colors.white,
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 4),
            const Text(
              'View Items',
              style: TextStyle(color: Colors.white70, fontSize: 12),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildReferralCard() {
    return InkWell(
      onTap: () {
        Navigator.of(
          context,
        ).push(MaterialPageRoute(builder: (context) => const ReferralScreen()));
      },
      borderRadius: BorderRadius.circular(14),
      child: Container(
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [Color(0xFFB22222), Color(0xFF8B0000)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(14),
          boxShadow: [
            BoxShadow(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.black.withOpacity(0.25)
                  : Colors.black.withOpacity(0.10),
              blurRadius: 16,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.15),
                shape: BoxShape.circle,
              ),
              child: const Icon(Icons.share, color: Colors.white, size: 18),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: const [
                  Text(
                    'Referrals',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    'Share your code & earn exclusive discounts',
                    style: TextStyle(color: Colors.white70, fontSize: 12),
                  ),
                ],
              ),
            ),
            const SizedBox(width: 12),
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 8,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.15),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white.withOpacity(0.2)),
                  ),
                  child: const Text(
                    'EARN UP TO 15% OFF',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                const SizedBox(width: 10),
                const Icon(Icons.chevron_right, color: Colors.white, size: 22),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDrawer() {
    return Drawer(
      backgroundColor: Colors.transparent,
      child: SafeArea(
        child: Container(
          margin: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white.withOpacity(0.08)
                  : Colors.black.withOpacity(0.06),
            ),
            gradient: LinearGradient(
              colors: [
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.06 : 0.4,
                ),
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.02 : 0.2,
                ),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 30,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(20),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
              child: ValueListenableBuilder<ThemeMode>(
                valueListenable: themeModeNotifier,
                builder: (context, themeMode, child) {
                  return Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          borderRadius: const BorderRadius.vertical(
                            top: Radius.circular(20),
                          ),
                          gradient: LinearGradient(
                            colors: [
                              const Color(0xFF8B0000).withOpacity(0.2),
                              Colors.transparent,
                            ],
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                          ),
                        ),
                        child: Row(
                          children: [
                            Container(
                              width: 44,
                              height: 44,
                              decoration: const BoxDecoration(
                                shape: BoxShape.circle,
                                color: Color(0xFF8B0000),
                              ),
                              child: const Icon(
                                Icons.person,
                                color: Colors.white,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text(
                                    'Guest User',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontWeight: FontWeight.bold,
                                      fontSize: 16,
                                    ),
                                  ),
                                  const SizedBox(height: 2),
                                  Container(
                                    padding: const EdgeInsets.symmetric(
                                      horizontal: 8,
                                      vertical: 4,
                                    ),
                                    decoration: BoxDecoration(
                                      color: const Color(
                                        0xFF8B0000,
                                      ).withOpacity(0.12),
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: const Text(
                                      'Limited Access',
                                      style: TextStyle(
                                        color: Color(0xFF8B0000),
                                        fontSize: 11,
                                        fontWeight: FontWeight.w600,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 8),
                      Expanded(
                        child: ListView(
                          padding: const EdgeInsets.symmetric(horizontal: 12),
                          children: [
                            _buildSectionLabel('Available Services'),
                            const SizedBox(height: 6),
                            _buildDrawerItem(
                              icon: Icons.store,
                              label: 'Service Hub',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) =>
                                        const ServiceHubScreen(),
                                  ),
                                );
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.shopping_cart,
                              label: 'Cart',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) => const CartScreen(),
                                  ),
                                );
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.share,
                              label: 'Referral Program',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) =>
                                        const ReferralScreen(),
                                  ),
                                );
                              },
                            ),
                            const SizedBox(height: 14),
                            _buildSectionLabel('Account'),
                            const SizedBox(height: 6),
                            _buildDrawerItem(
                              icon: Icons.logout,
                              label: 'Logout',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).pushReplacement(
                                  MaterialPageRoute(
                                    builder: (context) => const LoginScreen(),
                                  ),
                                );
                              },
                            ),
                          ],
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildSectionLabel(String label) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Text(
        label,
        style: const TextStyle(
          color: Colors.white54,
          fontSize: 12,
          fontWeight: FontWeight.w600,
          letterSpacing: 0.5,
        ),
      ),
    );
  }

  Widget _buildDrawerItem({
    required IconData icon,
    required String label,
    required VoidCallback onTap,
    Widget? trailing,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 4),
      decoration: BoxDecoration(borderRadius: BorderRadius.circular(12)),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        leading: Icon(icon, color: Colors.white70, size: 20),
        title: Text(
          label,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        trailing: trailing,
        onTap: onTap,
      ),
    );
  }

  Widget _buildLandscapeLayout() {
    return Row(
      children: [
        // Left Panel - Welcome and Premium Features (40% width)
        Expanded(
          flex: 4,
          child: Container(
            padding: EdgeInsets.all(ResponsiveUtils.getSpacing(context)),
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header with Profile Info
                  Row(
                    children: [
                      Container(
                        width: isMobile ? 40 : 48,
                        height: isMobile ? 40 : 48,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          color: const Color(0xFF8B0000),
                        ),
                        child: Icon(
                          Icons.person,
                          color: Colors.white,
                          size: isMobile ? 20 : 24,
                        ),
                      ),
                      SizedBox(width: ResponsiveUtils.getSpacing(context)),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Guest User',
                              style: TextStyle(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white
                                    : Colors.black87,
                                fontSize: ResponsiveUtils.getBodyFontSize(
                                  context,
                                ),
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Text(
                              'Limited Access Mode',
                              style: TextStyle(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                                fontSize: ResponsiveUtils.getSmallFontSize(
                                  context,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: ResponsiveUtils.getSpacing(context)),

                  // Welcome Banner
                  Container(
                    width: double.infinity,
                    padding: ResponsiveUtils.getCardPadding(context),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          const Color(0xFF8B0000),
                          const Color(0xFFC62828),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(20),
                      boxShadow: [
                        BoxShadow(
                          color: const Color(0xFF8B0000).withOpacity(0.3),
                          blurRadius: 15,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Colors.white.withOpacity(0.2),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Icon(
                                Icons.star,
                                color: Colors.white,
                                size: ResponsiveUtils.getIconSize(context),
                              ),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Welcome to Impact Graphics!',
                                    style: TextStyle(
                                      fontSize: ResponsiveUtils.getBodyFontSize(
                                        context,
                                      ),
                                      fontWeight: FontWeight.bold,
                                      color: Colors.white,
                                    ),
                                  ),
                                  Text(
                                    'Unlock Premium Features',
                                    style: TextStyle(
                                      fontSize:
                                          ResponsiveUtils.getSmallFontSize(
                                            context,
                                          ),
                                      color: Colors.white.withOpacity(0.9),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Join thousands of satisfied customers and get exclusive access to our premium services, order tracking, wallet features, and more!',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            color: Colors.white.withOpacity(0.95),
                            height: 1.4,
                          ),
                        ),
                        const SizedBox(height: 20),
                        Row(
                          children: [
                            Expanded(
                              child: ElevatedButton(
                                onPressed: () {
                                  Navigator.of(context).pushReplacement(
                                    MaterialPageRoute(
                                      builder: (context) => const LoginScreen(),
                                    ),
                                  );
                                },
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Colors.white,
                                  foregroundColor: const Color(0xFF8B0000),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  padding: EdgeInsets.symmetric(
                                    vertical: isMobile ? 12 : 16,
                                  ),
                                ),
                                child: Text(
                                  'Create Account',
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getBodyFontSize(
                                      context,
                                    ),
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: OutlinedButton(
                                onPressed: () {
                                  Navigator.of(context).pushReplacement(
                                    MaterialPageRoute(
                                      builder: (context) => const LoginScreen(),
                                    ),
                                  );
                                },
                                style: OutlinedButton.styleFrom(
                                  side: const BorderSide(
                                    color: Colors.white,
                                    width: 2,
                                  ),
                                  foregroundColor: Colors.white,
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  padding: EdgeInsets.symmetric(
                                    vertical: isMobile ? 12 : 16,
                                  ),
                                ),
                                child: Text(
                                  'Sign In',
                                  style: TextStyle(
                                    fontSize: ResponsiveUtils.getBodyFontSize(
                                      context,
                                    ),
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  SizedBox(height: ResponsiveUtils.getSpacing(context)),

                  // Premium Features Preview
                  Container(
                    width: double.infinity,
                    padding: ResponsiveUtils.getCardPadding(context),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Theme.of(context).brightness == Brightness.dark
                              ? const Color(0xFF2A2A2A).withOpacity(0.9)
                              : Colors.white.withOpacity(0.95),
                          Theme.of(context).brightness == Brightness.dark
                              ? const Color(0xFF1A1A1A).withOpacity(0.9)
                              : Colors.white.withOpacity(0.9),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(20),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.2),
                        width: 1,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.1),
                          blurRadius: 15,
                          offset: const Offset(0, 6),
                        ),
                      ],
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(8),
                              decoration: BoxDecoration(
                                color: const Color(0xFF8B0000).withOpacity(0.1),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Icon(
                                Icons.diamond,
                                color: const Color(0xFF8B0000),
                                size: ResponsiveUtils.getIconSize(context),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Text(
                              'Premium Features',
                              style: TextStyle(
                                fontSize: ResponsiveUtils.getTitleFontSize(
                                  context,
                                ),
                                fontWeight: FontWeight.w900,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white
                                    : Colors.black87,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 16),
                        _buildFeatureItem(
                          'Order Tracking',
                          'Track your orders in real-time',
                        ),
                        _buildFeatureItem(
                          'Wallet & Payments',
                          'Secure payment processing',
                        ),
                        _buildFeatureItem(
                          'Analytics Dashboard',
                          'View detailed insights',
                        ),
                        _buildFeatureItem(
                          'Personalized Offers',
                          'Exclusive deals and discounts',
                        ),
                        _buildFeatureItem(
                          'Priority Support',
                          '24/7 customer service',
                        ),
                        _buildFeatureItem(
                          'Loyalty Rewards',
                          'Earn points on every purchase',
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),

        // Right Panel - Services and Actions (60% width)
        Expanded(
          flex: 6,
          child: Container(
            padding: EdgeInsets.all(ResponsiveUtils.getSpacing(context)),
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Services Section Header
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: const Color(0xFF8B0000).withOpacity(0.1),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          Icons.explore,
                          color: const Color(0xFF8B0000),
                          size: ResponsiveUtils.getIconSize(context),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Text(
                        'Explore Our Services',
                        style: TextStyle(
                          fontSize: ResponsiveUtils.getTitleFontSize(context),
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black87,
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: ResponsiveUtils.getSpacing(context)),

                  // Service Hub and Cart Cards Row
                  Row(
                    children: [
                      Expanded(child: _buildServiceHubCard()),
                      SizedBox(width: ResponsiveUtils.getSpacing(context)),
                      Expanded(child: _buildCartCard()),
                    ],
                  ),
                  SizedBox(height: ResponsiveUtils.getSpacing(context)),

                  // Referral Card
                  _buildReferralCard(),
                  SizedBox(height: ResponsiveUtils.getSpacing(context)),

                  // Call to Action Card
                  Container(
                    width: double.infinity,
                    padding: ResponsiveUtils.getCardPadding(context),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          const Color(0xFF8B0000).withOpacity(0.1),
                          const Color(0xFFC62828).withOpacity(0.05),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(20),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.3),
                        width: 2,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: const Color(0xFF8B0000).withOpacity(0.2),
                          blurRadius: 10,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Column(
                      children: [
                        Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(10),
                              decoration: BoxDecoration(
                                color: const Color(0xFF8B0000),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Icon(
                                Icons.rocket_launch,
                                color: Colors.white,
                                size: ResponsiveUtils.getIconSize(context),
                              ),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Ready to Get Started?',
                                    style: TextStyle(
                                      fontSize: ResponsiveUtils.getBodyFontSize(
                                        context,
                                      ),
                                      fontWeight: FontWeight.bold,
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white
                                          : Colors.black87,
                                    ),
                                  ),
                                  Text(
                                    'Create your account now!',
                                    style: TextStyle(
                                      fontSize:
                                          ResponsiveUtils.getSmallFontSize(
                                            context,
                                          ),
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white70
                                          : Colors.black54,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Join our community and unlock the full potential of Impact Graphics. Get started in less than 2 minutes!',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getBodyFontSize(context),
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                            height: 1.4,
                          ),
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 20),
                        SizedBox(
                          width: double.infinity,
                          child: ElevatedButton.icon(
                            onPressed: () {
                              Navigator.of(context).pushReplacement(
                                MaterialPageRoute(
                                  builder: (context) => const LoginScreen(),
                                ),
                              );
                            },
                            icon: Icon(
                              Icons.person_add,
                              size: ResponsiveUtils.getIconSize(context),
                            ),
                            label: Text(
                              'Create Free Account',
                              style: TextStyle(
                                fontSize: ResponsiveUtils.getBodyFontSize(
                                  context,
                                ),
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: const Color(0xFF8B0000),
                              foregroundColor: Colors.white,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                              padding: EdgeInsets.symmetric(
                                vertical: isMobile ? 14 : 18,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }
}

class DashboardScreen extends StatefulWidget {
  const DashboardScreen({super.key});

  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen>
    with WidgetsBindingObserver {
  int _currentIndex = 0;
  int _currentServiceTab = 0; // 0 for Marketing, 1 for Development
  int _currentMarketingPackage = 1; // 0=Starter, 1=Growth, 2=Premium
  final GlobalKey<ScaffoldState> _scaffoldKey = GlobalKey<ScaffoldState>();
  late PageController _marketingPackageController;
  String? _currentUserId;

  // User profile data
  String _userName = 'Guest User';
  String _userRole = 'Client';
  String _userTier = 'Silver Tier';
  bool _isLoadingProfile = true;
  String? _profileImageUrl;
  File? _selectedImageFile;
  bool _isUploadingImage = false;

  // Responsive variables
  bool isMobile = false;
  bool isTablet = false;
  bool isDesktop = false;
  bool isLandscape = false;

  // Real-time dashboard data
  int _activeProjects = 0;
  int _loyaltyPoints = 0;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _currentUserId = FirebaseAuth.instance.currentUser?.uid;
    _marketingPackageController = PageController(
      initialPage: 1, // Start with Growth package
      viewportFraction: 0.85,
    );
    _marketingPackageController.addListener(() {
      if (_marketingPackageController.page != null) {
        setState(() {
          _currentMarketingPackage = _marketingPackageController.page!.round();
        });
      }
    });

    // Load user profile
    _loadUserProfile();
    // Load real-time dashboard data
    _loadDashboardData();
    // Setup portfolio notification callback
    _setupPortfolioNotificationCallback();
  }

  void _setupPortfolioNotificationCallback() {
    print('=== SETTING UP PORTFOLIO NAVIGATION CALLBACK (User Dashboard) ===');
    // Set up callback for portfolio notifications
    NotificationService.setPortfolioNavigationCallback((data) {
      print('=== PORTFOLIO NAVIGATION CALLBACK TRIGGERED (User) ===');
      print('Current index before: $_currentIndex');
      print('Navigating to Services Hub (index 1)');
      // Navigate to Services Hub (index 1)
      setState(() {
        _currentIndex = 1; // Services Hub is at index 1
      });
      print('Current index after: $_currentIndex');
    });
    print('Callback set successfully for user dashboard');
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _marketingPackageController.dispose();
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);
    // Refresh user profile when app becomes active to get latest tier information
    if (state == AppLifecycleState.resumed) {
      _loadUserProfile();
    }
  }

  Future<void> _loadUserProfile() async {
    print('Loading user profile for user ID: $_currentUserId');
    if (_currentUserId != null) {
      try {
        final userProfile = await FirebaseService.getUserProfile(
          _currentUserId!,
        );
        print('User profile fetched: ${userProfile?.exists}');
        if (userProfile != null && userProfile.exists) {
          final data = userProfile.data() as Map<String, dynamic>;
          print('User profile data: $data');
          if (mounted) {
            setState(() {
              _userName = data['name'] ?? 'Guest User';
              _userRole = data['role'] ?? 'Client';
              // Determine tier based on Gold Tier subscription status
              final isGoldTierActive = data['goldTierActive'] ?? false;
              final goldTierStatus = data['goldTierStatus'] ?? 'inactive';
              _userTier = (isGoldTierActive && goldTierStatus == 'active')
                  ? 'Gold Tier'
                  : 'Silver Tier';
              _profileImageUrl = data['profileImageUrl'];
              _isLoadingProfile = false;
            });
          }
          print(
            'Profile loaded - Name: $_userName, Role: $_userRole, Tier: $_userTier',
          );
        } else {
          print('User profile does not exist');
          if (mounted) {
            setState(() {
              _isLoadingProfile = false;
            });
          }
        }
      } catch (e) {
        print('Error loading user profile: $e');
        if (mounted) {
          setState(() {
            _isLoadingProfile = false;
          });
        }
      }
    } else {
      print('No current user ID available');
      if (mounted) {
        setState(() {
          _isLoadingProfile = false;
        });
      }
    }
  }

  // Method to refresh user profile (can be called externally)
  Future<void> refreshUserProfile() async {
    await _loadUserProfile();
  }

  Future<void> _handleLogout() async {
    try {
      print('Starting logout process...');

      print('Signing out from Firebase Auth...');
      // Sign out from Firebase Auth
      await FirebaseAuth.instance.signOut();
      print('Firebase Auth sign out completed');

      print('Signing out from Google Sign-In...');
      // Sign out from Google Sign-In
      final GoogleSignIn googleSignIn = GoogleSignIn();
      await googleSignIn.signOut();
      print('Google Sign-In sign out completed');

      print('All logout operations completed successfully');

      print('Navigating to Continue as Guest screen...');
      // Navigate to Continue as Guest screen
      Navigator.of(context).pushAndRemoveUntil(
        MaterialPageRoute(builder: (context) => const GuestScreen()),
        (route) => false,
      );
      print('Navigation completed');

      print('Showing success message...');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Successfully logged out'),
            backgroundColor: Color(0xFF8B0000),
          ),
        );
      }
      print('Logout process completed successfully');
    } catch (e) {
      print('Logout error: $e');
      print('Error stack trace: ${StackTrace.current}');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Logout failed: ${e.toString()}'),
          backgroundColor: const Color(0xFF8B0000),
        ),
      );
    }
  }

  Future<void> _loadDashboardData() async {
    if (_currentUserId != null) {
      try {
        // Load active projects count
        final projects = await FirebaseService.getActiveProjectsCount(
          _currentUserId!,
        );

        // Load loyalty points
        final points = await FirebaseService.getLoyaltyPoints(_currentUserId!);

        if (mounted) {
          setState(() {
            _activeProjects = projects;
            _loyaltyPoints = points;
          });
        }
      } catch (e) {
        print('Error loading dashboard data: $e');
      }
    }
  }

  Future<void> _refreshDashboardData() async {
    await _loadDashboardData();
  }

  Stream<double> _getWalletBalanceStream() {
    if (_currentUserId == null) {
      return Stream.value(0.0);
    }

    return FirebaseFirestore.instance
        .collection('users')
        .doc(_currentUserId!)
        .snapshots()
        .map((snapshot) {
          if (snapshot.exists && snapshot.data() != null) {
            return (snapshot.data()!['walletBalance'] ?? 0.0).toDouble();
          }
          return 0.0;
        });
  }

  // Profile editing methods
  Future<void> _pickImage() async {
    try {
      final ImagePicker picker = ImagePicker();
      final XFile? image = await picker.pickImage(
        source: ImageSource.gallery,
        maxWidth: 1024,
        maxHeight: 1024,
        imageQuality: 90,
      );

      if (image != null) {
        await _cropImage(File(image.path));
      }
    } catch (e) {
      print('Error picking image: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Failed to pick image'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Future<void> _takePhoto() async {
    try {
      final ImagePicker picker = ImagePicker();
      final XFile? image = await picker.pickImage(
        source: ImageSource.camera,
        maxWidth: 1024,
        maxHeight: 1024,
        imageQuality: 90,
      );

      if (image != null) {
        await _cropImage(File(image.path));
      }
    } catch (e) {
      print('Error taking photo: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Failed to take photo'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Future<void> _cropImage(File imageFile) async {
    try {
      final croppedFile = await ImageCropper().cropImage(
        sourcePath: imageFile.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1),
        uiSettings: [
          AndroidUiSettings(
            toolbarTitle: 'Crop Profile Picture',
            toolbarColor: const Color(0xFF8B0000),
            toolbarWidgetColor: Colors.white,
            initAspectRatio: CropAspectRatioPreset.square,
            lockAspectRatio: true,
            backgroundColor: const Color(0xFF1A1A1A),
            activeControlsWidgetColor: const Color(0xFF8B0000),
            cropFrameColor: const Color(0xFF8B0000),
            cropGridColor: const Color(0xFF8B0000).withOpacity(0.5),
          ),
          IOSUiSettings(
            title: 'Crop Profile Picture',
            doneButtonTitle: 'Done',
            cancelButtonTitle: 'Cancel',
            aspectRatioLockEnabled: true,
            resetAspectRatioEnabled: false,
            aspectRatioPickerButtonHidden: true,
            rotateButtonsHidden: false,
            rotateClockwiseButtonHidden: false,
            hidesNavigationBar: false,
          ),
        ],
      );

      if (croppedFile != null) {
        setState(() {
          _selectedImageFile = File(croppedFile.path);
        });
      }
    } catch (e) {
      print('Error cropping image: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Failed to crop image'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Future<String?> _uploadProfileImage() async {
    if (_selectedImageFile == null) return null;

    setState(() {
      _isUploadingImage = true;
    });

    try {
      final userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId == null) return null;

      final storageRef = FirebaseStorage.instance
          .ref()
          .child('profile_images')
          .child('$userId.jpg');

      final uploadTask = storageRef.putFile(_selectedImageFile!);
      final snapshot = await uploadTask;
      final downloadUrl = await snapshot.ref.getDownloadURL();

      // Update user profile in Firestore
      await FirebaseService.updateUserProfile(userId, {
        'profileImageUrl': downloadUrl,
        'updatedAt': FieldValue.serverTimestamp(),
      });

      setState(() {
        _profileImageUrl = downloadUrl;
        _isUploadingImage = false;
      });

      return downloadUrl;
    } catch (e) {
      print('Error uploading profile image: $e');
      setState(() {
        _isUploadingImage = false;
      });
      return null;
    }
  }

  Future<void> _updateUserProfile({
    required String name,
    required String phone,
    String? profileImageUrl,
  }) async {
    try {
      final userId = FirebaseAuth.instance.currentUser?.uid;
      if (userId == null) return;

      final updateData = {
        'name': name,
        'phone': phone,
        'updatedAt': FieldValue.serverTimestamp(),
      };

      if (profileImageUrl != null) {
        updateData['profileImageUrl'] = profileImageUrl;
      }

      await FirebaseService.updateUserProfile(userId, updateData);

      // Reload user profile
      await _loadUserProfile();

      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Profile updated successfully!'),
          backgroundColor: Color(0xFF8B0000),
        ),
      );
    } catch (e) {
      print('Error updating profile: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error updating profile: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _showProfileEditDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Edit Profile',
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Profile Image Section
              GestureDetector(
                onTap: () => _showImagePickerDialog(),
                child: Container(
                  width: 120,
                  height: 120,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: const Color(0xFF1A1A1A),
                    border: Border.all(
                      color: const Color(0xFF8B0000),
                      width: 3,
                    ),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.3),
                        blurRadius: 10,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: _selectedImageFile != null
                      ? ClipOval(
                          child: Image.file(
                            _selectedImageFile!,
                            fit: BoxFit.cover,
                          ),
                        )
                      : _profileImageUrl != null
                      ? ClipOval(
                          child: Image.network(
                            _profileImageUrl!,
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) =>
                                const Icon(
                                  Icons.person,
                                  size: 60,
                                  color: Colors.white70,
                                ),
                          ),
                        )
                      : const Icon(
                          Icons.person,
                          size: 60,
                          color: Colors.white70,
                        ),
                ),
              ),
              const SizedBox(height: 16),
              const Text(
                'Tap to change photo',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: _isUploadingImage
                ? null
                : () async {
                    Navigator.of(context).pop();

                    // Upload image if selected
                    String? imageUrl;
                    if (_selectedImageFile != null) {
                      imageUrl = await _uploadProfileImage();
                    }

                    // Update profile with only the image
                    await _updateUserProfile(
                      name: _userName, // Keep existing name
                      phone: '', // Keep existing phone
                      profileImageUrl: imageUrl,
                    );
                  },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
            ),
            child: _isUploadingImage
                ? const SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                    ),
                  )
                : const Text('Save'),
          ),
        ],
      ),
    );
  }

  void _showImagePickerDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Choose Photo',
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ListTile(
              leading: const Icon(Icons.camera_alt, color: Color(0xFF8B0000)),
              title: const Text(
                'Take Photo',
                style: TextStyle(color: Colors.white),
              ),
              onTap: () {
                Navigator.of(context).pop();
                _takePhoto();
              },
            ),
            ListTile(
              leading: const Icon(
                Icons.photo_library,
                color: Color(0xFF8B0000),
              ),
              title: const Text(
                'Choose from Gallery',
                style: TextStyle(color: Colors.white),
              ),
              onTap: () {
                Navigator.of(context).pop();
                _pickImage();
              },
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // Update responsive variables
    isMobile = ResponsiveUtils.isMobile(context);
    isTablet = ResponsiveUtils.isTablet(context);
    isDesktop = ResponsiveUtils.isDesktop(context);
    isLandscape = MediaQuery.of(context).orientation == Orientation.landscape;

    return Scaffold(
      key: _scaffoldKey,
      backgroundColor: Colors.transparent,
      drawer: isLandscape ? null : _buildDrawer(),
      body: Stack(
        children: [
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  const Color(0xFF8B0000),
                  Theme.of(context).brightness == Brightness.dark
                      ? const Color(0xFF1A1A1A)
                      : const Color(0xFFF5F5F5),
                ],
              ),
            ),
            child: _currentIndex == 0
                ? ValueListenableBuilder<ThemeMode>(
                    valueListenable: themeModeNotifier,
                    builder: (context, themeMode, child) {
                      return SafeArea(
                        child: isLandscape
                            ? _buildLandscapeLayout()
                            : CustomScrollView(
                                slivers: [
                                  // Header Section (scrolls with content)
                                  SliverToBoxAdapter(
                                    child: Container(
                                      padding: ResponsiveUtils.getScreenPadding(
                                        context,
                                      ),
                                      child: Column(
                                        children: [
                                          // Top Row with Menu, Profile, and Refresh
                                          Row(
                                            crossAxisAlignment:
                                                CrossAxisAlignment.center,
                                            children: [
                                              // Profile Picture
                                              GestureDetector(
                                                onTap: () =>
                                                    _showProfileEditDialog(),
                                                child: Stack(
                                                  children: [
                                                    Container(
                                                      width: isMobile
                                                          ? 32
                                                          : isTablet
                                                          ? 40
                                                          : 48,
                                                      height: isMobile
                                                          ? 32
                                                          : isTablet
                                                          ? 40
                                                          : 48,
                                                      decoration: BoxDecoration(
                                                        shape: BoxShape.circle,
                                                        color: const Color(
                                                          0xFF8B0000,
                                                        ),
                                                      ),
                                                      child:
                                                          _profileImageUrl !=
                                                              null
                                                          ? ClipOval(
                                                              child: Image.network(
                                                                _profileImageUrl!,
                                                                fit: BoxFit
                                                                    .cover,
                                                                errorBuilder:
                                                                    (
                                                                      context,
                                                                      error,
                                                                      stackTrace,
                                                                    ) => Icon(
                                                                      Icons
                                                                          .person,
                                                                      color: Colors
                                                                          .white,
                                                                      size:
                                                                          isMobile
                                                                          ? 18
                                                                          : isTablet
                                                                          ? 22
                                                                          : 24,
                                                                    ),
                                                              ),
                                                            )
                                                          : Icon(
                                                              Icons.person,
                                                              color:
                                                                  Colors.white,
                                                              size: isMobile
                                                                  ? 18
                                                                  : isTablet
                                                                  ? 22
                                                                  : 24,
                                                            ),
                                                    ),
                                                    Positioned(
                                                      bottom: 0,
                                                      right: 0,
                                                      child: Container(
                                                        width: isMobile
                                                            ? 12
                                                            : 16,
                                                        height: isMobile
                                                            ? 12
                                                            : 16,
                                                        decoration:
                                                            BoxDecoration(
                                                              color:
                                                                  const Color(
                                                                    0xFF8B0000,
                                                                  ),
                                                              shape: BoxShape
                                                                  .circle,
                                                              border: Border.all(
                                                                color: Colors
                                                                    .white,
                                                                width: 1,
                                                              ),
                                                            ),
                                                        child: Icon(
                                                          Icons.edit,
                                                          color: Colors.white,
                                                          size: isMobile
                                                              ? 8
                                                              : 10,
                                                        ),
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                              ),
                                              SizedBox(
                                                width:
                                                    ResponsiveUtils.getSpacing(
                                                      context,
                                                    ) *
                                                    1.5,
                                              ),
                                              // Profile Info
                                              Expanded(
                                                child: Column(
                                                  crossAxisAlignment:
                                                      CrossAxisAlignment.start,
                                                  children: [
                                                    Text(
                                                      _isLoadingProfile
                                                          ? 'Loading...'
                                                          : _userName,
                                                      style: TextStyle(
                                                        color: Colors.white,
                                                        fontSize:
                                                            ResponsiveUtils.getBodyFontSize(
                                                              context,
                                                            ),
                                                        fontWeight:
                                                            FontWeight.bold,
                                                      ),
                                                    ),
                                                    Text(
                                                      '$_userTier â€¢ $_userRole',
                                                      style: TextStyle(
                                                        color:
                                                            Theme.of(
                                                                  context,
                                                                ).brightness ==
                                                                Brightness.dark
                                                            ? Colors.white70
                                                            : const Color(
                                                                0xFF666666,
                                                              ),
                                                        fontSize:
                                                            ResponsiveUtils.getSmallFontSize(
                                                              context,
                                                            ),
                                                      ),
                                                    ),
                                                  ],
                                                ),
                                              ),
                                              // Theme Switcher Button
                                              IconButton(
                                                icon: Icon(
                                                  themeMode == ThemeMode.dark
                                                      ? Icons.light_mode
                                                      : Icons.dark_mode,
                                                  color: Colors.white,
                                                  size:
                                                      ResponsiveUtils.getIconSize(
                                                        context,
                                                      ),
                                                ),
                                                onPressed: () {
                                                  themeModeNotifier.value =
                                                      themeMode ==
                                                          ThemeMode.dark
                                                      ? ThemeMode.light
                                                      : ThemeMode.dark;
                                                },
                                              ),
                                              SizedBox(
                                                width:
                                                    ResponsiveUtils.getSpacing(
                                                      context,
                                                    ),
                                              ),
                                              // Hamburger Menu moved to right
                                              IconButton(
                                                icon: Icon(
                                                  Icons.menu,
                                                  color: Colors.white,
                                                  size:
                                                      ResponsiveUtils.getIconSize(
                                                        context,
                                                      ),
                                                ),
                                                onPressed: () {
                                                  _scaffoldKey.currentState
                                                      ?.openDrawer();
                                                },
                                              ),
                                            ],
                                          ),
                                          SizedBox(
                                            height: ResponsiveUtils.getSpacing(
                                              context,
                                            ),
                                          ),
                                          // Summary Cards
                                          Row(
                                            children: [
                                              Expanded(
                                                child: _currentUserId == null
                                                    ? _buildSummaryCard(
                                                        title: 'Total Projects',
                                                        value: '0',
                                                        icon:
                                                            Icons.track_changes,
                                                      )
                                                    : StreamBuilder<int>(
                                                        stream:
                                                            FirebaseService.getTotalProjectsCount(
                                                              _currentUserId!,
                                                            ),
                                                        builder: (context, snapshot) {
                                                          return _buildSummaryCard(
                                                            title:
                                                                'Total Projects',
                                                            value:
                                                                snapshot.data
                                                                    ?.toString() ??
                                                                '0',
                                                            icon: Icons
                                                                .track_changes,
                                                          );
                                                        },
                                                      ),
                                              ),
                                              SizedBox(
                                                width:
                                                    ResponsiveUtils.getSpacing(
                                                      context,
                                                    ),
                                              ),
                                              Expanded(
                                                child: _currentUserId == null
                                                    ? _buildSummaryCard(
                                                        title: 'Services Used',
                                                        value: '0',
                                                        icon:
                                                            Icons.network_check,
                                                      )
                                                    : StreamBuilder<int>(
                                                        stream:
                                                            FirebaseService.getTotalServicesUsedCount(
                                                              _currentUserId!,
                                                            ),
                                                        builder: (context, snapshot) {
                                                          return _buildSummaryCard(
                                                            title:
                                                                'Services Used',
                                                            value:
                                                                snapshot.data
                                                                    ?.toString() ??
                                                                '0',
                                                            icon: Icons
                                                                .network_check,
                                                          );
                                                        },
                                                      ),
                                              ),
                                            ],
                                          ),
                                        ],
                                      ),
                                    ),
                                  ),
                                  // Main Content
                                  SliverToBoxAdapter(
                                    child: Padding(
                                      padding: const EdgeInsets.symmetric(
                                        horizontal: 20,
                                      ),
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          // Services Section
                                          _buildSectionTitle('Services'),
                                          const SizedBox(height: 16),
                                          _buildMarketingServiceCard(),
                                          const SizedBox(height: 16),
                                          Row(
                                            children: [
                                              Expanded(
                                                child: _buildSmallServiceCard(
                                                  'Leasing',
                                                  'Gadgets & Equipment',
                                                  Icons.phone_android,
                                                ),
                                              ),
                                              const SizedBox(width: 12),
                                              Expanded(
                                                child: _buildSmallServiceCard(
                                                  'Development',
                                                  'Apps & Websites',
                                                  Icons.grid_view,
                                                ),
                                              ),
                                              const SizedBox(width: 12),
                                              Expanded(
                                                child: _buildSmallServiceCard(
                                                  'My Orders',
                                                  'Track & Manage',
                                                  Icons.receipt_long,
                                                ),
                                              ),
                                            ],
                                          ),
                                          const SizedBox(height: 32),
                                          // Updates & Activity Section
                                          Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.spaceBetween,
                                            children: [
                                              _buildSectionTitle(
                                                'Updates & Activity',
                                              ),
                                              TextButton(
                                                onPressed: () {
                                                  setState(() {
                                                    _currentIndex = 1;
                                                  });
                                                },
                                                child: const Text(
                                                  'View All',
                                                  style: TextStyle(
                                                    color: Color(0xFF8B0000),
                                                    fontWeight: FontWeight.bold,
                                                  ),
                                                ),
                                              ),
                                            ],
                                          ),
                                          const SizedBox(height: 16),
                                          _currentUserId == null
                                              ? _buildActivityCard(
                                                  'No Updates',
                                                  'Please log in to see your updates',
                                                  'no_updates',
                                                )
                                              : StreamBuilder(
                                                  stream:
                                                      FirebaseService.getUpdatesStream(
                                                        _currentUserId!,
                                                      ),
                                                  builder: (context, snapshot) {
                                                    if (snapshot.hasError) {
                                                      return _buildActivityCard(
                                                        'Error Loading Updates',
                                                        'Unable to load updates at this time',
                                                        'error',
                                                      );
                                                    }

                                                    if (snapshot
                                                            .connectionState ==
                                                        ConnectionState
                                                            .waiting) {
                                                      return _buildActivityCard(
                                                        'Loading Updates...',
                                                        'Please wait while we fetch your latest updates',
                                                        'loading',
                                                      );
                                                    }

                                                    final updates =
                                                        snapshot.data?.docs ??
                                                        [];

                                                    if (updates.isEmpty) {
                                                      return _buildActivityCard(
                                                        'No Updates Yet',
                                                        'You\'ll see all your updates and notifications here',
                                                        'no_updates',
                                                      );
                                                    }

                                                    // Show only the latest 3 updates
                                                    final latestUpdates =
                                                        updates
                                                            .take(3)
                                                            .toList();

                                                    return Column(
                                                      children: latestUpdates.map((
                                                        updateDoc,
                                                      ) {
                                                        final updateData =
                                                            updateDoc.data()
                                                                as Map<
                                                                  String,
                                                                  dynamic
                                                                >;
                                                        final update =
                                                            UpdateItem.fromFirestore(
                                                              updateDoc.id,
                                                              updateData,
                                                            );
                                                        return Column(
                                                          children: [
                                                            _buildActivityCardWithUpdate(
                                                              update,
                                                            ),
                                                            if (latestUpdates
                                                                    .indexOf(
                                                                      updateDoc,
                                                                    ) <
                                                                latestUpdates
                                                                        .length -
                                                                    1)
                                                              const SizedBox(
                                                                height: 12,
                                                              ),
                                                          ],
                                                        );
                                                      }).toList(),
                                                    );
                                                  },
                                                ),
                                          const SizedBox(height: 32),
                                          // Personal Dashboard Section with background
                                          _buildPersonalDashboardSection(),
                                          const SizedBox(height: 20),
                                          // Resources & Docs and Chat Support cards (outside Personal Dashboard)
                                          Row(
                                            children: [
                                              Expanded(
                                                child: _buildSupportCard(
                                                  'Resources & Docs',
                                                  'Everything you\'ve received from us',
                                                  Icons.description,
                                                  onTap: () {
                                                    Navigator.of(context).push(
                                                      MaterialPageRoute(
                                                        builder: (context) =>
                                                            const ResourcesDocsScreen(),
                                                      ),
                                                    );
                                                  },
                                                ),
                                              ),
                                              const SizedBox(width: 12),
                                              Expanded(
                                                child: _buildSupportCard(
                                                  'Chat Support',
                                                  'Get Help & Feedback',
                                                  Icons.chat_bubble,
                                                  onTap: () {
                                                    Navigator.of(context).push(
                                                      MaterialPageRoute(
                                                        builder: (context) =>
                                                            const ChatSupportScreen(),
                                                      ),
                                                    );
                                                  },
                                                ),
                                              ),
                                            ],
                                          ),
                                          const SizedBox(height: 16),
                                          // My Orders Card
                                          _buildSupportCard(
                                            'My Orders',
                                            'View & Manage Orders',
                                            Icons.shopping_bag,
                                            onTap: () {
                                              Navigator.of(context).push(
                                                MaterialPageRoute(
                                                  builder: (context) =>
                                                      const MyOrdersScreen(),
                                                ),
                                              );
                                            },
                                          ),
                                          const SizedBox(height: 16),
                                          // Referral Card
                                          _buildReferralCard(),
                                          const SizedBox(height: 16),
                                          // Gold Tier Trial Card
                                          _buildGoldTierCard(),
                                          const SizedBox(height: 16),
                                          // Active Package Card
                                          _buildActivePackageCard(),
                                          const SizedBox(height: 20),
                                        ],
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                      );
                    },
                  )
                : _currentIndex == 1
                ? UpdatesScreen(
                    onBackPressed: () {
                      setState(() {
                        _currentIndex = 0; // Navigate back to dashboard
                      });
                    },
                  )
                : _currentIndex == 2
                ? const CartScreen()
                : _currentIndex == 3
                ? const WalletScreen()
                : _currentIndex == 4
                ? MyOrdersScreen(
                    onBackPressed: () {
                      setState(() {
                        _currentIndex = 0; // Go back to dashboard
                      });
                    },
                  )
                : _currentIndex == 5
                ? _buildPortfolioLinksScreen()
                : _currentIndex == 6
                ? const ProfileScreen()
                : const SizedBox.shrink(),
          ),
        ],
      ),
      bottomNavigationBar: isLandscape ? null : _buildBottomNavigationBar(),
      floatingActionButton: isLandscape ? _buildLandscapeChatFAB() : null,
    );
  }

  Widget _buildLandscapeChatFAB() {
    return FloatingActionButton.extended(
      onPressed: () {
        Navigator.of(context).push(
          MaterialPageRoute(builder: (context) => const ChatSupportScreen()),
        );
      },
      backgroundColor: const Color(0xFF8B0000),
      foregroundColor: Colors.white,
      elevation: 8,
      icon: const Icon(Icons.chat_bubble, size: 24),
      label: const Text(
        'Support',
        style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
      ),
    );
  }

  Widget _buildLandscapeLayout() {
    return GestureDetector(
      onHorizontalDragEnd: (DragEndDetails details) {
        // Detect right-to-left swipe (opening sidebar)
        if (details.primaryVelocity! < -300) {
          _showLandscapeSidebar();
        }
      },
      child: Stack(
        children: [
          Padding(
            padding: const EdgeInsets.only(
              bottom: 88, // 8-point grid: 11 * 8 = 88px for proper spacing
            ), // Add bottom padding to avoid navigation bar overlap with 8-point grid spacing
            child: Row(
              children: [
                // Left Panel - Profile and Summary (smaller on mobile)
                Expanded(
                  flex: isMobile ? 1 : 1,
                  child: Container(
                    padding: EdgeInsets.all(isMobile ? 8 : 16),
                    child: Column(
                      children: [
                        // Profile Section
                        _buildLandscapeProfileSection(),
                        SizedBox(height: isMobile ? 16 : 24),
                        // Personal Dashboard Card
                        Expanded(
                          child: SingleChildScrollView(
                            child: Column(
                              children: [
                                _buildPersonalDashboardSection(),
                                SizedBox(height: isMobile ? 16 : 24),
                                // Gold Tier Card - Positioned at bottom left
                                _buildLandscapeGoldTierCard(),
                                const SizedBox(height: 16),
                                // Active Package Card
                                _buildLandscapeActivePackageCard(),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                // Center Panel - Services Hub Tabs (larger on mobile)
                Expanded(
                  flex: isMobile ? 2 : 2,
                  child: Container(
                    padding: EdgeInsets.all(isMobile ? 8 : 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildSectionTitle('Services Hub'),
                        SizedBox(
                          height: isMobile ? 16 : 16,
                        ), // 8-point grid: 2 * 8 = 16px
                        // Services Hub Tabs
                        Expanded(
                          child: Container(
                            decoration: BoxDecoration(
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? const Color(0xFF2A2A2A)
                                  : Colors.white,
                              borderRadius: BorderRadius.circular(16),
                              border:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Border.all(color: Colors.white10)
                                  : Border.all(color: const Color(0xFFE0E0E0)),
                              boxShadow:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? null
                                  : [
                                      BoxShadow(
                                        color: Colors.black.withOpacity(0.1),
                                        blurRadius: 4,
                                        offset: const Offset(0, 2),
                                      ),
                                    ],
                            ),
                            child: Column(
                              children: [
                                // Tab Bar
                                Container(
                                  padding: const EdgeInsets.all(
                                    8,
                                  ), // 8-point grid: 1 * 8 = 8px
                                  child: Row(
                                    children: [
                                      Expanded(
                                        child: _buildServiceTab(
                                          icon: Icons.trending_up,
                                          label: 'Marketing',
                                          isSelected: _currentServiceTab == 0,
                                          onTap: () => setState(
                                            () => _currentServiceTab = 0,
                                          ),
                                        ),
                                      ),
                                      const SizedBox(width: 8),
                                      Expanded(
                                        child: _buildServiceTab(
                                          icon: Icons.code,
                                          label: 'Development',
                                          isSelected: _currentServiceTab == 1,
                                          onTap: () => setState(
                                            () => _currentServiceTab = 1,
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                                // Tab Content
                                Expanded(
                                  child: _currentServiceTab == 0
                                      ? _buildMarketingTabContent()
                                      : _buildDevelopmentTabContent(),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                // Right Panel - Updates and Support (smaller on mobile)
                Expanded(
                  flex: isMobile ? 1 : 1,
                  child: Container(
                    padding: EdgeInsets.all(isMobile ? 8 : 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildSectionTitle('Updates & Activity'),
                        SizedBox(
                          height: isMobile ? 16 : 16,
                        ), // 8-point grid: 2 * 8 = 16px
                        Expanded(
                          child: _currentUserId == null
                              ? _buildActivityCard(
                                  'No Updates',
                                  'Please log in to see your updates',
                                  'no_updates',
                                )
                              : StreamBuilder(
                                  stream: FirebaseService.getUpdatesStream(
                                    _currentUserId!,
                                  ),
                                  builder: (context, snapshot) {
                                    if (snapshot.hasError) {
                                      return _buildActivityCard(
                                        'Error Loading Updates',
                                        'Unable to load updates at this time',
                                        'error',
                                      );
                                    }

                                    if (snapshot.connectionState ==
                                        ConnectionState.waiting) {
                                      return _buildActivityCard(
                                        'Loading Updates...',
                                        'Please wait while we fetch your latest updates',
                                        'loading',
                                      );
                                    }

                                    final updates = snapshot.data?.docs ?? [];

                                    if (updates.isEmpty) {
                                      return _buildActivityCard(
                                        'No Updates Yet',
                                        'You\'ll see all your updates and notifications here',
                                        'no_updates',
                                      );
                                    }

                                    // Show only the latest 3 updates
                                    final latestUpdates = updates
                                        .take(3)
                                        .toList();

                                    return SingleChildScrollView(
                                      child: Column(
                                        children: latestUpdates.map((
                                          updateDoc,
                                        ) {
                                          final updateData =
                                              updateDoc.data()
                                                  as Map<String, dynamic>;
                                          final update =
                                              UpdateItem.fromFirestore(
                                                updateDoc.id,
                                                updateData,
                                              );
                                          return Column(
                                            children: [
                                              _buildActivityCardWithUpdate(
                                                update,
                                              ),
                                              if (latestUpdates.indexOf(
                                                    updateDoc,
                                                  ) <
                                                  latestUpdates.length - 1)
                                                SizedBox(
                                                  height: isMobile ? 8 : 16,
                                                ),
                                            ],
                                          );
                                        }).toList(),
                                      ),
                                    );
                                  },
                                ),
                        ),
                        SizedBox(
                          height: isMobile ? 16 : 16,
                        ), // 8-point grid: 2 * 8 = 16px
                        // Support Cards
                        Row(
                          children: [
                            Expanded(
                              child: _buildSupportCard(
                                'Resources & Docs',
                                'Everything you\'ve received from us',
                                Icons.description,
                                onTap: () {
                                  Navigator.of(context).push(
                                    MaterialPageRoute(
                                      builder: (context) =>
                                          const ResourcesDocsScreen(),
                                    ),
                                  );
                                },
                              ),
                            ),
                            SizedBox(
                              width: isMobile ? 8 : 16,
                            ), // 8-point grid: 2 * 8 = 16px
                            Expanded(
                              child: _buildSupportCard(
                                'My Orders',
                                'Track your order status',
                                Icons.shopping_bag,
                                onTap: () {
                                  Navigator.of(context).push(
                                    MaterialPageRoute(
                                      builder: (context) =>
                                          const OrdersScreen(),
                                    ),
                                  );
                                },
                              ),
                            ),
                          ],
                        ),
                        SizedBox(
                          height: isMobile ? 16 : 16,
                        ), // 8-point grid: 2 * 8 = 16px
                        // Referral Card - Compact for Landscape
                        _buildLandscapeReferralCard(),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ), // Close Padding widget
          // Floating Navigation Bar for Landscape
          ...(isLandscape ? [_buildFloatingNavigationBar()] : []),
        ],
      ),
    );
  }

  Widget _buildLandscapeProfileSection() {
    return Container(
      padding: EdgeInsets.all(isMobile ? 12 : 16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(isMobile ? 12 : 16),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0), width: 1),
        boxShadow: Theme.of(context).brightness == Brightness.dark
            ? null
            : [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 1),
                ),
              ],
      ),
      child: Row(
        children: [
          Container(
            width: isMobile ? 36 : 48,
            height: isMobile ? 36 : 48,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: const Color(0xFF8B0000),
              border: Border.all(color: const Color(0xFF8B0000), width: 2),
            ),
            child: ClipOval(
              child: _profileImageUrl != null && _profileImageUrl!.isNotEmpty
                  ? Image.network(
                      _profileImageUrl!,
                      fit: BoxFit.cover,
                      loadingBuilder: (context, child, loadingProgress) {
                        if (loadingProgress == null) return child;
                        return const Center(
                          child: CircularProgressIndicator(
                            color: Colors.white,
                            strokeWidth: 2,
                          ),
                        );
                      },
                      errorBuilder: (context, error, stackTrace) => Icon(
                        Icons.person,
                        color: Colors.white,
                        size: isMobile ? 18 : 24,
                      ),
                    )
                  : Icon(
                      Icons.person,
                      color: Colors.white,
                      size: isMobile ? 18 : 24,
                    ),
            ),
          ),
          SizedBox(width: isMobile ? 8 : 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  _isLoadingProfile ? 'Loading...' : _userName,
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                    fontSize: isMobile ? 14 : 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Text(
                  '$_userTier â€¢ $_userRole',
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                    fontSize: isMobile ? 10 : 12,
                  ),
                ),
              ],
            ),
          ),
          ValueListenableBuilder<ThemeMode>(
            valueListenable: themeModeNotifier,
            builder: (context, themeMode, child) {
              return IconButton(
                icon: Icon(
                  themeMode == ThemeMode.dark
                      ? Icons.light_mode
                      : Icons.dark_mode,
                  color: const Color(0xFF8B0000),
                  size: isMobile ? 16 : 20,
                ),
                onPressed: () {
                  themeModeNotifier.value = themeMode == ThemeMode.dark
                      ? ThemeMode.light
                      : ThemeMode.dark;
                },
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildLandscapeSummaryCards() {
    return Column(
      children: [
        StreamBuilder<int>(
          stream: FirebaseService.getActiveProjectsCountStream(_currentUserId!),
          builder: (context, snapshot) {
            return _buildSummaryCard(
              title: 'Active Projects',
              value: snapshot.data?.toString() ?? '0',
              icon: Icons.work,
            );
          },
        ),
        SizedBox(height: isMobile ? 8 : 12),
        StreamBuilder<double>(
          stream: _getWalletBalanceStream(),
          builder: (context, snapshot) {
            if (snapshot.connectionState == ConnectionState.waiting) {
              return _buildSummaryCard(
                title: 'Wallet Balance',
                value: 'Loading...',
                icon: Icons.account_balance_wallet,
              );
            }

            final balance = snapshot.data ?? 0.0;
            return _buildSummaryCard(
              title: 'Wallet Balance',
              value: 'R${balance.toStringAsFixed(2)}',
              icon: Icons.account_balance_wallet,
            );
          },
        ),
        SizedBox(height: isMobile ? 8 : 12),
        _buildSummaryCard(
          title: 'Loyalty Points',
          value: '$_loyaltyPoints',
          icon: Icons.stars,
        ),
      ],
    );
  }

  Widget _buildSummaryCard({
    required String title,
    required String value,
    required IconData icon,
  }) {
    return Container(
      padding: EdgeInsets.all(isMobile && isLandscape ? 8 : 12),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(isMobile && isLandscape ? 8 : 12),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0), width: 1),
        boxShadow: Theme.of(context).brightness == Brightness.dark
            ? null
            : [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 1),
                ),
              ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                icon,
                color: const Color(0xFFC62828),
                size: isMobile && isLandscape ? 12 : 16,
              ),
              SizedBox(width: isMobile && isLandscape ? 4 : 6),
              Expanded(
                child: Text(
                  title,
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : const Color(0xFF666666),
                    fontSize: isMobile && isLandscape ? 9 : 11,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: isMobile && isLandscape ? 4 : 6),
          Text(
            value,
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : const Color(0xFF333333),
              fontSize: isMobile && isLandscape ? 14 : 16,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Text(
      title,
      style: TextStyle(
        color: Colors.white,
        fontSize: 20,
        fontWeight: FontWeight.bold,
      ),
    );
  }

  Widget _buildMarketingServiceCard() {
    return InkWell(
      onTap: () {
        Navigator.of(context).push(
          MaterialPageRoute(builder: (context) => const ServiceHubScreen()),
        );
      },
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: const Color(0xFF8B0000),
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            if (Theme.of(context).brightness == Brightness.light)
              BoxShadow(
                color: Colors.black.withOpacity(0.08),
                blurRadius: 18,
                offset: const Offset(0, 8),
              ),
          ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.2),
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(
                Icons.trending_up,
                color: Colors.white,
                size: 24,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Marketing',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  const Text(
                    'Branding & Campaigns',
                    style: TextStyle(color: Colors.white70, fontSize: 14),
                  ),
                  const SizedBox(height: 8),
                  StreamBuilder<int>(
                    stream: FirebaseService.getActiveProjectsCountStream(
                      _currentUserId!,
                    ),
                    builder: (context, snapshot) {
                      final projectCount = snapshot.data ?? 0;
                      return Text(
                        'Your preferred service â€¢ $projectCount active projects',
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.8),
                          fontSize: 12,
                          fontWeight: FontWeight.w500,
                        ),
                      );
                    },
                  ),
                ],
              ),
            ),
            const Icon(Icons.arrow_forward_ios, color: Colors.white, size: 16),
          ],
        ),
      ),
    );
  }

  Widget _buildSmallServiceCard(String title, String subtitle, IconData icon) {
    return InkWell(
      onTap: () {
        if (title == 'My Orders') {
          Navigator.of(
            context,
          ).push(MaterialPageRoute(builder: (context) => const OrdersScreen()));
        } else if (title == 'Development') {
          Navigator.of(context).push(
            MaterialPageRoute(
              builder: (context) => const ServiceHubScreen(initialTab: 1),
            ),
          );
        } else if (title == 'Leasing') {
          _showComingSoonDialog('Leasing Service');
        }
      },
      borderRadius: BorderRadius.circular(12),
      child: Container(
        height: isMobile && isLandscape ? 70 : 90,
        padding: EdgeInsets.all(isMobile && isLandscape ? 6 : 8),
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Theme.of(context).brightness == Brightness.dark
              ? Border.all(color: Colors.white10)
              : Border.all(color: const Color(0xFFE0E0E0), width: 1),
          boxShadow: Theme.of(context).brightness == Brightness.dark
              ? null
              : [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 4,
                    offset: const Offset(0, 1),
                  ),
                ],
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: EdgeInsets.all(isMobile && isLandscape ? 4 : 5),
              decoration: BoxDecoration(
                color: const Color(0xFFC62828).withOpacity(0.1),
                borderRadius: BorderRadius.circular(5),
              ),
              child: Icon(
                icon,
                color: const Color(0xFFC62828),
                size: isMobile && isLandscape ? 14 : 16,
              ),
            ),
            SizedBox(height: isMobile && isLandscape ? 3 : 4),
            Text(
              title,
              style: TextStyle(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white
                    : const Color(0xFF333333),
                fontSize: isMobile && isLandscape ? 9 : 10,
                fontWeight: FontWeight.bold,
              ),
              textAlign: TextAlign.center,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
            SizedBox(height: isMobile && isLandscape ? 1 : 1),
            Text(
              subtitle,
              style: TextStyle(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white70
                    : const Color(0xFF666666),
                fontSize: isMobile && isLandscape ? 7 : 8,
              ),
              textAlign: TextAlign.center,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildActivityCard(String header, String content, String label) {
    return _buildDashboardActivityCard(header, content, label);
  }

  Widget _buildActivityCardWithUpdate(UpdateItem update) {
    return _buildDashboardActivityCardWithUpdate(update);
  }

  Widget _buildImpactLogo({double size = 24}) {
    return SizedBox(
      width: size,
      height: size,
      child: Image.asset(
        'assets/images/logo.png',
        width: size,
        height: size,
        fit: BoxFit.contain,
      ),
    );
  }

  Widget _buildDashboardActivityCard(
    String header,
    String content,
    String label,
  ) {
    // Determine icon and color based on label/type
    IconData? icon;
    Color iconColor;
    bool isSystemUpdate = false;

    switch (label.toLowerCase()) {
      case 'project':
        icon = Icons.work;
        iconColor = const Color(0xFF8B0000);
        break;
      case 'service':
        icon = Icons.add_circle;
        iconColor = Colors.blue;
        break;
      case 'payment':
        icon = Icons.payment;
        iconColor = Colors.green;
        break;
      case 'loyalty':
        icon = Icons.star;
        iconColor = const Color(0xFFFFD700);
        break;
      case 'system':
        isSystemUpdate = true;
        iconColor = Colors.orange;
        break;
      default:
        icon = Icons.notifications;
        iconColor = const Color(0xFF8B0000);
    }

    return InkWell(
      onTap: () => _showUpdateDialogOld(
        header,
        content,
        label,
        isSystemUpdate ? null : icon,
        iconColor,
      ),
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Theme.of(context).brightness == Brightness.dark
              ? Border.all(color: Colors.white10)
              : Border.all(color: const Color(0xFFE0E0E0), width: 1),
          boxShadow: Theme.of(context).brightness == Brightness.dark
              ? null
              : [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 4,
                    offset: const Offset(0, 1),
                  ),
                ],
        ),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Icon
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: iconColor.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: isSystemUpdate
                  ? _buildImpactLogo(size: 20)
                  : Icon(icon, color: iconColor, size: 20),
            ),
            const SizedBox(width: 12),
            // Content
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    header,
                    style: const TextStyle(
                      color: Color(0xFFC62828),
                      fontSize: 14,
                      fontWeight: FontWeight.bold,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    content,
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : const Color(0xFF666666),
                      fontSize: 13,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            // Click indicator
            Icon(
              Icons.arrow_forward_ios,
              size: 16,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white54
                  : const Color(0xFF999999),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDashboardActivityCardWithUpdate(UpdateItem update) {
    // Determine icon and color based on update type
    IconData? icon;
    Color iconColor;
    bool isSystemUpdate = false;

    switch (update.type.toString().toLowerCase()) {
      case 'updatetype.project':
        icon = Icons.work;
        iconColor = const Color(0xFF8B0000);
        break;
      case 'updatetype.service':
        icon = Icons.add_circle;
        iconColor = Colors.blue;
        break;
      case 'updatetype.payment':
        icon = Icons.payment;
        iconColor = Colors.green;
        break;
      case 'updatetype.loyalty':
        icon = Icons.star;
        iconColor = const Color(0xFFFFD700);
        break;
      case 'updatetype.system':
        isSystemUpdate = true;
        iconColor = Colors.orange;
        break;
      case 'updatetype.portfolio_update':
        icon = Icons.photo_library;
        iconColor = const Color(0xFF9C27B0);
        break;
      case 'updatetype.welcome':
        icon = Icons.waving_hand;
        iconColor = const Color(0xFF4CAF50);
        break;
      default:
        icon = Icons.notifications;
        iconColor = const Color(0xFF8B0000);
    }

    return InkWell(
      onTap: () async {
        // Mark notification as read when clicked
        if (!update.isRead) {
          await NotificationCountService.markNotificationAsRead(update.id);
        }

        // Show the update dialog
        _showUpdateDialogOld(
          update.title,
          update.message,
          update.type.toString().split('.').last,
          isSystemUpdate ? null : icon,
          iconColor,
        );
      },
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Theme.of(context).brightness == Brightness.dark
              ? Border.all(
                  color: update.isRead
                      ? Colors.white10
                      : const Color(0xFF8B0000),
                )
              : Border.all(
                  color: update.isRead
                      ? const Color(0xFFE0E0E0)
                      : const Color(0xFF8B0000),
                  width: update.isRead ? 1 : 2,
                ),
          boxShadow: Theme.of(context).brightness == Brightness.dark
              ? null
              : [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 4,
                    offset: const Offset(0, 1),
                  ),
                ],
        ),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Icon
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: iconColor.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: isSystemUpdate
                  ? _buildImpactLogo(size: 20)
                  : Icon(icon, color: iconColor, size: 20),
            ),
            const SizedBox(width: 12),
            // Content
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Expanded(
                        child: Text(
                          update.title,
                          style: TextStyle(
                            color: update.isRead
                                ? (Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : const Color(0xFF666666))
                                : const Color(0xFFC62828),
                            fontSize: 14,
                            fontWeight: update.isRead
                                ? FontWeight.w500
                                : FontWeight.bold,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      if (!update.isRead)
                        Container(
                          width: 6,
                          height: 6,
                          decoration: const BoxDecoration(
                            color: Color(0xFF8B0000),
                            shape: BoxShape.circle,
                          ),
                        ),
                    ],
                  ),
                  const SizedBox(height: 4),
                  Text(
                    update.message,
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : const Color(0xFF666666),
                      fontSize: 13,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            // Click indicator
            Icon(
              Icons.arrow_forward_ios,
              size: 16,
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white54
                  : const Color(0xFF999999),
            ),
          ],
        ),
      ),
    );
  }

  void _showUpdateDialogOld(
    String title,
    String message,
    String type,
    IconData? icon,
    Color iconColor,
  ) {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          elevation: 0,
          backgroundColor: Colors.transparent,
          child: Container(
            constraints: const BoxConstraints(maxWidth: 400),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF2A2A2A)
                  : Colors.white,
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.2),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Header with gradient background
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(24),
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [Color(0xFF8B0000), Color(0xFFC62828)],
                    ),
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(20),
                      topRight: Radius.circular(20),
                    ),
                  ),
                  child: Row(
                    children: [
                      // Icon
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: type.toLowerCase() == "system"
                            ? _buildImpactLogo(size: 24)
                            : Icon(icon, color: Colors.white, size: 24),
                      ),
                      const SizedBox(width: 16),
                      // Title and type
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              title,
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 8,
                                vertical: 4,
                              ),
                              decoration: BoxDecoration(
                                color: Colors.white.withOpacity(0.2),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Text(
                                type.toUpperCase(),
                                style: const TextStyle(
                                  color: Colors.white,
                                  fontSize: 10,
                                  fontWeight: FontWeight.w600,
                                  letterSpacing: 0.5,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      // Close button
                      IconButton(
                        onPressed: () => Navigator.of(context).pop(),
                        icon: const Icon(Icons.close, color: Colors.white),
                        style: IconButton.styleFrom(
                          backgroundColor: Colors.white.withOpacity(0.2),
                        ),
                      ),
                    ],
                  ),
                ),
                // Content
                Padding(
                  padding: const EdgeInsets.all(24),
                  child: Column(
                    children: [
                      Text(
                        message,
                        style: TextStyle(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : const Color(0xFF333333),
                          fontSize: 16,
                          height: 1.5,
                        ),
                        textAlign: TextAlign.left,
                      ),
                      const SizedBox(height: 24),
                      // Action buttons
                      Row(
                        children: [
                          Expanded(
                            child: OutlinedButton(
                              onPressed: () => Navigator.of(context).pop(),
                              style: OutlinedButton.styleFrom(
                                side: BorderSide(
                                  color: Theme.of(context).primaryColor,
                                ),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                              child: Text(
                                'Close',
                                style: TextStyle(
                                  color: Theme.of(context).primaryColor,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: ElevatedButton(
                              onPressed: () {
                                Navigator.of(context).pop();
                                switch (type.toLowerCase()) {
                                  case 'project':
                                  case 'order':
                                    setState(
                                      () => _currentIndex = 3,
                                    ); // Orders tab
                                    break;
                                  case 'service':
                                    Navigator.of(context).push(
                                      MaterialPageRoute(
                                        builder: (context) =>
                                            const ServiceHubScreen(),
                                      ),
                                    );
                                    break;
                                  case 'payment':
                                    // Handle payment action
                                    break;
                                  default:
                                    setState(
                                      () => _currentIndex = 1,
                                    ); // Updates tab
                                }
                              },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: Theme.of(context).primaryColor,
                                foregroundColor: Colors.white,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                              child: const Text(
                                'View Details',
                                style: TextStyle(fontWeight: FontWeight.w600),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildBottomNavigationBar() {
    final bool isDark = Theme.of(context).brightness == Brightness.dark;
    return Container(
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF2A2A2A) : Colors.white,
        border: Border(
          top: BorderSide(color: isDark ? Colors.white10 : Colors.black12),
        ),
      ),
      child: BottomNavigationBar(
        currentIndex: _currentIndex > 4 ? 0 : _currentIndex,
        onTap: (index) => setState(() => _currentIndex = index),
        type: BottomNavigationBarType.fixed,
        backgroundColor: isDark ? const Color(0xFF2A2A2A) : Colors.white,
        selectedItemColor: Theme.of(context).primaryColor,
        unselectedItemColor: isDark ? Colors.white70 : const Color(0xFF666666),
        selectedLabelStyle: const TextStyle(fontSize: 12),
        unselectedLabelStyle: const TextStyle(fontSize: 12),
        items: [
          BottomNavigationBarItem(
            icon: Icon(Icons.dashboard),
            label: 'Dashboard',
          ),
          BottomNavigationBarItem(
            icon: StreamBuilder<int>(
              stream: NotificationCountService.getUnreadNotificationCount(),
              builder: (context, snapshot) {
                final unreadCount = snapshot.data ?? 0;

                return Stack(
                  children: [
                    const Icon(Icons.notifications),
                    if (unreadCount > 0)
                      Positioned(
                        right: 0,
                        top: 0,
                        child: Container(
                          padding: const EdgeInsets.all(2),
                          decoration: BoxDecoration(
                            color: const Color(0xFF8B0000),
                            borderRadius: BorderRadius.circular(10),
                          ),
                          constraints: const BoxConstraints(
                            minWidth: 16,
                            minHeight: 16,
                          ),
                          child: Text(
                            unreadCount > 99 ? '99+' : '$unreadCount',
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ),
                      ),
                  ],
                );
              },
            ),
            label: 'Updates',
          ),
          BottomNavigationBarItem(
            icon: StreamBuilder<List<CartItem>>(
              stream: CartService.getCartItemsStream(
                FirebaseAuth.instance.currentUser?.uid ?? '',
              ),
              builder: (context, snapshot) {
                final itemCount = snapshot.hasData
                    ? CartService.getItemCount(snapshot.data!)
                    : 0;

                return Stack(
                  children: [
                    const Icon(Icons.shopping_cart),
                    if (itemCount > 0)
                      Positioned(
                        right: 0,
                        top: 0,
                        child: Container(
                          padding: const EdgeInsets.all(2),
                          decoration: BoxDecoration(
                            color: const Color(0xFF8B0000),
                            borderRadius: BorderRadius.circular(10),
                          ),
                          constraints: const BoxConstraints(
                            minWidth: 16,
                            minHeight: 16,
                          ),
                          child: Text(
                            '$itemCount',
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                            ),
                            textAlign: TextAlign.center,
                          ),
                        ),
                      ),
                  ],
                );
              },
            ),
            label: 'Cart',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.account_balance_wallet),
            label: 'Wallet',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.list_alt),
            label: 'My Orders',
          ),
        ],
      ),
    );
  }

  Widget _buildQuickActionCard(
    String title,
    IconData icon,
    VoidCallback onTap,
  ) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Theme.of(context).brightness == Brightness.dark
              ? Border.all(color: Colors.white10)
              : Border.all(color: const Color(0xFFE0E0E0)),
          boxShadow: [
            BoxShadow(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.black.withOpacity(0.2)
                  : Colors.black.withOpacity(0.05),
              blurRadius: 4,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Column(
          children: [
            Icon(icon, color: const Color(0xFF8B0000), size: 32),
            const SizedBox(height: 8),
            Text(
              title,
              style: TextStyle(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white
                    : const Color(0xFF333333),
                fontSize: 12,
                fontWeight: FontWeight.w500,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPersonalDashboardSection() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: Theme.of(context).brightness == Brightness.dark
              ? [const Color(0xFF2B2B2B), const Color(0xFF1F1F1F)]
              : [Colors.white, const Color(0xFFF8F9FA)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0), width: 1),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.black.withOpacity(0.3)
                : Colors.black.withOpacity(0.1),
            blurRadius: 12,
            offset: const Offset(0, 6),
          ),
        ],
      ),
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Personal Dashboard',
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : const Color(0xFF333333),
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: StreamBuilder<int>(
                  stream: FirebaseService.getActiveProjectsCountStream(
                    _currentUserId!,
                  ),
                  builder: (context, snapshot) {
                    return _buildSummaryCard(
                      title: 'Active Projects',
                      value: snapshot.data?.toString() ?? '0',
                      icon: Icons.work,
                    );
                  },
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: StreamBuilder<double>(
                  stream: _getWalletBalanceStream(),
                  builder: (context, snapshot) {
                    if (snapshot.connectionState == ConnectionState.waiting) {
                      return _buildSummaryCard(
                        title: 'Wallet',
                        value: 'Loading...',
                        icon: Icons.account_balance_wallet,
                      );
                    }

                    final balance = snapshot.data ?? 0.0;
                    return _buildSummaryCard(
                      title: 'Wallet',
                      value: 'R${balance.toStringAsFixed(2)}',
                      icon: Icons.account_balance_wallet,
                    );
                  },
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'Loyalty Points',
                style: TextStyle(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white70
                      : const Color(0xFF666666),
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
              ),
              Text(
                '$_loyaltyPoints / 2,000',
                style: TextStyle(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white
                      : const Color(0xFF333333),
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildSupportCard(
    String title,
    String subtitle,
    IconData icon, {
    VoidCallback? onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: 80,
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Theme.of(context).brightness == Brightness.dark
              ? Border.all(color: Colors.white10)
              : Border.all(color: const Color(0xFFE0E0E0), width: 1),
          boxShadow: Theme.of(context).brightness == Brightness.dark
              ? null
              : [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 4,
                    offset: const Offset(0, 1),
                  ),
                ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: const Color(0xFFC62828).withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: const Color(0xFFC62828), size: 20),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white
                          : const Color(0xFF333333),
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : const Color(0xFF666666),
                      fontSize: 10,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildReferralCard() {
    return InkWell(
      onTap: () {
        Navigator.of(
          context,
        ).push(MaterialPageRoute(builder: (context) => const ReferralScreen()));
      },
      borderRadius: BorderRadius.circular(14),
      child: Container(
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [Color(0xFFB22222), Color(0xFF8B0000)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(14),
          boxShadow: [
            BoxShadow(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.black.withOpacity(0.25)
                  : Colors.black.withOpacity(0.10),
              blurRadius: 16,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.15),
                shape: BoxShape.circle,
              ),
              child: const Icon(Icons.share, color: Colors.white, size: 18),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: const [
                  Text(
                    'Referrals',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    'Share your code & earn exclusive discounts',
                    style: TextStyle(color: Colors.white70, fontSize: 12),
                  ),
                ],
              ),
            ),
            const SizedBox(width: 12),
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 8,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.15),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white.withOpacity(0.2)),
                  ),
                  child: const Text(
                    'EARN UP TO 15% OFF',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                const SizedBox(width: 10),
                const Icon(Icons.chevron_right, color: Colors.white, size: 22),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLandscapeReferralCard() {
    return InkWell(
      onTap: () {
        Navigator.of(
          context,
        ).push(MaterialPageRoute(builder: (context) => const ReferralScreen()));
      },
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: EdgeInsets.all(isMobile ? 12 : 16),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [Color(0xFFB22222), Color(0xFF8B0000)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.black.withOpacity(0.25)
                  : Colors.black.withOpacity(0.10),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Container(
                  padding: EdgeInsets.all(isMobile ? 8 : 10),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.15),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    Icons.share,
                    color: Colors.white,
                    size: isMobile ? 16 : 18,
                  ),
                ),
                SizedBox(width: isMobile ? 8 : 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Referrals',
                        style: TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                          fontSize: isMobile ? 12 : 14,
                        ),
                      ),
                      SizedBox(height: 2),
                      Text(
                        'Share your code & earn exclusive discounts',
                        style: TextStyle(
                          color: Colors.white70,
                          fontSize: isMobile ? 10 : 12,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            SizedBox(height: isMobile ? 8 : 12),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Container(
                  padding: EdgeInsets.symmetric(
                    horizontal: isMobile ? 8 : 10,
                    vertical: isMobile ? 6 : 8,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.15),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white.withOpacity(0.2)),
                  ),
                  child: Text(
                    'EARN UP TO 15% OFF',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: isMobile ? 9 : 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                Icon(
                  Icons.chevron_right,
                  color: Colors.white,
                  size: isMobile ? 18 : 20,
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildGoldTierCard() {
    return StreamBuilder<DocumentSnapshot>(
      stream: FirebaseFirestore.instance
          .collection('users')
          .doc(_currentUserId)
          .snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return _buildGoldTierUpgradeCard();
        }

        final userData = snapshot.data!.data() as Map<String, dynamic>?;
        final isGoldTierActive = userData?['goldTierActive'] ?? false;
        final goldTierStatus = userData?['goldTierStatus'] ?? 'inactive';
        final goldTierActivationDate =
            userData?['goldTierActivationDate'] as Timestamp?;
        final trialEndDate = userData?['goldTierTrialEndDate'] as Timestamp?;

        if (isGoldTierActive && goldTierStatus == 'active') {
          return _buildGoldTierActiveCard(goldTierActivationDate);
        } else if (isGoldTierActive && goldTierStatus == 'trial') {
          return _buildGoldTierTrialCard(trialEndDate);
        } else {
          return _buildGoldTierUpgradeCard();
        }
      },
    );
  }

  Widget _buildTrialCountdown(Timestamp trialEndDate) {
    return StreamBuilder<DateTime>(
      stream: Stream.periodic(
        const Duration(seconds: 1),
        (_) => DateTime.now(),
      ),
      builder: (context, snapshot) {
        final now = snapshot.data ?? DateTime.now();
        final trialEnd = trialEndDate.toDate();
        final difference = trialEnd.difference(now);

        if (difference.isNegative) {
          return const Text(
            'Trial Expired',
            style: TextStyle(
              color: Colors.red,
              fontSize: 14,
              fontWeight: FontWeight.bold,
            ),
          );
        }

        final days = difference.inDays;
        final hours = difference.inHours % 24;
        final minutes = difference.inMinutes % 60;

        return Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          decoration: BoxDecoration(
            color: const Color(0xFFFFD700).withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: const Color(0xFFFFD700).withOpacity(0.3)),
          ),
          child: Text(
            'Trial ends in: ${days}d ${hours}h ${minutes}m',
            style: const TextStyle(
              color: Color(0xFFFFD700),
              fontSize: 12,
              fontWeight: FontWeight.bold,
            ),
          ),
        );
      },
    );
  }

  Widget _buildGoldTierTrialCard(Timestamp? trialEndDate) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFFFFD700), width: 1),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.black.withOpacity(0.3)
                : Colors.black.withOpacity(0.08),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: const Color(0xFFFFD700),
                  shape: BoxShape.circle,
                ),
                child: const Icon(Icons.star, color: Colors.black, size: 16),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Row(
                  children: [
                    const Icon(
                      Icons.celebration,
                      color: Color(0xFFFFD700),
                      size: 18,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      'Gold Tier Trial',
                      style: TextStyle(
                        color: Theme.of(context).brightness == Brightness.dark
                            ? const Color(0xFFFFD700)
                            : const Color(0xFF333333),
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: const Color(0xFFFFD700),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Text(
                  'TRIAL ACTIVE',
                  style: TextStyle(
                    color: Colors.black,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Column(
            children: [
              _buildBenefitItem('10% discount on all services'),
              const SizedBox(height: 8),
              _buildBenefitItem('Priority support & faster response'),
              const SizedBox(height: 8),
              _buildBenefitItem('Exclusive access to premium features'),
              const SizedBox(height: 8),
              _buildBenefitItem('Double loyalty points on every purchase'),
            ],
          ),
          const SizedBox(height: 20),
          Center(
            child: Column(
              children: [
                const Text(
                  'Free Trial - 7 Days',
                  style: TextStyle(
                    color: Color(0xFFFFD700),
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                if (trialEndDate != null) ...[
                  _buildTrialCountdown(trialEndDate),
                  const SizedBox(height: 8),
                ],
                Text(
                  'Payment of R299 due after trial â€¢ Enjoy premium benefits!',
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                    fontSize: 12,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
          const SizedBox(height: 20),
          Row(
            children: [
              Expanded(
                child: SizedBox(
                  height: 48,
                  child: ElevatedButton.icon(
                    onPressed: () => _navigateToGoldTierSubscription(),
                    icon: const Icon(
                      Icons.workspace_premium,
                      color: Colors.black,
                      size: 18,
                    ),
                    label: const Text(
                      'UPGRADE NOW',
                      style: TextStyle(
                        color: Colors.black,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFFFD700),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 0,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: SizedBox(
                  height: 48,
                  child: OutlinedButton.icon(
                    onPressed: () => _showCancelTrialDialog(),
                    icon: const Icon(
                      Icons.cancel_outlined,
                      color: Colors.white70,
                      size: 18,
                    ),
                    label: const Text(
                      'CANCEL TRIAL',
                      style: TextStyle(
                        color: Colors.white70,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    style: OutlinedButton.styleFrom(
                      side: const BorderSide(color: Colors.white70),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildGoldTierActiveCard(Timestamp? activationDate) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFF4CAF50), width: 2),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.black.withOpacity(0.3)
                : Colors.black.withOpacity(0.08),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: const Color(0xFF4CAF50),
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.check_circle,
                  color: Colors.white,
                  size: 16,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Row(
                  children: [
                    const Icon(
                      Icons.workspace_premium,
                      color: Color(0xFF4CAF50),
                      size: 18,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      'Gold Tier Active',
                      style: TextStyle(
                        color: Theme.of(context).brightness == Brightness.dark
                            ? const Color(0xFF4CAF50)
                            : const Color(0xFF2E7D32),
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: const Color(0xFF4CAF50),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Text(
                  'ACTIVE',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Column(
            children: [
              _buildBenefitItem('10% discount on all services', isActive: true),
              const SizedBox(height: 8),
              _buildBenefitItem(
                'Priority support & faster response',
                isActive: true,
              ),
              const SizedBox(height: 8),
              _buildBenefitItem(
                'Exclusive access to premium features',
                isActive: true,
              ),
              const SizedBox(height: 8),
              _buildBenefitItem(
                'Double loyalty points on every purchase',
                isActive: true,
              ),
            ],
          ),
          const SizedBox(height: 20),
          // Next payment countdown
          _buildNextPaymentCountdown(activationDate),
          const SizedBox(height: 20),
          Row(
            children: [
              Expanded(
                child: SizedBox(
                  height: 48,
                  child: ElevatedButton.icon(
                    onPressed: () => _showCancelSubscriptionDialog(
                      null,
                      'Gold Tier',
                      'gold_tier',
                    ),
                    icon: const Icon(
                      Icons.cancel_outlined,
                      color: Colors.white,
                      size: 18,
                    ),
                    label: const Text(
                      'CANCEL',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFFF44336),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 0,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: SizedBox(
                  height: 48,
                  child: ElevatedButton.icon(
                    onPressed: () => _showSubscriptionDetails(),
                    icon: const Icon(
                      Icons.info_outline,
                      color: Colors.white,
                      size: 18,
                    ),
                    label: const Text(
                      'DETAILS',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF2196F3),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 0,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildNextPaymentCountdown(Timestamp? activationDate) {
    if (activationDate == null) {
      return Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: const Color(0xFF4CAF50).withOpacity(0.1),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: const Color(0xFF4CAF50).withOpacity(0.3)),
        ),
        child: const Text(
          'Next payment: R299/month',
          style: TextStyle(
            color: Color(0xFF4CAF50),
            fontSize: 14,
            fontWeight: FontWeight.w600,
          ),
          textAlign: TextAlign.center,
        ),
      );
    }

    // Calculate next payment date (30 days from activation)
    final nextPaymentDate = activationDate.toDate().add(
      const Duration(days: 30),
    );
    final now = DateTime.now();
    final daysUntilPayment = nextPaymentDate.difference(now).inDays;

    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: const Color(0xFF4CAF50).withOpacity(0.1),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: const Color(0xFF4CAF50).withOpacity(0.3)),
      ),
      child: Column(
        children: [
          Text(
            'Next payment in $daysUntilPayment days',
            style: const TextStyle(
              color: Color(0xFF4CAF50),
              fontSize: 14,
              fontWeight: FontWeight.w600,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),
          // Animated progress bar
          TweenAnimationBuilder<double>(
            duration: const Duration(milliseconds: 1000),
            tween: Tween(begin: 0.0, end: (30 - daysUntilPayment) / 30),
            builder: (context, value, child) {
              return LinearProgressIndicator(
                value: value,
                backgroundColor: const Color(0xFF4CAF50).withOpacity(0.2),
                valueColor: const AlwaysStoppedAnimation<Color>(
                  Color(0xFF4CAF50),
                ),
                minHeight: 6,
              );
            },
          ),
          const SizedBox(height: 4),
          Text(
            'R299/month â€¢ Auto-renewal',
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : Colors.black54,
              fontSize: 12,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildBenefitItem(String text, {bool isActive = false}) {
    return Row(
      children: [
        Icon(
          Icons.check_circle,
          color: isActive ? const Color(0xFF4CAF50) : const Color(0xFFFFD700),
          size: 16,
        ),
        const SizedBox(width: 8),
        Expanded(
          child: Text(
            text,
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white
                  : Colors.black87,
              fontSize: 14,
              fontWeight: isActive ? FontWeight.w600 : FontWeight.normal,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildGoldTierUpgradeCard() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFFFFD700), width: 2),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.black.withOpacity(0.3)
                : Colors.black.withOpacity(0.08),
            blurRadius: 18,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisSize: MainAxisSize.min,
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: const Color(0xFFFFD700),
                    shape: BoxShape.circle,
                  ),
                  child: const Icon(Icons.star, color: Colors.black, size: 16),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Row(
                    children: [
                      const Icon(
                        Icons.workspace_premium,
                        color: Color(0xFFFFD700),
                        size: 18,
                      ),
                      const SizedBox(width: 4),
                      Expanded(
                        child: Text(
                          'Upgrade to Gold Tier',
                          style: TextStyle(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? const Color(0xFFFFD700)
                                : const Color(0xFF333333),
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                    ],
                  ),
                ),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 6,
                  ),
                  decoration: BoxDecoration(
                    color: const Color(0xFFFFD700),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: const Text(
                    'UPGRADE',
                    style: TextStyle(
                      color: Colors.black,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            Column(
              children: [
                _buildBenefitItem('10% discount on all services'),
                const SizedBox(height: 8),
                _buildBenefitItem('Priority support & faster response'),
                const SizedBox(height: 8),
                _buildBenefitItem('Exclusive access to premium features'),
                const SizedBox(height: 8),
                _buildBenefitItem('Double loyalty points on every purchase'),
              ],
            ),
            const SizedBox(height: 20),
            Center(
              child: Column(
                children: [
                  const Text(
                    'R299/month',
                    style: TextStyle(
                      color: Color(0xFFFFD700),
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    'Unlock all premium features and benefits',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: 12,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
            const SizedBox(height: 20),
            SizedBox(
              width: double.infinity,
              height: 48,
              child: ElevatedButton.icon(
                onPressed: () => _navigateToGoldTierSubscription(),
                icon: const Icon(
                  Icons.workspace_premium,
                  color: Colors.black,
                  size: 18,
                ),
                label: const Text(
                  'UPGRADE NOW',
                  style: TextStyle(
                    color: Colors.black,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFFFD700),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  elevation: 0,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showCancelSubscriptionDialog([
    String? subscriptionId,
    String? packageName,
    String? packageType,
  ]) async {
    String finalPackageName = packageName ?? 'subscription';
    String finalPackageType = packageType ?? 'subscription';

    // Fetch package details if subscription ID is provided and no package info given
    if (subscriptionId != null && packageName == null) {
      try {
        final subscriptionDoc = await FirebaseFirestore.instance
            .collection('delayed_subscriptions')
            .doc(subscriptionId)
            .get();

        if (subscriptionDoc.exists) {
          final data = subscriptionDoc.data() as Map<String, dynamic>;
          finalPackageName = data['packageName'] ?? 'subscription';
          finalPackageType = data['type'] ?? 'subscription';
        }
      } catch (e) {
        print('Error fetching subscription details: $e');
      }
    }

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: const Row(
            children: [
              Icon(Icons.cancel_outlined, color: Colors.red, size: 28),
              SizedBox(width: 10),
              Expanded(
                child: Text(
                  'Cancel Subscription',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          content: Text(
            'Are you sure you want to cancel your $finalPackageName? You will lose access to all premium features and benefits.',
            style: const TextStyle(color: Colors.white70, fontSize: 16),
          ),
          actions: <Widget>[
            TextButton(
              style: TextButton.styleFrom(
                backgroundColor: Colors.grey[600],
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: const Text('Keep Subscription'),
            ),
            TextButton(
              style: TextButton.styleFrom(
                backgroundColor: const Color(0xFFF44336),
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              onPressed: () {
                Navigator.of(context).pop();
                _cancelGoldTierSubscription(
                  subscriptionId,
                  finalPackageName,
                  finalPackageType,
                );
              },
              child: const Text('Cancel Subscription'),
            ),
          ],
        );
      },
    );
  }

  void _showSubscriptionDetails() {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: const Row(
            children: [
              Icon(Icons.info_outline, color: Color(0xFF2196F3), size: 28),
              SizedBox(width: 10),
              Expanded(
                child: Text(
                  'Subscription Details',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          content: const Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Gold Tier Subscription',
                style: TextStyle(
                  color: Color(0xFF4CAF50),
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: 12),
              Text(
                'â€¢ Monthly billing: R299.00',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
              Text(
                'â€¢ Auto-renewal enabled',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
              Text(
                'â€¢ Next payment: 30 days from activation',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
              SizedBox(height: 12),
              Text(
                'Benefits:',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
              SizedBox(height: 8),
              Text(
                'â€¢ 10% discount on all services',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
              Text(
                'â€¢ Priority support & faster response',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
              Text(
                'â€¢ Exclusive access to premium features',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
              Text(
                'â€¢ Double loyalty points on every purchase',
                style: TextStyle(color: Colors.white70, fontSize: 14),
              ),
            ],
          ),
          actions: <Widget>[
            TextButton(
              style: TextButton.styleFrom(
                backgroundColor: const Color(0xFF2196F3),
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              onPressed: () {
                Navigator.of(context).pop();
              },
              child: const Text('Close'),
            ),
          ],
        );
      },
    );
  }

  Future<void> _cancelGoldTierSubscription([
    String? subscriptionId,
    String? packageName,
    String? packageType,
  ]) async {
    try {
      // Show loading dialog
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return const AlertDialog(
            backgroundColor: Color(0xFF2A2A2A),
            content: Row(
              children: [
                CircularProgressIndicator(color: Color(0xFF8B0000)),
                SizedBox(width: 20),
                Text(
                  'Cancelling subscription...',
                  style: TextStyle(color: Colors.white),
                ),
              ],
            ),
          );
        },
      );

      String finalSubscriptionType = packageType ?? 'subscription';
      String finalPackageName = packageName ?? 'subscription';

      // If specific subscription ID provided, update the subscription
      if (subscriptionId != null) {
        await FirebaseFirestore.instance
            .collection('delayed_subscriptions')
            .doc(subscriptionId)
            .update({
              'status': 'cancelled',
              'cancelledAt': FieldValue.serverTimestamp(),
              'updatedAt': FieldValue.serverTimestamp(),
            });
      }

      // Create a transaction record for the cancellation
      await FirebaseFirestore.instance.collection('transactions').add({
        'userId': _currentUserId!,
        'amount': 0.0,
        'transactionId': 'CANCEL_${DateTime.now().millisecondsSinceEpoch}',
        'status': 'completed',
        'type': 'subscription_cancellation',
        'description':
            '$finalPackageName cancelled - access until end of billing period',
        'createdAt': FieldValue.serverTimestamp(),
      });

      // Update Gold tier status if it's a Gold tier subscription
      if (finalSubscriptionType.toLowerCase().contains('gold') ||
          finalPackageName.toLowerCase().contains('gold') ||
          finalPackageName == 'Gold Tier') {
        await FirebaseFirestore.instance
            .collection('users')
            .doc(_currentUserId)
            .update({
              'goldTierActive': false,
              'goldTierStatus': 'cancelled',
              'accountStatus': 'Silver Tier user',
              'goldTierCancellationDate': FieldValue.serverTimestamp(),
              'updatedAt': FieldValue.serverTimestamp(),
            });
      }

      // Close loading dialog
      Navigator.of(context).pop();

      // Show success message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('$finalPackageName cancelled successfully'),
          backgroundColor: Colors.orange,
          duration: const Duration(seconds: 3),
        ),
      );

      // Send appropriate notification based on subscription type
      String notificationTitle = 'Subscription Cancelled';
      String notificationBody =
          'Your $finalPackageName has been cancelled. You will retain access until the end of your current billing period.';

      if (finalSubscriptionType.toLowerCase().contains('gold') ||
          finalPackageName.toLowerCase().contains('gold')) {
        notificationBody =
            'Your Gold Tier subscription has been cancelled. You will retain access until the end of your current billing period.';
      }

      await NotificationService.sendNotificationToUser(
        userId: _currentUserId!,
        title: notificationTitle,
        body: notificationBody,
        type: 'update',
        action: 'subscription_cancelled',
      );
    } catch (e) {
      // Close loading dialog
      Navigator.of(context).pop();

      // Show error message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error cancelling subscription: $e'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  /// Show cancel trial dialog
  void _showCancelTrialDialog() async {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: const Row(
            children: [
              Icon(Icons.cancel_outlined, color: Colors.red, size: 28),
              SizedBox(width: 10),
              Expanded(
                child: Text(
                  'Cancel Gold Tier Trial',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          content: const Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Are you sure you want to cancel your Gold Tier trial?',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(height: 16),
              Text(
                'This will immediately:',
                style: TextStyle(
                  color: Colors.white70,
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
              ),
              SizedBox(height: 8),
              Row(
                children: [
                  Icon(Icons.remove, color: Colors.red, size: 16),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'Remove 10% discount on all services',
                      style: TextStyle(color: Colors.white70, fontSize: 14),
                    ),
                  ),
                ],
              ),
              SizedBox(height: 4),
              Row(
                children: [
                  Icon(Icons.remove, color: Colors.red, size: 16),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'Remove priority support access',
                      style: TextStyle(color: Colors.white70, fontSize: 14),
                    ),
                  ),
                ],
              ),
              SizedBox(height: 4),
              Row(
                children: [
                  Icon(Icons.remove, color: Colors.red, size: 16),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'Remove exclusive premium features',
                      style: TextStyle(color: Colors.white70, fontSize: 14),
                    ),
                  ),
                ],
              ),
              SizedBox(height: 16),
              Text(
                'You can upgrade anytime to regain these benefits.',
                style: TextStyle(
                  color: Colors.white60,
                  fontSize: 12,
                  fontStyle: FontStyle.italic,
                ),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text(
                'Keep Trial',
                style: TextStyle(
                  color: Colors.white70,
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
            ElevatedButton(
              onPressed: () => _cancelGoldTierTrial(),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.red,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 12,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              child: const Text(
                'Cancel Trial',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
              ),
            ),
          ],
        );
      },
    );
  }

  /// Cancel Gold Tier trial
  Future<void> _cancelGoldTierTrial() async {
    try {
      // Show loading dialog
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return const AlertDialog(
            backgroundColor: Color(0xFF2A2A2A),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.all(Radius.circular(16)),
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                CircularProgressIndicator(color: Color(0xFF8B0000)),
                SizedBox(height: 16),
                Text(
                  'Cancelling trial...',
                  style: TextStyle(color: Colors.white),
                ),
              ],
            ),
          );
        },
      );

      // Cancel trial using the service
      final success = await GoldTierTrialService.cancelTrial(_currentUserId!);

      // Close loading dialog
      Navigator.of(context).pop();

      if (success) {
        // Close the cancel dialog
        Navigator.of(context).pop();

        // Show success message
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Gold Tier trial cancelled successfully'),
            backgroundColor: Colors.orange,
            duration: Duration(seconds: 3),
          ),
        );

        // Refresh the UI
        setState(() {});
      } else {
        // Close the cancel dialog
        Navigator.of(context).pop();

        // Show error message
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Failed to cancel trial. Please try again.'),
            backgroundColor: Colors.red,
            duration: Duration(seconds: 3),
          ),
        );
      }
    } catch (e) {
      // Close loading dialog
      Navigator.of(context).pop();

      // Close the cancel dialog
      Navigator.of(context).pop();

      // Show error message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error cancelling trial: $e'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  /// Show coming soon dialog
  void _showComingSoonDialog(String serviceName) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: Row(
            children: [
              Icon(
                Icons.schedule,
                color: Theme.of(context).brightness == Brightness.dark
                    ? const Color(0xFF8B0000)
                    : const Color(0xFF8B0000),
                size: 28,
              ),
              const SizedBox(width: 10),
              Expanded(
                child: Text(
                  'Coming Soon',
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.construction,
                size: 64,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white54
                    : Colors.grey,
              ),
              const SizedBox(height: 16),
              Text(
                '$serviceName is currently under development.',
                style: TextStyle(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white70
                      : Colors.black54,
                  fontSize: 16,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 8),
              Text(
                'We\'re working hard to bring you this exciting new feature. Stay tuned for updates!',
                style: TextStyle(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.white54
                      : Colors.black45,
                  fontSize: 14,
                ),
                textAlign: TextAlign.center,
              ),
            ],
          ),
          actions: [
            ElevatedButton(
              onPressed: () {
                Navigator.of(context).pop();
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 12,
                ),
              ),
              child: const Text('Got it!'),
            ),
          ],
        );
      },
    );
  }

  Widget _buildLandscapeGoldTierCard() {
    return Container(
      padding: EdgeInsets.all(isMobile ? 8 : 12), // Reduced padding
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFFFFD700), width: 1),
        boxShadow: [
          BoxShadow(
            color: Theme.of(context).brightness == Brightness.dark
                ? Colors.black.withOpacity(0.3)
                : Colors.black.withOpacity(0.08),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: EdgeInsets.all(isMobile ? 6 : 8),
                decoration: BoxDecoration(
                  color: const Color(0xFFFFD700),
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Icons.star,
                  color: Colors.black,
                  size: isMobile ? 12 : 14, // Reduced icon size
                ),
              ),
              SizedBox(width: isMobile ? 8 : 12),
              Expanded(
                child: Row(
                  children: [
                    Icon(
                      Icons.celebration,
                      color: const Color(0xFFFFD700),
                      size: isMobile ? 14 : 16, // Reduced icon size
                    ),
                    SizedBox(width: isMobile ? 3 : 4),
                    Expanded(
                      child: Text(
                        'Gold Tier Trial',
                        style: TextStyle(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? const Color(0xFFFFD700)
                              : const Color(0xFF333333),
                          fontSize: isMobile ? 14 : 16,
                          fontWeight: FontWeight.bold,
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          // Tier status label moved to the right
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              Container(
                padding: EdgeInsets.symmetric(
                  horizontal: isMobile ? 6 : 8,
                  vertical: isMobile ? 4 : 6,
                ),
                decoration: BoxDecoration(
                  color: const Color(0xFFFFD700),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  'TRIAL',
                  style: TextStyle(
                    color: Colors.black,
                    fontSize: isMobile ? 8 : 9,
                    fontWeight: FontWeight.bold,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          SizedBox(height: isMobile ? 8 : 12), // Reduced spacing
          // Compact benefits list
          Column(
            children: [
              _buildLandscapeBenefitItem('10% discount on all services'),
              SizedBox(height: isMobile ? 4 : 6), // Reduced spacing
              _buildLandscapeBenefitItem('Priority support & faster response'),
              SizedBox(height: isMobile ? 4 : 6), // Reduced spacing
              _buildLandscapeBenefitItem(
                'Exclusive access to premium features',
              ),
            ],
          ),
          SizedBox(height: isMobile ? 8 : 12), // Reduced spacing
          // Compact trial info - centered
          Center(
            child: Container(
              padding: EdgeInsets.all(isMobile ? 6 : 8), // Reduced padding
              decoration: BoxDecoration(
                color: const Color(0xFFFFD700).withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: const Color(0xFFFFD700).withOpacity(0.3),
                ),
              ),
              child: Column(
                children: [
                  Text(
                    'Free Trial - 7 Days',
                    style: TextStyle(
                      color: const Color(0xFFFFD700),
                      fontSize: isMobile ? 14 : 16,
                      fontWeight: FontWeight.bold,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  SizedBox(height: isMobile ? 2 : 4), // Reduced spacing
                  Text(
                    'R299 due after trial',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: isMobile ? 10 : 12,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          ),
          SizedBox(height: isMobile ? 8 : 12), // Reduced spacing
          SizedBox(
            width: double.infinity,
            height: isMobile ? 32 : 36, // Reduced button height
            child: ElevatedButton.icon(
              onPressed: () => _navigateToGoldTierSubscription(),
              icon: Icon(
                Icons.workspace_premium,
                color: Colors.black,
                size: isMobile ? 14 : 16, // Reduced icon size
              ),
              label: Text(
                'PAY NOW',
                style: TextStyle(
                  color: Colors.black,
                  fontSize: isMobile ? 12 : 14,
                  fontWeight: FontWeight.bold,
                ),
              ),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFFFFD700),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
                elevation: 0,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLandscapeBenefitItem(String text) {
    return Row(
      children: [
        Icon(
          Icons.check_circle,
          color: const Color(0xFFFFD700),
          size: ResponsiveUtils.isMobile(context) ? 14 : 16,
        ),
        SizedBox(width: ResponsiveUtils.isMobile(context) ? 6 : 8),
        Expanded(
          child: Text(
            text,
            style: TextStyle(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white70
                  : const Color(0xFF333333),
              fontSize: ResponsiveUtils.isMobile(context) ? 11 : 12,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDrawer() {
    return Drawer(
      backgroundColor: Colors.transparent,
      child: SafeArea(
        child: Container(
          margin: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white.withOpacity(0.08)
                  : Colors.black.withOpacity(0.06),
            ),
            gradient: LinearGradient(
              colors: [
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.06 : 0.4,
                ),
                Colors.white.withOpacity(
                  Theme.of(context).brightness == Brightness.dark ? 0.02 : 0.2,
                ),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.25),
                blurRadius: 30,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(20),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
              child: ValueListenableBuilder<ThemeMode>(
                valueListenable: themeModeNotifier,
                builder: (context, themeMode, child) {
                  return Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          borderRadius: const BorderRadius.vertical(
                            top: Radius.circular(20),
                          ),
                          gradient: LinearGradient(
                            colors: [
                              const Color(0xFF8B0000).withOpacity(0.2),
                              Colors.transparent,
                            ],
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                          ),
                        ),
                        child: Row(
                          children: [
                            Container(
                              width: 44,
                              height: 44,
                              decoration: const BoxDecoration(
                                shape: BoxShape.circle,
                                color: Color(0xFF8B0000),
                              ),
                              child: const Icon(
                                Icons.person,
                                color: Colors.white,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    _isLoadingProfile
                                        ? 'Loading...'
                                        : _userName,
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontWeight: FontWeight.bold,
                                      fontSize: 16,
                                    ),
                                  ),
                                  const SizedBox(height: 2),
                                  Container(
                                    padding: const EdgeInsets.symmetric(
                                      horizontal: 8,
                                      vertical: 4,
                                    ),
                                    decoration: BoxDecoration(
                                      color: const Color(
                                        0xFF8B0000,
                                      ).withOpacity(0.12),
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: Text(
                                      _userTier,
                                      style: TextStyle(
                                        color: Color(0xFF8B0000),
                                        fontSize: 11,
                                        fontWeight: FontWeight.w600,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 8),
                      Expanded(
                        child: ListView(
                          padding: const EdgeInsets.symmetric(horizontal: 12),
                          children: [
                            _buildSectionLabel('Browse'),
                            const SizedBox(height: 6),
                            _buildDrawerItem(
                              icon: Icons.notifications,
                              label: 'Updates',
                              onTap: () {
                                Navigator.of(context).pop();
                                setState(() => _currentIndex = 1);
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.shopping_cart,
                              label: 'Cart',
                              onTap: () {
                                Navigator.of(context).pop();
                                setState(() => _currentIndex = 2);
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.account_balance_wallet,
                              label: 'Wallet',
                              onTap: () {
                                Navigator.of(context).pop();
                                setState(() => _currentIndex = 3);
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.person,
                              label: 'Profile',
                              onTap: () {
                                Navigator.of(context).pop();
                                setState(() => _currentIndex = 6);
                              },
                            ),
                            const SizedBox(height: 14),
                            _buildSectionLabel('Support'),
                            const SizedBox(height: 8),
                            _buildDrawerItem(
                              icon: Icons.description,
                              label: 'Resources & Docs',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) =>
                                        const ResourcesDocsScreen(),
                                  ),
                                );
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.chat_bubble,
                              label: 'Chat Support',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) =>
                                        const ChatSupportScreen(),
                                  ),
                                );
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.info_outline,
                              label: 'About Us',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) => const AboutUsScreen(),
                                  ),
                                );
                              },
                            ),
                            _buildDrawerItem(
                              icon: Icons.lightbulb_outline,
                              label: 'Suggestions',
                              onTap: () {
                                Navigator.of(context).pop();
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) =>
                                        const SuggestionScreen(),
                                  ),
                                );
                              },
                            ),
                            const SizedBox(height: 14),
                            _buildSectionLabel('Preferences'),
                            const SizedBox(height: 6),
                            _buildDrawerItem(
                              icon: themeMode == ThemeMode.dark
                                  ? Icons.light_mode
                                  : Icons.dark_mode,
                              label: themeMode == ThemeMode.dark
                                  ? 'Light Mode'
                                  : 'Dark Mode',
                              trailing: Switch(
                                value: themeMode == ThemeMode.dark
                                    ? false
                                    : true,
                                activeThumbColor: const Color(0xFF8B0000),
                                onChanged: (value) => themeModeNotifier.value =
                                    value ? ThemeMode.light : ThemeMode.dark,
                              ),
                              onTap: () => themeModeNotifier.value =
                                  themeMode == ThemeMode.dark
                                  ? ThemeMode.light
                                  : ThemeMode.dark,
                            ),
                            const SizedBox(height: 14),
                            _buildSectionLabel('Account'),
                            const SizedBox(height: 6),
                            _buildDrawerItem(
                              icon: Icons.logout,
                              label: 'Logout',
                              onTap: () async {
                                print('Logout button tapped!');
                                Navigator.of(context).pop();
                                print(
                                  'Sidebar closed, calling _handleLogout...',
                                );
                                await _handleLogout();
                              },
                            ),
                          ],
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildSectionLabel(String label) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Text(
        label,
        style: const TextStyle(
          color: Colors.white54,
          fontSize: 12,
          fontWeight: FontWeight.w600,
          letterSpacing: 0.5,
        ),
      ),
    );
  }

  Widget _buildDrawerItem({
    required IconData icon,
    required String label,
    required Function() onTap,
    Widget? trailing,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 4),
      decoration: BoxDecoration(borderRadius: BorderRadius.circular(12)),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        leading: Icon(icon, color: Colors.white70, size: 20),
        title: Text(
          label,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        trailing: trailing,
        onTap: onTap,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ),
    );
  }

  // Floating Navigation Bar with Flat Morphic Background
  Widget _buildPortfolioLinksScreen() {
    // Portfolio screen with client work showcase
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [
            const Color(0xFF8B0000),
            Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF1A1A1A)
                : const Color(0xFFF5F5F5),
          ],
        ),
      ),
      child: SafeArea(
        child: Column(
          children: [
            // Header with Back Button
            Padding(
              padding: const EdgeInsets.only(
                left: 12,
                right: 20,
                top: 12,
                bottom: 4,
              ),
              child: Row(
                children: [
                  // Back button
                  IconButton(
                    icon: const Icon(
                      Icons.arrow_back,
                      color: Colors.white,
                      size: 24,
                    ),
                    onPressed: () => setState(() => _currentIndex = 0),
                    tooltip: 'Back to Dashboard',
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Our Portfolio',
                          style: TextStyle(
                            fontSize: 22,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Explore our client work and creative solutions',
                          style: TextStyle(fontSize: 13, color: Colors.white70),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
            // Portfolio Grid
            Expanded(
              child: RefreshIndicator(
                onRefresh: () async {
                  setState(() {});
                  await Future.delayed(const Duration(milliseconds: 500));
                },
                color: const Color(0xFF8B0000),
                child: SingleChildScrollView(
                  physics: const AlwaysScrollableScrollPhysics(),
                  child: _buildDashboardPortfolioList(),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDashboardPortfolioList() {
    return Container(
      padding: const EdgeInsets.only(left: 20, right: 20, top: 4, bottom: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Real-time portfolio links from Firebase
          StreamBuilder<List<Map<String, dynamic>>>(
            stream: FirebaseService.getSharedLinksStream(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(
                  child: Padding(
                    padding: EdgeInsets.all(40),
                    child: CircularProgressIndicator(
                      valueColor: AlwaysStoppedAnimation<Color>(
                        Color(0xFF8B0000),
                      ),
                    ),
                  ),
                );
              }

              if (snapshot.hasError) {
                return Center(
                  child: Padding(
                    padding: const EdgeInsets.all(40),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.error_outline,
                          color: Colors.red,
                          size: 48,
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Error loading portfolio: ${snapshot.error}',
                          style: const TextStyle(color: Colors.red),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                );
              }

              final links = snapshot.data ?? [];

              if (links.isEmpty) {
                return const Center(
                  child: Padding(
                    padding: EdgeInsets.all(40),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.work, color: Colors.white54, size: 48),
                        SizedBox(height: 16),
                        Text(
                          'Portfolio coming soon',
                          style: TextStyle(color: Colors.white54, fontSize: 16),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'We\'re working on showcasing our amazing client work',
                          style: TextStyle(color: Colors.white38, fontSize: 14),
                        ),
                      ],
                    ),
                  ),
                );
              }

              // Use GridView for better landscape layout
              return GridView.builder(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: isTablet || isDesktop ? 2 : 1,
                  crossAxisSpacing: 16,
                  mainAxisSpacing: 16,
                  childAspectRatio: isTablet || isDesktop ? 1.5 : 1.2,
                ),
                itemCount: links.length,
                itemBuilder: (context, index) {
                  final link = links[index];
                  return _buildDashboardPortfolioCard(link);
                },
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildDashboardPortfolioCard(Map<String, dynamic> link) {
    return InkWell(
      onTap: () async {
        final url = link['url'] ?? '';
        if (url.isNotEmpty) {
          final uri = Uri.parse(url);
          if (await canLaunchUrl(uri)) {
            await launchUrl(uri, mode: LaunchMode.externalApplication);
          }
        }
      },
      borderRadius: BorderRadius.circular(16),
      child: Container(
        decoration: BoxDecoration(
          color: Theme.of(context).brightness == Brightness.dark
              ? const Color(0xFF2A2A2A)
              : Colors.white,
          borderRadius: BorderRadius.circular(16),
          border: Theme.of(context).brightness == Brightness.dark
              ? Border.all(color: Colors.white10)
              : Border.all(color: const Color(0xFFE0E0E0)),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.2),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Image - Takes up more space and shows fully
            Expanded(
              flex: 3,
              child: ClipRRect(
                borderRadius: const BorderRadius.only(
                  topLeft: Radius.circular(16),
                  topRight: Radius.circular(16),
                ),
                child: link['image'] != null && link['image'].isNotEmpty
                    ? Image.network(
                        link['image'],
                        width: double.infinity,
                        fit: BoxFit.cover,
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: const Color(0xFF8B0000).withOpacity(0.1),
                            child: Center(
                              child: CircularProgressIndicator(
                                value:
                                    loadingProgress.expectedTotalBytes != null
                                    ? loadingProgress.cumulativeBytesLoaded /
                                          loadingProgress.expectedTotalBytes!
                                    : null,
                                color: const Color(0xFF8B0000),
                                strokeWidth: 3,
                              ),
                            ),
                          );
                        },
                        errorBuilder: (context, error, stackTrace) => Container(
                          color: const Color(0xFF8B0000).withOpacity(0.1),
                          child: const Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.image_not_supported,
                                  color: Color(0xFF8B0000),
                                  size: 40,
                                ),
                                SizedBox(height: 8),
                                Text(
                                  'Image unavailable',
                                  style: TextStyle(
                                    color: Color(0xFF8B0000),
                                    fontSize: 12,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      )
                    : Container(
                        color: const Color(0xFF8B0000).withOpacity(0.1),
                        child: const Center(
                          child: Icon(
                            Icons.work,
                            color: Color(0xFF8B0000),
                            size: 48,
                          ),
                        ),
                      ),
              ),
            ),
            // Content section
            Expanded(
              flex: 2,
              child: Padding(
                padding: const EdgeInsets.all(12),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Website URL
                          if (link['url'] != null && link['url'].isNotEmpty)
                            Row(
                              children: [
                                Icon(
                                  Icons.link,
                                  size: 14,
                                  color: const Color(0xFF8B0000),
                                ),
                                const SizedBox(width: 6),
                                Expanded(
                                  child: Text(
                                    link['url'],
                                    style: TextStyle(
                                      fontSize: 11,
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white54
                                          : Colors.black54,
                                    ),
                                    maxLines: 1,
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                ),
                              ],
                            ),
                          const SizedBox(height: 8),
                          // Title
                          Text(
                            link['title'] ?? 'Client Work',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white
                                  : Colors.black87,
                            ),
                            maxLines: 2,
                            overflow: TextOverflow.ellipsis,
                          ),
                          const SizedBox(height: 6),
                          // Description
                          if (link['description'] != null &&
                              link['description'].isNotEmpty)
                            Flexible(
                              child: Text(
                                link['description'],
                                style: TextStyle(
                                  fontSize: 12,
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  height: 1.4,
                                ),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                        ],
                      ),
                    ),
                    // Visit button
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: () async {
                          final url = link['url'] ?? '';
                          if (url.isNotEmpty) {
                            final uri = Uri.parse(url);
                            if (await canLaunchUrl(uri)) {
                              await launchUrl(
                                uri,
                                mode: LaunchMode.externalApplication,
                              );
                            }
                          }
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                          elevation: 2,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 10,
                          ),
                        ),
                        icon: const Icon(Icons.open_in_new, size: 16),
                        label: const Text(
                          'Visit',
                          style: TextStyle(
                            fontSize: 13,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFloatingNavigationBar() {
    return Positioned(
      bottom: 24, // 8-point grid: 3 * 8 = 24px (already follows 8-point grid)
      left: 0,
      right: 0,
      child: Center(
        child: Container(
          width:
              MediaQuery.of(context).size.width * 0.48, // 48% of screen width
          margin: const EdgeInsets.symmetric(horizontal: 24),
          decoration: BoxDecoration(
            // Flat morphic background
            color: Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF2A2A2A) // Dark flat background
                : const Color(0xFFF8F9FA), // Light flat background
            borderRadius: BorderRadius.circular(20),
            // Subtle border for depth
            border: Border.all(
              color: Theme.of(context).brightness == Brightness.dark
                  ? Colors.white.withOpacity(0.08)
                  : Colors.black.withOpacity(0.06),
              width: 1,
            ),
            // Flat morphic shadow
            boxShadow: [
              BoxShadow(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.black.withOpacity(0.4)
                    : Colors.black.withOpacity(0.1),
                blurRadius: 20,
                offset: const Offset(0, 8),
                spreadRadius: 0,
              ),
              // Inner highlight for morphic effect (using Container with gradient instead of inset shadow)
            ],
          ),
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Theme.of(context).brightness == Brightness.dark
                      ? Colors.white.withOpacity(0.05)
                      : Colors.white.withOpacity(0.3),
                  Colors.transparent,
                ],
              ),
            ),
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                children: [
                  _buildFloatingNavItem(
                    icon: Icons.dashboard,
                    isSelected: _currentIndex == 0,
                    onTap: () => setState(() => _currentIndex = 0),
                  ),
                  _buildFloatingNavItem(
                    icon: Icons.notifications,
                    isSelected: _currentIndex == 1,
                    onTap: () => setState(() => _currentIndex = 1),
                  ),
                  _buildFloatingNavItem(
                    icon: Icons.shopping_cart,
                    isSelected: _currentIndex == 2,
                    onTap: () => setState(() => _currentIndex = 2),
                  ),
                  _buildFloatingNavItem(
                    icon: Icons.account_balance_wallet,
                    isSelected: _currentIndex == 3,
                    onTap: () => setState(() => _currentIndex = 3),
                  ),
                  _buildFloatingNavItem(
                    icon: Icons.list_alt,
                    isSelected: _currentIndex == 4,
                    onTap: () => setState(() => _currentIndex = 4),
                  ),
                  _buildFloatingNavItem(
                    icon: Icons.link,
                    isSelected: _currentIndex == 5,
                    onTap: () => setState(() => _currentIndex = 5),
                  ),
                ],
              ),
            ), // Close Padding
          ), // Close Container with gradient
        ), // Close inner Container
      ), // Close Center
    ); // Close Positioned
  }

  // Show Landscape Sidebar (Updated to use portrait-style structure)
  void _showLandscapeSidebar() {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (BuildContext context) {
        return Dialog(
          backgroundColor: Colors.transparent,
          insetPadding: EdgeInsets.zero,
          child: Row(
            children: [
              // Sidebar Content with Transparent Morphic Design
              Container(
                width: 320,
                height: MediaQuery.of(context).size.height,
                decoration: BoxDecoration(
                  color: Colors.transparent,
                  border: Border(
                    right: BorderSide(
                      color: Colors.white.withOpacity(0.15),
                      width: 1,
                    ),
                  ),
                ),
                child: ClipRRect(
                  child: BackdropFilter(
                    filter: ImageFilter.blur(sigmaX: 25, sigmaY: 25),
                    child: Container(
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [
                            Colors.black.withOpacity(0.3),
                            Colors.black.withOpacity(0.1),
                            Colors.transparent,
                          ],
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                        ),
                        border: Border(
                          right: BorderSide(
                            color: Colors.white.withOpacity(0.1),
                            width: 0.5,
                          ),
                        ),
                      ),
                      child: Column(
                        children: [
                          // Header with User Profile - Transparent Morphic
                          Container(
                            padding: const EdgeInsets.all(24),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                colors: [
                                  Colors.white.withOpacity(0.05),
                                  Colors.transparent,
                                ],
                                begin: Alignment.topCenter,
                                end: Alignment.bottomCenter,
                              ),
                              border: Border(
                                bottom: BorderSide(
                                  color: Colors.white.withOpacity(0.08),
                                  width: 0.5,
                                ),
                              ),
                            ),
                            child: Row(
                              children: [
                                Container(
                                  width: 48,
                                  height: 48,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    color: const Color(0xFF8B0000),
                                  ),
                                  child: const Icon(
                                    Icons.person,
                                    color: Colors.white,
                                    size: 24,
                                  ),
                                ),
                                const SizedBox(width: 16),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        _isLoadingProfile
                                            ? 'Loading...'
                                            : _userName,
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: 18,
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                      Text(
                                        '$_userTier $_userRole',
                                        style: TextStyle(
                                          color: const Color(0xFF8B0000),
                                          fontSize: 14,
                                          fontWeight: FontWeight.w600,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                                IconButton(
                                  onPressed: () => Navigator.of(context).pop(),
                                  icon: const Icon(
                                    Icons.close,
                                    color: Colors.white,
                                    size: 24,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          // Sidebar Menu Items (Portrait-style structure)
                          Expanded(
                            child: SingleChildScrollView(
                              padding: const EdgeInsets.symmetric(vertical: 16),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  // Browse Section
                                  _buildSidebarSection('Browse'),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.notifications,
                                    title: 'Updates',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      setState(() => _currentIndex = 1);
                                    },
                                  ),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.shopping_cart,
                                    title: 'Cart',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      setState(() => _currentIndex = 2);
                                    },
                                  ),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.account_balance_wallet,
                                    title: 'Wallet',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      setState(() => _currentIndex = 3);
                                    },
                                  ),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.person,
                                    title: 'Profile',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      setState(() => _currentIndex = 6);
                                    },
                                  ),

                                  const SizedBox(height: 24),

                                  // Support Section
                                  _buildSidebarSection('Support'),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.description,
                                    title: 'Resources & Docs',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      Navigator.of(context).push(
                                        MaterialPageRoute(
                                          builder: (context) =>
                                              const ResourcesDocsScreen(),
                                        ),
                                      );
                                    },
                                  ),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.chat_bubble,
                                    title: 'Chat Support',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      Navigator.of(context).push(
                                        MaterialPageRoute(
                                          builder: (context) =>
                                              const ChatSupportScreen(),
                                        ),
                                      );
                                    },
                                  ),

                                  const SizedBox(height: 24),

                                  // Preferences Section
                                  _buildSidebarSection('Preferences'),
                                  _buildThemeToggleItem(),

                                  const SizedBox(height: 24),

                                  // Account Section
                                  _buildSidebarSection('Account'),
                                  _buildSimpleSidebarItem(
                                    icon: Icons.logout,
                                    title: 'Logout',
                                    onTap: () {
                                      Navigator.of(context).pop();
                                      _handleLogout();
                                    },
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
              // Transparent overlay to close sidebar
              Expanded(
                child: GestureDetector(
                  onTap: () => Navigator.of(context).pop(),
                  child: Container(color: Colors.transparent),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  // Sidebar Menu Item Builder
  Widget _buildSidebarMenuItem({
    required IconData icon,
    required String title,
    required String subtitle,
    bool isSelected = false,
    required Function() onTap,
  }) {
    return InkWell(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: isSelected
              ? const Color(0xFF8B0000).withOpacity(0.2)
              : Colors.transparent,
          borderRadius: BorderRadius.circular(12),
          border: isSelected
              ? Border.all(
                  color: const Color(0xFF8B0000).withOpacity(0.3),
                  width: 1,
                )
              : null,
        ),
        child: Row(
          children: [
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: isSelected
                    ? const Color(0xFF8B0000).withOpacity(0.3)
                    : const Color(0xFF8B0000).withOpacity(0.2),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(
                icon,
                color: isSelected ? Colors.white : const Color(0xFF8B0000),
                size: 20,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      color: isSelected ? Colors.white : Colors.white,
                      fontSize: 16,
                      fontWeight: isSelected
                          ? FontWeight.bold
                          : FontWeight.w500,
                    ),
                  ),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: isSelected ? Colors.white70 : Colors.white60,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            if (isSelected)
              const Icon(
                Icons.arrow_forward_ios,
                color: Colors.white,
                size: 16,
              ),
          ],
        ),
      ),
    );
  }

  // Sidebar Section Header - Transparent Morphic
  Widget _buildSidebarSection(String title) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.03),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.05), width: 0.5),
      ),
      child: Text(
        title,
        style: TextStyle(
          color: Colors.white.withOpacity(0.8),
          fontSize: 11,
          fontWeight: FontWeight.w600,
          letterSpacing: 0.8,
        ),
      ),
    );
  }

  // Simple Sidebar Item Builder - Transparent Morphic
  Widget _buildSimpleSidebarItem({
    required IconData icon,
    required String title,
    required Function() onTap,
  }) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: Colors.transparent,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: Colors.transparent, width: 1),
          ),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.05),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: Colors.white.withOpacity(0.08),
                    width: 0.5,
                  ),
                ),
                child: Icon(
                  icon,
                  color: Colors.white.withOpacity(0.8),
                  size: 18,
                ),
              ),
              const SizedBox(width: 16),
              Text(
                title,
                style: TextStyle(
                  color: Colors.white.withOpacity(0.9),
                  fontSize: 15,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // Theme Toggle Item - Transparent Morphic
  Widget _buildThemeToggleItem() {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.03),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withOpacity(0.08), width: 0.5),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.05),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: Colors.white.withOpacity(0.08),
                width: 0.5,
              ),
            ),
            child: Icon(
              Icons.light_mode,
              color: Colors.white.withOpacity(0.8),
              size: 18,
            ),
          ),
          const SizedBox(width: 16),
          Text(
            'Light Mode',
            style: TextStyle(
              color: Colors.white.withOpacity(0.9),
              fontSize: 15,
              fontWeight: FontWeight.w500,
            ),
          ),
          const Spacer(),
          ValueListenableBuilder<ThemeMode>(
            valueListenable: themeModeNotifier,
            builder: (context, themeMode, child) {
              return Container(
                padding: const EdgeInsets.all(2),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.05),
                  borderRadius: BorderRadius.circular(20),
                  border: Border.all(
                    color: Colors.white.withOpacity(0.1),
                    width: 0.5,
                  ),
                ),
                child: Switch(
                  value: themeMode == ThemeMode.light,
                  onChanged: (value) {
                    themeModeNotifier.value = value
                        ? ThemeMode.light
                        : ThemeMode.dark;
                  },
                  activeThumbColor: const Color(0xFF8B0000),
                  activeTrackColor: const Color(0xFF8B0000).withOpacity(0.2),
                  inactiveThumbColor: Colors.white.withOpacity(0.7),
                  inactiveTrackColor: Colors.white.withOpacity(0.1),
                ),
              );
            },
          ),
        ],
      ),
    );
  }

  // Floating Navigation Item with Flat Morphic Effect
  Widget _buildFloatingNavItem({
    required IconData icon,
    required bool isSelected,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeInOut,
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          // Flat morphic background for selected state
          color: isSelected
              ? Theme.of(context).brightness == Brightness.dark
                    ? const Color(0xFF8B0000).withOpacity(0.15)
                    : const Color(0xFF8B0000).withOpacity(0.1)
              : Colors.transparent,
          borderRadius: BorderRadius.circular(16),
          // Flat border for selected state
          border: isSelected
              ? Border.all(
                  color: const Color(0xFF8B0000).withOpacity(0.3),
                  width: 1.5,
                )
              : null,
          // Flat morphic shadow for selected state
          boxShadow: isSelected
              ? [
                  BoxShadow(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.black.withOpacity(0.3)
                        : Colors.black.withOpacity(0.1),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                    spreadRadius: 0,
                  ),
                ]
              : null,
        ),
        child: Container(
          decoration: isSelected
              ? BoxDecoration(
                  borderRadius: BorderRadius.circular(16),
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      Theme.of(context).brightness == Brightness.dark
                          ? Colors.white.withOpacity(0.1)
                          : Colors.white.withOpacity(0.3),
                      Colors.transparent,
                    ],
                  ),
                )
              : null,
          child: Icon(
            icon,
            color: isSelected
                ? const Color(0xFF8B0000) // Red color for selected
                : Theme.of(context).brightness == Brightness.dark
                ? Colors.white.withOpacity(0.7) // Dark theme unselected
                : Colors.black.withOpacity(0.6), // Light theme unselected
            size: 24,
          ),
        ),
      ),
    );
  }

  // Service Tab Builder
  Widget _buildServiceTab({
    required IconData icon,
    required String label,
    required bool isSelected,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeInOut,
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
        decoration: BoxDecoration(
          color: isSelected ? const Color(0xFF8B0000) : Colors.transparent,
          borderRadius: BorderRadius.circular(12),
          boxShadow: isSelected
              ? [
                  BoxShadow(
                    color: const Color(0xFF8B0000).withOpacity(0.3),
                    blurRadius: 8,
                    offset: const Offset(0, 2),
                  ),
                ]
              : null,
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon,
              size: 18,
              color: isSelected
                  ? Colors.white
                  : Theme.of(context).brightness == Brightness.dark
                  ? Colors.white60
                  : Colors.black45,
            ),
            const SizedBox(width: 8),
            Text(
              label,
              style: TextStyle(
                fontSize: 14,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.w600,
                color: isSelected
                    ? Colors.white
                    : Theme.of(context).brightness == Brightness.dark
                    ? Colors.white60
                    : Colors.black45,
              ),
            ),
          ],
        ),
      ),
    );
  }

  // Marketing Tab Content
  Widget _buildMarketingTabContent() {
    final List<MarketingPackage> marketingPackages = [
      MarketingPackage(
        id: '1',
        name: 'Starter',
        icon: 'â­',
        price: 500.00,
        originalPrice: 800.00,
        period: 'month',
        isPopular: false,
        features: [
          'Basic Social Media Management',
          '5 Graphic Designs/month',
          'Content Creation',
          'Email Support',
        ],
        color: const Color(0xFF8B0000),
        description: 'Perfect for small businesses',
        savings: 'Save R300/month',
        bestFor: 'Small Businesses',
        setupFee: 1500.00,
      ),
      MarketingPackage(
        id: '2',
        name: 'Growth',
        icon: 'ðŸš€',
        price: 800.00,
        originalPrice: 1200.00,
        period: 'month',
        isPopular: true,
        features: [
          'Advanced Social Media Management',
          '10 Graphic Designs/month',
          'Content Strategy',
          'Basic SEO',
          'Priority Support',
        ],
        color: const Color(0xFF8B0000),
        description: 'Ideal for growing businesses',
        savings: 'Save R400/month',
        bestFor: 'Growing Businesses',
        setupFee: 3000.00,
      ),
      MarketingPackage(
        id: '3',
        name: 'Premium',
        icon: 'ðŸ‘‘',
        price: 1500.00,
        originalPrice: 2200.00,
        period: 'month',
        isPopular: false,
        features: [
          'Full Social Media Management',
          'Unlimited Graphic Designs',
          'Advanced SEO & SEM',
          '24/7 Priority Support',
          'Website Maintenance',
        ],
        color: const Color(0xFF8B0000),
        description: 'Complete marketing solution',
        savings: 'Save R701/month',
        bestFor: 'Established Businesses',
        setupFee: 5000.00,
      ),
    ];

    final List<MarketingServiceModel> individualServices = [
      MarketingServiceModel(
        id: 'ms1',
        name: 'Social Media Management',
        description:
            'Complete social media strategy and management across all platforms',
        price: 1200.00,
        period: 'month',
        icon: Icons.share,
        features: [
          'Platform setup & optimization',
          'Content planning & scheduling',
          'Community management',
          'Performance analytics',
          'Monthly strategy reports',
        ],
      ),
      MarketingServiceModel(
        id: 'ms2',
        name: 'Content Creation',
        description:
            'Professional content creation for all your marketing channels',
        price: 800.00,
        period: 'month',
        icon: Icons.edit,
        features: [
          'Blog posts & articles',
          'Social media graphics',
          'Email newsletters',
          'Video content',
          'Brand storytelling',
        ],
      ),
      MarketingServiceModel(
        id: 'ms3',
        name: 'SEO Optimization',
        description:
            'Search engine optimization to improve your online visibility',
        price: 1500.00,
        period: 'month',
        icon: Icons.trending_up,
        features: [
          'Keyword research & analysis',
          'On-page optimization',
          'Technical SEO audit',
          'Link building strategy',
          'Ranking monitoring',
        ],
      ),
      MarketingServiceModel(
        id: 'ms4',
        name: 'Email Marketing',
        description:
            'Strategic email marketing campaigns to engage your audience',
        price: 600.00,
        period: 'month',
        icon: Icons.email,
        features: [
          'Campaign design & setup',
          'List segmentation',
          'Automated workflows',
          'A/B testing',
          'Performance tracking',
        ],
      ),
      MarketingServiceModel(
        id: 'ms5',
        name: 'Graphic Design',
        description: 'Professional graphic design for all your marketing needs',
        price: 400.00,
        period: 'month',
        icon: Icons.brush,
        features: [
          'Logo & brand identity',
          'Marketing materials',
          'Social media graphics',
          'Print collateral',
          'Digital assets',
        ],
      ),
      MarketingServiceModel(
        id: 'ms6',
        name: 'PPC Advertising',
        description:
            'Pay-per-click advertising campaigns for immediate results',
        price: 1000.00,
        period: 'month',
        icon: Icons.ads_click,
        features: [
          'Google Ads management',
          'Facebook/Instagram ads',
          'Campaign optimization',
          'Budget management',
          'ROI tracking',
        ],
      ),
    ];

    return Container(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: double.infinity,
            child: Text(
              'Marketing Services',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white
                    : Colors.black87,
              ),
              textAlign: TextAlign.center,
            ),
          ),
          const SizedBox(height: 8),
          SizedBox(
            width: double.infinity,
            child: Text(
              'Comprehensive marketing solutions for your business growth',
              style: TextStyle(
                fontSize: 14,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white70
                    : Colors.black54,
              ),
              textAlign: TextAlign.center,
            ),
          ),
          const SizedBox(height: 16),
          Expanded(
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Packages Section - Moved to top
                  Text(
                    'Complete Packages',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white
                          : Colors.black87,
                    ),
                  ),
                  const SizedBox(height: 12),
                  Text(
                    'All-inclusive packages for comprehensive marketing',
                    style: TextStyle(
                      fontSize: 14,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white60
                          : Colors.black45,
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Marketing Packages - Horizontal Layout
                  LayoutBuilder(
                    builder: (context, constraints) {
                      final isLandscape =
                          MediaQuery.of(context).orientation ==
                          Orientation.landscape;

                      if (isLandscape) {
                        // Horizontal layout for landscape - no scrolling
                        return SizedBox(
                          height: 280,
                          child: Row(
                            children: marketingPackages.map((package) {
                              return Expanded(
                                child: Container(
                                  margin: const EdgeInsets.symmetric(
                                    horizontal: 8,
                                  ),
                                  child: _buildMarketingPackageCard(package),
                                ),
                              );
                            }).toList(),
                          ),
                        );
                      } else {
                        // Vertical layout for portrait - with scrolling
                        return Column(
                          children: [
                            SizedBox(
                              height: 280,
                              child: PageView.builder(
                                controller: _marketingPackageController,
                                itemCount: marketingPackages.length,
                                itemBuilder: (context, index) {
                                  final package = marketingPackages[index];
                                  return Container(
                                    margin: const EdgeInsets.symmetric(
                                      horizontal: 8,
                                    ),
                                    child: _buildMarketingPackageCard(package),
                                  );
                                },
                              ),
                            ),
                            const SizedBox(height: 16),
                            // Package Indicators (only for portrait)
                            Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: List.generate(
                                marketingPackages.length,
                                (index) => Container(
                                  width: 8,
                                  height: 8,
                                  margin: const EdgeInsets.symmetric(
                                    horizontal: 4,
                                  ),
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    color: index == _currentMarketingPackage
                                        ? const Color(0xFF8B0000)
                                        : Theme.of(context).brightness ==
                                              Brightness.dark
                                        ? Colors.white30
                                        : Colors.black26,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        );
                      }
                    },
                  ),
                  const SizedBox(height: 24),
                  // Consultation Card
                  _buildConsultationCard('marketing'),
                  const SizedBox(height: 24),
                  // Individual Services Section
                  Text(
                    'Individual Services',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white
                          : Colors.black87,
                    ),
                  ),
                  const SizedBox(height: 12),
                  Text(
                    'Choose specific services that fit your needs',
                    style: TextStyle(
                      fontSize: 14,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white60
                          : Colors.black45,
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Individual Services Grid
                  GridView.builder(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    gridDelegate:
                        const SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 2,
                          childAspectRatio: 0.85,
                          crossAxisSpacing: 12,
                          mainAxisSpacing: 12,
                        ),
                    itemCount: individualServices.length,
                    itemBuilder: (context, index) {
                      final service = individualServices[index];
                      return _buildMarketingServiceGridCard(service);
                    },
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Development Tab Content
  Widget _buildDevelopmentTabContent() {
    final List<ServiceCategory> developmentCategories = [
      ServiceCategory(
        id: 'dev1',
        name: 'Web Development',
        description: 'Custom website and web application development',
        icon: Icons.web,
        color: const Color(0xFF2196F3),
        services: [
          Service(
            id: 'dev1',
            name: 'Custom Website',
            description: 'Professional website development with modern design',
            price: 2500.00,
            duration: '2-3 weeks',
            features: [
              'Responsive design',
              'SEO optimized',
              'Content management',
              'Contact forms',
            ],
          ),
          Service(
            id: 'dev2',
            name: 'E-commerce Website',
            description: 'Online store with payment integration',
            price: 4500.00,
            duration: '3-4 weeks',
            features: [
              'Payment gateway',
              'Inventory management',
              'Order tracking',
              'Admin panel',
            ],
          ),
          Service(
            id: 'dev3',
            name: 'Web Application',
            description: 'Custom web application development',
            price: 8000.00,
            duration: '4-6 weeks',
            features: [
              'Custom functionality',
              'Database design',
              'User authentication',
              'API integration',
            ],
          ),
        ],
      ),
      ServiceCategory(
        id: 'dev4',
        name: 'Mobile Development',
        description: 'iOS and Android mobile application development',
        icon: Icons.phone_android,
        color: const Color(0xFF4CAF50),
        services: [
          Service(
            id: 'dev4',
            name: 'Mobile App Development',
            description: 'Custom mobile applications for iOS and Android',
            price: 8000.00,
            duration: '6-8 weeks',
            features: [
              'Cross-platform development',
              'Native performance',
              'Push notifications',
              'App store submission',
            ],
          ),
          Service(
            id: 'dev5',
            name: 'E-commerce Mobile App',
            description: 'Mobile shopping app with payment integration',
            price: 12000.00,
            duration: '8-10 weeks',
            features: [
              'Payment processing',
              'Product catalog',
              'Order management',
              'User profiles',
            ],
          ),
        ],
      ),
    ];

    return Container(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: double.infinity,
            child: Text(
              'Development Services',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white
                    : Colors.black87,
              ),
              textAlign: TextAlign.center,
            ),
          ),
          const SizedBox(height: 8),
          SizedBox(
            width: double.infinity,
            child: Text(
              'Professional development services for your digital needs',
              style: TextStyle(
                fontSize: 14,
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.white70
                    : Colors.black54,
              ),
              textAlign: TextAlign.center,
            ),
          ),
          const SizedBox(height: 16),
          Expanded(
            child: ListView(
              children: [
                // Consultation Card
                _buildConsultationCard('development'),
                const SizedBox(height: 16),
                // Development Categories
                ...developmentCategories.map((category) {
                  return _buildDevelopmentCategoryCard(category);
                }),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // Beautiful Marketing Package Card Builder - Compact
  Widget _buildMarketingPackageCard(MarketingPackage package) {
    print('=== BUILDING PACKAGE CARD FOR: ${package.name} ===');

    if (_currentUserId == null) {
      print('User ID is null, returning card without stream');
      // Return card without active status if user not authenticated
      return _buildPackageCardWithoutStream(package, false);
    }

    print('User ID: $_currentUserId, setting up StreamBuilder');

    return StreamBuilder<DocumentSnapshot>(
      stream: FirebaseFirestore.instance
          .collection('users')
          .doc(_currentUserId)
          .snapshots(),
      builder: (context, userSnapshot) {
        print('=== STREAM BUILDER CALLED FOR ${package.name} ===');
        print('Snapshot has data: ${userSnapshot.hasData}');
        print('Snapshot exists: ${userSnapshot.data?.exists}');

        bool isActive = false;

        // Check user profile for active package
        if (userSnapshot.hasData && userSnapshot.data!.exists) {
          final userData = userSnapshot.data!.data() as Map<String, dynamic>?;
          final activePackage = userData?['activePackage'] as String?;
          isActive = activePackage == package.name;

          print('=== PACKAGE CARD DEBUG ===');
          print('Current package: ${package.name}');
          print('User active package: $activePackage');
          print('Is active: $isActive');
          print('User ID: $_currentUserId');
        } else {
          print('No user data available');
        }

        return Container(
          margin: const EdgeInsets.only(bottom: 16),
          height:
              280, // Increased height to give buttons more space and prevent squeezing
          decoration: BoxDecoration(
            color: Theme.of(context).brightness == Brightness.dark
                ? const Color(0xFF2A2A2A)
                : Colors.white,
            borderRadius: BorderRadius.circular(16),
            border: isActive
                ? Border.all(color: Colors.green, width: 2)
                : package.isPopular
                ? Border.all(color: const Color(0xFF8B0000), width: 2)
                : Theme.of(context).brightness == Brightness.dark
                ? Border.all(color: Colors.white10)
                : Border.all(color: const Color(0xFFE0E0E0)),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.1),
                blurRadius: 8,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Column(
            children: [
              // Header with Package Info
              Container(
                padding: const EdgeInsets.all(10), // Further reduced padding
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: package.isPopular
                        ? [
                            const Color(0xFF8B0000).withOpacity(0.1),
                            const Color(0xFF8B0000).withOpacity(0.05),
                          ]
                        : [Colors.transparent, Colors.transparent],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(16),
                    topRight: Radius.circular(16),
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    Text(
                      package.name,
                      textAlign: TextAlign.center,
                      style: TextStyle(
                        fontSize: 18, // Reduced font size
                        fontWeight: FontWeight.bold,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white
                            : Colors.black87,
                      ),
                    ),
                    if (package.bestFor.isNotEmpty)
                      Text(
                        package.bestFor,
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 11, // Reduced font size
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54,
                        ),
                      ),
                  ],
                ),
              ),
              // Pricing Section
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(10), // Further reduced padding
                  child: Column(
                    children: [
                      // Setup Fee
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 10,
                          vertical: 8,
                        ), // Reduced padding
                        decoration: BoxDecoration(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white.withOpacity(0.05)
                              : Colors.grey.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(
                            10,
                          ), // Reduced radius
                          border: Border.all(
                            color:
                                Theme.of(context).brightness == Brightness.dark
                                ? Colors.white.withOpacity(0.1)
                                : Colors.grey.withOpacity(0.2),
                            width: 1,
                          ),
                        ),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Setup Fee',
                                  style: TextStyle(
                                    fontSize: 11, // Reduced font size
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                  ),
                                ),
                                Text(
                                  'R${package.setupFee.toStringAsFixed(0)}',
                                  style: TextStyle(
                                    fontSize: 16, // Reduced font size
                                    fontWeight: FontWeight.bold,
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white
                                        : Colors.black87,
                                  ),
                                ),
                              ],
                            ),
                            Icon(
                              Icons.rocket_launch,
                              color: const Color(0xFF8B0000),
                              size: 18, // Reduced icon size
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 4), // Further reduced spacing
                      // Monthly Price
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 10,
                          vertical: 8,
                        ), // Reduced padding
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              const Color(0xFF8B0000).withOpacity(0.1),
                              const Color(0xFF8B0000).withOpacity(0.05),
                            ],
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                          ),
                          borderRadius: BorderRadius.circular(
                            10,
                          ), // Reduced radius
                          border: Border.all(
                            color: const Color(0xFF8B0000).withOpacity(0.2),
                            width: 1,
                          ),
                        ),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Monthly',
                                  style: TextStyle(
                                    fontSize: 11, // Reduced font size
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white70
                                        : Colors.black54,
                                  ),
                                ),
                                Text(
                                  'R${package.price.toStringAsFixed(0)}',
                                  style: TextStyle(
                                    fontSize: 18, // Reduced font size
                                    fontWeight: FontWeight.bold,
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? const Color(
                                            0xFFFFD700,
                                          ) // Gold color for dark mode
                                        : const Color(
                                            0xFF8B0000,
                                          ), // Red color for light mode
                                  ),
                                ),
                              ],
                            ),
                            Icon(
                              Icons.repeat,
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? const Color(
                                      0xFFFFD700,
                                    ) // Gold color for dark mode
                                  : const Color(
                                      0xFF8B0000,
                                    ), // Red color for light mode
                              size: 18, // Reduced icon size
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 6), // Further reduced spacing
                      // Get Started/Active Button
                      Expanded(
                        child: SizedBox(
                          width: double.infinity,
                          child: ElevatedButton(
                            onPressed: isActive
                                ? null
                                : () {
                                    _handlePackageSelection(package);
                                  },
                            style: ElevatedButton.styleFrom(
                              backgroundColor: isActive
                                  ? Colors.grey
                                  : const Color(0xFF8B0000),
                              foregroundColor: Colors.white,
                              elevation: isActive ? 0 : 4,
                              shadowColor: isActive
                                  ? Colors.transparent
                                  : const Color(0xFF8B0000).withOpacity(0.3),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(10),
                              ),
                            ),
                            child: Text(
                              isActive ? 'Active' : 'Get Started',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  /// Build package card without StreamBuilder (for unauthenticated users)
  Widget _buildPackageCardWithoutStream(
    MarketingPackage package,
    bool isActive,
  ) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      height: 280,
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: isActive
            ? Border.all(color: Colors.green, width: 2)
            : package.isPopular
            ? Border.all(color: const Color(0xFF8B0000), width: 2)
            : Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        children: [
          // Header with Package Info
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: package.isPopular
                    ? [
                        const Color(0xFF8B0000).withOpacity(0.1),
                        const Color(0xFF8B0000).withOpacity(0.05),
                      ]
                    : [Colors.transparent, Colors.transparent],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              borderRadius: const BorderRadius.only(
                topLeft: Radius.circular(16),
                topRight: Radius.circular(16),
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.center,
              children: [
                Text(
                  package.name,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
                if (package.bestFor.isNotEmpty)
                  Text(
                    package.bestFor,
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 11,
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                    ),
                  ),
              ],
            ),
          ),
          // Pricing Section
          Expanded(
            child: Container(
              padding: const EdgeInsets.all(10),
              child: Column(
                children: [
                  // Setup Fee
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white.withOpacity(0.05)
                          : Colors.grey.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(10),
                      border: Border.all(
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white.withOpacity(0.1)
                            : Colors.grey.withOpacity(0.2),
                        width: 1,
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Setup Fee',
                              style: TextStyle(
                                fontSize: 11,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                            Text(
                              'R${package.setupFee.toStringAsFixed(0)}',
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? const Color(0xFFFFD700)
                                    : const Color(0xFF8B0000),
                              ),
                            ),
                          ],
                        ),
                        Icon(
                          Icons.rocket_launch,
                          color: const Color(0xFF8B0000),
                          size: 18,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 4),
                  // Monthly Price
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          const Color(0xFF8B0000).withOpacity(0.1),
                          const Color(0xFF8B0000).withOpacity(0.05),
                        ],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(10),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.2),
                        width: 1,
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Monthly',
                              style: TextStyle(
                                fontSize: 11,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                            Text(
                              'R${package.price.toStringAsFixed(0)}',
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? const Color(0xFFFFD700)
                                    : const Color(0xFF8B0000),
                              ),
                            ),
                          ],
                        ),
                        Icon(
                          Icons.repeat,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? const Color(0xFFFFD700)
                              : const Color(0xFF8B0000),
                          size: 18,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 6),
                  // Get Started/Active Button
                  Expanded(
                    child: SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: isActive
                            ? null
                            : () {
                                _handlePackageSelection(package);
                              },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: isActive
                              ? Colors.grey
                              : const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                          elevation: isActive ? 0 : 4,
                          shadowColor: isActive
                              ? Colors.transparent
                              : const Color(0xFF8B0000).withOpacity(0.3),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(10),
                          ),
                        ),
                        child: Text(
                          isActive ? 'Active' : 'Get Started',
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Development Category Card Builder
  Widget _buildDevelopmentCategoryCard(ServiceCategory category) {
    return Container(
      margin: const EdgeInsets.only(bottom: 20),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        children: [
          // Category Header
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: category.color.withOpacity(0.1),
              borderRadius: const BorderRadius.only(
                topLeft: Radius.circular(16),
                topRight: Radius.circular(16),
              ),
            ),
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: category.color,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Icon(category.icon, color: Colors.white, size: 24),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        category.name,
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black87,
                        ),
                      ),
                      Text(
                        category.description,
                        style: TextStyle(
                          fontSize: 14,
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white70
                              : Colors.black54,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          // Services List
          Container(
            padding: const EdgeInsets.all(20),
            child: Column(
              children: [
                ...category.services.map(
                  (service) => Container(
                    margin: const EdgeInsets.only(bottom: 16),
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? const Color(0xFF1A1A1A)
                          : const Color(0xFFF8F9FA),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white10
                            : const Color(0xFFE0E0E0),
                      ),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    service.name,
                                    style: TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.bold,
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white
                                          : Colors.black87,
                                    ),
                                  ),
                                  const SizedBox(height: 4),
                                  Text(
                                    service.description,
                                    style: TextStyle(
                                      fontSize: 14,
                                      color:
                                          Theme.of(context).brightness ==
                                              Brightness.dark
                                          ? Colors.white70
                                          : Colors.black54,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.end,
                              children: [
                                Text(
                                  'R${service.price.toStringAsFixed(0)}',
                                  style: TextStyle(
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                    color: category.color,
                                  ),
                                ),
                                Text(
                                  service.duration,
                                  style: TextStyle(
                                    fontSize: 12,
                                    color:
                                        Theme.of(context).brightness ==
                                            Brightness.dark
                                        ? Colors.white54
                                        : Colors.black38,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),
                        // Features
                        Wrap(
                          spacing: 8,
                          runSpacing: 4,
                          children: service.features
                              .map(
                                (feature) => Container(
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 8,
                                    vertical: 4,
                                  ),
                                  decoration: BoxDecoration(
                                    color: category.color.withOpacity(0.1),
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: Text(
                                    feature,
                                    style: TextStyle(
                                      fontSize: 12,
                                      color: category.color,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ),
                              )
                              .toList(),
                        ),
                        const SizedBox(height: 12),
                        // Get Quote Button
                        SizedBox(
                          width: double.infinity,
                          child: OutlinedButton(
                            onPressed: () {
                              // Navigate to ServiceHubScreen with development focus
                              Navigator.of(context).push(
                                MaterialPageRoute(
                                  builder: (context) =>
                                      const ServiceHubScreen(initialTab: 1),
                                ),
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              foregroundColor: category.color,
                              side: BorderSide(color: category.color),
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                              ),
                            ),
                            child: const Text(
                              'Get Quote',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // Marketing Service Card Builder
  Widget _buildMarketingServiceGridCard(MarketingServiceModel service) {
    return Container(
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.1),
              borderRadius: const BorderRadius.only(
                topLeft: Radius.circular(12),
                topRight: Radius.circular(12),
              ),
            ),
            child: Column(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(service.icon, color: Colors.white, size: 24),
                ),
                const SizedBox(height: 12),
                Text(
                  service.name,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
          // Content
          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(8), // Reduced padding
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    service.description,
                    style: TextStyle(
                      fontSize: 11, // Smaller font
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 2), // Minimal spacing
                  // Features Preview - Made even more compact
                  if (service.features.isNotEmpty)
                    Row(
                      children: [
                        Icon(
                          Icons.check_circle,
                          color: const Color(0xFF8B0000),
                          size: 8, // Very small icon
                        ),
                        const SizedBox(width: 2), // Minimal spacing
                        Expanded(
                          child: Text(
                            '${service.features.length} features',
                            style: TextStyle(
                              fontSize: 8, // Very small font
                              color:
                                  Theme.of(context).brightness ==
                                      Brightness.dark
                                  ? Colors.white60
                                  : Colors.black45,
                            ),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                  const SizedBox(height: 2), // Minimal spacing
                  // Get Started Button
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: () {
                        // Navigate to ServiceHubScreen with marketing focus
                        Navigator.of(context).push(
                          MaterialPageRoute(
                            builder: (context) =>
                                const ServiceHubScreen(initialTab: 0),
                          ),
                        );
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 6),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(6),
                        ),
                      ),
                      child: const Text(
                        'Get Started',
                        style: TextStyle(
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Consultation Card Builder
  Widget _buildConsultationCard(String serviceType) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 8),
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [const Color(0xFF8B0000), const Color(0xFFB22222)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: const Color(0xFF8B0000).withOpacity(0.3),
            blurRadius: 12,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Icon(
                  Icons.chat_bubble_outline,
                  color: Colors.white,
                  size: 28,
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Need a Custom Quote?',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      'Chat with our team in real-time',
                      style: TextStyle(
                        fontSize: 14,
                        color: Colors.white.withOpacity(0.9),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Text(
            'Get personalized $serviceType solutions tailored to your business needs. '
            'Our experts are ready to discuss your project and provide a detailed quote.',
            style: TextStyle(
              fontSize: 14,
              color: Colors.white.withOpacity(0.95),
              height: 1.5,
            ),
          ),
          const SizedBox(height: 16),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: [
              _buildConsultationFeature('Free Consultation'),
              _buildConsultationFeature('Custom Quote'),
              _buildConsultationFeature('Live Chat'),
            ],
          ),
          const SizedBox(height: 20),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(
                    builder: (context) =>
                        ConsultationRequestScreen(serviceType: serviceType),
                  ),
                );
              },
              icon: const Icon(Icons.chat, size: 20),
              label: const Text(
                'Start Consultation',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
              ),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.white,
                foregroundColor: const Color(0xFF8B0000),
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                elevation: 0,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildConsultationFeature(String text) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.2),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white.withOpacity(0.3)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.check_circle, color: const Color(0xFFFFD700), size: 14),
          const SizedBox(width: 4),
          Text(
            text,
            style: const TextStyle(
              fontSize: 12,
              color: Colors.white,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  // Service Card Builder (Legacy - kept for compatibility)
  Widget _buildServiceCard(
    String title,
    String description,
    IconData icon,
    String price,
  ) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).brightness == Brightness.dark
            ? const Color(0xFF2A2A2A)
            : Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Theme.of(context).brightness == Brightness.dark
            ? Border.all(color: Colors.white10)
            : Border.all(color: const Color(0xFFE0E0E0)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: const Color(0xFF8B0000), size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  description,
                  style: TextStyle(
                    fontSize: 14,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white70
                        : Colors.black54,
                  ),
                ),
              ],
            ),
          ),
          Text(
            price,
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Color(0xFF8B0000),
            ),
          ),
        ],
      ),
    );
  }

  void _navigateToGoldTierSubscription() {
    // Get current user info from AuthService
    final authService = Provider.of<AuthService>(context, listen: false);
    final userProfile = authService.userProfile;

    if (userProfile == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please log in to upgrade to Gold Tier'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Debug: Print user profile to see the structure
    print('User profile data: $userProfile');

    // Use the existing _currentUserId from the class
    final userId = _currentUserId;
    final userEmail = userProfile['email'];
    final userName = userProfile['name'] ?? 'User';

    print('Extracted - UserId: $userId, Email: $userEmail, Name: $userName');

    if (userId == null || userEmail == null || userName == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'User information incomplete. UserId: $userId, Email: $userEmail, Name: $userName',
          ),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    Navigator.of(context)
        .push(
          MaterialPageRoute(
            builder: (context) => GoldTierSubscriptionScreen(
              userId: userId,
              userEmail: userEmail,
              userName: userName,
            ),
          ),
        )
        .then((success) {
          if (success == true) {
            // Gold tier subscription was successful
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('Welcome to Gold Tier! ðŸ†'),
                backgroundColor: Colors.green,
                duration: Duration(seconds: 3),
              ),
            );

            // Refresh the UI to show updated tier status
            setState(() {
              // The UI will automatically update via StreamBuilder
            });
          }
        });
  }

  /// Handle package selection - cancel previous package and start new one
  Future<void> _handlePackageSelection(MarketingPackage package) async {
    try {
      // Check if user has an active package
      final activeSubscriptions = await FirebaseFirestore.instance
          .collection('delayed_subscriptions')
          .where('userId', isEqualTo: _currentUserId)
          .where('status', whereIn: ['pending_activation', 'active'])
          .get();

      // Cancel any existing active packages
      if (activeSubscriptions.docs.isNotEmpty) {
        for (final doc in activeSubscriptions.docs) {
          await doc.reference.update({
            'status': 'cancelled',
            'cancelledAt': FieldValue.serverTimestamp(),
            'updatedAt': FieldValue.serverTimestamp(),
          });
        }

        // Show notification about cancellation
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Previous package cancelled. Starting ${package.name} package.',
            ),
            backgroundColor: Colors.orange,
          ),
        );
      }

      // Update user profile with active package
      await FirebaseFirestore.instance
          .collection('users')
          .doc(_currentUserId)
          .update({
            'activePackage': package.name,
            'updatedAt': FieldValue.serverTimestamp(),
          });

      // Navigate to subscription screen
      final currentUser = FirebaseAuth.instance.currentUser;
      if (currentUser != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(currentUser.uid)
            .get();

        if (userDoc.exists) {
          final userData = userDoc.data() as Map<String, dynamic>;
          Navigator.of(context).push(
            MaterialPageRoute(
              builder: (context) => GoldTierSubscriptionScreen(
                userId: currentUser.uid,
                userEmail: currentUser.email ?? '',
                userName: userData['name'] ?? 'User',
              ),
            ),
          );
        }
      }
    } catch (e) {
      print('Error handling package selection: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Error: $e'), backgroundColor: Colors.red),
      );
    }
  }

  Widget _buildActivePackageCard() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('delayed_subscriptions')
          .where('userId', isEqualTo: _currentUserId)
          .where('status', whereIn: ['pending_activation', 'active'])
          .snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return const SizedBox.shrink(); // Don't show card if no active package
        }

        final subscription = snapshot.data!.docs.first;
        final data = subscription.data() as Map<String, dynamic>;
        final packageName = data['packageName'] ?? 'Unknown Package';
        final status = data['status'] ?? 'pending';
        final activationDate = data['activationDate'] as Timestamp?;
        final monthlyAmount = data['monthlyAmount'] ?? 0.0;

        return InkWell(
          onTap: () {
            Navigator.of(context).push(
              MaterialPageRoute(
                builder: (context) => const PackageManagementScreen(),
              ),
            );
          },
          borderRadius: BorderRadius.circular(16),
          child: Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF2A2A2A)
                  : Colors.white,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: status == 'active'
                    ? Colors.green
                    : const Color(0xFFFFD700),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.black.withOpacity(0.3)
                      : Colors.black.withOpacity(0.08),
                  blurRadius: 18,
                  offset: const Offset(0, 8),
                ),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: status == 'active'
                            ? Colors.green
                            : const Color(0xFFFFD700),
                        shape: BoxShape.circle,
                      ),
                      child: Icon(
                        status == 'active'
                            ? Icons.check_circle
                            : Icons.schedule,
                        color: Colors.white,
                        size: 16,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Row(
                        children: [
                          Icon(
                            Icons.business_center,
                            color: status == 'active'
                                ? Colors.green
                                : const Color(0xFFFFD700),
                            size: 18,
                          ),
                          const SizedBox(width: 4),
                          Expanded(
                            child: Text(
                              'Active Package',
                              style: TextStyle(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? (status == 'active'
                                          ? Colors.green
                                          : const Color(0xFFFFD700))
                                    : (status == 'active'
                                          ? Colors.green
                                          : const Color(0xFF333333)),
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
                    ),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: status == 'active'
                            ? Colors.green
                            : const Color(0xFFFFD700),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Text(
                        status == 'active' ? 'ACTIVE' : 'PENDING',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                Text(
                  packageName,
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                if (status == 'pending_activation' &&
                    activationDate != null) ...[
                  Text(
                    'Monthly billing starts: ${_formatDate(activationDate.toDate())}',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: 14,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    'Monthly amount: R${monthlyAmount.toStringAsFixed(2)}',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: 14,
                    ),
                  ),
                ] else if (status == 'active') ...[
                  Text(
                    'Monthly billing: R${monthlyAmount.toStringAsFixed(2)}',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: 14,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    _getNextBillingDate(activationDate),
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: 14,
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Cancel subscription button
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: () =>
                          _showCancelSubscriptionDialog(subscription.id),
                      icon: const Icon(Icons.cancel, size: 16),
                      label: const Text(
                        'Cancel Subscription',
                        style: TextStyle(fontSize: 12),
                      ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.red,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 8),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
                    ),
                  ),
                ],
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildLandscapeActivePackageCard() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('delayed_subscriptions')
          .where('userId', isEqualTo: _currentUserId)
          .where('status', whereIn: ['pending_activation', 'active'])
          .snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return const SizedBox.shrink(); // Don't show card if no active package
        }

        final subscription = snapshot.data!.docs.first;
        final data = subscription.data() as Map<String, dynamic>;
        final packageName = data['packageName'] ?? 'Unknown Package';
        final status = data['status'] ?? 'pending';
        final activationDate = data['activationDate'] as Timestamp?;
        final monthlyAmount = data['monthlyAmount'] ?? 0.0;

        return InkWell(
          onTap: () {
            Navigator.of(context).push(
              MaterialPageRoute(
                builder: (context) => const PackageManagementScreen(),
              ),
            );
          },
          borderRadius: BorderRadius.circular(12),
          child: Container(
            padding: EdgeInsets.all(isMobile ? 8 : 12),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark
                  ? const Color(0xFF2A2A2A)
                  : Colors.white,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: status == 'active'
                    ? Colors.green
                    : const Color(0xFFFFD700),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.black.withOpacity(0.3)
                      : Colors.black.withOpacity(0.08),
                  blurRadius: 8,
                  offset: const Offset(0, 4),
                ),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Container(
                      padding: EdgeInsets.all(isMobile ? 6 : 8),
                      decoration: BoxDecoration(
                        color: status == 'active'
                            ? Colors.green
                            : const Color(0xFFFFD700),
                        shape: BoxShape.circle,
                      ),
                      child: Icon(
                        status == 'active'
                            ? Icons.check_circle
                            : Icons.schedule,
                        color: Colors.white,
                        size: isMobile ? 12 : 14,
                      ),
                    ),
                    SizedBox(width: isMobile ? 8 : 12),
                    Expanded(
                      child: Row(
                        children: [
                          Icon(
                            Icons.business_center,
                            color: status == 'active'
                                ? Colors.green
                                : const Color(0xFFFFD700),
                            size: isMobile ? 14 : 16,
                          ),
                          SizedBox(width: isMobile ? 3 : 4),
                          Expanded(
                            child: Text(
                              'Active Package',
                              style: TextStyle(
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? (status == 'active'
                                          ? Colors.green
                                          : const Color(0xFFFFD700))
                                    : (status == 'active'
                                          ? Colors.green
                                          : const Color(0xFF333333)),
                                fontSize: isMobile ? 14 : 16,
                                fontWeight: FontWeight.bold,
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
                    ),
                    Container(
                      padding: EdgeInsets.symmetric(
                        horizontal: isMobile ? 6 : 8,
                        vertical: isMobile ? 4 : 6,
                      ),
                      decoration: BoxDecoration(
                        color: status == 'active'
                            ? Colors.green
                            : const Color(0xFFFFD700),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Text(
                        status == 'active' ? 'ACTIVE' : 'PENDING',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: isMobile ? 8 : 9,
                          fontWeight: FontWeight.bold,
                        ),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
                SizedBox(height: isMobile ? 8 : 12),
                Text(
                  packageName,
                  style: TextStyle(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.black87,
                    fontSize: isMobile ? 16 : 18,
                    fontWeight: FontWeight.bold,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: isMobile ? 4 : 6),
                if (status == 'pending_activation' &&
                    activationDate != null) ...[
                  Text(
                    'Starts: ${_formatDate(activationDate.toDate())}',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: isMobile ? 10 : 12,
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                  SizedBox(height: isMobile ? 2 : 4),
                  Text(
                    'R${monthlyAmount.toStringAsFixed(2)}/month',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: isMobile ? 10 : 12,
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ] else if (status == 'active') ...[
                  Text(
                    'R${monthlyAmount.toStringAsFixed(2)}/month',
                    style: TextStyle(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? Colors.white70
                          : Colors.black54,
                      fontSize: isMobile ? 10 : 12,
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ],
            ),
          ),
        );
      },
    );
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final difference = date.difference(now);

    if (difference.inDays > 0) {
      return '${difference.inDays} days';
    } else if (difference.inHours > 0) {
      return '${difference.inHours} hours';
    } else {
      return 'Today';
    }
  }

  String _getNextBillingDate(Timestamp? activationDate) {
    if (activationDate == null) {
      return 'Next billing: TBD';
    }

    final activation = activationDate.toDate();
    final now = DateTime.now();

    // Calculate next billing date (same day of month as activation)
    DateTime nextBilling = DateTime(now.year, now.month, activation.day);

    // If the day has passed this month, move to next month
    if (nextBilling.isBefore(now)) {
      nextBilling = DateTime(now.year, now.month + 1, activation.day);
    }

    // Handle month overflow (e.g., if activation was on 31st but next month only has 30 days)
    if (nextBilling.month != (now.month == 12 ? 1 : now.month + 1)) {
      nextBilling = DateTime(nextBilling.year, nextBilling.month, 0);
    }

    final daysUntilBilling = nextBilling.difference(now).inDays;

    if (daysUntilBilling == 0) {
      return 'Next billing: Today';
    } else if (daysUntilBilling == 1) {
      return 'Next billing: Tomorrow';
    } else if (daysUntilBilling < 7) {
      return 'Next billing: In $daysUntilBilling days';
    } else {
      return 'Next billing: ${nextBilling.day}/${nextBilling.month}/${nextBilling.year}';
    }
  }
}

class AdminDashboardScreen extends StatefulWidget {
  const AdminDashboardScreen({super.key});

  @override
  State<AdminDashboardScreen> createState() => _AdminDashboardScreenState();
}

class _AdminDashboardScreenState extends State<AdminDashboardScreen>
    with TickerProviderStateMixin {
  final int _currentIndex = 0;
  final String _adminEmail = 'admin@impactgraphicsza.co.za';
  bool _showQuickActions = false;
  String _currentScreen = 'dashboard'; // Track current screen
  String _searchQuery = ''; // Search query for users
  String _currentMarketingTab = 'proposals'; // Track current marketing tab
  String _currentServiceTab = 'services'; // Track current service hub tab
  Map<String, dynamic>?
  _selectedClient; // Track selected client for details view
  final TextEditingController _searchController = TextEditingController();
  late TabController _adminTabController; // Admin Service Hub tab controller

  // Variables to store link preview data
  String? _currentImageUrl;
  String? _currentSiteName;
  Timer? _debounceTimer;

  @override
  void initState() {
    super.initState();
    _adminTabController = TabController(length: 1, vsync: this);
    _setupRealTimeListeners();
    _setupPortfolioNotificationCallback();
  }

  void _setupPortfolioNotificationCallback() {
    print('=== SETTING UP PORTFOLIO NAVIGATION CALLBACK (Admin Dashboard) ===');
    // Set up callback for portfolio notifications
    NotificationService.setPortfolioNavigationCallback((data) {
      print('=== PORTFOLIO NAVIGATION CALLBACK TRIGGERED (Admin) ===');
      print('Current screen before: $_currentScreen');
      print('Navigating to Services Hub');
      // Navigate to Services Hub
      setState(() {
        _currentScreen = 'serviceHub';
        // Force scroll to portfolio section (tab index 2)
        _adminTabController.animateTo(
          0,
        ); // Service Hub has only 1 tab for portfolio
      });
      print('Current screen after: $_currentScreen');
    });
    print('Callback set successfully for admin dashboard');
  }

  void _setupRealTimeListeners() {
    // Listen to recent orders in real-time
    FirebaseFirestore.instance
        .collection('orders')
        .orderBy('createdAt', descending: true)
        .limit(10) // Get only the 10 most recent orders
        .snapshots()
        .listen((snapshot) {
          if (mounted) {
            setState(() {
              _recentOrders = snapshot.docs.map((doc) {
                final data = doc.data();
                return {
                  'id': doc.id,
                  'orderNumber': data['orderNumber'] ?? 'N/A',
                  'client': data['customerName'] ?? 'Unknown Client',
                  'phone': data['customerEmail'] ?? 'No contact',
                  'description':
                      data['serviceName'] ?? data['description'] ?? 'Service',
                  'status': data['status'] ?? 'pending',
                };
              }).toList();
              _isLoadingOrders = false;
            });
          }
        })
        .onError((error) {
          print('Error listening to orders: $error');
          if (mounted) {
            setState(() {
              _isLoadingOrders = false;
            });
          }
        });
  }

  // Add User Dialog Controllers
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _phoneController = TextEditingController();
  String _selectedRole = 'Designer';
  String _selectedStatus = 'Active';

  // Add Client Dialog Controllers
  final TextEditingController _clientNameController = TextEditingController();
  final TextEditingController _clientContactController =
      TextEditingController();
  final TextEditingController _clientEmailController = TextEditingController();
  final TextEditingController _clientPhoneController = TextEditingController();
  final TextEditingController _clientAddressController =
      TextEditingController();
  String _selectedClientStatus = 'Active';
  String _selectedOrderStatus = 'all';

  // Real-time data streams
  List<Map<String, dynamic>> _recentOrders = [];
  bool _isLoadingOrders = true;

  void _setScreen(String screen) {
    print('Setting screen to: $screen'); // Debug print
    setState(() {
      _currentScreen = screen;
      _selectedClient = null; // Clear selected client when changing screens
    });
    print('Current screen is now: $_currentScreen'); // Debug print
  }

  void _setSelectedClient(Map<String, dynamic> client) {
    setState(() {
      _selectedClient = client;
    });
  }

  void _showLogoutDialog() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: const Text(
            'Logout',
            style: TextStyle(
              color: Colors.white,
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          content: const Text(
            'Are you sure you want to logout?',
            style: TextStyle(color: Colors.white70, fontSize: 16),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70, fontSize: 16),
              ),
            ),
            ElevatedButton(
              onPressed: () async {
                Navigator.of(context).pop();
                await _handleLogout();
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
              ),
              child: const Text(
                'Logout',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w500),
              ),
            ),
          ],
        );
      },
    );
  }

  Future<void> _handleLogout() async {
    try {
      // Show loading indicator
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return const Center(
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF8B0000)),
            ),
          );
        },
      );

      // Perform logout
      await AuthService.instance?.signOut();

      // Close loading dialog
      if (mounted) {
        Navigator.of(context).pop();
      }

      // Navigate to guest screen
      if (mounted) {
        Navigator.of(context).pushAndRemoveUntil(
          MaterialPageRoute(builder: (context) => const GuestScreen()),
          (route) => false,
        );
      }
    } catch (e) {
      // Close loading dialog
      if (mounted) {
        Navigator.of(context).pop();
      }

      // Show error message
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Logout failed: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  // Real-time filtering will be handled in StreamBuilder

  @override
  Widget build(BuildContext context) {
    // Debug: Check current user
    final currentUser = AuthService.instance?.user;
    print('AdminDashboardScreen - Current user: $currentUser'); // Debug print
    print(
      'AdminDashboardScreen - Is admin email: ${currentUser?.email?.endsWith('@impactgraphicsza.co.za')}',
    ); // Debug print

    return Scaffold(
      backgroundColor: const Color(0xFF2A2A2A),
      body: Row(
        children: [
          // Left Sidebar
          Container(
            width: 280,
            color: const Color(0xFF1A1A1A),
            child: Column(
              children: [
                // Logo Section
                Container(
                  padding: const EdgeInsets.all(24),
                  child: Row(
                    children: [
                      Container(
                        width: 32,
                        height: 32,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          color: const Color(0xFF8B0000),
                        ),
                        child: const Center(
                          child: Text(
                            'IG',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 8),
                      const Expanded(
                        child: Text(
                          'IMPACT GRAPHICS ZA',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 14,
                            fontWeight: FontWeight.bold,
                          ),
                          overflow: TextOverflow.ellipsis,
                          maxLines: 1,
                        ),
                      ),
                    ],
                  ),
                ),

                // Navigation Items
                Expanded(
                  child: ListView(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    children: [
                      _buildNavItem(
                        'DASHBOARD',
                        Icons.dashboard,
                        _currentScreen == 'dashboard',
                        () => _setScreen('dashboard'),
                      ),
                      _buildNavItem(
                        'INSIGHT',
                        Icons.insights,
                        _currentScreen == 'insight',
                        () => _setScreen('insight'),
                      ),
                      _buildNavItem(
                        'INVOICES',
                        Icons.receipt,
                        _currentScreen == 'invoices',
                        () => _setScreen('invoices'),
                      ),
                      _buildNavItem(
                        'WALLETS',
                        Icons.account_balance_wallet,
                        _currentScreen == 'wallets',
                        () => _setScreen('wallets'),
                      ),
                      _buildNavItem(
                        'ORDERS',
                        Icons.shopping_bag,
                        _currentScreen == 'orders',
                        () => _setScreen('orders'),
                      ),
                      _buildNavItem(
                        'SERVICE HUB',
                        Icons.store,
                        _currentScreen == 'service_hub',
                        () => _setScreen('service_hub'),
                      ),
                      _buildNavItem(
                        'POTENTIAL CLIENTS',
                        Icons.people,
                        _currentScreen == 'users',
                        () => _setScreen('users'),
                      ),
                      _buildNavItem(
                        'CLIENTS',
                        Icons.business,
                        _currentScreen == 'clients',
                        () => _setScreen('clients'),
                      ),
                      _buildNavItem(
                        'MARKETING',
                        Icons.campaign,
                        _currentScreen == 'marketing',
                        () => _setScreen('marketing'),
                      ),
                      _buildNavItem(
                        'CONSULTATIONS',
                        Icons.chat_bubble_outline,
                        _currentScreen == 'consultations',
                        () => _setScreen('consultations'),
                      ),
                      _buildNavItem(
                        'LEASING',
                        Icons.business,
                        _currentScreen == 'leasing',
                        () => _setScreen('leasing'),
                      ),
                      _buildNavItem(
                        'DEVELOPMENT',
                        Icons.code,
                        _currentScreen == 'development',
                        () => _setScreen('development'),
                      ),
                    ],
                  ),
                ),

                // Analytics Section
                Container(
                  padding: const EdgeInsets.all(16),
                  margin: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000).withOpacity(0.1),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: const Color(0xFF8B0000).withOpacity(0.3),
                    ),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          const Icon(
                            Icons.analytics,
                            color: Color(0xFF8B0000),
                            size: 20,
                          ),
                          const SizedBox(width: 8),
                          const Text(
                            'ANALYTICS',
                            style: TextStyle(
                              color: Color(0xFF8B0000),
                              fontSize: 12,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const Spacer(),
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 8,
                              vertical: 4,
                            ),
                            decoration: BoxDecoration(
                              color: Colors.yellow,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: const Text(
                              '7D',
                              style: TextStyle(
                                color: Colors.black,
                                fontSize: 10,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      FutureBuilder<Map<String, dynamic>>(
                        future: FirebaseService.getClientStats(),
                        builder: (context, snapshot) {
                          if (snapshot.hasData) {
                            final stats = snapshot.data!;
                            return Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  '${stats['totalClients']} Clients',
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(
                                  'R${(stats['totalRevenue'] as double).toStringAsFixed(0)}K Income',
                                  style: TextStyle(
                                    color: Colors.white70,
                                    fontSize: 12,
                                  ),
                                ),
                              ],
                            );
                          } else {
                            return Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Loading...',
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(
                                  'Loading...',
                                  style: TextStyle(
                                    color: Colors.white70,
                                    fontSize: 12,
                                  ),
                                ),
                              ],
                            );
                          }
                        },
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // Main Content Area
          Expanded(
            child: Container(
              color: const Color(0xFF2A2A2A),
              child: Column(
                children: [
                  // Top Bar
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1A1A1A),
                      border: Border(
                        bottom: BorderSide(
                          color: Colors.white.withOpacity(0.1),
                        ),
                      ),
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                _currentScreen == 'users'
                                    ? 'Potential Clients'
                                    : _currentScreen == 'clients'
                                    ? 'Client Management'
                                    : _currentScreen == 'consultations'
                                    ? 'Consultation Requests'
                                    : 'Welcome back, Admin!',
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: 24,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              Text(
                                _currentScreen == 'users'
                                    ? 'Users who haven\'t made purchases yet'
                                    : _currentScreen == 'clients'
                                    ? 'Manage your clients and their information'
                                    : _currentScreen == 'consultations'
                                    ? 'View and respond to client consultation requests'
                                    : 'IMPACT GRAPHICS ZA',
                                style: TextStyle(
                                  color: Colors.white70,
                                  fontSize: 16,
                                ),
                              ),
                            ],
                          ),
                        ),
                        Row(
                          children: [
                            IconButton(
                              icon: const Icon(
                                Icons.chat_bubble_outline,
                                color: Colors.white,
                              ),
                              onPressed: () {
                                Navigator.of(context).push(
                                  MaterialPageRoute(
                                    builder: (context) =>
                                        const AdminSupportScreen(),
                                  ),
                                );
                              },
                            ),
                            IconButton(
                              icon: const Icon(
                                Icons.notifications_outlined,
                                color: Colors.white,
                              ),
                              onPressed: () {
                                print(
                                  'Notification bell clicked!',
                                ); // Debug print
                                _setScreen('notifications');
                              },
                            ),
                            IconButton(
                              icon: const Icon(
                                Icons.person_outline,
                                color: Colors.white,
                              ),
                              onPressed: () {},
                            ),
                            SizedBox(width: 8),
                            IconButton(
                              icon: const Icon(
                                Icons.logout,
                                color: Colors.white,
                              ),
                              onPressed: () => _showLogoutDialog(),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),

                  // Main Content
                  Expanded(
                    child: Column(
                      children: [
                        // Fixed header content (summary cards)
                        Padding(
                          padding: const EdgeInsets.fromLTRB(24, 24, 24, 0),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              // Show different content based on current screen
                              if (_currentScreen == 'dashboard') ...[
                                // Financial Cards
                                LayoutBuilder(
                                  builder: (context, constraints) {
                                    if (constraints.maxWidth < 900) {
                                      // Horizontal scroll for smaller screens
                                      return SingleChildScrollView(
                                        scrollDirection: Axis.horizontal,
                                        child: Row(
                                          children: [
                                            SizedBox(
                                              width: 280,
                                              height: 140,
                                              child: _buildFinancialCard(
                                                'Bank Balance',
                                                'R 195,497.00',
                                                'Capitec Business Account',
                                                Icons.account_balance,
                                                true,
                                              ),
                                            ),
                                            const SizedBox(width: 16),
                                            SizedBox(
                                              width: 280,
                                              height: 140,
                                              child: _buildFinancialCard(
                                                'Revenue Tracker',
                                                'R 153,901',
                                                'Lease: R0K | Services: R154K',
                                                Icons.assessment,
                                                false,
                                              ),
                                            ),
                                            const SizedBox(width: 16),
                                            SizedBox(
                                              width: 280,
                                              height: 140,
                                              child: _buildFinancialCard(
                                                'Upcoming Payout',
                                                'R 153,901',
                                                '88 invoices â€¢ 0 gadget re',
                                                Icons.calendar_today,
                                                false,
                                              ),
                                            ),
                                          ],
                                        ),
                                      );
                                    } else {
                                      // Equal width for larger screens
                                      return Row(
                                        children: [
                                          Expanded(
                                            child: SizedBox(
                                              height: 140,
                                              child: _buildFinancialCard(
                                                'Bank Balance',
                                                'R 195,497.00',
                                                'Capitec Business Account',
                                                Icons.account_balance,
                                                true,
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 16),
                                          Expanded(
                                            child: SizedBox(
                                              height: 140,
                                              child: _buildFinancialCard(
                                                'Revenue Tracker',
                                                'R 153,901',
                                                'Lease: R0K | Services: R154K',
                                                Icons.assessment,
                                                false,
                                              ),
                                            ),
                                          ),
                                          const SizedBox(width: 16),
                                          Expanded(
                                            child: SizedBox(
                                              height: 140,
                                              child: _buildFinancialCard(
                                                'Upcoming Payout',
                                                'R 153,901',
                                                '88 invoices â€¢ 0 gadget re',
                                                Icons.calendar_today,
                                                false,
                                              ),
                                            ),
                                          ),
                                        ],
                                      );
                                    }
                                  },
                                ),
                              ],
                            ],
                          ),
                        ),

                        // Main content area
                        Expanded(
                          child: Padding(
                            padding: const EdgeInsets.fromLTRB(24, 16, 24, 24),
                            child: _currentScreen == 'dashboard'
                                ? LayoutBuilder(
                                    builder: (context, constraints) {
                                      if (constraints.maxWidth < 800) {
                                        // Stack layout for smaller screens
                                        return SingleChildScrollView(
                                          child: Column(
                                            children: [
                                              _buildRecentOrdersSection(),
                                              const SizedBox(height: 16),
                                              // Quick Actions Button
                                              Align(
                                                alignment:
                                                    Alignment.centerRight,
                                                child: Column(
                                                  children: [
                                                    ElevatedButton.icon(
                                                      onPressed: () {
                                                        setState(() {
                                                          _showQuickActions =
                                                              !_showQuickActions;
                                                        });
                                                      },
                                                      icon: const Icon(
                                                        Icons.add,
                                                      ),
                                                      label: const Text(
                                                        'Quick Actions',
                                                      ),
                                                      style: ElevatedButton.styleFrom(
                                                        backgroundColor:
                                                            const Color(
                                                              0xFF8B0000,
                                                            ),
                                                        foregroundColor:
                                                            Colors.white,
                                                        padding:
                                                            const EdgeInsets.symmetric(
                                                              horizontal: 24,
                                                              vertical: 12,
                                                            ),
                                                        shape: RoundedRectangleBorder(
                                                          borderRadius:
                                                              BorderRadius.circular(
                                                                8,
                                                              ),
                                                        ),
                                                      ),
                                                    ),
                                                    if (_showQuickActions) ...[
                                                      const SizedBox(
                                                        height: 16,
                                                      ),
                                                      _buildQuickActionsMenu(),
                                                    ],
                                                  ],
                                                ),
                                              ),
                                            ],
                                          ),
                                        );
                                      } else {
                                        // Side-by-side layout for larger screens
                                        return SingleChildScrollView(
                                          child: Row(
                                            crossAxisAlignment:
                                                CrossAxisAlignment.start,
                                            children: [
                                              Expanded(
                                                flex: 3,
                                                child:
                                                    _buildRecentOrdersSection(),
                                              ),
                                              const SizedBox(width: 24),
                                              // Quick Actions Button
                                              Column(
                                                children: [
                                                  ElevatedButton.icon(
                                                    onPressed: () {
                                                      setState(() {
                                                        _showQuickActions =
                                                            !_showQuickActions;
                                                      });
                                                    },
                                                    icon: const Icon(Icons.add),
                                                    label: const Text(
                                                      'Quick Actions',
                                                    ),
                                                    style: ElevatedButton.styleFrom(
                                                      backgroundColor:
                                                          const Color(
                                                            0xFF8B0000,
                                                          ),
                                                      foregroundColor:
                                                          Colors.white,
                                                      padding:
                                                          const EdgeInsets.symmetric(
                                                            horizontal: 24,
                                                            vertical: 12,
                                                          ),
                                                      shape: RoundedRectangleBorder(
                                                        borderRadius:
                                                            BorderRadius.circular(
                                                              8,
                                                            ),
                                                      ),
                                                    ),
                                                  ),
                                                  if (_showQuickActions) ...[
                                                    const SizedBox(height: 16),
                                                    _buildQuickActionsMenu(),
                                                  ],
                                                ],
                                              ),
                                            ],
                                          ),
                                        );
                                      }
                                    },
                                  )
                                : _currentScreen == 'users'
                                ? _buildUsersScreen()
                                : _currentScreen == 'clients'
                                ? _buildClientsScreen()
                                : _currentScreen == 'orders'
                                ? _buildOrdersScreen()
                                : _currentScreen == 'consultations'
                                ? _buildConsultationsScreen()
                                : _currentScreen == 'invoices'
                                ? _buildInvoicesScreen()
                                : _currentScreen == 'notifications'
                                ? _buildNotificationsScreen()
                                : _currentScreen == 'wallets'
                                ? _buildWalletsScreen()
                                : _currentScreen == 'marketing'
                                ? _buildMarketingScreen()
                                : _currentScreen == 'service_hub'
                                ? _buildServiceHubScreen()
                                : _currentScreen == 'development'
                                ? _buildDevelopmentScreen()
                                : Container(),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildNavItem(
    String title,
    IconData icon, [
    bool isActive = false,
    VoidCallback? onTap,
  ]) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      child: ListTile(
        leading: Icon(
          icon,
          color: isActive ? Colors.white : Colors.white70,
          size: 20,
        ),
        title: Text(
          title,
          style: TextStyle(
            color: isActive ? Colors.white : Colors.white70,
            fontSize: 14,
            fontWeight: isActive ? FontWeight.bold : FontWeight.normal,
          ),
        ),
        tileColor: isActive ? const Color(0xFF8B0000) : Colors.transparent,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        onTap: onTap,
      ),
    );
  }

  Widget _buildFinancialCard(
    String title,
    String amount,
    String description,
    IconData icon,
    bool showRefresh,
  ) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisSize: MainAxisSize.min,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: _getIconColor(icon).withOpacity(0.15),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Icon(icon, color: _getIconColor(icon), size: 12),
              ),
              const Spacer(),
              if (showRefresh)
                Container(
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.05),
                    borderRadius: BorderRadius.circular(3),
                  ),
                  child: IconButton(
                    icon: const Icon(
                      Icons.refresh,
                      color: Colors.white70,
                      size: 10,
                    ),
                    onPressed: () {},
                    padding: const EdgeInsets.all(1),
                    constraints: const BoxConstraints(
                      minWidth: 16,
                      minHeight: 16,
                    ),
                  ),
                ),
            ],
          ),
          const SizedBox(height: 6),
          Text(
            amount,
            style: const TextStyle(
              color: Colors.yellow,
              fontSize: 16,
              fontWeight: FontWeight.bold,
              letterSpacing: -0.5,
            ),
          ),
          const SizedBox(height: 2),
          Text(
            title,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 10,
              fontWeight: FontWeight.w600,
            ),
          ),
          const SizedBox(height: 1),
          Text(
            description,
            style: const TextStyle(
              color: Colors.white60,
              fontSize: 8,
              fontWeight: FontWeight.w400,
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }

  Color _getIconColor(IconData icon) {
    switch (icon) {
      case Icons.account_balance:
        return Colors.amber;
      case Icons.assessment:
        return const Color(0xFF8B0000);
      case Icons.calendar_today:
        return const Color(0xFF8B0000);
      default:
        return const Color(0xFF8B0000);
    }
  }

  Widget _buildRecentOrdersSection() {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              border: Border(
                bottom: BorderSide(color: Colors.white.withOpacity(0.1)),
              ),
            ),
            child: Row(
              children: [
                const Icon(Icons.chat_bubble_outline, color: Colors.white),
                const SizedBox(width: 8),
                const Text(
                  'Recent Orders',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                if (_isLoadingOrders)
                  const SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                    ),
                  )
                else
                  const Icon(Icons.description, color: Colors.white70),
              ],
            ),
          ),
          if (_isLoadingOrders)
            Container(
              padding: const EdgeInsets.all(40),
              child: const Center(
                child: CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                ),
              ),
            )
          else if (_recentOrders.isEmpty)
            Container(
              padding: const EdgeInsets.all(40),
              child: const Center(
                child: Column(
                  children: [
                    Icon(
                      Icons.shopping_cart_outlined,
                      color: Colors.white54,
                      size: 48,
                    ),
                    SizedBox(height: 16),
                    Text(
                      'No recent orders',
                      style: TextStyle(color: Colors.white54, fontSize: 16),
                    ),
                  ],
                ),
              ),
            )
          else
            ..._recentOrders.map((order) => _buildOrderCard(order)),
        ],
      ),
    );
  }

  Widget _buildOrderCard(Map<String, dynamic> order) {
    return Container(
      margin: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(8),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: InkWell(
        onTap: () => _showOrderDetails(order),
        borderRadius: BorderRadius.circular(8),
        child: Container(
          padding: const EdgeInsets.all(16),
          child: Column(
            children: [
              Row(
                children: [
                  Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      color: const Color(0xFF8B0000),
                      border: Border.all(color: Colors.green, width: 2),
                    ),
                    child: const Icon(
                      Icons.person,
                      color: Colors.white,
                      size: 20,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Show service name prominently instead of order number
                        Text(
                          order['description'] ?? 'Service Request',
                          style: const TextStyle(
                            color: Colors.black87,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          order['client'] ?? 'Unknown Client',
                          style: const TextStyle(
                            color: Colors.black54,
                            fontSize: 12,
                          ),
                        ),
                        Row(
                          children: [
                            const Icon(
                              Icons.email,
                              color: Colors.black54,
                              size: 12,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              order['phone'] ?? 'No contact',
                              style: const TextStyle(
                                color: Colors.black54,
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                        Text(
                          'Order: ${order['orderNumber'] ?? 'N/A'}',
                          style: const TextStyle(
                            color: Colors.black54,
                            fontSize: 11,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 8,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: _getStatusColor(
                              order['status'],
                            ).withOpacity(0.2),
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            (order['status'] ?? 'pending').toUpperCase(),
                            style: TextStyle(
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                              color: _getStatusColor(order['status']),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              // Add accept/decline buttons for pending orders
              if (order['status']?.toString().toLowerCase() == 'pending' ||
                  order['status']?.toString().toLowerCase() == 'new')
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  child: Row(
                    children: [
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () => _acceptOrder(order),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 8),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(6),
                            ),
                          ),
                          child: const Text(
                            'Accept',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () => _declineOrder(order),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.red,
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 8),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(6),
                            ),
                          ),
                          child: const Text(
                            'Decline',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }

  void _showOrderDetails(Map<String, dynamic> order) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            order['description'] ?? 'Order Details',
            style: const TextStyle(
              color: Colors.white,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          content: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                _buildDetailRow('Client', order['client'] ?? 'Unknown'),
                _buildDetailRow('Email', order['phone'] ?? 'No contact'),
                _buildDetailRow('Order Number', order['orderNumber'] ?? 'N/A'),
                _buildDetailRow(
                  'Status',
                  (order['status'] ?? 'pending').toUpperCase(),
                ),
                if (order['progressStage'] != null)
                  _buildDetailRow(
                    'Progress Stage',
                    _getProgressStageDisplayName(order['progressStage']),
                  ),
                if (order['progressPercentage'] != null)
                  _buildDetailRow(
                    'Progress',
                    '${order['progressPercentage']}%',
                  ),
                const SizedBox(height: 16),
                // Show accept/decline buttons for pending orders
                if (order['status']?.toString().toLowerCase() == 'pending' ||
                    order['status']?.toString().toLowerCase() == 'new')
                  Row(
                    children: [
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.of(context).pop();
                            _acceptOrder(order);
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 12),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: const Text(
                            'Accept Order',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.of(context).pop();
                            _declineOrder(order);
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.red,
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(vertical: 12),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: const Text(
                            'Decline Order',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ),
                    ],
                  )
                // Show progress update button for in-progress orders
                else if (order['status']?.toString().toLowerCase() ==
                    'in_progress')
                  ElevatedButton.icon(
                    onPressed: () {
                      Navigator.of(context).pop();
                      _showProgressUpdateDialog(order);
                    },
                    icon: const Icon(Icons.update),
                    label: const Text('Update Progress'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(
                        vertical: 12,
                        horizontal: 16,
                      ),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                  ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text(
                'Close',
                style: TextStyle(color: Colors.white, fontSize: 16),
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 100,
            child: Text(
              '$label:',
              style: const TextStyle(
                color: Colors.white70,
                fontSize: 14,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: const TextStyle(color: Colors.white, fontSize: 14),
            ),
          ),
        ],
      ),
    );
  }

  Color _getStatusColor(String? status) {
    switch (status?.toLowerCase()) {
      case 'pending':
        return Colors.orange;
      case 'in_progress':
      case 'in progress':
        return Colors.blue;
      case 'completed':
        return Colors.green;
      case 'cancelled':
      case 'declined':
        return Colors.red;
      default:
        return Colors.grey;
    }
  }

  // Accept order functionality
  Future<void> _acceptOrder(dynamic order) async {
    try {
      String orderId;

      // Handle both Order objects and Map<String, dynamic>
      if (order is Order) {
        orderId = order.id;
      } else if (order is Map<String, dynamic>) {
        orderId = order['id'] ?? '';
      } else {
        _showErrorSnackBar('Invalid order data format');
        return;
      }

      if (orderId.isEmpty) {
        _showErrorSnackBar('Order ID not found');
        return;
      }

      // Show loading indicator
      _showLoadingSnackBar('Accepting order...');

      // Update order status in Firestore with detailed progress tracking
      await FirebaseFirestore.instance.collection('orders').doc(orderId).update(
        {
          'status': 'accepted', // Set to 'accepted' for cart detection
          'progress': 'accepted',
          'progressStage': 'design_started',
          'progressPercentage': 10,
          'updatedAt': FieldValue.serverTimestamp(),
          'adminAction': 'accepted',
          'adminActionDate': FieldValue.serverTimestamp(),
          'acceptedBy': 'admin@impactgraphicsza.co.za',
          'estimatedCompletion': FieldValue.serverTimestamp(),
          'progressHistory': FieldValue.arrayUnion([
            {
              'action': 'accepted',
              'timestamp': DateTime.now().toIso8601String(),
              'by': 'admin@impactgraphicsza.co.za',
              'note': 'Order accepted by admin',
            },
          ]),
        },
      );

      // Update cart item status to 'accepted'
      await _updateCartItemStatus(orderId, 'accepted');

      // Show success message
      _showSuccessSnackBar('Order accepted successfully!');

      // Optional: Send notification to client
      await _sendOrderStatusNotification(order, 'accepted');
    } catch (e) {
      print('Error accepting order: $e');
      _showErrorSnackBar('Failed to accept order. Please try again.');
    }
  }

  // Decline order functionality
  Future<void> _declineOrder(dynamic order) async {
    try {
      String orderId;
      String declineReason = 'Declined by admin';

      // Handle both Order objects and Map<String, dynamic>
      if (order is Order) {
        orderId = order.id;
      } else if (order is Map<String, dynamic>) {
        orderId = order['id'] ?? '';
      } else {
        _showErrorSnackBar('Invalid order data format');
        return;
      }

      if (orderId.isEmpty) {
        _showErrorSnackBar('Order ID not found');
        return;
      }

      // Show confirmation dialog
      final confirmed = await _showDeclineConfirmationDialog(order);
      if (!confirmed) return;

      // Show loading indicator
      _showLoadingSnackBar('Declining order...');

      // Check if order was paid and process refund if necessary
      final orderDoc = await FirebaseFirestore.instance
          .collection('orders')
          .doc(orderId)
          .get();
      if (orderDoc.exists) {
        final orderData = orderDoc.data() as Map<String, dynamic>;
        final paymentStatus = orderData['paymentStatus'] as String?;
        final finalPrice =
            (orderData['finalPrice'] ?? orderData['price'] ?? 0.0).toDouble();

        print(
          '=== DECLINE ORDER: Order $orderId paymentStatus: $paymentStatus, amount: R$finalPrice ===',
        );

        // Use the FirebaseService method that handles refunds automatically
        await FirebaseService.declineOrderWithRefund(orderId, declineReason);

        if (paymentStatus == 'completed') {
          print(
            '=== DECLINE ORDER: Refund processed for paid order $orderId ===',
          );
          _showSuccessSnackBar(
            'Order declined and refund processed! R${finalPrice.toStringAsFixed(2)} has been credited to user\'s wallet.',
          );
        } else {
          print(
            '=== DECLINE ORDER: No refund needed for unpaid order $orderId ===',
          );
          _showSuccessSnackBar('Order declined successfully!');
        }
      } else {
        // Fallback to old method if order not found
        await FirebaseFirestore.instance
            .collection('orders')
            .doc(orderId)
            .update({
              'status': 'declined',
              'progress': 'declined',
              'progressStage': 'order_rejected',
              'progressPercentage': 0,
              'updatedAt': FieldValue.serverTimestamp(),
              'adminAction': 'declined',
              'adminActionDate': FieldValue.serverTimestamp(),
              'declinedBy': 'admin@impactgraphicsza.co.za',
              'declineReason': declineReason,
              'progressHistory': FieldValue.arrayUnion([
                {
                  'action': 'declined',
                  'timestamp': DateTime.now().toIso8601String(),
                  'by': 'admin@impactgraphicsza.co.za',
                  'note': 'Order declined by admin',
                },
              ]),
            });
        _showSuccessSnackBar('Order declined successfully!');
      }

      // Update cart item status to 'declined'
      await _updateCartItemStatus(orderId, 'declined');

      // Send notification to client
      await _sendOrderStatusNotification(order, 'declined');
    } catch (e) {
      print('Error declining order: $e');
      _showErrorSnackBar('Failed to decline order. Please try again.');
    }
  }

  // Update order progress with detailed tracking
  Future<void> _updateOrderProgress(
    String orderId,
    String progressStage,
    int progressPercentage, {
    String? note,
    Map<String, dynamic>? additionalData,
  }) async {
    try {
      final updateData = {
        'progressStage': progressStage,
        'progressPercentage': progressPercentage,
        'updatedAt': FieldValue.serverTimestamp(),
        'progressHistory': FieldValue.arrayUnion([
          {
            'stage': progressStage,
            'percentage': progressPercentage,
            'timestamp': FieldValue.serverTimestamp(),
            'by': 'admin@impactgraphicsza.co.za',
            'note': note ?? 'Progress updated',
          },
        ]),
      };

      if (additionalData != null) {
        additionalData.forEach((key, value) {
          updateData[key] = value;
        });
      }

      await FirebaseFirestore.instance
          .collection('orders')
          .doc(orderId)
          .update(updateData);

      _showSuccessSnackBar('Order progress updated successfully!');
    } catch (e) {
      print('Error updating order progress: $e');
      _showErrorSnackBar('Failed to update order progress. Please try again.');
    }
  }

  // Show progress update dialog
  void _showProgressUpdateDialog(Map<String, dynamic> order) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            'Update Progress - ${order['description'] ?? 'Order'}',
            style: const TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text(
                  'Select the current progress stage:',
                  style: TextStyle(color: Colors.white70, fontSize: 14),
                ),
                const SizedBox(height: 16),
                // Progress Stage Buttons
                _buildProgressStageButton(
                  order,
                  'design_in_progress',
                  25,
                  'Design In Progress',
                ),
                _buildProgressStageButton(
                  order,
                  'design_review',
                  50,
                  'Design Review',
                ),
                _buildProgressStageButton(
                  order,
                  'revisions',
                  60,
                  'Making Revisions',
                ),
                _buildProgressStageButton(
                  order,
                  'final_approval',
                  75,
                  'Final Approval',
                ),
                _buildProgressStageButton(
                  order,
                  'printing',
                  85,
                  'Printing/Production',
                ),
                _buildProgressStageButton(
                  order,
                  'quality_check',
                  95,
                  'Quality Check',
                ),
                _buildProgressStageButton(
                  order,
                  'ready_for_delivery',
                  98,
                  'Ready for Delivery',
                ),
                _buildProgressStageButton(
                  order,
                  'completed',
                  100,
                  'Mark as Completed',
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white),
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildProgressStageButton(
    Map<String, dynamic> order,
    String stage,
    int percentage,
    String label,
  ) {
    return Container(
      width: double.infinity,
      margin: const EdgeInsets.only(bottom: 8),
      child: ElevatedButton(
        onPressed: () {
          Navigator.of(context).pop();
          if (stage == 'completed') {
            _markOrderAsCompleted(order);
          } else {
            _updateOrderProgress(
              order['id'],
              stage,
              percentage,
              note: 'Progress updated to $label',
            );
          }
        },
        style: ElevatedButton.styleFrom(
          backgroundColor: const Color(0xFF8B0000),
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(vertical: 12),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(6)),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              label,
              style: const TextStyle(fontSize: 14, fontWeight: FontWeight.w500),
            ),
            Text(
              '$percentage%',
              style: const TextStyle(fontSize: 12, fontWeight: FontWeight.w400),
            ),
          ],
        ),
      ),
    );
  }

  // Mark order as completed
  Future<void> _markOrderAsCompleted(Map<String, dynamic> order) async {
    try {
      final orderId = order['id'];
      if (orderId == null) {
        _showErrorSnackBar('Order ID not found');
        return;
      }

      // Show loading indicator
      _showLoadingSnackBar('Marking order as completed...');

      // Update order status in Firestore
      await FirebaseFirestore.instance.collection('orders').doc(orderId).update(
        {
          'status': 'completed',
          'progress': 'completed',
          'progressStage': 'completed',
          'progressPercentage': 100,
          'updatedAt': FieldValue.serverTimestamp(),
          'completedAt': FieldValue.serverTimestamp(),
          'completedBy': 'admin@impactgraphicsza.co.za',
          'progressHistory': FieldValue.arrayUnion([
            {
              'action': 'completed',
              'timestamp': FieldValue.serverTimestamp(),
              'by': 'admin@impactgraphicsza.co.za',
              'note': 'Order marked as completed',
            },
          ]),
        },
      );

      // Show success message
      _showSuccessSnackBar('Order marked as completed successfully!');

      // Optional: Send notification to client
      await _sendOrderStatusNotification(order, 'completed');
    } catch (e) {
      print('Error marking order as completed: $e');
      _showErrorSnackBar(
        'Failed to mark order as completed. Please try again.',
      );
    }
  }

  // Get progress stage display name
  String _getProgressStageDisplayName(String stage) {
    switch (stage) {
      case 'design_started':
        return 'Design Started';
      case 'design_in_progress':
        return 'Design In Progress';
      case 'design_review':
        return 'Design Review';
      case 'revisions':
        return 'Making Revisions';
      case 'final_approval':
        return 'Final Approval';
      case 'printing':
        return 'Printing/Production';
      case 'quality_check':
        return 'Quality Check';
      case 'ready_for_delivery':
        return 'Ready for Delivery';
      case 'completed':
        return 'Completed';
      case 'order_rejected':
        return 'Order Rejected';
      default:
        return stage.replaceAll('_', ' ').toUpperCase();
    }
  }

  // Show confirmation dialog for declining order
  Future<bool> _showDeclineConfirmationDialog(dynamic order) async {
    String serviceName;
    String clientName;

    // Handle both Order objects and Map<String, dynamic>
    if (order is Order) {
      serviceName = order.title;
      clientName = 'Client'; // Order class doesn't have clientName
    } else if (order is Map<String, dynamic>) {
      serviceName =
          order['serviceName'] ?? order['description'] ?? 'Unknown Service';
      clientName = order['clientName'] ?? order['client'] ?? 'Unknown Client';
    } else {
      serviceName = 'Unknown Service';
      clientName = 'Unknown Client';
    }

    return await showDialog<bool>(
          context: context,
          builder: (BuildContext context) {
            return AlertDialog(
              title: const Text('Decline Order'),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text('Are you sure you want to decline this order?'),
                  const SizedBox(height: 8),
                  Text('Service: $serviceName'),
                  Text('Client: $clientName'),
                  const SizedBox(height: 8),
                  const Text(
                    'This action cannot be undone.',
                    style: TextStyle(
                      color: Colors.red,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ],
              ),
              actions: [
                TextButton(
                  onPressed: () => Navigator.of(context).pop(false),
                  child: const Text('Cancel'),
                ),
                ElevatedButton(
                  onPressed: () => Navigator.of(context).pop(true),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.red,
                    foregroundColor: Colors.white,
                  ),
                  child: const Text('Decline Order'),
                ),
              ],
            );
          },
        ) ??
        false;
  }

  // Send notification to client about order status change
  Future<void> _sendOrderStatusNotification(
    dynamic order,
    String action,
  ) async {
    try {
      String orderId;
      String serviceName;
      String clientId;

      // Handle both Order objects and Map<String, dynamic>
      if (order is Order) {
        orderId = order.id;
        serviceName = order.title;
        clientId = ''; // Order class doesn't have userId or clientId
      } else if (order is Map<String, dynamic>) {
        orderId = order['id'] ?? '';
        serviceName =
            order['serviceName'] ?? order['description'] ?? 'Unknown Service';
        clientId = order['userId'] ?? order['clientId'] ?? '';
      } else {
        orderId = 'Unknown';
        serviceName = 'Unknown Service';
        clientId = '';
      }

      // This would integrate with your notification service
      // For now, we'll just log it
      print('Sending $action notification for order: $orderId');

      // You can add actual notification logic here using your NotificationService
      // Example:
      // await NotificationService.instance.sendNotificationToUser(
      //   userId: clientId,
      //   title: action == 'accepted' ? 'Order Accepted!' : 'Order Declined',
      //   body: action == 'accepted'
      //     ? 'Your order for $serviceName has been accepted and is now in progress.'
      //     : 'Your order for $serviceName has been declined.',
      //   type: 'order_status',
      // );
    } catch (e) {
      print('Error sending notification: $e');
      // Don't show error to user for notification failures
    }
  }

  // Helper methods for showing snackbars
  void _showSuccessSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  void _showErrorSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 4),
      ),
    );
  }

  void _showLoadingSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const SizedBox(
              width: 16,
              height: 16,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
              ),
            ),
            const SizedBox(width: 12),
            Text(message),
          ],
        ),
        backgroundColor: Colors.blue,
        duration: const Duration(seconds: 2),
      ),
    );
  }

  Widget _buildQuickActionsMenu() {
    return Container(
      width: 200,
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.3),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              border: Border(
                bottom: BorderSide(color: Colors.white.withOpacity(0.1)),
              ),
            ),
            child: Row(
              children: [
                const Text(
                  'Quick Actions',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                IconButton(
                  icon: const Icon(
                    Icons.close,
                    color: Colors.white70,
                    size: 20,
                  ),
                  onPressed: () {
                    setState(() {
                      _showQuickActions = false;
                    });
                  },
                  padding: EdgeInsets.zero,
                  constraints: const BoxConstraints(),
                ),
              ],
            ),
          ),
          ...[
            'Add Lease',
            'Generate Invoice',
            'Add New Client',
            'Update Gadget Listing',
            'Broadcast Message',
            'Bank Settings',
            'Location Tracker',
            'KPI Snapshot',
          ].map((action) => _buildQuickActionItem(action)),
        ],
      ),
    );
  }

  Widget _buildQuickActionItem(String action) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        border: Border(
          bottom: BorderSide(color: const Color(0xFF8B0000).withOpacity(0.3)),
        ),
      ),
      child: Text(
        action,
        style: const TextStyle(color: Colors.white, fontSize: 14),
      ),
    );
  }

  // Consultations Screen Content
  Widget _buildConsultationsScreen() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('consultations')
          .orderBy('lastMessageAt', descending: true)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.hasError) {
          return Center(
            child: Text(
              'Error: ${snapshot.error}',
              style: const TextStyle(color: Colors.red),
            ),
          );
        }

        if (!snapshot.hasData) {
          return const Center(child: CircularProgressIndicator());
        }

        final consultations = snapshot.data!.docs;

        if (consultations.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  Icons.chat_bubble_outline,
                  size: 64,
                  color: Colors.white.withOpacity(0.3),
                ),
                const SizedBox(height: 16),
                Text(
                  'No consultation requests yet',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.7),
                    fontSize: 16,
                  ),
                ),
              ],
            ),
          );
        }

        return ListView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          itemCount: consultations.length,
          itemBuilder: (context, index) {
            final consultation = consultations[index];
            final data = consultation.data() as Map<String, dynamic>;
            final consultationId = consultation.id;
            final userId = data['userId'] as String?;
            final userName = data['userName'] as String? ?? 'Unknown User';
            final userEmail = data['userEmail'] as String? ?? '';
            final serviceType = data['serviceType'] as String? ?? 'Unknown';
            final status = data['status'] as String? ?? 'active';
            final lastMessageAt = data['lastMessageAt'] as Timestamp?;

            return _buildConsultationCard(
              consultationId,
              userId,
              userName,
              userEmail,
              serviceType,
              status,
              lastMessageAt,
            );
          },
        );
      },
    );
  }

  Widget _buildConsultationCard(
    String consultationId,
    String? userId,
    String userName,
    String userEmail,
    String serviceType,
    String status,
    Timestamp? lastMessageAt,
  ) {
    return Card(
      margin: const EdgeInsets.only(bottom: 16),
      color: const Color(0xFF1A1A1A),
      child: InkWell(
        onTap: () {
          _openAdminChat(consultationId, userId, userName, serviceType);
        },
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: const Color(0xFF8B0000).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: const Icon(
                      Icons.chat_bubble_outline,
                      color: Color(0xFF8B0000),
                      size: 24,
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          userName,
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Row(
                          children: [
                            Icon(
                              serviceType == 'marketing'
                                  ? Icons.trending_up
                                  : Icons.code,
                              size: 14,
                              color: Colors.white70,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              '${serviceType[0].toUpperCase()}${serviceType.substring(1)} Services',
                              style: const TextStyle(
                                color: Colors.white70,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 12,
                      vertical: 6,
                    ),
                    decoration: BoxDecoration(
                      color: status == 'active'
                          ? Colors.green.withOpacity(0.2)
                          : Colors.grey.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text(
                      status == 'active' ? 'Active' : 'Closed',
                      style: TextStyle(
                        color: status == 'active' ? Colors.green : Colors.grey,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
              if (lastMessageAt != null) ...[
                const SizedBox(height: 12),
                Row(
                  children: [
                    const Icon(
                      Icons.access_time,
                      size: 14,
                      color: Colors.white54,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      'Last message: ${_formatChatTimestamp(lastMessageAt)}',
                      style: const TextStyle(
                        color: Colors.white54,
                        fontSize: 12,
                      ),
                    ),
                  ],
                ),
              ],
              const SizedBox(height: 16),
              ElevatedButton.icon(
                onPressed: () {
                  _openAdminChat(consultationId, userId, userName, serviceType);
                },
                icon: const Icon(Icons.message, size: 18),
                label: const Text('View Chat'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF8B0000),
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(
                    horizontal: 24,
                    vertical: 12,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  String _formatChatTimestamp(Timestamp timestamp) {
    final dateTime = timestamp.toDate();
    final now = DateTime.now();
    final difference = now.difference(dateTime);

    if (difference.inMinutes < 1) {
      return 'Just now';
    } else if (difference.inHours < 1) {
      return '${difference.inMinutes}m ago';
    } else if (difference.inDays < 1) {
      return '${difference.inHours}h ago';
    } else if (difference.inDays < 7) {
      return '${difference.inDays}d ago';
    } else {
      return '${dateTime.day}/${dateTime.month}/${dateTime.year}';
    }
  }

  void _openAdminChat(
    String consultationId,
    String? userId,
    String userName,
    String serviceType,
  ) {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => AdminConsultationChatScreen(
          consultationId: consultationId,
          userId: userId,
          userName: userName,
          serviceType: serviceType,
        ),
      ),
    );
  }

  // Clients Screen Content
  Widget _buildClientsScreen() {
    if (_selectedClient != null) {
      return _buildClientDetailsScreen();
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header with Add Client button
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              'Client Database',
              style: TextStyle(
                color: Colors.white,
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            ElevatedButton.icon(
              onPressed: () {
                _showAddClientDialog();
              },
              icon: Icon(Icons.add, size: 16),
              label: Text('Add Client'),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
                padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(6),
                ),
              ),
            ),
          ],
        ),
        SizedBox(height: 16),

        // Search Bar for Clients
        Container(
          decoration: BoxDecoration(
            color: const Color(0xFF1A1A1A),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: TextField(
            style: TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText: 'Search clients by name, contact, email, or company...',
              hintStyle: TextStyle(color: Colors.white.withOpacity(0.6)),
              prefixIcon: Icon(Icons.search, color: Colors.white60),
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 12,
              ),
            ),
          ),
        ),
        SizedBox(height: 16),

        // Clients Cards with Real-time Data
        StreamBuilder<QuerySnapshot>(
          stream: FirebaseService.getClientsStream(),
          builder: (context, snapshot) {
            if (snapshot.hasError) {
              return Container(
                padding: EdgeInsets.all(32),
                child: Column(
                  children: [
                    Icon(Icons.error_outline, color: Colors.red, size: 48),
                    SizedBox(height: 16),
                    Text(
                      'Error loading clients: ${snapshot.error}',
                      style: TextStyle(color: Colors.red, fontSize: 16),
                    ),
                  ],
                ),
              );
            }

            if (snapshot.connectionState == ConnectionState.waiting) {
              return Container(
                padding: EdgeInsets.all(32),
                child: Column(
                  children: [
                    CircularProgressIndicator(color: const Color(0xFF8B0000)),
                    SizedBox(height: 16),
                    Text(
                      'Loading clients...',
                      style: TextStyle(color: Colors.white60, fontSize: 16),
                    ),
                  ],
                ),
              );
            }

            final clients = snapshot.data?.docs ?? [];

            if (clients.isEmpty) {
              return Container(
                padding: EdgeInsets.all(32),
                child: Column(
                  children: [
                    Icon(
                      Icons.business_outlined,
                      color: Colors.white60,
                      size: 48,
                    ),
                    SizedBox(height: 16),
                    Text(
                      'No clients found',
                      style: TextStyle(color: Colors.white60, fontSize: 16),
                    ),
                  ],
                ),
              );
            }

            return Column(
              children: clients.map((doc) {
                final data = doc.data() as Map<String, dynamic>;
                data['id'] = doc.id; // Add document ID to the data
                return _buildClientCard(data);
              }).toList(),
            );
          },
        ),
      ],
    );
  }

  Widget _buildClientCard(Map<String, dynamic> client) {
    return Container(
      margin: EdgeInsets.only(bottom: 12),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header row with company name and status
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Text(
                  client['name'],
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                  overflow: TextOverflow.ellipsis,
                  maxLines: 1,
                ),
              ),
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: client['status'] == 'Active'
                      ? Colors.green.withOpacity(0.2)
                      : Colors.red.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Text(
                  client['status'],
                  style: TextStyle(
                    color: client['status'] == 'Active'
                        ? Colors.green
                        : Colors.red,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: 8),

          // Address
          Text(
            client['address'],
            style: TextStyle(color: Colors.white60, fontSize: 12),
            overflow: TextOverflow.ellipsis,
            maxLines: 1,
          ),
          SizedBox(height: 8),

          // Contact info
          Row(
            children: [
              Icon(Icons.person, color: Colors.white60, size: 14),
              SizedBox(width: 4),
              Text(
                client['contact'],
                style: TextStyle(color: Colors.white, fontSize: 14),
              ),
              SizedBox(width: 16),
              Icon(Icons.phone, color: Colors.white60, size: 14),
              SizedBox(width: 4),
              Text(
                client['phone'],
                style: TextStyle(color: Colors.white, fontSize: 14),
              ),
            ],
          ),
          SizedBox(height: 8),

          // Stats and actions row
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // Stats
              Row(
                children: [
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      '${client['totalOrders']} orders',
                      style: TextStyle(color: Colors.white, fontSize: 12),
                    ),
                  ),
                  SizedBox(width: 8),
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: const Color(0xFF8B0000).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      'R ${(client['totalSpent'] as num?)?.toStringAsFixed(0) ?? '0'}',
                      style: TextStyle(
                        color: const Color(0xFF8B0000),
                        fontWeight: FontWeight.w500,
                        fontSize: 12,
                      ),
                    ),
                  ),
                ],
              ),

              // Actions
              Row(
                children: [
                  IconButton(
                    icon: Icon(
                      Icons.visibility,
                      color: Colors.white60,
                      size: 16,
                    ),
                    onPressed: () {
                      _setSelectedClient(client);
                    },
                    padding: EdgeInsets.all(4),
                    constraints: BoxConstraints(minWidth: 32, minHeight: 32),
                  ),
                  IconButton(
                    icon: Icon(Icons.edit, color: Colors.white60, size: 16),
                    onPressed: () {
                      // TODO: Edit client functionality
                    },
                    padding: EdgeInsets.all(4),
                    constraints: BoxConstraints(minWidth: 32, minHeight: 32),
                  ),
                  IconButton(
                    icon: Icon(Icons.delete, color: Colors.red, size: 16),
                    onPressed: () {
                      _showDeleteClientDialog(client);
                    },
                    padding: EdgeInsets.all(4),
                    constraints: BoxConstraints(minWidth: 32, minHeight: 32),
                  ),
                ],
              ),
            ],
          ),
        ],
      ),
    );
  }

  // Users Screen Content
  Widget _buildUsersScreen() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header with Add User button
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              'Potential Clients',
              style: TextStyle(
                color: Colors.white,
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            ElevatedButton.icon(
              onPressed: () {
                _showAddUserDialog();
              },
              icon: Icon(Icons.add, size: 16),
              label: Text('Add User'),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
                padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(6),
                ),
              ),
            ),
          ],
        ),
        SizedBox(height: 16),

        // Search Bar
        Container(
          decoration: BoxDecoration(
            color: const Color(0xFF1A1A1A),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: TextField(
            controller: _searchController,
            onChanged: (value) {
              setState(() {
                _searchQuery = value;
              });
            },
            style: TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText: 'Search potential clients by name, email, or phone...',
              hintStyle: TextStyle(color: Colors.white60),
              prefixIcon: Icon(Icons.search, color: Colors.white60),
              suffixIcon: _searchQuery.isNotEmpty
                  ? IconButton(
                      icon: Icon(Icons.clear, color: Colors.white60),
                      onPressed: () {
                        setState(() {
                          _searchQuery = '';
                          _searchController.clear();
                        });
                      },
                    )
                  : null,
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 12,
              ),
            ),
          ),
        ),
        SizedBox(height: 16),

        // Users Table with Real-time Data
        Container(
          decoration: BoxDecoration(
            color: const Color(0xFF1A1A1A),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: StreamBuilder<QuerySnapshot>(
            stream: FirebaseService.getPotentialClientsStream(),
            builder: (context, snapshot) {
              if (snapshot.hasError) {
                return Container(
                  padding: EdgeInsets.all(32),
                  child: Column(
                    children: [
                      Icon(Icons.error_outline, color: Colors.red, size: 48),
                      SizedBox(height: 16),
                      Text(
                        'Error loading users: ${snapshot.error}',
                        style: TextStyle(color: Colors.red, fontSize: 16),
                      ),
                    ],
                  ),
                );
              }

              if (snapshot.connectionState == ConnectionState.waiting) {
                return Container(
                  padding: EdgeInsets.all(32),
                  child: Column(
                    children: [
                      CircularProgressIndicator(color: const Color(0xFF8B0000)),
                      SizedBox(height: 16),
                      Text(
                        'Loading users...',
                        style: TextStyle(color: Colors.white60, fontSize: 16),
                      ),
                    ],
                  ),
                );
              }

              final users = snapshot.data?.docs ?? [];

              // Filter users based on search query
              final filteredUsers = _searchQuery.isEmpty
                  ? users
                  : users.where((doc) {
                      final data = doc.data() as Map<String, dynamic>;
                      final query = _searchQuery.toLowerCase();
                      return data['name']?.toString().toLowerCase().contains(
                                query,
                              ) ==
                              true ||
                          data['email']?.toString().toLowerCase().contains(
                                query,
                              ) ==
                              true ||
                          data['role']?.toString().toLowerCase().contains(
                                query,
                              ) ==
                              true ||
                          data['phone']?.toString().toLowerCase().contains(
                                query,
                              ) ==
                              true;
                    }).toList();

              return Column(
                children: [
                  // Results count
                  if (_searchQuery.isNotEmpty)
                    Padding(
                      padding: EdgeInsets.only(bottom: 16),
                      child: Text(
                        '${filteredUsers.length} result${filteredUsers.length == 1 ? '' : 's'} found',
                        style: TextStyle(color: Colors.white60, fontSize: 14),
                      ),
                    ),
                  // Table Header
                  Container(
                    padding: EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.05),
                      borderRadius: BorderRadius.only(
                        topLeft: Radius.circular(8),
                        topRight: Radius.circular(8),
                      ),
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          flex: 2,
                          child: Text(
                            'Name',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Expanded(
                          flex: 3,
                          child: Text(
                            'Email',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Expanded(
                          flex: 1,
                          child: Text(
                            'Role',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Expanded(
                          flex: 1,
                          child: Text(
                            'Status',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Expanded(
                          flex: 2,
                          child: Text(
                            'Last Login',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Expanded(
                          flex: 1,
                          child: Text(
                            'Actions',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  // Users List
                  if (filteredUsers.isEmpty)
                    Container(
                      padding: EdgeInsets.all(32),
                      child: Column(
                        children: [
                          Icon(
                            Icons.people_outline,
                            color: Colors.white60,
                            size: 48,
                          ),
                          SizedBox(height: 16),
                          Text(
                            _searchQuery.isNotEmpty
                                ? 'No potential clients found matching "$_searchQuery"'
                                : 'No potential clients found',
                            style: TextStyle(
                              color: Colors.white60,
                              fontSize: 16,
                            ),
                          ),
                        ],
                      ),
                    )
                  else
                    ...filteredUsers.map((doc) {
                      final data = doc.data() as Map<String, dynamic>;
                      data['id'] = doc.id; // Add document ID to the data
                      return _buildUserRow(data);
                    }),
                ],
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildUserRow(Map<String, dynamic> user) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        border: Border(
          bottom: BorderSide(color: Colors.white.withOpacity(0.1)),
        ),
      ),
      child: LayoutBuilder(
        builder: (context, constraints) {
          // Use responsive layout based on available width
          if (constraints.maxWidth < 800) {
            // Mobile/tablet layout - stack vertically
            return Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Header row with avatar and name
                Row(
                  children: [
                    Container(
                      width: 32,
                      height: 32,
                      decoration: BoxDecoration(
                        color: const Color(0xFF8B0000),
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Center(
                        child: Text(
                          user['name'].split(' ').map((n) => n[0]).join(''),
                          style: TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 12,
                          ),
                        ),
                      ),
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            user['name'],
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          Text(
                            user['phone']?.toString() ?? 'No phone',
                            style: TextStyle(
                              color: Colors.white60,
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 8),

                // Email
                Text(
                  user['email']?.toString() ?? 'No email',
                  style: TextStyle(color: Colors.white, fontSize: 12),
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: 8),

                // Status and role row
                Row(
                  children: [
                    Container(
                      padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: _getRoleColor(user['role']).withOpacity(0.2),
                        borderRadius: BorderRadius.circular(4),
                      ),
                      child: Text(
                        user['role']?.toString() ?? 'Unknown',
                        style: TextStyle(
                          color: _getRoleColor(user['role']?.toString() ?? ''),
                          fontSize: 12,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ),
                    SizedBox(width: 8),
                    Container(
                      padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: user['status'] == 'Active'
                            ? Colors.green.withOpacity(0.2)
                            : Colors.red.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(4),
                      ),
                      child: Text(
                        user['isActive'] == true ? 'Active' : 'Inactive',
                        style: TextStyle(
                          color: user['isActive'] == true
                              ? Colors.green
                              : Colors.red,
                          fontSize: 12,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 8),

                // Last login and actions row
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      user['lastLogin'] != null
                          ? _formatTimestamp(user['lastLogin'])
                          : 'Never',
                      style: TextStyle(color: Colors.white60, fontSize: 12),
                    ),
                    Row(
                      children: [
                        IconButton(
                          icon: Icon(
                            Icons.edit,
                            color: Colors.white60,
                            size: 16,
                          ),
                          onPressed: () {
                            // TODO: Edit user functionality
                          },
                        ),
                        IconButton(
                          icon: Icon(Icons.delete, color: Colors.red, size: 16),
                          onPressed: () {
                            _showDeleteUserDialog(user);
                          },
                        ),
                      ],
                    ),
                  ],
                ),
              ],
            );
          } else {
            // Desktop layout - horizontal row
            return Row(
              children: [
                Expanded(
                  flex: 2,
                  child: Row(
                    children: [
                      Container(
                        width: 32,
                        height: 32,
                        decoration: BoxDecoration(
                          color: const Color(0xFF8B0000),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Center(
                          child: Text(
                            (user['name']?.toString() ?? 'U')
                                .split(' ')
                                .map((n) => n.isNotEmpty ? n[0] : '')
                                .join(''),
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 12,
                            ),
                          ),
                        ),
                      ),
                      SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              user['name']?.toString() ?? 'Unknown Name',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            Text(
                              user['phone']?.toString() ?? 'No phone',
                              style: TextStyle(
                                color: Colors.white60,
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
                Expanded(
                  flex: 3,
                  child: Text(
                    user['email']?.toString() ?? 'No email',
                    style: TextStyle(color: Colors.white),
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
                Expanded(
                  flex: 1,
                  child: Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: _getRoleColor(user['role']).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      user['role']?.toString() ?? 'Unknown',
                      style: TextStyle(
                        color: _getRoleColor(user['role']?.toString() ?? ''),
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                ),
                Expanded(
                  flex: 1,
                  child: Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: user['status'] == 'Active'
                          ? Colors.green.withOpacity(0.2)
                          : Colors.red.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      user['isActive'] == true ? 'Active' : 'Inactive',
                      style: TextStyle(
                        color: user['isActive'] == true
                            ? Colors.green
                            : Colors.red,
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                ),
                Expanded(
                  flex: 2,
                  child: Text(
                    user['lastLogin'] != null
                        ? _formatTimestamp(user['lastLogin'])
                        : 'Never',
                    style: TextStyle(color: Colors.white60, fontSize: 12),
                  ),
                ),
                Expanded(
                  flex: 1,
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    mainAxisAlignment: MainAxisAlignment.end,
                    children: [
                      IconButton(
                        icon: Icon(Icons.edit, color: Colors.white60, size: 16),
                        padding: EdgeInsets.all(4),
                        constraints: BoxConstraints(
                          minWidth: 32,
                          minHeight: 32,
                        ),
                        onPressed: () {
                          // TODO: Edit user functionality
                        },
                      ),
                      IconButton(
                        icon: Icon(Icons.delete, color: Colors.red, size: 16),
                        padding: EdgeInsets.all(4),
                        constraints: BoxConstraints(
                          minWidth: 32,
                          minHeight: 32,
                        ),
                        onPressed: () {
                          _showDeleteUserDialog(user);
                        },
                      ),
                    ],
                  ),
                ),
              ],
            );
          }
        },
      ),
    );
  }

  Color _getRoleColor(String role) {
    switch (role) {
      case 'Admin':
        return const Color(0xFF8B0000);
      case 'Manager':
        return Colors.orange;
      case 'Designer':
        return Colors.blue;
      default:
        return Colors.grey;
    }
  }

  String _formatTimestamp(dynamic timestamp) {
    if (timestamp == null) return 'Never';

    try {
      if (timestamp is Timestamp) {
        final date = timestamp.toDate();
        return '${date.day}/${date.month}/${date.year} ${date.hour}:${date.minute.toString().padLeft(2, '0')}';
      } else if (timestamp is String) {
        return timestamp;
      } else {
        return 'Unknown';
      }
    } catch (e) {
      return 'Error';
    }
  }

  void _showAddUserDialog() {
    // Reset form fields
    _nameController.clear();
    _emailController.clear();
    _phoneController.clear();
    _selectedRole = 'Designer';
    _selectedStatus = 'Active';

    showDialog(
      context: context,
      builder: (BuildContext context) {
        return StatefulBuilder(
          builder: (context, setState) {
            return AlertDialog(
              backgroundColor: const Color(0xFF1A1A1A),
              title: Row(
                children: [
                  Icon(Icons.person_add, color: const Color(0xFF8B0000)),
                  SizedBox(width: 12),
                  Text(
                    'Add New User',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              content: SizedBox(
                width: 400,
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Name Field
                    TextField(
                      controller: _nameController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Full Name',
                        labelStyle: TextStyle(color: Colors.white60),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Email Field
                    TextField(
                      controller: _emailController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Email Address',
                        labelStyle: TextStyle(color: Colors.white60),
                        hintText: 'user@impactgraphicsza.co.za',
                        hintStyle: TextStyle(
                          color: Colors.white.withOpacity(0.4),
                        ),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Phone Field
                    TextField(
                      controller: _phoneController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Phone Number',
                        labelStyle: TextStyle(color: Colors.white60),
                        hintText: '+27 82 123 4567',
                        hintStyle: TextStyle(
                          color: Colors.white.withOpacity(0.4),
                        ),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Role Dropdown
                    Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Role',
                                style: TextStyle(
                                  color: Colors.white60,
                                  fontSize: 12,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                              SizedBox(height: 8),
                              Container(
                                decoration: BoxDecoration(
                                  border: Border.all(
                                    color: Colors.white.withOpacity(0.3),
                                  ),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: DropdownButtonFormField<String>(
                                  initialValue: _selectedRole,
                                  dropdownColor: const Color(0xFF1A1A1A),
                                  style: TextStyle(color: Colors.white),
                                  decoration: InputDecoration(
                                    border: InputBorder.none,
                                    contentPadding: EdgeInsets.symmetric(
                                      horizontal: 12,
                                      vertical: 8,
                                    ),
                                  ),
                                  items: ['Admin', 'Manager', 'Designer'].map((
                                    String role,
                                  ) {
                                    return DropdownMenuItem<String>(
                                      value: role,
                                      child: Row(
                                        children: [
                                          Container(
                                            width: 12,
                                            height: 12,
                                            decoration: BoxDecoration(
                                              color: _getRoleColor(role),
                                              shape: BoxShape.circle,
                                            ),
                                          ),
                                          SizedBox(width: 8),
                                          Text(role),
                                        ],
                                      ),
                                    );
                                  }).toList(),
                                  onChanged: (String? newValue) {
                                    setState(() {
                                      _selectedRole = newValue!;
                                    });
                                  },
                                ),
                              ),
                            ],
                          ),
                        ),
                        SizedBox(width: 16),

                        // Status Dropdown
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Status',
                                style: TextStyle(
                                  color: Colors.white60,
                                  fontSize: 12,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                              SizedBox(height: 8),
                              Container(
                                decoration: BoxDecoration(
                                  border: Border.all(
                                    color: Colors.white.withOpacity(0.3),
                                  ),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: DropdownButtonFormField<String>(
                                  initialValue: _selectedStatus,
                                  dropdownColor: const Color(0xFF1A1A1A),
                                  style: TextStyle(color: Colors.white),
                                  decoration: InputDecoration(
                                    border: InputBorder.none,
                                    contentPadding: EdgeInsets.symmetric(
                                      horizontal: 12,
                                      vertical: 8,
                                    ),
                                  ),
                                  items: ['Active', 'Inactive'].map((
                                    String status,
                                  ) {
                                    return DropdownMenuItem<String>(
                                      value: status,
                                      child: Row(
                                        children: [
                                          Container(
                                            width: 12,
                                            height: 12,
                                            decoration: BoxDecoration(
                                              color: status == 'Active'
                                                  ? Colors.green
                                                  : Colors.red,
                                              shape: BoxShape.circle,
                                            ),
                                          ),
                                          SizedBox(width: 8),
                                          Text(status),
                                        ],
                                      ),
                                    );
                                  }).toList(),
                                  onChanged: (String? newValue) {
                                    setState(() {
                                      _selectedStatus = newValue!;
                                    });
                                  },
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              actions: [
                TextButton(
                  onPressed: () {
                    Navigator.of(context).pop();
                  },
                  child: Text(
                    'Cancel',
                    style: TextStyle(color: Colors.white60),
                  ),
                ),
                ElevatedButton(
                  onPressed: () {
                    _addNewUser();
                    Navigator.of(context).pop();
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                  ),
                  child: Text('Add User'),
                ),
              ],
            );
          },
        );
      },
    );
  }

  void _showAddClientDialog() {
    // Reset form fields
    _clientNameController.clear();
    _clientContactController.clear();
    _clientEmailController.clear();
    _clientPhoneController.clear();
    _clientAddressController.clear();
    _selectedClientStatus = 'Active';

    showDialog(
      context: context,
      builder: (BuildContext context) {
        return StatefulBuilder(
          builder: (context, setState) {
            return AlertDialog(
              backgroundColor: const Color(0xFF1A1A1A),
              title: Row(
                children: [
                  Icon(Icons.business, color: const Color(0xFF8B0000)),
                  SizedBox(width: 12),
                  Text(
                    'Add New Client',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              content: SizedBox(
                width: 400,
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Company Name Field
                    TextField(
                      controller: _clientNameController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Company Name',
                        labelStyle: TextStyle(color: Colors.white60),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Contact Person Field
                    TextField(
                      controller: _clientContactController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Contact Person',
                        labelStyle: TextStyle(color: Colors.white60),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Email Field
                    TextField(
                      controller: _clientEmailController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Email Address',
                        labelStyle: TextStyle(color: Colors.white60),
                        hintText: 'contact@company.co.za',
                        hintStyle: TextStyle(
                          color: Colors.white.withOpacity(0.4),
                        ),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Phone Field
                    TextField(
                      controller: _clientPhoneController,
                      style: TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        labelText: 'Phone Number',
                        labelStyle: TextStyle(color: Colors.white60),
                        hintText: '+27 82 123 4567',
                        hintStyle: TextStyle(
                          color: Colors.white.withOpacity(0.4),
                        ),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Address Field
                    TextField(
                      controller: _clientAddressController,
                      style: TextStyle(color: Colors.white),
                      maxLines: 2,
                      decoration: InputDecoration(
                        labelText: 'Company Address',
                        labelStyle: TextStyle(color: Colors.white60),
                        hintText:
                            '123 Business Street, Johannesburg, South Africa',
                        hintStyle: TextStyle(
                          color: Colors.white.withOpacity(0.4),
                        ),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide(
                            color: const Color(0xFF8B0000),
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),

                    // Status Dropdown
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Status',
                          style: TextStyle(
                            color: Colors.white60,
                            fontSize: 12,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                        SizedBox(height: 8),
                        Container(
                          decoration: BoxDecoration(
                            border: Border.all(
                              color: Colors.white.withOpacity(0.3),
                            ),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: DropdownButtonFormField<String>(
                            initialValue: _selectedClientStatus,
                            dropdownColor: const Color(0xFF1A1A1A),
                            style: TextStyle(color: Colors.white),
                            decoration: InputDecoration(
                              border: InputBorder.none,
                              contentPadding: EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 8,
                              ),
                            ),
                            items: ['Active', 'Inactive'].map((String status) {
                              return DropdownMenuItem<String>(
                                value: status,
                                child: Row(
                                  children: [
                                    Container(
                                      width: 12,
                                      height: 12,
                                      decoration: BoxDecoration(
                                        color: status == 'Active'
                                            ? Colors.green
                                            : Colors.red,
                                        shape: BoxShape.circle,
                                      ),
                                    ),
                                    SizedBox(width: 8),
                                    Text(status),
                                  ],
                                ),
                              );
                            }).toList(),
                            onChanged: (String? newValue) {
                              setState(() {
                                _selectedClientStatus = newValue!;
                              });
                            },
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              actions: [
                TextButton(
                  onPressed: () {
                    Navigator.of(context).pop();
                  },
                  child: Text(
                    'Cancel',
                    style: TextStyle(color: Colors.white60),
                  ),
                ),
                ElevatedButton(
                  onPressed: () {
                    _addNewClient();
                    Navigator.of(context).pop();
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                  ),
                  child: Text('Add Client'),
                ),
              ],
            );
          },
        );
      },
    );
  }

  Widget _buildClientDetailsScreen() {
    final client = _selectedClient!;

    return SingleChildScrollView(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header with back button
          Row(
            children: [
              IconButton(
                icon: Icon(Icons.arrow_back, color: Colors.white),
                onPressed: () {
                  setState(() {
                    _selectedClient = null;
                  });
                },
              ),
              SizedBox(width: 8),
              Expanded(
                child: Text(
                  '${client['name']} - Client Details',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              ElevatedButton.icon(
                onPressed: () {
                  // TODO: Edit client functionality
                },
                icon: Icon(Icons.edit, size: 16),
                label: Text('Edit Client'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF8B0000),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(6),
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: 20),

          // Client Overview Card
          Container(
            padding: EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: const Color(0xFF1A1A1A),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.white.withOpacity(0.1)),
            ),
            child: Row(
              children: [
                Container(
                  width: 80,
                  height: 80,
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000),
                    borderRadius: BorderRadius.circular(40),
                  ),
                  child: Icon(Icons.business, color: Colors.white, size: 40),
                ),
                SizedBox(width: 20),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        client['name'],
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Client ID: ${client['id']}',
                        style: TextStyle(color: Colors.white60, fontSize: 14),
                      ),
                      SizedBox(height: 8),
                      Row(
                        children: [
                          Container(
                            padding: EdgeInsets.symmetric(
                              horizontal: 12,
                              vertical: 6,
                            ),
                            decoration: BoxDecoration(
                              color: client['status'] == 'Active'
                                  ? Colors.green.withOpacity(0.2)
                                  : Colors.red.withOpacity(0.2),
                              borderRadius: BorderRadius.circular(20),
                              border: Border.all(
                                color: client['status'] == 'Active'
                                    ? Colors.green
                                    : Colors.red,
                                width: 1,
                              ),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Container(
                                  width: 8,
                                  height: 8,
                                  decoration: BoxDecoration(
                                    color: client['status'] == 'Active'
                                        ? Colors.green
                                        : Colors.red,
                                    shape: BoxShape.circle,
                                  ),
                                ),
                                SizedBox(width: 8),
                                Text(
                                  client['status'],
                                  style: TextStyle(
                                    color: client['status'] == 'Active'
                                        ? Colors.green
                                        : Colors.red,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          SizedBox(width: 16),
                          Icon(
                            Icons.location_on,
                            color: Colors.white60,
                            size: 16,
                          ),
                          SizedBox(width: 4),
                          Text(
                            client['address'],
                            style: TextStyle(
                              color: Colors.white60,
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 20),

          // Quick Stats Row
          Row(
            children: [
              Expanded(
                child: _buildQuickStatCard(
                  'Total Orders',
                  '${client['totalOrders']}',
                  Icons.shopping_cart,
                ),
              ),
              SizedBox(width: 16),
              Expanded(
                child: _buildQuickStatCard(
                  'Total Spent',
                  'R ${(client['totalSpent'] as num?)?.toStringAsFixed(0) ?? '0'}',
                  Icons.payments,
                ),
              ),
              SizedBox(width: 16),
              Expanded(
                child: _buildQuickStatCard(
                  'Wallet Balance',
                  'R ${(client['walletBalance'] as num?)?.toStringAsFixed(2) ?? '0.00'}',
                  Icons.account_balance_wallet,
                ),
              ),
              SizedBox(width: 16),
              Expanded(
                child: _buildQuickStatCard(
                  'Active Packages',
                  '${client['activePackageCount'] ?? (client['activePackage'] != null ? 1 : 0)}',
                  Icons.inventory,
                ),
              ),
            ],
          ),
          SizedBox(height: 20),

          // Overview Information
          _buildOverviewTab(client),
        ],
      ),
    );
  }

  Widget _buildQuickStatCard(String title, String value, IconData icon) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(icon, color: const Color(0xFF8B0000), size: 24),
          SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              color: Colors.white,
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          Text(title, style: TextStyle(color: Colors.white60, fontSize: 12)),
        ],
      ),
    );
  }

  Widget _buildOverviewTab(Map<String, dynamic> client) {
    return SingleChildScrollView(
      child: Column(
        children: [
          _buildInfoSection('Contact Information', [
            _buildInfoRow('Contact Person', client['contact']),
            _buildInfoRow('Phone Number', client['phone']),
            _buildInfoRow('Email Address', client['email']),
            _buildInfoRow('Last Login', '2025-08-21 14:30'),
          ]),
          SizedBox(height: 16),
          _buildInfoSection('Company Information', [
            _buildInfoRow('Company Name', client['name']),
            _buildInfoRow('Address', client['address']),
            _buildInfoRow('Account Created', '2025-01-15'),
            _buildInfoRow('Account Status', client['status']),
          ]),
          SizedBox(height: 16),
          _buildInfoSection('Recent Activity', [
            _buildInfoRow('Last Order', '2025-08-15'),
            _buildInfoRow('Last Payment', '2025-08-21'),
            _buildInfoRow('Last Support Contact', '2025-08-14'),
            _buildInfoRow(
              'Average Order Value',
              _calculateAverageOrder(client),
            ),
          ]),
        ],
      ),
    );
  }

  Widget _buildInvoicesTab(Map<String, dynamic> client) {
    return SingleChildScrollView(
      child: Column(
        children: [
          _buildInvoiceCard(
            'INV-2025-001',
            'Logo Design Package',
            'R 5,500',
            'Paid',
          ),
          SizedBox(height: 12),
          _buildInvoiceCard(
            'INV-2025-002',
            'Business Cards',
            'R 2,800',
            'Pending',
          ),
          SizedBox(height: 12),
          _buildInvoiceCard(
            'INV-2025-003',
            'Website Banner',
            'R 1,200',
            'Paid',
          ),
          SizedBox(height: 12),
          _buildInvoiceCard(
            'INV-2025-004',
            'Social Media Kit',
            'R 3,500',
            'Overdue',
          ),
        ],
      ),
    );
  }

  Widget _buildInvoiceCard(
    String invoiceId,
    String description,
    String amount,
    String status,
  ) {
    Color statusColor = status == 'Paid'
        ? Colors.green
        : status == 'Pending'
        ? Colors.orange
        : Colors.red;

    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  invoiceId,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                Text(
                  description,
                  style: TextStyle(color: Colors.white60, fontSize: 12),
                ),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(
                amount,
                style: TextStyle(
                  color: const Color(0xFF8B0000),
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: statusColor.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Text(
                  status,
                  style: TextStyle(
                    color: statusColor,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildPackagesTab(Map<String, dynamic> client) {
    return SingleChildScrollView(
      child: Column(
        children: [
          _buildPackageCard(
            'Premium Design Package',
            'R 15,000',
            'Active',
            '2025-01-15',
            '2025-12-31',
          ),
          SizedBox(height: 12),
          _buildPackageCard(
            'Social Media Management',
            'R 8,500',
            'Active',
            '2025-03-01',
            '2025-08-31',
          ),
          SizedBox(height: 12),
          _buildPackageCard(
            'Basic Logo Design',
            'R 3,000',
            'Expired',
            '2024-06-01',
            '2024-12-31',
          ),
        ],
      ),
    );
  }

  Widget _buildPackageCard(
    String name,
    String price,
    String status,
    String startDate,
    String endDate,
  ) {
    Color statusColor = status == 'Active' ? Colors.green : Colors.red;

    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Text(
                  name,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: statusColor.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Text(
                  status,
                  style: TextStyle(
                    color: statusColor,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: 8),
          Text(
            'Price: $price',
            style: TextStyle(
              color: const Color(0xFF8B0000),
              fontSize: 14,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 4),
          Text(
            'Duration: $startDate to $endDate',
            style: TextStyle(color: Colors.white60, fontSize: 12),
          ),
        ],
      ),
    );
  }

  Widget _buildMessagesTab(Map<String, dynamic> client) {
    return Column(
      children: [
        // Messages List
        Expanded(
          child: Container(
            decoration: BoxDecoration(
              color: const Color(0xFF1A1A1A),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.white.withOpacity(0.1)),
            ),
            child: ListView(
              padding: EdgeInsets.all(16),
              children: [
                _buildMessageBubble(
                  'Hello! I need help with my logo design.',
                  'Client',
                  '2025-08-21 14:30',
                  false,
                ),
                _buildMessageBubble(
                  'Sure! I can help you with that. What specific changes do you need?',
                  'Admin',
                  '2025-08-21 14:35',
                  true,
                ),
                _buildMessageBubble(
                  'I want to change the colors to match my brand better.',
                  'Client',
                  '2025-08-21 15:00',
                  false,
                ),
                _buildMessageBubble(
                  'Perfect! I\'ll make those changes and send you the updated version.',
                  'Admin',
                  '2025-08-21 15:05',
                  true,
                ),
              ],
            ),
          ),
        ),
        SizedBox(height: 16),

        // Message Input
        Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: const Color(0xFF1A1A1A),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  style: TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'Type your message...',
                    hintStyle: TextStyle(color: Colors.white60),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(
                        color: Colors.white.withOpacity(0.3),
                      ),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(
                        color: Colors.white.withOpacity(0.3),
                      ),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(color: const Color(0xFF8B0000)),
                    ),
                  ),
                ),
              ),
              SizedBox(width: 12),
              ElevatedButton(
                onPressed: () {
                  // TODO: Send message functionality
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF8B0000),
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                child: Icon(Icons.send),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildMessageBubble(
    String message,
    String sender,
    String time,
    bool isAdmin,
  ) {
    return Container(
      margin: EdgeInsets.only(bottom: 12),
      child: Row(
        mainAxisAlignment: isAdmin
            ? MainAxisAlignment.end
            : MainAxisAlignment.start,
        children: [
          if (!isAdmin) ...[
            Container(
              width: 32,
              height: 32,
              decoration: BoxDecoration(
                color: const Color(0xFF8B0000),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(Icons.person, color: Colors.white, size: 16),
            ),
            SizedBox(width: 8),
          ],
          Flexible(
            child: Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: isAdmin
                    ? const Color(0xFF8B0000)
                    : Colors.white.withOpacity(0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    message,
                    style: TextStyle(color: Colors.white, fontSize: 14),
                  ),
                  SizedBox(height: 4),
                  Text(
                    time,
                    style: TextStyle(color: Colors.white60, fontSize: 12),
                  ),
                ],
              ),
            ),
          ),
          if (isAdmin) ...[
            SizedBox(width: 8),
            Container(
              width: 32,
              height: 32,
              decoration: BoxDecoration(
                color: const Color(0xFF8B0000),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(
                Icons.admin_panel_settings,
                color: Colors.white,
                size: 16,
              ),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildInfoSection(String title, List<Widget> children) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            title,
            style: TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 12),
          ...children,
        ],
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          SizedBox(
            width: 140,
            child: Text(
              label,
              style: TextStyle(color: Colors.white60, fontSize: 14),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(
                color: Colors.white,
                fontSize: 14,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _showClientDetails(Map<String, dynamic> client) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return Dialog(
          backgroundColor: const Color(0xFF1A1A1A),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          child: Container(
            width: 600,
            constraints: BoxConstraints(
              maxHeight: MediaQuery.of(context).size.height * 0.8,
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Header
                Container(
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.05),
                    borderRadius: BorderRadius.only(
                      topLeft: Radius.circular(16),
                      topRight: Radius.circular(16),
                    ),
                  ),
                  child: Row(
                    children: [
                      Container(
                        width: 50,
                        height: 50,
                        decoration: BoxDecoration(
                          color: const Color(0xFF8B0000),
                          borderRadius: BorderRadius.circular(25),
                        ),
                        child: Icon(
                          Icons.business,
                          color: Colors.white,
                          size: 24,
                        ),
                      ),
                      SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              client['name'],
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Text(
                              'Client ID: ${client['id']}',
                              style: TextStyle(
                                color: Colors.white60,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                      ),
                      IconButton(
                        icon: Icon(Icons.close, color: Colors.white60),
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                      ),
                    ],
                  ),
                ),

                // Content
                Expanded(
                  child: SingleChildScrollView(
                    padding: EdgeInsets.all(20),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Status Badge
                        Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 6,
                          ),
                          decoration: BoxDecoration(
                            color: client['status'] == 'Active'
                                ? Colors.green.withOpacity(0.2)
                                : Colors.red.withOpacity(0.2),
                            borderRadius: BorderRadius.circular(20),
                            border: Border.all(
                              color: client['status'] == 'Active'
                                  ? Colors.green
                                  : Colors.red,
                              width: 1,
                            ),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Container(
                                width: 8,
                                height: 8,
                                decoration: BoxDecoration(
                                  color: client['status'] == 'Active'
                                      ? Colors.green
                                      : Colors.red,
                                  shape: BoxShape.circle,
                                ),
                              ),
                              SizedBox(width: 8),
                              Text(
                                client['status'],
                                style: TextStyle(
                                  color: client['status'] == 'Active'
                                      ? Colors.green
                                      : Colors.red,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                        ),
                        SizedBox(height: 24),

                        // Contact Information
                        _buildDetailSection(
                          'Contact Information',
                          Icons.person,
                          [
                            _buildDetailRow(
                              'Contact Person',
                              client['contact'],
                            ),
                            _buildDetailRow('Phone Number', client['phone']),
                            _buildDetailRow('Email Address', client['email']),
                          ],
                        ),
                        SizedBox(height: 24),

                        // Company Information
                        _buildDetailSection(
                          'Company Information',
                          Icons.business,
                          [
                            _buildDetailRow('Company Name', client['name']),
                            _buildDetailRow('Address', client['address']),
                          ],
                        ),
                        SizedBox(height: 24),

                        // Business Statistics
                        _buildDetailSection(
                          'Business Statistics',
                          Icons.analytics,
                          [
                            _buildDetailRow(
                              'Total Orders',
                              '${client['totalOrders']}',
                            ),
                            _buildDetailRow(
                              'Total Spent',
                              'R ${(client['totalSpent'] as num?)?.toStringAsFixed(0) ?? '0'}',
                            ),
                            _buildDetailRow(
                              'Average Order Value',
                              _calculateAverageOrder(client),
                            ),
                          ],
                        ),
                        SizedBox(height: 24),

                        // Recent Activity (placeholder)
                        _buildDetailSection('Recent Activity', Icons.history, [
                          _buildDetailRow('Last Order', '2025-08-21'),
                          _buildDetailRow('Last Contact', '2025-08-20'),
                          _buildDetailRow('Account Created', '2025-01-15'),
                        ]),
                      ],
                    ),
                  ),
                ),

                // Footer Actions
                Container(
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.05),
                    borderRadius: BorderRadius.only(
                      bottomLeft: Radius.circular(16),
                      bottomRight: Radius.circular(16),
                    ),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.end,
                    children: [
                      TextButton(
                        onPressed: () {
                          Navigator.of(context).pop();
                        },
                        child: Text(
                          'Close',
                          style: TextStyle(color: Colors.white60),
                        ),
                      ),
                      SizedBox(width: 12),
                      ElevatedButton.icon(
                        onPressed: () {
                          // TODO: Edit client functionality
                          Navigator.of(context).pop();
                        },
                        icon: Icon(Icons.edit, size: 16),
                        label: Text('Edit Client'),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildDetailSection(
    String title,
    IconData icon,
    List<Widget> children,
  ) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Icon(icon, color: const Color(0xFF8B0000), size: 20),
            SizedBox(width: 8),
            Text(
              title,
              style: TextStyle(
                color: Colors.white,
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
        SizedBox(height: 12),
        Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.white.withOpacity(0.05),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: Column(children: children),
        ),
      ],
    );
  }

  String _calculateAverageOrder(Map<String, dynamic> client) {
    int orders = client['totalOrders'] ?? 0;
    if (orders == 0) return 'R 0';

    // totalSpent is now a double, not a string
    double totalSpent = (client['totalSpent'] as num?)?.toDouble() ?? 0.0;
    double average = totalSpent / orders;

    return 'R ${average.toStringAsFixed(0)}';
  }

  void _addNewClient() async {
    if (_clientNameController.text.isNotEmpty &&
        _clientContactController.text.isNotEmpty &&
        _clientEmailController.text.isNotEmpty &&
        _clientPhoneController.text.isNotEmpty &&
        _clientAddressController.text.isNotEmpty) {
      try {
        final newClient = {
          'name': _clientNameController.text,
          'contact': _clientContactController.text,
          'email': _clientEmailController.text,
          'phone': _clientPhoneController.text,
          'address': _clientAddressController.text,
          'status': _selectedClientStatus,
          'totalOrders': 0,
          'totalSpent': 0.0,
          'lastOrder': null,
          'createdAt': FieldValue.serverTimestamp(),
          'updatedAt': FieldValue.serverTimestamp(),
        };

        await FirebaseService.clientsCollection.add(newClient);

        // Clear form fields
        _clientNameController.clear();
        _clientContactController.clear();
        _clientEmailController.clear();
        _clientPhoneController.clear();
        _clientAddressController.clear();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Client added successfully!'),
            backgroundColor: Colors.green,
          ),
        );
      } catch (e) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error adding client: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Please fill in all required fields'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _addNewUser() async {
    if (_nameController.text.isNotEmpty &&
        _emailController.text.isNotEmpty &&
        _phoneController.text.isNotEmpty) {
      try {
        final newUser = {
          'name': _nameController.text,
          'email': _emailController.text,
          'phone': _phoneController.text,
          'role': _selectedRole,
          'isActive': _selectedStatus == 'Active',
          'loyaltyPoints': 0,
          'isSilverTier': false,
          'isGoldTier': false,
          'createdAt': FieldValue.serverTimestamp(),
          'updatedAt': FieldValue.serverTimestamp(),
          'lastLogin': null,
        };

        await FirebaseService.usersCollection.add(newUser);

        // Clear form fields
        _nameController.clear();
        _emailController.clear();
        _phoneController.clear();

        // Show success message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('User ${_nameController.text} added successfully!'),
            backgroundColor: Colors.green,
            duration: Duration(seconds: 3),
          ),
        );
      } catch (e) {
        // Show error message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error adding user: $e'),
            backgroundColor: Colors.red,
            duration: Duration(seconds: 3),
          ),
        );
      }
    } else {
      // Show error message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Please fill in all required fields'),
          backgroundColor: Colors.red,
          duration: Duration(seconds: 3),
        ),
      );
    }
  }

  // Orders Screen Content
  Widget _buildOrdersScreen() {
    print('Building orders screen...'); // Debug log

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              'Order Management',
              style: TextStyle(
                color: Colors.white,
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            Row(
              children: [
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000).withOpacity(0.2),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: StreamBuilder<QuerySnapshot>(
                    stream: FirebaseService.ordersCollection.snapshots(),
                    builder: (context, snapshot) {
                      int totalOrders = snapshot.hasData
                          ? snapshot.data!.docs.length
                          : 0;
                      return Text(
                        '$totalOrders Orders',
                        style: TextStyle(
                          color: const Color(0xFF8B0000),
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      );
                    },
                  ),
                ),
                SizedBox(width: 16),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.orange.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: StreamBuilder<QuerySnapshot>(
                    stream: FirebaseService.ordersCollection
                        .where('status', whereIn: ['accepted', 'in_progress'])
                        .snapshots(),
                    builder: (context, snapshot) {
                      int pendingPaymentOrders = snapshot.hasData
                          ? snapshot.data!.docs.length
                          : 0;
                      return Text(
                        '$pendingPaymentOrders Pending Payment',
                        style: TextStyle(
                          color: Colors.red,
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      );
                    },
                  ),
                ),
                SizedBox(width: 16),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.green.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: StreamBuilder<QuerySnapshot>(
                    stream: FirebaseService.ordersCollection
                        .where('status', isEqualTo: 'completed')
                        .snapshots(),
                    builder: (context, snapshot) {
                      int paidOrders = snapshot.hasData
                          ? snapshot.data!.docs.length
                          : 0;
                      return Text(
                        '$paidOrders Paid',
                        style: TextStyle(
                          color: Colors.green,
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          ],
        ),
        SizedBox(height: 16),

        // Search and Filter Bar
        Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: const Color(0xFF1A1A1A),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  decoration: InputDecoration(
                    hintText:
                        'Search orders by order number, customer name, or service...',
                    hintStyle: TextStyle(color: Colors.white60),
                    prefixIcon: Icon(Icons.search, color: Colors.white60),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(
                        color: Colors.white.withOpacity(0.2),
                      ),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(
                        color: Colors.white.withOpacity(0.2),
                      ),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(color: const Color(0xFF8B0000)),
                    ),
                  ),
                  style: TextStyle(color: Colors.white),
                ),
              ),
              SizedBox(width: 16),
              DropdownButton<String>(
                value: _selectedOrderStatus,
                dropdownColor: const Color(0xFF1A1A1A),
                style: TextStyle(color: Colors.white),
                underline: Container(),
                items: [
                  DropdownMenuItem(value: 'all', child: Text('All Orders')),
                  DropdownMenuItem(
                    value: 'pending',
                    child: Text('Pending Approval'),
                  ),
                  DropdownMenuItem(
                    value: 'accepted',
                    child: Text('Pending Payment'),
                  ),
                  DropdownMenuItem(
                    value: 'in_progress',
                    child: Text('In Progress'),
                  ),
                  DropdownMenuItem(value: 'completed', child: Text('Paid')),
                  DropdownMenuItem(value: 'declined', child: Text('Declined')),
                ],
                onChanged: (value) {
                  setState(() {
                    _selectedOrderStatus = value ?? 'all';
                  });
                },
              ),
            ],
          ),
        ),
        SizedBox(height: 16),

        // Orders List
        Expanded(
          child: StreamBuilder<QuerySnapshot>(
            stream: _getOrdersStream(),
            builder: (context, snapshot) {
              print(
                'Orders StreamBuilder state: ${snapshot.connectionState}',
              ); // Debug log
              print(
                'Orders StreamBuilder hasData: ${snapshot.hasData}',
              ); // Debug log
              print(
                'Orders StreamBuilder docs count: ${snapshot.data?.docs.length ?? 0}',
              ); // Debug log

              if (snapshot.hasError) {
                print(
                  'Orders StreamBuilder error: ${snapshot.error}',
                ); // Debug log
                return Center(
                  child: Text(
                    'Error loading orders: ${snapshot.error}',
                    style: TextStyle(color: Colors.red),
                  ),
                );
              }

              if (snapshot.connectionState == ConnectionState.waiting) {
                print('Orders StreamBuilder waiting...'); // Debug log
                return Center(
                  child: CircularProgressIndicator(
                    color: const Color(0xFF8B0000),
                  ),
                );
              }

              if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                print('Orders StreamBuilder: No orders found'); // Debug log
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.shopping_bag_outlined,
                        size: 64,
                        color: Colors.white60,
                      ),
                      SizedBox(height: 16),
                      Text(
                        'No orders found',
                        style: TextStyle(
                          color: Colors.white60,
                          fontSize: 18,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                      SizedBox(height: 8),
                      Text(
                        'Orders will appear here when customers place them',
                        style: TextStyle(
                          color: Colors.white.withOpacity(0.4),
                          fontSize: 14,
                        ),
                      ),
                    ],
                  ),
                );
              }

              return ListView.builder(
                itemCount: snapshot.data!.docs.length,
                itemBuilder: (context, index) {
                  final orderData =
                      snapshot.data!.docs[index].data() as Map<String, dynamic>;
                  final orderId = snapshot.data!.docs[index].id;
                  return _buildAdminOrderCard(orderData, orderId);
                },
              );
            },
          ),
        ),
      ],
    );
  }

  Stream<QuerySnapshot> _getOrdersStream() {
    print(
      'Getting orders stream for status: $_selectedOrderStatus',
    ); // Debug log
    if (_selectedOrderStatus == 'all') {
      return FirebaseService.ordersCollection
          .orderBy('createdAt', descending: true)
          .snapshots();
    } else {
      return FirebaseService.ordersCollection
          .where('status', isEqualTo: _selectedOrderStatus)
          .orderBy('createdAt', descending: true)
          .snapshots();
    }
  }

  Widget _buildAdminOrderCard(Map<String, dynamic> orderData, String orderId) {
    final status = orderData['status'] ?? 'pending';
    final orderNumber =
        orderData['orderNumber'] ??
        orderId; // Use generated order number, fallback to document ID
    final customerName = orderData['customerName'] ?? 'Unknown Customer';
    final serviceName = orderData['serviceName'] ?? 'Unknown Service';
    final price = orderData['finalPrice'] ?? orderData['price'] ?? 0.0;
    final createdAt = orderData['createdAt'] as Timestamp?;
    final description =
        orderData['projectDescription'] ??
        orderData['description'] ??
        'No description provided';

    Color statusColor;
    String statusText;

    switch (status) {
      case 'pending':
        statusColor = Colors.orange;
        statusText = 'Pending Approval';
        break;
      case 'accepted':
        statusColor = Colors.red; // Red for pending payment
        statusText = 'Pending Payment';
        break;
      case 'in_progress':
        statusColor = Colors.red; // Red for pending payment
        statusText = 'Pending Payment';
        break;
      case 'completed':
        statusColor = Colors.green; // Green for paid
        statusText = 'Paid';
        break;
      case 'declined':
        statusColor = Colors.grey;
        statusText = 'Declined';
        break;
      default:
        statusColor = Colors.grey;
        statusText = 'Unknown';
    }

    return Container(
      margin: EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withOpacity(0.1)),
      ),
      child: ExpansionTile(
        title: Row(
          children: [
            Container(
              padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: statusColor.withOpacity(0.2),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                statusText,
                style: TextStyle(
                  color: statusColor,
                  fontWeight: FontWeight.w500,
                  fontSize: 12,
                ),
              ),
            ),
            SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    orderNumber,
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  Text(
                    customerName,
                    style: TextStyle(color: Colors.white60, fontSize: 12),
                  ),
                ],
              ),
            ),
            Text(
              'R ${price.toStringAsFixed(0)}',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
          ],
        ),
        subtitle: Padding(
          padding: EdgeInsets.only(top: 8),
          child: Row(
            children: [
              Icon(Icons.business, color: Colors.white60, size: 16),
              SizedBox(width: 4),
              Text(
                serviceName,
                style: TextStyle(color: Colors.white60, fontSize: 12),
              ),
              Spacer(),
              Text(
                createdAt != null
                    ? DateFormat('MMM dd, yyyy').format(createdAt.toDate())
                    : 'Unknown date',
                style: TextStyle(
                  color: Colors.white.withOpacity(0.4),
                  fontSize: 12,
                ),
              ),
            ],
          ),
        ),
        children: [
          Container(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Project Description
                Text(
                  'Project Description:',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 14,
                  ),
                ),
                SizedBox(height: 8),
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.05),
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Text(
                    description,
                    style: TextStyle(color: Colors.white70, fontSize: 13),
                  ),
                ),
                SizedBox(height: 16),

                // Action Buttons
                Row(
                  children: [
                    if (status == 'pending') ...[
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: () =>
                              _acceptOrder({...orderData, 'id': orderId}),
                          icon: Icon(Icons.check, size: 16),
                          label: Text('Accept Order'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                            padding: EdgeInsets.symmetric(vertical: 12),
                          ),
                        ),
                      ),
                      SizedBox(width: 12),
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: () =>
                              _declineOrder({...orderData, 'id': orderId}),
                          icon: Icon(Icons.close, size: 16),
                          label: Text('Decline Order'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.red,
                            foregroundColor: Colors.white,
                            padding: EdgeInsets.symmetric(vertical: 12),
                          ),
                        ),
                      ),
                    ] else if (status == 'accepted') ...[
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: () =>
                              _updateOrderStatus(orderId, 'in_progress'),
                          icon: Icon(Icons.play_arrow, size: 16),
                          label: Text('Start Work'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue,
                            foregroundColor: Colors.white,
                            padding: EdgeInsets.symmetric(vertical: 12),
                          ),
                        ),
                      ),
                    ] else if (status == 'in_progress') ...[
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: () =>
                              _updateOrderStatus(orderId, 'completed'),
                          icon: Icon(Icons.check_circle, size: 16),
                          label: Text('Mark Complete'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                            padding: EdgeInsets.symmetric(vertical: 12),
                          ),
                        ),
                      ),
                    ],
                    SizedBox(width: 12),
                    Expanded(
                      child: OutlinedButton.icon(
                        onPressed: () => _showOrderDetails(orderData),
                        icon: Icon(Icons.visibility, size: 16),
                        label: Text('View Details'),
                        style: OutlinedButton.styleFrom(
                          foregroundColor: Colors.white,
                          side: BorderSide(
                            color: Colors.white.withOpacity(0.3),
                          ),
                          padding: EdgeInsets.symmetric(vertical: 12),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _updateOrderStatus(String orderId, String newStatus) async {
    try {
      await FirebaseService.ordersCollection.doc(orderId).update({
        'status': newStatus,
        'updatedAt': FieldValue.serverTimestamp(),
      });

      String statusText = newStatus.replaceAll('_', ' ').toUpperCase();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Order status updated to $statusText!'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error updating order status: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  Widget _buildOrderDetailRow(String label, String value) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 120,
            child: Text(
              '$label:',
              style: TextStyle(
                color: Colors.white60,
                fontWeight: FontWeight.w500,
                fontSize: 12,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(color: Colors.white, fontSize: 12),
            ),
          ),
        ],
      ),
    );
  }

  // Helper method to update cart item status
  Future<void> _updateCartItemStatus(String orderId, String status) async {
    try {
      // Get the order data to find the user ID
      final orderDoc = await FirebaseService.ordersCollection
          .doc(orderId)
          .get();
      if (!orderDoc.exists) {
        print('Order not found: $orderId');
        return;
      }

      final orderData = orderDoc.data() as Map<String, dynamic>;
      final userId = orderData['userId'];

      if (userId == null) {
        print('User ID not found in order: $orderId');
        return;
      }

      // Find cart items with this order ID for the specific user
      final cartItems = await FirebaseFirestore.instance
          .collection('carts')
          .doc(userId)
          .collection('items')
          .where('orderId', isEqualTo: orderId)
          .get();

      for (var doc in cartItems.docs) {
        await doc.reference.update({
          'orderStatus': status,
          'updatedAt': FieldValue.serverTimestamp(),
        });
      }

      // If order is declined, remove it from cart after a delay
      if (status == 'declined') {
        Future.delayed(const Duration(seconds: 5), () async {
          for (var doc in cartItems.docs) {
            await doc.reference.delete();
          }
        });
      }

      print(
        'Successfully updated cart item status for order $orderId to $status',
      );
    } catch (e) {
      print('Error updating cart item status: $e');
    }
  }

  // Invoices Screen Content
  Widget _buildInvoicesScreen() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Invoice Management',
                  style: TextStyle(
                    fontSize: 28,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
                SizedBox(height: 4),
                Text(
                  'View and manage all user invoices',
                  style: TextStyle(fontSize: 14, color: Colors.white70),
                ),
              ],
            ),
            Row(
              children: [
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: const Color(0xFF8B0000).withOpacity(0.2),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: StreamBuilder<QuerySnapshot>(
                    stream: FirebaseService.ordersCollection.snapshots(),
                    builder: (context, snapshot) {
                      int totalInvoices = snapshot.hasData
                          ? snapshot.data!.docs.length
                          : 0;
                      return Text(
                        '$totalInvoices Invoices',
                        style: TextStyle(
                          color: const Color(0xFF8B0000),
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      );
                    },
                  ),
                ),
                SizedBox(width: 16),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.green.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: StreamBuilder<QuerySnapshot>(
                    stream: FirebaseService.ordersCollection
                        .where('status', isEqualTo: 'completed')
                        .snapshots(),
                    builder: (context, snapshot) {
                      int paidInvoices = snapshot.hasData
                          ? snapshot.data!.docs.length
                          : 0;
                      return Text(
                        '$paidInvoices Paid',
                        style: TextStyle(
                          color: Colors.green,
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      );
                    },
                  ),
                ),
                SizedBox(width: 16),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.orange.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: StreamBuilder<QuerySnapshot>(
                    stream: FirebaseService.ordersCollection
                        .where('status', whereIn: ['pending', 'accepted'])
                        .snapshots(),
                    builder: (context, snapshot) {
                      int pendingInvoices = snapshot.hasData
                          ? snapshot.data!.docs.length
                          : 0;
                      return Text(
                        '$pendingInvoices Pending',
                        style: TextStyle(
                          color: Colors.orange,
                          fontWeight: FontWeight.w500,
                          fontSize: 12,
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          ],
        ),
        SizedBox(height: 24),

        // Search Bar
        Container(
          decoration: BoxDecoration(
            color: const Color(0xFF1A1A1A),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.white.withOpacity(0.1)),
          ),
          child: TextField(
            controller: _searchController,
            onChanged: (value) {
              setState(() {
                _searchQuery = value;
              });
            },
            style: TextStyle(color: Colors.white),
            decoration: InputDecoration(
              hintText:
                  'Search invoices by order number, name, email, or phone...',
              hintStyle: TextStyle(color: Colors.white60),
              prefixIcon: Icon(Icons.search, color: Colors.white60),
              suffixIcon: _searchQuery.isNotEmpty
                  ? IconButton(
                      icon: Icon(Icons.clear, color: Colors.white60),
                      onPressed: () {
                        setState(() {
                          _searchQuery = '';
                          _searchController.clear();
                        });
                      },
                    )
                  : null,
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 12,
              ),
            ),
          ),
        ),
        SizedBox(height: 16),

        // Invoices Table with Real-time Data
        Expanded(
          child: Container(
            decoration: BoxDecoration(
              color: const Color(0xFF1A1A1A),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.white.withOpacity(0.1)),
            ),
            child: StreamBuilder<QuerySnapshot>(
              stream: FirebaseService.ordersCollection
                  .orderBy('createdAt', descending: true)
                  .snapshots(),
              builder: (context, snapshot) {
                if (snapshot.hasError) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.error_outline, color: Colors.red, size: 48),
                        SizedBox(height: 16),
                        Text(
                          'Error loading invoices: ${snapshot.error}',
                          style: TextStyle(color: Colors.red, fontSize: 16),
                        ),
                      ],
                    ),
                  );
                }

                if (snapshot.connectionState == ConnectionState.waiting) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        CircularProgressIndicator(
                          color: const Color(0xFF8B0000),
                        ),
                        SizedBox(height: 16),
                        Text(
                          'Loading invoices...',
                          style: TextStyle(color: Colors.white60, fontSize: 16),
                        ),
                      ],
                    ),
                  );
                }

                final invoices = snapshot.data?.docs ?? [];

                // Filter invoices based on search query
                final filteredInvoices = _searchQuery.isEmpty
                    ? invoices
                    : invoices.where((doc) {
                        final data = doc.data() as Map<String, dynamic>;
                        final query = _searchQuery.toLowerCase();
                        return data['orderId']
                                    ?.toString()
                                    .toLowerCase()
                                    .contains(query) ==
                                true ||
                            data['userName']?.toString().toLowerCase().contains(
                                  query,
                                ) ==
                                true ||
                            data['userEmail']
                                    ?.toString()
                                    .toLowerCase()
                                    .contains(query) ==
                                true ||
                            data['userPhone']
                                    ?.toString()
                                    .toLowerCase()
                                    .contains(query) ==
                                true;
                      }).toList();

                if (filteredInvoices.isEmpty) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.receipt_long,
                          color: Colors.white60,
                          size: 48,
                        ),
                        SizedBox(height: 16),
                        Text(
                          _searchQuery.isNotEmpty
                              ? 'No invoices found matching "$_searchQuery"'
                              : 'No invoices found',
                          style: TextStyle(color: Colors.white60, fontSize: 16),
                        ),
                        SizedBox(height: 24),
                        // Quick Start Section
                        Container(
                          padding: EdgeInsets.all(20),
                          decoration: BoxDecoration(
                            color: Colors.orange.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(
                              color: Colors.orange.withOpacity(0.3),
                            ),
                          ),
                          child: Column(
                            children: [
                              Text(
                                'Quick Start',
                                style: TextStyle(
                                  color: Colors.orange,
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              SizedBox(height: 12),
                              Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  ElevatedButton.icon(
                                    onPressed: () {
                                      print(
                                        'Load Sample Invoices button clicked!',
                                      );
                                      _populateSampleInvoices();
                                    },
                                    icon: Icon(Icons.data_usage, size: 20),
                                    label: Text(
                                      'Load Sample Invoices',
                                      style: TextStyle(fontSize: 16),
                                    ),
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.orange,
                                      foregroundColor: Colors.white,
                                      padding: EdgeInsets.symmetric(
                                        horizontal: 24,
                                        vertical: 16,
                                      ),
                                      shape: RoundedRectangleBorder(
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                    ),
                                  ),
                                  SizedBox(width: 16),
                                  ElevatedButton.icon(
                                    onPressed: () => _showCreateInvoiceDialog(),
                                    icon: Icon(Icons.add, size: 20),
                                    label: Text(
                                      'Create Custom',
                                      style: TextStyle(fontSize: 16),
                                    ),
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: const Color(0xFF8B0000),
                                      foregroundColor: Colors.white,
                                      padding: EdgeInsets.symmetric(
                                        horizontal: 24,
                                        vertical: 16,
                                      ),
                                      shape: RoundedRectangleBorder(
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                        SizedBox(height: 16),
                        Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 8,
                          ),
                          decoration: BoxDecoration(
                            color: Colors.green.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(20),
                            border: Border.all(
                              color: Colors.green.withOpacity(0.3),
                            ),
                          ),
                          child: Text(
                            'Real-time sync is active âœ“',
                            style: TextStyle(
                              color: Colors.green,
                              fontSize: 12,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ),
                      ],
                    ),
                  );
                }

                return Column(
                  children: [
                    // Table Header
                    Container(
                      padding: EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.05),
                        borderRadius: BorderRadius.only(
                          topLeft: Radius.circular(8),
                          topRight: Radius.circular(8),
                        ),
                      ),
                      child: Row(
                        children: [
                          Expanded(
                            flex: 2,
                            child: Text(
                              'Order ID',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          Expanded(
                            flex: 2,
                            child: Text(
                              'Customer',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          Expanded(
                            flex: 2,
                            child: Text(
                              'Service',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              'Amount',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              'Status',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          Expanded(
                            flex: 2,
                            child: Text(
                              'Date',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                          Expanded(
                            flex: 1,
                            child: Text(
                              'Actions',
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    // Invoices List
                    Expanded(
                      child: ListView.builder(
                        itemCount: filteredInvoices.length,
                        itemBuilder: (context, index) {
                          final data =
                              filteredInvoices[index].data()
                                  as Map<String, dynamic>;
                          return _buildInvoiceRow(data);
                        },
                      ),
                    ),
                  ],
                );
              },
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildInvoiceRow(Map<String, dynamic> invoice) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        border: Border(
          bottom: BorderSide(color: Colors.white.withOpacity(0.1)),
        ),
      ),
      child: Row(
        children: [
          Expanded(
            flex: 2,
            child: Text(
              invoice['orderId']?.toString() ?? 'N/A',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  invoice['userName']?.toString() ?? 'Unknown',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                Text(
                  invoice['userEmail']?.toString() ?? 'No email',
                  style: TextStyle(color: Colors.white60, fontSize: 12),
                ),
              ],
            ),
          ),
          Expanded(
            flex: 2,
            child: Text(
              invoice['serviceName']?.toString() ?? 'Unknown Service',
              style: TextStyle(color: Colors.white),
              overflow: TextOverflow.ellipsis,
            ),
          ),
          Expanded(
            flex: 1,
            child: Text(
              'R${invoice['totalAmount']?.toString() ?? '0'}',
              style: TextStyle(
                color: Colors.green,
                fontWeight: FontWeight.bold,
                fontSize: 14,
              ),
            ),
          ),
          Expanded(
            flex: 1,
            child: Container(
              padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: _getInvoiceStatusColor(
                  invoice['status'],
                ).withOpacity(0.2),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                _getInvoiceStatusText(invoice['status']),
                style: TextStyle(
                  color: _getInvoiceStatusColor(invoice['status']),
                  fontSize: 12,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
          ),
          Expanded(
            flex: 2,
            child: Text(
              _formatTimestamp(invoice['createdAt']),
              style: TextStyle(color: Colors.white60, fontSize: 12),
            ),
          ),
          Expanded(
            flex: 1,
            child: Row(
              children: [
                IconButton(
                  icon: Icon(Icons.visibility, color: Colors.white60, size: 16),
                  onPressed: () => _viewInvoiceDetails(invoice),
                ),
                IconButton(
                  icon: Icon(Icons.download, color: Colors.white60, size: 16),
                  onPressed: () => _downloadInvoice(invoice),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Color _getInvoiceStatusColor(String? status) {
    switch (status?.toLowerCase()) {
      case 'completed':
      case 'paid':
        return Colors.green;
      case 'pending':
      case 'accepted':
        return Colors.orange;
      case 'declined':
      case 'cancelled':
        return Colors.red;
      default:
        return Colors.grey;
    }
  }

  String _getInvoiceStatusText(String? status) {
    switch (status?.toLowerCase()) {
      case 'completed':
        return 'Paid';
      case 'pending':
        return 'Pending';
      case 'accepted':
        return 'Accepted';
      case 'declined':
        return 'Declined';
      case 'cancelled':
        return 'Cancelled';
      default:
        return 'Unknown';
    }
  }

  void _viewInvoiceDetails(Map<String, dynamic> invoice) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            'Invoice Details',
            style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
          ),
          content: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                _buildInvoiceDetailRow(
                  'Order ID',
                  invoice['orderId']?.toString() ?? 'N/A',
                ),
                _buildInvoiceDetailRow(
                  'Customer',
                  invoice['userName']?.toString() ?? 'Unknown',
                ),
                _buildInvoiceDetailRow(
                  'Email',
                  invoice['userEmail']?.toString() ?? 'No email',
                ),
                _buildInvoiceDetailRow(
                  'Phone',
                  invoice['userPhone']?.toString() ?? 'No phone',
                ),
                _buildInvoiceDetailRow(
                  'Service',
                  invoice['serviceName']?.toString() ?? 'Unknown',
                ),
                _buildInvoiceDetailRow(
                  'Amount',
                  'R${invoice['totalAmount']?.toString() ?? '0'}',
                ),
                _buildInvoiceDetailRow(
                  'Status',
                  _getInvoiceStatusText(invoice['status']),
                ),
                _buildInvoiceDetailRow(
                  'Created',
                  _formatTimestamp(invoice['createdAt']),
                ),
                if (invoice['updatedAt'] != null)
                  _buildInvoiceDetailRow(
                    'Updated',
                    _formatTimestamp(invoice['updatedAt']),
                  ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: Text('Close', style: TextStyle(color: Colors.white70)),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.of(context).pop();
                _downloadInvoice(invoice);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
              ),
              child: Text('Download'),
            ),
          ],
        );
      },
    );
  }

  Widget _buildInvoiceDetailRow(String label, String value) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 80,
            child: Text(
              '$label:',
              style: TextStyle(
                color: Colors.white70,
                fontWeight: FontWeight.w500,
                fontSize: 14,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(color: Colors.white, fontSize: 14),
            ),
          ),
        ],
      ),
    );
  }

  void _downloadInvoice(Map<String, dynamic> invoice) {
    try {
      // Navigate to the same InvoiceScreen that users use
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => InvoiceScreen(
            transactionId: invoice['orderId']?.toString() ?? 'N/A',
            customerName: invoice['userName']?.toString() ?? 'Unknown',
            customerEmail: invoice['userEmail']?.toString() ?? 'No email',
            serviceName:
                invoice['serviceName']?.toString() ?? 'Unknown Service',
            amount: (invoice['totalAmount'] ?? 0.0).toDouble(),
            status: _getInvoiceStatusText(invoice['status']),
            date: invoice['createdAt'] != null
                ? (invoice['createdAt'] as Timestamp).toDate()
                : DateTime.now(),
            phone: invoice['userPhone']?.toString(),
            orderNumber: invoice['orderId']?.toString(),
          ),
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error opening invoice: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Sample invoice data population
  Future<void> _populateSampleInvoices() async {
    print('=== POPULATE SAMPLE INVOICES DEBUG ===');
    print('Creating sample invoices...');

    final sampleInvoices = [
      {
        'orderId': 'INV-2024-001',
        'userName': 'John Smith',
        'userEmail': 'john.smith@email.com',
        'userPhone': '+27 82 123 4567',
        'serviceName': 'Logo Design',
        'totalAmount': 2500.00,
        'status': 'completed',
        'createdAt': FieldValue.serverTimestamp(),
        'description': 'Professional logo design for startup company',
      },
      {
        'orderId': 'INV-2024-002',
        'userName': 'Sarah Johnson',
        'userEmail': 'sarah.j@business.co.za',
        'userPhone': '+27 83 987 6543',
        'serviceName': 'Website Development',
        'totalAmount': 8500.00,
        'status': 'pending',
        'createdAt': FieldValue.serverTimestamp(),
        'description': 'Full website development with e-commerce functionality',
      },
      {
        'orderId': 'INV-2024-003',
        'userName': 'Mike Wilson',
        'userEmail': 'mike.wilson@agency.com',
        'userPhone': '+27 84 555 1234',
        'serviceName': 'Marketing Package',
        'totalAmount': 3000.00,
        'status': 'completed',
        'createdAt': FieldValue.serverTimestamp(),
        'description': 'Growth marketing package with social media management',
      },
      {
        'orderId': 'INV-2024-004',
        'userName': 'Lisa Brown',
        'userEmail': 'lisa.brown@restaurant.co.za',
        'userPhone': '+27 85 777 8888',
        'serviceName': 'Brand Identity',
        'totalAmount': 4500.00,
        'status': 'pending',
        'createdAt': FieldValue.serverTimestamp(),
        'description':
            'Complete brand identity package including logo, colors, and guidelines',
      },
      {
        'orderId': 'INV-2024-005',
        'userName': 'David Thompson',
        'userEmail': 'david.t@techstartup.com',
        'userPhone': '+27 86 999 0000',
        'serviceName': 'UI/UX Design',
        'totalAmount': 6000.00,
        'status': 'completed',
        'createdAt': FieldValue.serverTimestamp(),
        'description': 'Mobile app UI/UX design and prototyping',
      },
    ];

    final batch = FirebaseService.ordersCollection.firestore.batch();

    for (var invoice in sampleInvoices) {
      final docRef = FirebaseService.ordersCollection.doc();
      batch.set(docRef, invoice);
      print(
        '  - Adding invoice: ${invoice['orderId']} - ${invoice['userName']}',
      );
    }

    try {
      await batch.commit();
      print('Sample invoices created successfully');
      print('Batch committed to Firestore');

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Sample invoices loaded successfully!'),
          backgroundColor: Colors.green,
          duration: Duration(seconds: 3),
        ),
      );
    } catch (e) {
      print('Error creating sample invoices: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error loading sample invoices: $e'),
          backgroundColor: Colors.red,
          duration: Duration(seconds: 3),
        ),
      );
    }

    print('=== END POPULATE SAMPLE INVOICES DEBUG ===');
  }

  // Delete client dialog
  void _showDeleteClientDialog(Map<String, dynamic> client) {
    // Add null safety checks
    final clientName = client['name'] ?? 'Unknown Client';
    final clientId = client['id'] ?? '';
    final clientEmail = client['email'] ?? 'No email';

    print('ðŸ”´ Showing delete dialog for client: $clientName');
    print('ðŸ”´ Client ID: $clientId');
    print('ðŸ”´ Client data: $client');

    if (clientId.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: Client ID is missing'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF1A1A1A),
          title: Row(
            children: [
              Icon(Icons.delete_forever, color: Colors.red),
              SizedBox(width: 12),
              Text(
                'Delete Client',
                style: TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          content: Text(
            'Are you sure you want to delete $clientName? This action cannot be undone.',
            style: TextStyle(color: Colors.white),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: Text('Cancel', style: TextStyle(color: Colors.white60)),
            ),
            ElevatedButton(
              onPressed: () async {
                try {
                  print('ðŸ—‘ï¸ Attempting to delete client: $clientId');
                  print('ðŸ—‘ï¸ Client name: $clientName');
                  print('ðŸ—‘ï¸ Client email: $clientEmail');

                  await FirebaseService.deleteClient(clientId);

                  print('âœ… Client deleted successfully from Firebase');

                  Navigator.of(context).pop();
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Client deleted successfully!'),
                      backgroundColor: Colors.green,
                    ),
                  );
                } catch (e) {
                  print('âŒ Error deleting client: $e');
                  print('âŒ Error type: ${e.runtimeType}');

                  Navigator.of(context).pop();
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Error deleting client: $e'),
                      backgroundColor: Colors.red,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.red,
                foregroundColor: Colors.white,
              ),
              child: Text('Delete'),
            ),
          ],
        );
      },
    );
  }

  // Delete user dialog
  void _showDeleteUserDialog(Map<String, dynamic> user) {
    // Add null safety checks
    final userName = user['name'] ?? 'Unknown User';
    final userId = user['id'] ?? '';
    final userEmail = user['email'] ?? 'No email';

    print('ðŸ”´ Showing delete dialog for user: $userName');
    print('ðŸ”´ User ID: $userId');
    print('ðŸ”´ User data: $user');

    if (userId.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: User ID is missing'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF1A1A1A),
          title: Row(
            children: [
              Icon(Icons.delete_forever, color: Colors.red),
              SizedBox(width: 12),
              Text(
                'Delete User',
                style: TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          content: Text(
            'Are you sure you want to delete $userName? This action cannot be undone and will remove ALL user data.',
            style: TextStyle(color: Colors.white),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: Text('Cancel', style: TextStyle(color: Colors.white60)),
            ),
            ElevatedButton(
              onPressed: () async {
                try {
                  print('ðŸ—‘ï¸ Attempting to delete user: $userId');
                  print('ðŸ—‘ï¸ User name: $userName');
                  print('ðŸ—‘ï¸ User email: $userEmail');

                  final result = await FirebaseService.deleteUser(userId);

                  print('âœ… User deleted successfully from Firebase');

                  Navigator.of(context).pop();

                  if (result['success']) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text(
                          'User deleted successfully! All user data has been removed.',
                        ),
                        backgroundColor: Colors.green,
                        duration: Duration(seconds: 5),
                      ),
                    );

                    // Show detailed deletion results
                    if (result['deletionResults'] != null) {
                      final results =
                          result['deletionResults'] as Map<String, dynamic>;
                      print('ðŸ—‘ï¸ User deletion completed:');
                      results.forEach((key, value) {
                        print('  $key: $value');
                      });
                    }
                  } else {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text(
                          'Error deleting user: ${result['message']}',
                        ),
                        backgroundColor: Colors.red,
                        duration: Duration(seconds: 5),
                      ),
                    );
                  }
                } catch (e) {
                  print('âŒ Error deleting user: $e');
                  print('âŒ Error type: ${e.runtimeType}');

                  Navigator.of(context).pop();
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Error deleting user: $e'),
                      backgroundColor: Colors.red,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.red,
                foregroundColor: Colors.white,
              ),
              child: Text('Delete'),
            ),
          ],
        );
      },
    );
  }

  // Create custom invoice dialog
  void _showCreateInvoiceDialog() {
    final TextEditingController orderIdController = TextEditingController();
    final TextEditingController userNameController = TextEditingController();
    final TextEditingController userEmailController = TextEditingController();
    final TextEditingController userPhoneController = TextEditingController();
    final TextEditingController serviceController = TextEditingController();
    final TextEditingController amountController = TextEditingController();
    final TextEditingController descriptionController = TextEditingController();
    String selectedStatus = 'pending';

    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            'Create New Invoice',
            style: TextStyle(
              color: Colors.white,
              fontSize: 20,
              fontWeight: FontWeight.bold,
            ),
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(
                  controller: orderIdController,
                  style: TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    labelText: 'Order ID',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                TextField(
                  controller: userNameController,
                  style: TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    labelText: 'Customer Name',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                TextField(
                  controller: userEmailController,
                  style: TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    labelText: 'Email',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                TextField(
                  controller: userPhoneController,
                  style: TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    labelText: 'Phone',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                TextField(
                  controller: serviceController,
                  style: TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    labelText: 'Service',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                TextField(
                  controller: amountController,
                  style: TextStyle(color: Colors.white),
                  keyboardType: TextInputType.number,
                  decoration: InputDecoration(
                    labelText: 'Amount (R)',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                TextField(
                  controller: descriptionController,
                  style: TextStyle(color: Colors.white),
                  maxLines: 3,
                  decoration: InputDecoration(
                    labelText: 'Description',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                ),
                SizedBox(height: 16),
                DropdownButtonFormField<String>(
                  initialValue: selectedStatus,
                  style: TextStyle(color: Colors.white),
                  dropdownColor: const Color(0xFF2A2A2A),
                  decoration: InputDecoration(
                    labelText: 'Status',
                    labelStyle: TextStyle(color: Colors.white70),
                    border: OutlineInputBorder(),
                    enabledBorder: OutlineInputBorder(
                      borderSide: BorderSide(color: Colors.white30),
                    ),
                  ),
                  items: [
                    DropdownMenuItem(value: 'pending', child: Text('Pending')),
                    DropdownMenuItem(
                      value: 'completed',
                      child: Text('Completed'),
                    ),
                    DropdownMenuItem(
                      value: 'cancelled',
                      child: Text('Cancelled'),
                    ),
                  ],
                  onChanged: (value) {
                    selectedStatus = value!;
                  },
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: Text('Cancel', style: TextStyle(color: Colors.white70)),
            ),
            ElevatedButton(
              onPressed: () async {
                if (orderIdController.text.isEmpty ||
                    userNameController.text.isEmpty ||
                    userEmailController.text.isEmpty ||
                    serviceController.text.isEmpty ||
                    amountController.text.isEmpty) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Please fill in all required fields'),
                      backgroundColor: Colors.red,
                    ),
                  );
                  return;
                }

                try {
                  final amount = double.tryParse(amountController.text) ?? 0.0;

                  await FirebaseService.ordersCollection.add({
                    'orderId': orderIdController.text,
                    'userName': userNameController.text,
                    'userEmail': userEmailController.text,
                    'userPhone': userPhoneController.text,
                    'serviceName': serviceController.text,
                    'totalAmount': amount,
                    'status': selectedStatus,
                    'description': descriptionController.text,
                    'createdAt': FieldValue.serverTimestamp(),
                  });

                  Navigator.of(context).pop();
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Invoice created successfully!'),
                      backgroundColor: Colors.green,
                    ),
                  );
                } catch (e) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Error creating invoice: $e'),
                      backgroundColor: Colors.red,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
              ),
              child: Text('Create Invoice'),
            ),
          ],
        );
      },
    );
  }

  // Notifications Screen Content
  Widget _buildNotificationsScreen() {
    print('Building notifications screen'); // Debug print
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Admin Notifications',
                  style: TextStyle(
                    fontSize: 28,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
                SizedBox(height: 4),
                Text(
                  'Monitor system activities and user interactions',
                  style: TextStyle(fontSize: 14, color: Colors.white70),
                ),
              ],
            ),
            Row(
              children: [
                ElevatedButton.icon(
                  onPressed: () => _populateSampleNotifications(),
                  icon: Icon(Icons.data_usage),
                  label: Text('Load Sample Data'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.orange,
                    foregroundColor: Colors.white,
                  ),
                ),
                SizedBox(width: 12),
                ElevatedButton.icon(
                  onPressed: () => _showCreateNotificationDialog(),
                  icon: Icon(Icons.add),
                  label: Text('Create Notification'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    foregroundColor: Colors.white,
                  ),
                ),
              ],
            ),
          ],
        ),
        SizedBox(height: 24),

        // Notifications List
        Expanded(
          child: StreamBuilder<List<NotificationItem>>(
            stream: NotificationService.getUserNotifications(),
            builder: (context, snapshot) {
              print('=== NOTIFICATIONS DEBUG ===');
              print(
                'Notifications StreamBuilder state: ${snapshot.connectionState}',
              );
              print(
                'Notifications StreamBuilder hasError: ${snapshot.hasError}',
              );
              print('Notifications StreamBuilder hasData: ${snapshot.hasData}');
              if (snapshot.hasError) {
                print('Notifications StreamBuilder error: ${snapshot.error}');
              }
              if (snapshot.hasData) {
                print(
                  'Notifications data: ${snapshot.data?.length ?? 0} items',
                );
                snapshot.data?.forEach((notification) {
                  print('  - ${notification.title} (${notification.type})');
                });
              }
              print('=== END DEBUG ===');

              if (snapshot.connectionState == ConnectionState.waiting) {
                print('Notifications StreamBuilder waiting...'); // Debug print
                return Center(
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(
                      Color(0xFF8B0000),
                    ),
                  ),
                );
              }

              if (snapshot.hasError) {
                print(
                  'Notifications StreamBuilder error: ${snapshot.error}',
                ); // Debug print
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.error, color: Colors.red, size: 48),
                      SizedBox(height: 16),
                      Text(
                        'Error loading notifications:',
                        style: TextStyle(color: Colors.red, fontSize: 16),
                      ),
                      SizedBox(height: 8),
                      Text(
                        '${snapshot.error}',
                        style: TextStyle(
                          color: Colors.red.withOpacity(0.7),
                          fontSize: 12,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }

              final notifications = snapshot.data ?? [];
              print(
                'Notifications count: ${notifications.length}',
              ); // Debug print

              if (notifications.isEmpty) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.notifications_none,
                        size: 64,
                        color: Colors.white54,
                      ),
                      SizedBox(height: 16),
                      Text(
                        'No notifications found',
                        style: TextStyle(fontSize: 18, color: Colors.white54),
                      ),
                      SizedBox(height: 8),
                      Text(
                        'Click "Load Sample Data" to see example notifications',
                        style: TextStyle(fontSize: 14, color: Colors.white38),
                        textAlign: TextAlign.center,
                      ),
                      SizedBox(height: 16),
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 8,
                        ),
                        decoration: BoxDecoration(
                          color: Colors.green.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(20),
                          border: Border.all(
                            color: Colors.green.withOpacity(0.3),
                          ),
                        ),
                        child: Text(
                          'Real-time sync is active âœ“',
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.green,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ),
                      SizedBox(height: 16),
                      Container(
                        padding: EdgeInsets.all(20),
                        decoration: BoxDecoration(
                          color: Colors.orange.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: Colors.orange.withOpacity(0.3),
                          ),
                        ),
                        child: Column(
                          children: [
                            Text(
                              'Quick Start',
                              style: TextStyle(
                                color: Colors.orange,
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            SizedBox(height: 12),
                            Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                ElevatedButton.icon(
                                  onPressed: () {
                                    print('Load Sample Data button clicked!');
                                    _populateSampleNotifications();
                                  },
                                  icon: Icon(Icons.data_usage, size: 20),
                                  label: Text(
                                    'Load Sample Data',
                                    style: TextStyle(fontSize: 16),
                                  ),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: Colors.orange,
                                    foregroundColor: Colors.white,
                                    padding: EdgeInsets.symmetric(
                                      horizontal: 24,
                                      vertical: 16,
                                    ),
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                  ),
                                ),
                                SizedBox(width: 16),
                                ElevatedButton.icon(
                                  onPressed: () =>
                                      _showCreateNotificationDialog(),
                                  icon: Icon(Icons.add, size: 20),
                                  label: Text(
                                    'Create Custom',
                                    style: TextStyle(fontSize: 16),
                                  ),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: const Color(0xFF8B0000),
                                    foregroundColor: Colors.white,
                                    padding: EdgeInsets.symmetric(
                                      horizontal: 24,
                                      vertical: 16,
                                    ),
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                );
              }

              // Add error handling for the ListView
              try {
                return ListView.builder(
                  itemCount: notifications.length,
                  itemBuilder: (context, index) {
                    try {
                      final notification = notifications[index];
                      return _buildNotificationCard(notification);
                    } catch (e) {
                      print(
                        'Error building notification card at index $index: $e',
                      );
                      return Container(
                        margin: EdgeInsets.only(bottom: 16),
                        padding: EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: Colors.red.withOpacity(0.3),
                          ),
                        ),
                        child: Text(
                          'Error displaying notification: $e',
                          style: TextStyle(color: Colors.red),
                        ),
                      );
                    }
                  },
                );
              } catch (e) {
                print('Error building ListView: $e');
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.error, color: Colors.red, size: 48),
                      SizedBox(height: 16),
                      Text(
                        'Error displaying notifications:',
                        style: TextStyle(color: Colors.red, fontSize: 16),
                      ),
                      SizedBox(height: 8),
                      Text(
                        '$e',
                        style: TextStyle(
                          color: Colors.red.withOpacity(0.7),
                          fontSize: 12,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }
            },
          ),
        ),
      ],
    );
  }

  Widget _buildNotificationCard(NotificationItem notification) {
    try {
      return Container(
        margin: EdgeInsets.only(bottom: 16),
        decoration: BoxDecoration(
          color: notification.isRead
              ? const Color(0xFF2A2A2A).withOpacity(0.7)
              : const Color(0xFF2A2A2A),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: notification.isRead
                ? Colors.white10
                : _getNotificationTypeColor(notification.type).withOpacity(0.3),
            width: notification.isRead ? 1 : 2,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 8,
              offset: Offset(0, 4),
            ),
          ],
        ),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header Row
              Row(
                children: [
                  Container(
                    padding: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: _getNotificationTypeColor(
                        notification.type,
                      ).withOpacity(0.1),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: _getNotificationTypeColor(
                          notification.type,
                        ).withOpacity(0.2),
                      ),
                    ),
                    child: Icon(
                      _getNotificationTypeIcon(notification.type),
                      color: _getNotificationTypeColor(notification.type),
                      size: 24,
                    ),
                  ),
                  SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          notification.title,
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        SizedBox(height: 4),
                        Text(
                          _formatNotificationTimestamp(notification.timestamp),
                          style: TextStyle(color: Colors.white60, fontSize: 12),
                        ),
                      ],
                    ),
                  ),
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: _getPriorityColor(
                        notification.priority,
                      ).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: _getPriorityColor(notification.priority),
                        width: 1,
                      ),
                    ),
                    child: Text(
                      notification.priority.name.toUpperCase(),
                      style: TextStyle(
                        color: _getPriorityColor(notification.priority),
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  PopupMenuButton<String>(
                    icon: Icon(Icons.more_vert, color: Colors.white60),
                    color: const Color(0xFF1A1A1A),
                    itemBuilder: (context) => [
                      if (!notification.isRead)
                        PopupMenuItem(
                          value: 'mark_read',
                          child: Row(
                            children: [
                              Icon(
                                Icons.check_circle,
                                color: Colors.green,
                                size: 16,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Mark as Read',
                                style: TextStyle(color: Colors.white),
                              ),
                            ],
                          ),
                        ),
                      PopupMenuItem(
                        value: 'edit',
                        child: Row(
                          children: [
                            Icon(Icons.edit, color: Colors.blue, size: 16),
                            SizedBox(width: 8),
                            Text('Edit', style: TextStyle(color: Colors.white)),
                          ],
                        ),
                      ),
                      PopupMenuItem(
                        value: 'delete',
                        child: Row(
                          children: [
                            Icon(Icons.delete, color: Colors.red, size: 16),
                            SizedBox(width: 8),
                            Text(
                              'Delete',
                              style: TextStyle(color: Colors.white),
                            ),
                          ],
                        ),
                      ),
                    ],
                    onSelected: (value) {
                      switch (value) {
                        case 'mark_read':
                          NotificationService.markNotificationAsRead(
                            notification.id,
                          );
                          break;
                        case 'edit':
                          // TODO: Implement edit functionality
                          break;
                        case 'delete':
                          NotificationService.deleteNotification(
                            notification.id,
                          );
                          break;
                      }
                    },
                  ),
                ],
              ),
              SizedBox(height: 16),

              // Message
              Text(
                notification.message,
                style: TextStyle(color: Colors.white, fontSize: 14),
              ),

              // Metadata (if available)
              if (notification.metadata != null &&
                  notification.metadata!.isNotEmpty) ...[
                SizedBox(height: 12),
                Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.05),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white10),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Additional Information:',
                        style: TextStyle(
                          color: Colors.white60,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      SizedBox(height: 8),
                      Text(
                        notification.metadata!.toString(),
                        style: TextStyle(color: Colors.white70, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
        ),
      );
    } catch (e) {
      print('Error in _buildNotificationCard: $e');
      return Container(
        margin: EdgeInsets.only(bottom: 16),
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.red.withOpacity(0.1),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Colors.red.withOpacity(0.3)),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Error displaying notification:',
              style: TextStyle(color: Colors.red, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 8),
            Text(
              '$e',
              style: TextStyle(
                color: Colors.red.withOpacity(0.7),
                fontSize: 12,
              ),
            ),
          ],
        ),
      );
    }
  }

  Color _getNotificationTypeColor(NotificationType type) {
    switch (type) {
      case NotificationType.orderUpdate:
        return Colors.blue;
      case NotificationType.paymentReceived:
        return Colors.green;
      case NotificationType.projectCompleted:
        return Colors.purple;
      case NotificationType.newService:
        return Colors.orange;
      case NotificationType.systemUpdate:
        return Colors.grey;
      case NotificationType.adminMessage:
        return Colors.red;
      case NotificationType.invoiceGenerated:
        return Colors.teal;
      case NotificationType.membershipUpdate:
        return Colors.indigo;
      case NotificationType.general:
        return Colors.cyan;
      case NotificationType.orderCreated:
        return Colors.blue;
      case NotificationType.userUpgrade:
        return Colors.amber;
      case NotificationType.chatSupport:
        return Colors.pink;
      case NotificationType.paymentSuccess:
        return Colors.green;
      case NotificationType.goldTierUpgrade:
        return Colors.yellow;
    }
  }

  IconData _getNotificationTypeIcon(NotificationType type) {
    switch (type) {
      case NotificationType.orderUpdate:
        return Icons.shopping_cart;
      case NotificationType.paymentReceived:
        return Icons.payment;
      case NotificationType.projectCompleted:
        return Icons.check_circle;
      case NotificationType.newService:
        return Icons.add_business;
      case NotificationType.systemUpdate:
        return Icons.system_update;
      case NotificationType.adminMessage:
        return Icons.admin_panel_settings;
      case NotificationType.invoiceGenerated:
        return Icons.receipt;
      case NotificationType.membershipUpdate:
        return Icons.card_membership;
      case NotificationType.general:
        return Icons.notifications;
      case NotificationType.orderCreated:
        return Icons.add_shopping_cart;
      case NotificationType.userUpgrade:
        return Icons.person_add;
      case NotificationType.chatSupport:
        return Icons.chat;
      case NotificationType.paymentSuccess:
        return Icons.check_circle;
      case NotificationType.goldTierUpgrade:
        return Icons.workspace_premium;
    }
  }

  Color _getPriorityColor(NotificationPriority priority) {
    switch (priority) {
      case NotificationPriority.urgent:
        return Colors.red;
      case NotificationPriority.high:
        return Colors.orange;
      case NotificationPriority.medium:
        return Colors.yellow;
      case NotificationPriority.low:
        return Colors.green;
    }
  }

  String _formatNotificationTimestamp(DateTime timestamp) {
    final now = DateTime.now();
    final difference = now.difference(timestamp);

    if (difference.inDays > 0) {
      return '${difference.inDays}d ago';
    } else if (difference.inHours > 0) {
      return '${difference.inHours}h ago';
    } else if (difference.inMinutes > 0) {
      return '${difference.inMinutes}m ago';
    } else {
      return 'Just now';
    }
  }

  void _populateSampleNotifications() async {
    print('Populating sample notifications...'); // Debug print
    try {
      await NotificationService.createSampleAdminNotifications();
      print('Sample notifications created successfully'); // Debug print
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Sample notifications loaded successfully!'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      print('Error creating sample notifications: $e'); // Debug print
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error loading sample notifications: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _showCreateNotificationDialog() {
    // TODO: Implement create notification dialog
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Create notification functionality coming soon!'),
        backgroundColor: Colors.orange,
      ),
    );
  }

  // Wallets Screen Content
  Widget _buildWalletsScreen() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  'User Wallets',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                const Text(
                  'Manage all user wallets and transactions',
                  style: TextStyle(color: Colors.white70, fontSize: 16),
                ),
              ],
            ),
            ElevatedButton.icon(
              onPressed: () {
                // TODO: Add refresh functionality
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('Refreshing wallets...'),
                    backgroundColor: Color(0xFF8B0000),
                  ),
                );
              },
              icon: const Icon(Icons.refresh, color: Colors.white),
              label: const Text(
                'Refresh',
                style: TextStyle(color: Colors.white),
              ),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 12,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            ),
          ],
        ),
        const SizedBox(height: 24),

        // Search and Filter Bar
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: const Color(0xFF2A2A2A),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
          ),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  controller: _searchController,
                  onChanged: (value) {
                    setState(() {
                      _searchQuery = value;
                    });
                  },
                  style: const TextStyle(color: Colors.white),
                  decoration: const InputDecoration(
                    hintText: 'Search users by name or email...',
                    hintStyle: TextStyle(color: Colors.white54),
                    prefixIcon: Icon(Icons.search, color: Colors.white54),
                    border: InputBorder.none,
                    contentPadding: EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 12,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              DropdownButton<String>(
                value: _selectedOrderStatus,
                onChanged: (String? newValue) {
                  setState(() {
                    _selectedOrderStatus = newValue!;
                  });
                },
                dropdownColor: const Color(0xFF2A2A2A),
                style: const TextStyle(color: Colors.white),
                underline: Container(height: 1, color: const Color(0xFF3A3A3A)),
                items: <String>['all', 'active', 'inactive', 'suspended']
                    .map<DropdownMenuItem<String>>((String value) {
                      return DropdownMenuItem<String>(
                        value: value,
                        child: Text(value.toUpperCase()),
                      );
                    })
                    .toList(),
              ),
            ],
          ),
        ),
        const SizedBox(height: 24),

        // Wallets List
        Expanded(
          child: StreamBuilder<QuerySnapshot>(
            stream: FirebaseFirestore.instance
                .collection('users')
                .where('role', isNotEqualTo: 'admin')
                .snapshots(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(
                  child: CircularProgressIndicator(color: Color(0xFF8B0000)),
                );
              }

              if (snapshot.hasError) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(
                        Icons.error_outline,
                        color: Colors.red,
                        size: 64,
                      ),
                      const SizedBox(height: 16),
                      Text(
                        'Error loading wallets: ${snapshot.error}',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }

              if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(
                        Icons.account_balance_wallet_outlined,
                        color: Colors.white54,
                        size: 64,
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        'No users found',
                        style: TextStyle(
                          color: Colors.white54,
                          fontSize: 18,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                      const SizedBox(height: 8),
                      const Text(
                        'Users will appear here once they register',
                        style: TextStyle(color: Colors.white54, fontSize: 14),
                      ),
                    ],
                  ),
                );
              }

              // Filter users based on search query
              List<QueryDocumentSnapshot>
              filteredUsers = snapshot.data!.docs.where((doc) {
                final userData = doc.data() as Map<String, dynamic>;
                final name = userData['name']?.toString().toLowerCase() ?? '';
                final email = userData['email']?.toString().toLowerCase() ?? '';
                final searchLower = _searchQuery.toLowerCase();

                return name.contains(searchLower) ||
                    email.contains(searchLower);
              }).toList();

              return ListView.builder(
                itemCount: filteredUsers.length,
                itemBuilder: (context, index) {
                  final userDoc = filteredUsers[index];
                  final userData = userDoc.data() as Map<String, dynamic>;
                  final userId = userDoc.id;

                  return _buildWalletCard(userId, userData);
                },
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildWalletCard(String userId, Map<String, dynamic> userData) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(userId)
            .snapshots(),
        builder: (context, userSnapshot) {
          // If user doesn't exist, skip this user
          if (!userSnapshot.hasData || !userSnapshot.data!.exists) {
            return Container();
          }

          final userData = userSnapshot.data?.data() as Map<String, dynamic>?;
          final balance = userData?['walletBalance']?.toDouble() ?? 0.0;
          final status = userData?['isActive'] == true ? 'active' : 'inactive';

          return Container(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: [
                // Header Row - User Info + Status
                Row(
                  children: [
                    // User Avatar
                    Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        color: const Color(0xFF8B0000),
                        borderRadius: BorderRadius.circular(12),
                        boxShadow: [
                          BoxShadow(
                            color: const Color(0xFF8B0000).withOpacity(0.3),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Center(
                        child: Text(
                          (userData?['name']
                                  ?.toString()
                                  .substring(0, 1)
                                  .toUpperCase() ??
                              'U'),
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),

                    // User Details
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            userData?['name']?.toString() ?? 'Unknown User',
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                          const SizedBox(height: 2),
                          Text(
                            userData?['email']?.toString() ?? 'No email',
                            style: const TextStyle(
                              color: Colors.white70,
                              fontSize: 12,
                            ),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                          if (userData?['phone'] != null) ...[
                            const SizedBox(height: 2),
                            Text(
                              userData?['phone']?.toString() ?? '',
                              style: const TextStyle(
                                color: Colors.white60,
                                fontSize: 11,
                              ),
                            ),
                          ],
                        ],
                      ),
                    ),

                    // Status Badge
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: userData?['isActive'] == true
                            ? Colors.green.withOpacity(0.15)
                            : Colors.red.withOpacity(0.15),
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(
                          color: userData?['isActive'] == true
                              ? Colors.green
                              : Colors.red,
                          width: 1,
                        ),
                      ),
                      child: Text(
                        userData?['isActive'] == true ? 'ACTIVE' : 'INACTIVE',
                        style: TextStyle(
                          color: userData?['isActive'] == true
                              ? Colors.green
                              : Colors.red,
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 16),

                // Wallet Stats Row
                Row(
                  children: [
                    // Balance
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: const Color(0xFF1A1A1A),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: const Color(0xFF3A3A3A),
                            width: 1,
                          ),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                const Icon(
                                  Icons.account_balance_wallet,
                                  color: Color(0xFF8B0000),
                                  size: 16,
                                ),
                                const SizedBox(width: 6),
                                const Text(
                                  'Balance',
                                  style: TextStyle(
                                    color: Colors.white70,
                                    fontSize: 11,
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 6),
                            Text(
                              'R${balance.toStringAsFixed(2)}',
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(width: 8),

                    // Wallet Status
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: const Color(0xFF1A1A1A),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: const Color(0xFF3A3A3A),
                            width: 1,
                          ),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  status == 'active'
                                      ? Icons.check_circle
                                      : Icons.cancel,
                                  color: status == 'active'
                                      ? Colors.green
                                      : Colors.red,
                                  size: 16,
                                ),
                                const SizedBox(width: 6),
                                const Text(
                                  'Status',
                                  style: TextStyle(
                                    color: Colors.white70,
                                    fontSize: 11,
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 6),
                            Text(
                              status.toUpperCase(),
                              style: TextStyle(
                                color: status == 'active'
                                    ? Colors.green
                                    : Colors.red,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(width: 8),

                    // Transaction Count
                    Expanded(
                      child: StreamBuilder<QuerySnapshot>(
                        stream: FirebaseFirestore.instance
                            .collection('wallet_transactions')
                            .where('userId', isEqualTo: userId)
                            .snapshots(),
                        builder: (context, transactionSnapshot) {
                          final transactionCount = transactionSnapshot.hasData
                              ? transactionSnapshot.data!.docs.length
                              : 0;

                          return Container(
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              color: const Color(0xFF1A1A1A),
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: const Color(0xFF3A3A3A),
                                width: 1,
                              ),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Row(
                                  children: [
                                    const Icon(
                                      Icons.receipt_long,
                                      color: Colors.blue,
                                      size: 16,
                                    ),
                                    const SizedBox(width: 6),
                                    const Text(
                                      'Transactions',
                                      style: TextStyle(
                                        color: Colors.white70,
                                        fontSize: 11,
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 6),
                                Text(
                                  transactionCount.toString(),
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ],
                            ),
                          );
                        },
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 12),

                // Action Buttons
                Column(
                  children: [
                    Row(
                      children: [
                        Expanded(
                          child: ElevatedButton.icon(
                            onPressed: () {
                              _showWalletDetails(userId, userData ?? {});
                            },
                            icon: const Icon(Icons.visibility, size: 14),
                            label: const Text(
                              'Details',
                              style: TextStyle(fontSize: 12),
                            ),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: const Color(0xFF8B0000),
                              foregroundColor: Colors.white,
                              padding: const EdgeInsets.symmetric(vertical: 8),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 8),
                        Expanded(
                          child: ElevatedButton.icon(
                            onPressed: () {
                              _showTransactionHistory(userId, userData ?? {});
                            },
                            icon: const Icon(Icons.history, size: 14),
                            label: const Text(
                              'History',
                              style: TextStyle(fontSize: 12),
                            ),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: const Color(0xFF2A2A2A),
                              foregroundColor: Colors.white,
                              side: const BorderSide(color: Color(0xFF3A3A3A)),
                              padding: const EdgeInsets.symmetric(vertical: 8),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    // Credit Wallet Button (Full Width)
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: () {
                          _showCreditWalletDialog(userId, userData ?? {});
                        },
                        icon: const Icon(Icons.add_circle_outline, size: 14),
                        label: const Text(
                          'Credit Wallet',
                          style: TextStyle(fontSize: 12),
                        ),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.green,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 8),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  void _showWalletDetails(String userId, Map<String, dynamic> userData) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: Text(
          '${userData['name'] ?? 'User'}\'s Wallet Details',
          style: const TextStyle(color: Colors.white),
        ),
        content: StreamBuilder<DocumentSnapshot>(
          stream: FirebaseFirestore.instance
              .collection('users')
              .doc(userId)
              .snapshots(),
          builder: (context, snapshot) {
            if (snapshot.connectionState == ConnectionState.waiting) {
              return const Center(
                child: CircularProgressIndicator(color: Color(0xFF8B0000)),
              );
            }

            final userData = snapshot.data?.data() as Map<String, dynamic>?;
            final balance = userData?['walletBalance']?.toDouble() ?? 0.0;
            final createdAt = userData?['createdAt'] as Timestamp?;
            final updatedAt = userData?['updatedAt'] as Timestamp?;

            return Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildDetailRow('Balance', 'R${balance.toStringAsFixed(2)}'),
                _buildDetailRow('User ID', userId),
                _buildDetailRow(
                  'Email',
                  userData?['email']?.toString() ?? 'N/A',
                ),
                _buildDetailRow(
                  'Phone',
                  userData?['phone']?.toString() ?? 'N/A',
                ),
                if (createdAt != null)
                  _buildDetailRow('Created', _formatDate(createdAt.toDate())),
                if (updatedAt != null)
                  _buildDetailRow(
                    'Last Updated',
                    _formatDate(updatedAt.toDate()),
                  ),
              ],
            );
          },
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Close',
              style: TextStyle(color: Color(0xFF8B0000)),
            ),
          ),
        ],
      ),
    );
  }

  void _showTransactionHistory(String userId, Map<String, dynamic> userData) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: Text(
          '${userData['name']}\'s Transactions',
          style: const TextStyle(color: Colors.white),
        ),
        content: SizedBox(
          width: double.maxFinite,
          height: 400,
          child: StreamBuilder<QuerySnapshot>(
            stream: FirebaseFirestore.instance
                .collection('transactions')
                .where('userId', isEqualTo: userId)
                .snapshots(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(
                  child: CircularProgressIndicator(color: Color(0xFF8B0000)),
                );
              }

              if (snapshot.hasError) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(
                        Icons.error_outline,
                        color: Colors.red,
                        size: 48,
                      ),
                      const SizedBox(height: 16),
                      Text(
                        'Error loading transactions: ${snapshot.error}',
                        style: const TextStyle(color: Colors.red),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }

              if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(
                        Icons.receipt_long_outlined,
                        color: Colors.white54,
                        size: 48,
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        'No transactions found',
                        style: TextStyle(
                          color: Colors.white70,
                          fontSize: 16,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                      const SizedBox(height: 8),
                      const Text(
                        'Transactions will appear here once the user makes payments or receives funds',
                        style: TextStyle(color: Colors.white54, fontSize: 14),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }

              // Sort transactions by date (newest first)
              final sortedDocs = snapshot.data!.docs.toList()
                ..sort((a, b) {
                  final aData = a.data() as Map<String, dynamic>;
                  final bData = b.data() as Map<String, dynamic>;
                  final aDate = aData['createdAt'] as Timestamp?;
                  final bDate = bData['createdAt'] as Timestamp?;

                  if (aDate == null && bDate == null) return 0;
                  if (aDate == null) return 1;
                  if (bDate == null) return -1;

                  return bDate.compareTo(aDate); // Descending order
                });

              return ListView.builder(
                itemCount: sortedDocs.length,
                itemBuilder: (context, index) {
                  final doc = sortedDocs[index];
                  final data = doc.data() as Map<String, dynamic>;
                  final amount = data['amount']?.toDouble() ?? 0.0;
                  final type = data['type']?.toString() ?? 'unknown';
                  final description =
                      data['description']?.toString() ?? 'Transaction';
                  final createdAt = data['createdAt'] as Timestamp?;
                  final status = data['status']?.toString() ?? 'completed';
                  final reference = data['reference']?.toString();
                  final isDebit = type == 'payment';

                  return Container(
                    margin: const EdgeInsets.only(bottom: 8),
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1A1A1A),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: const Color(0xFF3A3A3A)),
                    ),
                    child: Row(
                      children: [
                        Container(
                          width: 32,
                          height: 32,
                          decoration: BoxDecoration(
                            color: isDebit
                                ? const Color(0xFF8B0000)
                                : Colors.green,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Icon(
                            isDebit ? Icons.arrow_upward : Icons.arrow_downward,
                            color: Colors.white,
                            size: 16,
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                description,
                                style: const TextStyle(
                                  color: Colors.white,
                                  fontSize: 14,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                              const SizedBox(height: 4),
                              if (createdAt != null)
                                Text(
                                  _formatDate(createdAt.toDate()),
                                  style: const TextStyle(
                                    color: Colors.white70,
                                    fontSize: 12,
                                  ),
                                ),
                              if (reference != null) ...[
                                const SizedBox(height: 2),
                                Text(
                                  'Ref: $reference',
                                  style: const TextStyle(
                                    color: Colors.white54,
                                    fontSize: 10,
                                  ),
                                ),
                              ],
                            ],
                          ),
                        ),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          children: [
                            Text(
                              '${isDebit ? '-' : '+'}R${amount.toStringAsFixed(2)}',
                              style: TextStyle(
                                color: isDebit
                                    ? const Color(0xFF8B0000)
                                    : Colors.green,
                                fontSize: 14,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 6,
                                vertical: 2,
                              ),
                              decoration: BoxDecoration(
                                color: status == 'completed'
                                    ? Colors.green.withOpacity(0.2)
                                    : status == 'pending'
                                    ? Colors.orange.withOpacity(0.2)
                                    : Colors.red.withOpacity(0.2),
                                borderRadius: BorderRadius.circular(6),
                              ),
                              child: Text(
                                status.toUpperCase(),
                                style: TextStyle(
                                  color: status == 'completed'
                                      ? Colors.green
                                      : status == 'pending'
                                      ? Colors.orange
                                      : Colors.red,
                                  fontSize: 10,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  );
                },
              );
            },
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Close',
              style: TextStyle(color: Color(0xFF8B0000)),
            ),
          ),
        ],
      ),
    );
  }

  void _showCreditWalletDialog(String userId, Map<String, dynamic> userData) {
    final TextEditingController amountController = TextEditingController();
    final TextEditingController reasonController = TextEditingController();

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: Row(
          children: [
            const Icon(Icons.add_circle_outline, color: Colors.green, size: 24),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                'Credit ${userData['name']}\'s Wallet',
                style: const TextStyle(color: Colors.white),
              ),
            ),
          ],
        ),
        content: StreamBuilder<DocumentSnapshot>(
          stream: FirebaseFirestore.instance
              .collection('users')
              .doc(userId)
              .snapshots(),
          builder: (context, userSnapshot) {
            final userData = userSnapshot.data?.data() as Map<String, dynamic>?;
            final balance = userData?['walletBalance']?.toDouble() ?? 0.0;

            return Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Current Balance Display
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: const Color(0xFF1A1A1A),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: const Color(0xFF3A3A3A)),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      const Text(
                        'Current Balance:',
                        style: TextStyle(color: Colors.white70, fontSize: 14),
                      ),
                      Text(
                        'R${balance.toStringAsFixed(2)}',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 16),

                // Amount Input
                const Text(
                  'Credit Amount (ZAR)',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: amountController,
                  keyboardType: TextInputType.numberWithOptions(decimal: true),
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: '0.00',
                    hintStyle: TextStyle(color: Colors.white54),
                    prefixText: 'R ',
                    prefixStyle: const TextStyle(
                      color: Colors.white,
                      fontSize: 16,
                    ),
                    filled: true,
                    fillColor: const Color(0xFF1A1A1A),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(
                        color: Colors.green,
                        width: 2,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                // Reason Input
                const Text(
                  'Reason (Optional)',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: reasonController,
                  maxLines: 2,
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'e.g., Customer service credit, refund, etc.',
                    hintStyle: TextStyle(color: Colors.white54),
                    filled: true,
                    fillColor: const Color(0xFF1A1A1A),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(
                        color: Colors.green,
                        width: 2,
                      ),
                    ),
                  ),
                ),
              ],
            );
          },
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () async {
              final amount = double.tryParse(amountController.text);
              final reason = reasonController.text.trim();

              if (amount == null || amount <= 0) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('Please enter a valid amount'),
                    backgroundColor: Colors.red,
                  ),
                );
                return;
              }

              if (amount > 100000) {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('Maximum credit amount is R100,000'),
                    backgroundColor: Colors.red,
                  ),
                );
                return;
              }

              // Confirm the credit operation
              final confirmed = await showDialog<bool>(
                context: context,
                builder: (context) => AlertDialog(
                  backgroundColor: const Color(0xFF2A2A2A),
                  title: const Text(
                    'Confirm Credit',
                    style: TextStyle(color: Colors.white),
                  ),
                  content: Column(
                    mainAxisSize: MainAxisSize.min,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Are you sure you want to credit ${userData['name']}\'s wallet?',
                        style: const TextStyle(color: Colors.white70),
                      ),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.green.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(
                            color: Colors.green.withOpacity(0.3),
                          ),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                const Text(
                                  'Amount:',
                                  style: TextStyle(color: Colors.white70),
                                ),
                                Text(
                                  'R${amount.toStringAsFixed(2)}',
                                  style: const TextStyle(
                                    color: Colors.green,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ],
                            ),
                            if (reason.isNotEmpty) ...[
                              const SizedBox(height: 4),
                              Row(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text(
                                    'Reason: ',
                                    style: TextStyle(color: Colors.white70),
                                  ),
                                  Expanded(
                                    child: Text(
                                      reason,
                                      style: const TextStyle(
                                        color: Colors.white,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ],
                        ),
                      ),
                    ],
                  ),
                  actions: [
                    TextButton(
                      onPressed: () => Navigator.pop(context, false),
                      child: const Text(
                        'Cancel',
                        style: TextStyle(color: Colors.white70),
                      ),
                    ),
                    ElevatedButton(
                      onPressed: () => Navigator.pop(context, true),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.green,
                      ),
                      child: const Text(
                        'Credit Wallet',
                        style: TextStyle(color: Colors.white),
                      ),
                    ),
                  ],
                ),
              );

              if (confirmed == true) {
                Navigator.pop(context); // Close the credit dialog
                await _creditUserWallet(userId, userData, amount, reason);
              }
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.green,
              foregroundColor: Colors.white,
            ),
            child: const Text('Credit Wallet'),
          ),
        ],
      ),
    );
  }

  Future<void> _creditUserWallet(
    String userId,
    Map<String, dynamic> userData,
    double amount,
    String reason,
  ) async {
    try {
      // Show loading indicator
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => const AlertDialog(
          backgroundColor: Color(0xFF2A2A2A),
          content: Row(
            children: [
              CircularProgressIndicator(color: Colors.green),
              SizedBox(width: 16),
              Text(
                'Crediting wallet...',
                style: TextStyle(color: Colors.white),
              ),
            ],
          ),
        ),
      );

      // Credit the wallet using batch operation
      final batch = FirebaseFirestore.instance.batch();

      // Update user wallet balance (primary storage)
      final userRef = FirebaseFirestore.instance
          .collection('users')
          .doc(userId);
      batch.update(userRef, {
        'walletBalance': FieldValue.increment(amount),
        'updatedAt': FieldValue.serverTimestamp(),
      });

      // Also update wallets collection for consistency
      final walletRef = FirebaseFirestore.instance
          .collection('wallets')
          .doc(userId);
      batch.update(walletRef, {
        'balance': FieldValue.increment(amount),
        'updatedAt': FieldValue.serverTimestamp(),
      });

      // Create transaction record
      final transactionRef = FirebaseFirestore.instance
          .collection('wallet_transactions')
          .doc();
      batch.set(transactionRef, {
        'userId': userId,
        'type': 'admin_credit',
        'amount': amount,
        'description': reason.isEmpty
            ? 'Admin credit'
            : 'Admin credit: $reason',
        'status': 'completed',
        'adminId': FirebaseAuth.instance.currentUser?.uid,
        'createdAt': FieldValue.serverTimestamp(),
        'updatedAt': FieldValue.serverTimestamp(),
        'reference': 'ADMIN_CREDIT_${DateTime.now().millisecondsSinceEpoch}',
      });

      await batch.commit();

      // Close loading dialog
      Navigator.pop(context);

      // Show success message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'Successfully credited ${userData['name']}\'s wallet with R${amount.toStringAsFixed(2)}',
          ),
          backgroundColor: Colors.green,
          duration: const Duration(seconds: 3),
        ),
      );

      // Send notification to user
      await FirebaseFirestore.instance.collection('notifications').add({
        'userId': userId,
        'title': 'Wallet Credited',
        'body':
            'Your wallet has been credited with R${amount.toStringAsFixed(2)}',
        'type': 'wallet_credit',
        'isRead': false,
        'createdAt': FieldValue.serverTimestamp(),
        'data': {
          'amount': amount,
          'reason': reason,
          'adminId': FirebaseAuth.instance.currentUser?.uid,
        },
      });
    } catch (e) {
      // Close loading dialog if still open
      if (Navigator.canPop(context)) {
        Navigator.pop(context);
      }

      // Show error message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error crediting wallet: $e'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  // Marketing Screen Content - Proposal & Appointment Management
  Widget _buildMarketingScreen() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  'Proposal & Appointment Management',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                const Text(
                  'Schedule proposals, send emails, manage appointments',
                  style: TextStyle(color: Colors.white70, fontSize: 16),
                ),
              ],
            ),
            Row(
              children: [
                ElevatedButton.icon(
                  onPressed: () => _showCreateProposalDialog(),
                  icon: const Icon(Icons.email, color: Colors.white, size: 16),
                  label: const Text(
                    'New Proposal',
                    style: TextStyle(color: Colors.white, fontSize: 12),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF8B0000),
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 8,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                ElevatedButton.icon(
                  onPressed: () => _showScheduleAppointmentDialog(),
                  icon: const Icon(
                    Icons.calendar_today,
                    color: Colors.white,
                    size: 16,
                  ),
                  label: const Text(
                    'Schedule Meeting',
                    style: TextStyle(color: Colors.white, fontSize: 12),
                  ),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF2A2A2A),
                    foregroundColor: Colors.white,
                    side: const BorderSide(color: Color(0xFF3A3A3A)),
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 8,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
        const SizedBox(height: 24),

        // Quick Stats Cards - Real-time data
        StreamBuilder<MarketingStats>(
          stream: _getMarketingStatsStream(),
          builder: (context, snapshot) {
            if (snapshot.connectionState == ConnectionState.waiting) {
              return Row(
                children: [
                  Expanded(child: _buildLoadingCard('Proposals')),
                  const SizedBox(width: 8),
                  Expanded(child: _buildLoadingCard('Meetings')),
                  const SizedBox(width: 8),
                  Expanded(child: _buildLoadingCard('Response')),
                ],
              );
            }

            if (snapshot.hasError) {
              return Row(
                children: [
                  Expanded(child: _buildErrorCard('Proposals')),
                  const SizedBox(width: 8),
                  Expanded(child: _buildErrorCard('Meetings')),
                  const SizedBox(width: 8),
                  Expanded(child: _buildErrorCard('Response')),
                ],
              );
            }

            final stats =
                snapshot.data ??
                MarketingStats(
                  totalProposals: 0,
                  proposalsThisWeek: 0,
                  totalAppointments: 0,
                  appointmentsThisWeek: 0,
                  responseRate: 0.0,
                  responseRateChange: 0.0,
                );

            return Row(
              children: [
                Expanded(
                  child: _buildStatCard(
                    'Proposals',
                    stats.totalProposals.toString(),
                    '+${stats.proposalsThisWeek} this week',
                    Icons.email,
                    const Color(0xFF8B0000),
                    Colors.green,
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: _buildStatCard(
                    'Meetings',
                    stats.totalAppointments.toString(),
                    '+${stats.appointmentsThisWeek} this week',
                    Icons.calendar_today,
                    Colors.blue,
                    Colors.blue,
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: _buildStatCard(
                    'Response',
                    '${stats.responseRate.toStringAsFixed(0)}%',
                    '${stats.responseRateChange >= 0 ? '+' : ''}${stats.responseRateChange.toStringAsFixed(0)}% this month',
                    Icons.trending_up,
                    Colors.green,
                    stats.responseRateChange >= 0 ? Colors.green : Colors.red,
                  ),
                ),
              ],
            );
          },
        ),
        const SizedBox(height: 24),

        // Tabs for different views
        Container(
          decoration: BoxDecoration(
            color: const Color(0xFF2A2A2A),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
          ),
          child: Row(
            children: [
              Expanded(
                child: _buildTabButton(
                  'Proposals',
                  _currentMarketingTab == 'proposals',
                ),
              ),
              Expanded(
                child: _buildTabButton(
                  'Appointments',
                  _currentMarketingTab == 'appointments',
                ),
              ),
              Expanded(
                child: _buildTabButton(
                  'Templates',
                  _currentMarketingTab == 'templates',
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 16),

        // Content based on selected tab
        Expanded(
          child: _currentMarketingTab == 'proposals'
              ? _buildProposalsList()
              : _currentMarketingTab == 'appointments'
              ? _buildAppointmentsList()
              : _buildTemplatesList(),
        ),
      ],
    );
  }

  // Service Hub Screen Content - Admin Version (matches user dashboard exactly)
  Widget _buildServiceHubScreen() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [const Color(0xFF8B0000), const Color(0xFF1A1A1A)],
        ),
      ),
      child: Column(
        children: [
          // Custom Header
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.only(
                top: 0,
                left: 20,
                right: 20,
                bottom: 0,
              ),
              child: Row(
                children: [
                  IconButton(
                    icon: const Icon(Icons.arrow_back, color: Colors.white),
                    onPressed: () => _setScreen('dashboard'),
                  ),
                  const Expanded(
                    child: Text(
                      'Service Hub - Admin',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ),
                  // Admin Edit Button
                  IconButton(
                    icon: const Icon(Icons.edit, color: Colors.white),
                    onPressed: () => _showAdminServiceHubOptions(),
                  ),
                ],
              ),
            ),
          ),
          // Enhanced Floating Tab Bar
          Container(
            margin: const EdgeInsets.only(
              top: 0,
              left: 20,
              right: 20,
              bottom: 20,
            ),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  const Color(0xFF2A2A2A).withOpacity(0.95),
                  const Color(0xFF1A1A1A).withOpacity(0.95),
                ],
              ),
              borderRadius: BorderRadius.circular(30),
              border: Border.all(
                color: const Color(0xFF8B0000).withOpacity(0.2),
                width: 1.5,
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.15),
                  blurRadius: 20,
                  offset: const Offset(0, 8),
                  spreadRadius: 2,
                ),
                BoxShadow(
                  color: const Color(0xFF8B0000).withOpacity(0.1),
                  blurRadius: 15,
                  offset: const Offset(0, 4),
                ),
              ],
            ),
            child: TabBar(
              controller: _adminTabController,
              indicator: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [const Color(0xFF8B0000), const Color(0xFFB22222)],
                ),
                borderRadius: BorderRadius.circular(30),
                boxShadow: [
                  BoxShadow(
                    color: const Color(0xFF8B0000).withOpacity(0.4),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              indicatorSize: TabBarIndicatorSize.tab,
              labelColor: Colors.white,
              unselectedLabelColor: Colors.white60,
              labelStyle: const TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.bold,
                letterSpacing: 0.5,
              ),
              unselectedLabelStyle: const TextStyle(
                fontSize: 15,
                fontWeight: FontWeight.w600,
                letterSpacing: 0.3,
              ),
              dividerColor: Colors.transparent,
              tabs: [
                Tab(
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.work,
                        size: 18,
                        color: _adminTabController.index == 0
                            ? Colors.white
                            : null,
                      ),
                      const SizedBox(width: 8),
                      const Text('Portfolio'),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // Tab Content
          Expanded(
            child: TabBarView(
              controller: _adminTabController,
              children: [
                // Portfolio Tab - Admin Version
                _buildAdminPortfolioTab(),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // Development Screen Content
  Widget _buildDevelopmentScreen() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [const Color(0xFF8B0000), const Color(0xFF1A1A1A)],
        ),
      ),
      child: Column(
        children: [
          // Custom Header
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.only(
                top: 0,
                left: 20,
                right: 20,
                bottom: 0,
              ),
              child: Row(
                children: [
                  IconButton(
                    icon: const Icon(Icons.arrow_back, color: Colors.white),
                    onPressed: () => _setScreen('dashboard'),
                  ),
                  const Expanded(
                    child: Text(
                      'Development Hub',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.code, color: Colors.white),
                    onPressed: () {},
                  ),
                ],
              ),
            ),
          ),

          // Main Content
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Welcome Section
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      gradient: const LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [Color(0xFF2A2A2A), Color(0xFF1A1A1A)],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.3),
                      ),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            const Icon(
                              Icons.code,
                              color: Color(0xFF8B0000),
                              size: 32,
                            ),
                            const SizedBox(width: 12),
                            const Text(
                              'Development Hub',
                              style: TextStyle(
                                fontSize: 24,
                                fontWeight: FontWeight.bold,
                                color: Colors.white,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),
                        const Text(
                          'Manage development activities, user suggestions, and technical improvements.',
                          style: TextStyle(
                            fontSize: 16,
                            color: Colors.white70,
                            height: 1.5,
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),

                  // Quick Actions Grid
                  const Text(
                    'Quick Actions',
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 16),

                  GridView.count(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    crossAxisCount: 2,
                    crossAxisSpacing: 16,
                    mainAxisSpacing: 16,
                    childAspectRatio: 1.2,
                    children: [
                      _buildDevelopmentActionCard(
                        'User Suggestions',
                        'View and manage user feedback',
                        Icons.lightbulb_outline,
                        const Color(0xFF8B0000),
                        () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (context) =>
                                  const AdminSuggestionsScreen(),
                            ),
                          );
                        },
                      ),
                      _buildDevelopmentActionCard(
                        'Code Repository',
                        'Access source code and documentation',
                        Icons.source,
                        const Color(0xFF4CAF50),
                        () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text(
                                'Code repository access coming soon!',
                              ),
                              backgroundColor: Color(0xFF4CAF50),
                            ),
                          );
                        },
                      ),
                      _buildDevelopmentActionCard(
                        'Deployment',
                        'Manage app deployments and updates',
                        Icons.rocket_launch,
                        const Color(0xFF2196F3),
                        () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text(
                                'Deployment management coming soon!',
                              ),
                              backgroundColor: Color(0xFF2196F3),
                            ),
                          );
                        },
                      ),
                      _buildDevelopmentActionCard(
                        'Analytics',
                        'View development metrics and performance',
                        Icons.analytics,
                        const Color(0xFFFF9800),
                        () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text(
                                'Development analytics coming soon!',
                              ),
                              backgroundColor: Color(0xFFFF9800),
                            ),
                          );
                        },
                      ),
                    ],
                  ),

                  const SizedBox(height: 24),

                  // Development Stats
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: const Color(0xFF2A2A2A),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.white10),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Development Statistics',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: Colors.white,
                          ),
                        ),
                        const SizedBox(height: 16),
                        Row(
                          children: [
                            Expanded(
                              child: _buildDevelopmentStatCard(
                                'Pending Suggestions',
                                '0',
                                Icons.pending,
                                Colors.orange,
                              ),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: _buildDevelopmentStatCard(
                                'Active Projects',
                                '0',
                                Icons.work,
                                Colors.blue,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDevelopmentActionCard(
    String title,
    String description,
    IconData icon,
    Color color,
    VoidCallback onTap,
  ) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [color.withOpacity(0.1), color.withOpacity(0.05)],
          ),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: color.withOpacity(0.3)),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: color.withOpacity(0.2),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(icon, color: color, size: 24),
            ),
            const SizedBox(height: 12),
            Text(
              title,
              style: const TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              description,
              style: const TextStyle(
                fontSize: 12,
                color: Colors.white70,
                height: 1.3,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDevelopmentStatCard(
    String label,
    String value,
    IconData icon,
    Color color,
  ) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withOpacity(0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(icon, color: color, size: 20),
              const SizedBox(width: 8),
              Expanded(
                child: Text(
                  label,
                  style: const TextStyle(fontSize: 12, color: Colors.white70),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  // Tab button widget
  Widget _buildTabButton(String title, bool isSelected) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _currentMarketingTab = title.toLowerCase();
        });
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
        decoration: BoxDecoration(
          color: isSelected ? const Color(0xFF8B0000) : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
        ),
        child: Text(
          title,
          style: TextStyle(
            color: isSelected ? Colors.white : Colors.white70,
            fontSize: 14,
            fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
          ),
          textAlign: TextAlign.center,
        ),
      ),
    );
  }

  // Admin Service Hub Tab Methods
  Widget _buildAdminPortfolioTab() {
    return SingleChildScrollView(
      child: Column(
        children: [
          // Header Section
          Container(
            padding: const EdgeInsets.all(20),
            child: Column(
              children: [
                Text(
                  'Portfolio Management - Admin View',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 16),
                Text(
                  'Add client work links to showcase your portfolio and build trust with potential clients.',
                  style: TextStyle(fontSize: 16, color: Colors.white70),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 20),
                // Action Buttons
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Add Portfolio Item Button
                    ElevatedButton.icon(
                      onPressed: () => _showAddLinkDialog(),
                      icon: const Icon(Icons.add, color: Colors.white),
                      label: const Text('Add Portfolio Item'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        padding: const EdgeInsets.symmetric(
                          horizontal: 20,
                          vertical: 12,
                        ),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(25),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    // Refresh Images Button
                    ElevatedButton.icon(
                      onPressed: () => _refreshPortfolioImages(),
                      icon: const Icon(Icons.refresh, color: Colors.white),
                      label: const Text('Refresh Images'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF2A2A2A),
                        padding: const EdgeInsets.symmetric(
                          horizontal: 20,
                          vertical: 12,
                        ),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(25),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          // Shared Links List
          _buildAdminSharedLinksList(),
        ],
      ),
    );
  }

  Widget _buildAdminSharedLinksList() {
    return Container(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Portfolio Items',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 16),
          // Real-time shared links from Firebase
          StreamBuilder<List<Map<String, dynamic>>>(
            stream: FirebaseService.getSharedLinksStream(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(
                      Color(0xFF8B0000),
                    ),
                  ),
                );
              }

              if (snapshot.hasError) {
                return Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(
                        Icons.error_outline,
                        color: Colors.red,
                        size: 48,
                      ),
                      const SizedBox(height: 16),
                      Text(
                        'Error loading shared links: ${snapshot.error}',
                        style: const TextStyle(color: Colors.red),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                );
              }

              final links = snapshot.data ?? [];

              if (links.isEmpty) {
                return const Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.work, color: Colors.white54, size: 48),
                      SizedBox(height: 16),
                      Text(
                        'No portfolio items found',
                        style: TextStyle(color: Colors.white54, fontSize: 16),
                      ),
                      SizedBox(height: 8),
                      Text(
                        'Add your first portfolio item to showcase your work',
                        style: TextStyle(color: Colors.white38, fontSize: 14),
                      ),
                    ],
                  ),
                );
              }

              return ListView.builder(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: links.length,
                itemBuilder: (context, index) {
                  final link = links[index];
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 16),
                    child: _buildAdminPortfolioCard(link),
                  );
                },
              );
            },
          ),
        ],
      ),
    );
  }

  // Launch URL helper method (Admin version)
  Future<void> _launchUrl(String url) async {
    try {
      final Uri uri = Uri.parse(url);
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
      } else {
        print('Could not launch $url');
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Could not open $url'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      print('Error launching URL: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error opening link: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Show portfolio item details dialog (Admin version)
  void _showPortfolioItemDialog(Map<String, dynamic> link) {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        child: Container(
          width: MediaQuery.of(context).size.width * 0.9,
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                const Color(0xFF2A2A2A).withOpacity(0.95),
                const Color(0xFF1A1A1A).withOpacity(0.95),
              ],
            ),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: const Color(0xFF8B0000).withOpacity(0.3),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: Column(
            children: [
              // Header
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.1),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(20),
                    topRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Icon(Icons.work, color: const Color(0xFF8B0000), size: 24),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        link['title'] ?? 'Client Project',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(
                        Icons.close,
                        color: Colors.white70,
                        size: 24,
                      ),
                    ),
                  ],
                ),
              ),

              // Content
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Image with auto-sizing
                      if (link['image'] != null && link['image'].isNotEmpty)
                        Container(
                          width: double.infinity,
                          constraints: const BoxConstraints(
                            minHeight: 150,
                            maxHeight: 300,
                          ),
                          margin: const EdgeInsets.only(bottom: 20),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(16),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.3),
                                blurRadius: 15,
                                offset: const Offset(0, 6),
                              ),
                            ],
                          ),
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(16),
                            child: Image.network(
                              link['image'],
                              width: double.infinity,
                              fit: BoxFit.cover,
                              errorBuilder: (context, error, stackTrace) {
                                return Container(
                                  height: 200,
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        const Color(0xFF1A1A1A),
                                        const Color(0xFF2A2A2A),
                                      ],
                                    ),
                                  ),
                                  child: const Center(
                                    child: Column(
                                      mainAxisAlignment:
                                          MainAxisAlignment.center,
                                      children: [
                                        Icon(
                                          Icons.broken_image,
                                          color: Colors.white54,
                                          size: 48,
                                        ),
                                        SizedBox(height: 8),
                                        Text(
                                          'Image not available',
                                          style: TextStyle(
                                            color: Colors.white54,
                                            fontSize: 14,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                );
                              },
                              loadingBuilder:
                                  (context, child, loadingProgress) {
                                    if (loadingProgress == null) return child;
                                    return Container(
                                      height: 200,
                                      decoration: BoxDecoration(
                                        gradient: LinearGradient(
                                          begin: Alignment.topLeft,
                                          end: Alignment.bottomRight,
                                          colors: [
                                            const Color(0xFF1A1A1A),
                                            const Color(0xFF2A2A2A),
                                          ],
                                        ),
                                      ),
                                      child: const Center(
                                        child: CircularProgressIndicator(
                                          valueColor:
                                              AlwaysStoppedAnimation<Color>(
                                                Color(0xFF8B0000),
                                              ),
                                        ),
                                      ),
                                    );
                                  },
                            ),
                          ),
                        )
                      else
                        Container(
                          width: double.infinity,
                          height: 200,
                          margin: const EdgeInsets.only(bottom: 20),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(16),
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [
                                const Color(0xFF1A1A1A),
                                const Color(0xFF2A2A2A),
                              ],
                            ),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.3),
                                blurRadius: 15,
                                offset: const Offset(0, 6),
                              ),
                            ],
                          ),
                          child: const Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  Icons.work,
                                  color: Colors.white54,
                                  size: 48,
                                ),
                                SizedBox(height: 8),
                                Text(
                                  'No image available',
                                  style: TextStyle(
                                    color: Colors.white54,
                                    fontSize: 14,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),

                      // Site name
                      Row(
                        children: [
                          Icon(
                            Icons.link,
                            color: const Color(0xFF8B0000),
                            size: 20,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            link['siteName'] ?? 'Client Work',
                            style: const TextStyle(
                              color: Colors.white70,
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 16),

                      // Description
                      if (link['description'] != null &&
                          link['description'].isNotEmpty)
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Project Description',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Text(
                              link['description'],
                              style: const TextStyle(
                                color: Colors.white70,
                                fontSize: 14,
                                height: 1.5,
                              ),
                            ),
                            const SizedBox(height: 20),
                          ],
                        ),

                      // URL
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Project URL',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Container(
                            width: double.infinity,
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              color: const Color(0xFF1A1A1A),
                              borderRadius: BorderRadius.circular(8),
                              border: Border.all(
                                color: const Color(0xFF3A3A3A),
                                width: 1,
                              ),
                            ),
                            child: Text(
                              link['url'] ?? '',
                              style: const TextStyle(
                                color: Color(0xFF8B0000),
                                fontSize: 12,
                                fontFamily: 'monospace',
                              ),
                              maxLines: 2,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ),

              // Action buttons
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF1A1A1A).withOpacity(0.5),
                  borderRadius: const BorderRadius.only(
                    bottomLeft: Radius.circular(20),
                    bottomRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () => Navigator.pop(context),
                        style: OutlinedButton.styleFrom(
                          side: const BorderSide(color: Color(0xFF8B0000)),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: Text(
                          'Close',
                          style: TextStyle(
                            color: const Color(0xFF8B0000),
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.pop(context);
                          _launchUrl(link['url'] ?? '');
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: const Text(
                          'Visit Project',
                          style: TextStyle(fontWeight: FontWeight.w600),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildAdminPortfolioCard(Map<String, dynamic> link) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF2A2A2A).withOpacity(0.9),
            const Color(0xFF1A1A1A).withOpacity(0.9),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: const Color(0xFF8B0000).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () => _showPortfolioItemDialog(link),
          borderRadius: BorderRadius.circular(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header with title and delete button
              Row(
                children: [
                  Icon(Icons.work, color: const Color(0xFF8B0000), size: 20),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      link['title'] ?? 'Untitled Portfolio Item',
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  PopupMenuButton<String>(
                    onSelected: (value) {
                      switch (value) {
                        case 'edit':
                          _showEditLinkDialog(link);
                          break;
                        case 'delete':
                          _showDeleteLinkDialog(link);
                          break;
                      }
                    },
                    itemBuilder: (context) => [
                      const PopupMenuItem(
                        value: 'edit',
                        child: Row(
                          children: [
                            Icon(Icons.edit, color: Colors.white70, size: 16),
                            SizedBox(width: 8),
                            Text('Edit'),
                          ],
                        ),
                      ),
                      const PopupMenuItem(
                        value: 'delete',
                        child: Row(
                          children: [
                            Icon(Icons.delete, color: Colors.red, size: 16),
                            SizedBox(width: 8),
                            Text('Delete'),
                          ],
                        ),
                      ),
                    ],
                    child: const Icon(Icons.more_vert, color: Colors.white70),
                  ),
                ],
              ),
              const SizedBox(height: 12),

              // Image and content row
              Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Portfolio image
                  Container(
                    width: 60,
                    height: 60,
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(8),
                      color: const Color(0xFF1A1A1A),
                    ),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(8),
                      child: link['image'] != null && link['image'].isNotEmpty
                          ? Image.network(
                              link['image'],
                              width: 60,
                              height: 60,
                              fit: BoxFit.cover,
                              errorBuilder: (context, error, stackTrace) {
                                return const Icon(
                                  Icons.work,
                                  color: Colors.white54,
                                  size: 24,
                                );
                              },
                              loadingBuilder:
                                  (context, child, loadingProgress) {
                                    if (loadingProgress == null) return child;
                                    return const Center(
                                      child: CircularProgressIndicator(
                                        valueColor:
                                            AlwaysStoppedAnimation<Color>(
                                              Color(0xFF8B0000),
                                            ),
                                        strokeWidth: 2,
                                      ),
                                    );
                                  },
                            )
                          : const Icon(
                              Icons.work,
                              color: Colors.white54,
                              size: 24,
                            ),
                    ),
                  ),
                  const SizedBox(width: 12),

                  // Description and URL
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          link['description'] ??
                              'No project description available',
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 14,
                          ),
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                        ),
                        const SizedBox(height: 8),
                        Text(
                          link['url'] ?? '',
                          style: const TextStyle(
                            color: Color(0xFF8B0000),
                            fontSize: 12,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildAdminMarketingPackageCard(
    String name,
    String icon,
    double price,
    String description,
    List<String> features,
    String id,
  ) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF2A2A2A).withOpacity(0.9),
            const Color(0xFF1A1A1A).withOpacity(0.9),
          ],
        ),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(
          color: const Color(0xFF8B0000).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Text(icon, style: const TextStyle(fontSize: 24)),
                  const SizedBox(width: 12),
                  Text(
                    name,
                    style: const TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
              // Admin Edit Button
              PopupMenuButton<String>(
                onSelected: (value) {
                  if (value == 'edit') {
                    _showEditMarketingPackageDialog(
                      name,
                      price,
                      description,
                      features,
                      id,
                    );
                  } else if (value == 'delete') {
                    _showDeleteMarketingPackageDialog(name, id);
                  }
                },
                itemBuilder: (context) => [
                  const PopupMenuItem(
                    value: 'edit',
                    child: Row(
                      children: [
                        Icon(Icons.edit, color: Colors.blue, size: 16),
                        SizedBox(width: 8),
                        Text('Edit'),
                      ],
                    ),
                  ),
                  const PopupMenuItem(
                    value: 'delete',
                    child: Row(
                      children: [
                        Icon(Icons.delete, color: Colors.red, size: 16),
                        SizedBox(width: 8),
                        Text('Delete'),
                      ],
                    ),
                  ),
                ],
                child: const Icon(Icons.more_vert, color: Colors.white70),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            description,
            style: const TextStyle(fontSize: 16, color: Colors.white70),
          ),
          const SizedBox(height: 16),
          Text(
            'R${price.toStringAsFixed(0)}/month',
            style: const TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: Color(0xFF8B0000),
            ),
          ),
          const SizedBox(height: 16),
          ...features.map(
            (feature) => Padding(
              padding: const EdgeInsets.only(bottom: 8),
              child: Row(
                children: [
                  const Icon(
                    Icons.check_circle,
                    color: Color(0xFF8B0000),
                    size: 16,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      feature,
                      style: const TextStyle(
                        fontSize: 14,
                        color: Colors.white70,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildAdminServiceCard(
    String name,
    String description,
    double price,
    String duration,
    List<String> features,
    String id,
  ) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF2A2A2A).withOpacity(0.9),
            const Color(0xFF1A1A1A).withOpacity(0.9),
          ],
        ),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(
          color: const Color(0xFF8B0000).withOpacity(0.3),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                name,
                style: const TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                ),
              ),
              // Admin Edit Button
              PopupMenuButton<String>(
                onSelected: (value) {
                  if (value == 'edit') {
                    _showEditServiceDialog(
                      name,
                      description,
                      price.toString(),
                      id,
                    );
                  } else if (value == 'delete') {
                    _showDeleteServiceDialog(name, id);
                  }
                },
                itemBuilder: (context) => [
                  const PopupMenuItem(
                    value: 'edit',
                    child: Row(
                      children: [
                        Icon(Icons.edit, color: Colors.blue, size: 16),
                        SizedBox(width: 8),
                        Text('Edit'),
                      ],
                    ),
                  ),
                  const PopupMenuItem(
                    value: 'delete',
                    child: Row(
                      children: [
                        Icon(Icons.delete, color: Colors.red, size: 16),
                        SizedBox(width: 8),
                        Text('Delete'),
                      ],
                    ),
                  ),
                ],
                child: const Icon(Icons.more_vert, color: Colors.white70),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            description,
            style: const TextStyle(fontSize: 16, color: Colors.white70),
          ),
          const SizedBox(height: 16),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'R${price.toStringAsFixed(0)}',
                style: const TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF8B0000),
                ),
              ),
              Text(
                duration,
                style: const TextStyle(fontSize: 14, color: Colors.white70),
              ),
            ],
          ),
          const SizedBox(height: 16),
          ...features.map(
            (feature) => Padding(
              padding: const EdgeInsets.only(bottom: 8),
              child: Row(
                children: [
                  const Icon(
                    Icons.check_circle,
                    color: Color(0xFF8B0000),
                    size: 16,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      feature,
                      style: const TextStyle(
                        fontSize: 14,
                        color: Colors.white70,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _showAdminServiceHubOptions() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Service Hub Management',
          style: TextStyle(color: Colors.white),
        ),
        content: const Text(
          'Choose what you want to manage:',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              _showCreateServiceDialog();
            },
            child: const Text(
              'Add Service',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              _showCreateProductDialog();
            },
            child: const Text(
              'Add Product',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              _showCreateCategoryDialog();
            },
            child: const Text(
              'Add Category',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
        ],
      ),
    );
  }

  void _showEditMarketingPackageDialog(
    String name,
    double price,
    String description,
    List<String> features,
    String id,
  ) {
    // TODO: Implement edit marketing package dialog
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Edit marketing package: $name'),
        backgroundColor: const Color(0xFF8B0000),
      ),
    );
  }

  void _showDeleteMarketingPackageDialog(String name, String id) {
    // TODO: Implement delete marketing package dialog
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Delete marketing package: $name'),
        backgroundColor: const Color(0xFF8B0000),
      ),
    );
  }

  // Service Hub Helper Methods
  Widget _buildServiceTabButton(String title, bool isSelected) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _currentServiceTab = title.toLowerCase();
        });
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
        decoration: BoxDecoration(
          color: isSelected ? const Color(0xFF8B0000) : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
        ),
        child: Text(
          title,
          style: TextStyle(
            color: isSelected ? Colors.white : Colors.white70,
            fontSize: 14,
            fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
          ),
          textAlign: TextAlign.center,
        ),
      ),
    );
  }

  Widget _buildServiceStatCard(
    String title,
    String value,
    String subtitle,
    IconData icon,
    Color color,
    Color subtitleColor,
  ) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Icon(icon, color: color, size: 24),
              Text(
                value,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            title,
            style: const TextStyle(
              color: Colors.white70,
              fontSize: 14,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            subtitle,
            style: TextStyle(
              color: subtitleColor,
              fontSize: 12,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildServicesList() {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: const BoxDecoration(
              border: Border(
                bottom: BorderSide(color: Color(0xFF3A3A3A), width: 1),
              ),
            ),
            child: Row(
              children: [
                const Text(
                  'Services',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                IconButton(
                  onPressed: () => _showCreateServiceDialog(),
                  icon: const Icon(Icons.add, color: Colors.white),
                ),
              ],
            ),
          ),
          // Services List - Real-time data
          Expanded(
            child: StreamBuilder<List<Map<String, dynamic>>>(
              stream: FirebaseService.getServicesStream(),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(
                    child: CircularProgressIndicator(
                      valueColor: AlwaysStoppedAnimation<Color>(
                        Color(0xFF8B0000),
                      ),
                    ),
                  );
                }

                if (snapshot.hasError) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.error_outline,
                          color: Colors.red,
                          size: 48,
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Error loading services: ${snapshot.error}',
                          style: const TextStyle(color: Colors.red),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  );
                }

                final services = snapshot.data ?? [];

                if (services.isEmpty) {
                  return const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.design_services,
                          color: Colors.white54,
                          size: 48,
                        ),
                        SizedBox(height: 16),
                        Text(
                          'No services found',
                          style: TextStyle(color: Colors.white54, fontSize: 16),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Add your first service to get started',
                          style: TextStyle(color: Colors.white38, fontSize: 14),
                        ),
                      ],
                    ),
                  );
                }

                return ListView.builder(
                  itemCount: services.length,
                  itemBuilder: (context, index) {
                    final service = services[index];
                    return _buildServiceItem(
                      service['name'] ?? 'Unnamed Service',
                      service['description'] ?? 'No description',
                      'R${service['price']?.toString() ?? '0.00'}',
                      service['status'] ?? 'Active',
                      Icons.design_services,
                      service['id'],
                    );
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildProductsList() {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: const BoxDecoration(
              border: Border(
                bottom: BorderSide(color: Color(0xFF3A3A3A), width: 1),
              ),
            ),
            child: Row(
              children: [
                const Text(
                  'Products',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                IconButton(
                  onPressed: () => _showCreateProductDialog(),
                  icon: const Icon(Icons.add, color: Colors.white),
                ),
              ],
            ),
          ),
          // Products List - Real-time data
          Expanded(
            child: StreamBuilder<List<Map<String, dynamic>>>(
              stream: FirebaseService.getProductsStream(),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(
                    child: CircularProgressIndicator(
                      valueColor: AlwaysStoppedAnimation<Color>(
                        Color(0xFF8B0000),
                      ),
                    ),
                  );
                }

                if (snapshot.hasError) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.error_outline,
                          color: Colors.red,
                          size: 48,
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Error loading products: ${snapshot.error}',
                          style: const TextStyle(color: Colors.red),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  );
                }

                final products = snapshot.data ?? [];

                if (products.isEmpty) {
                  return const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.inventory, color: Colors.white54, size: 48),
                        SizedBox(height: 16),
                        Text(
                          'No products found',
                          style: TextStyle(color: Colors.white54, fontSize: 16),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Add your first product to get started',
                          style: TextStyle(color: Colors.white38, fontSize: 14),
                        ),
                      ],
                    ),
                  );
                }

                return ListView.builder(
                  itemCount: products.length,
                  itemBuilder: (context, index) {
                    final product = products[index];
                    return _buildProductItem(
                      product['name'] ?? 'Unnamed Product',
                      product['description'] ?? 'No description',
                      'R${product['price']?.toString() ?? '0.00'}',
                      product['status'] ?? 'In Stock',
                      Icons.inventory,
                      product['id'],
                    );
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoriesList() {
    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: const BoxDecoration(
              border: Border(
                bottom: BorderSide(color: Color(0xFF3A3A3A), width: 1),
              ),
            ),
            child: Row(
              children: [
                const Text(
                  'Categories',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                IconButton(
                  onPressed: () => _showCreateCategoryDialog(),
                  icon: const Icon(Icons.add, color: Colors.white),
                ),
              ],
            ),
          ),
          // Categories List - Real-time data
          Expanded(
            child: StreamBuilder<List<Map<String, dynamic>>>(
              stream: FirebaseService.getCategoriesStream(),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(
                    child: CircularProgressIndicator(
                      valueColor: AlwaysStoppedAnimation<Color>(
                        Color(0xFF8B0000),
                      ),
                    ),
                  );
                }

                if (snapshot.hasError) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.error_outline,
                          color: Colors.red,
                          size: 48,
                        ),
                        const SizedBox(height: 16),
                        Text(
                          'Error loading categories: ${snapshot.error}',
                          style: const TextStyle(color: Colors.red),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  );
                }

                final categories = snapshot.data ?? [];

                if (categories.isEmpty) {
                  return const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.category, color: Colors.white54, size: 48),
                        SizedBox(height: 16),
                        Text(
                          'No categories found',
                          style: TextStyle(color: Colors.white54, fontSize: 16),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Add your first category to get started',
                          style: TextStyle(color: Colors.white38, fontSize: 14),
                        ),
                      ],
                    ),
                  );
                }

                return ListView.builder(
                  itemCount: categories.length,
                  itemBuilder: (context, index) {
                    final category = categories[index];
                    return _buildCategoryItem(
                      category['name'] ?? 'Unnamed Category',
                      '${(index + 1) * 3} items', // TODO: Calculate actual item count
                      Icons.category,
                      category['id'],
                    );
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildServiceItem(
    String name,
    String description,
    String price,
    String status,
    IconData icon,
    String? id,
  ) {
    return Container(
      margin: const EdgeInsets.all(8),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFF8B0000).withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: const Color(0xFF8B0000), size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  description,
                  style: const TextStyle(color: Colors.white70, fontSize: 14),
                ),
                const SizedBox(height: 8),
                Row(
                  children: [
                    Text(
                      price,
                      style: const TextStyle(
                        color: Colors.green,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: Colors.green.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(4),
                      ),
                      child: Text(
                        status,
                        style: const TextStyle(
                          color: Colors.green,
                          fontSize: 12,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          PopupMenuButton<String>(
            onSelected: (value) {
              if (value == 'edit') {
                _showEditServiceDialog(name, description, price, id);
              } else if (value == 'delete') {
                _showDeleteServiceDialog(name, id);
              }
            },
            itemBuilder: (context) => [
              const PopupMenuItem(
                value: 'edit',
                child: Row(
                  children: [
                    Icon(Icons.edit, color: Colors.white, size: 16),
                    SizedBox(width: 8),
                    Text('Edit', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'delete',
                child: Row(
                  children: [
                    Icon(Icons.delete, color: Colors.red, size: 16),
                    SizedBox(width: 8),
                    Text('Delete', style: TextStyle(color: Colors.red)),
                  ],
                ),
              ),
            ],
            child: const Icon(Icons.more_vert, color: Colors.white70),
          ),
        ],
      ),
    );
  }

  Widget _buildProductItem(
    String name,
    String description,
    String price,
    String status,
    IconData icon,
    String? id,
  ) {
    return Container(
      margin: const EdgeInsets.all(8),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: Colors.blue, size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  description,
                  style: const TextStyle(color: Colors.white70, fontSize: 14),
                ),
                const SizedBox(height: 8),
                Row(
                  children: [
                    Text(
                      price,
                      style: const TextStyle(
                        color: Colors.green,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: Colors.blue.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(4),
                      ),
                      child: Text(
                        status,
                        style: const TextStyle(
                          color: Colors.blue,
                          fontSize: 12,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          PopupMenuButton<String>(
            onSelected: (value) {
              if (value == 'edit') {
                _showEditProductDialog(name, description, price, id);
              } else if (value == 'delete') {
                _showDeleteProductDialog(name, id);
              }
            },
            itemBuilder: (context) => [
              const PopupMenuItem(
                value: 'edit',
                child: Row(
                  children: [
                    Icon(Icons.edit, color: Colors.white, size: 16),
                    SizedBox(width: 8),
                    Text('Edit', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'delete',
                child: Row(
                  children: [
                    Icon(Icons.delete, color: Colors.red, size: 16),
                    SizedBox(width: 8),
                    Text('Delete', style: TextStyle(color: Colors.red)),
                  ],
                ),
              ),
            ],
            child: const Icon(Icons.more_vert, color: Colors.white70),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoryItem(
    String name,
    String itemCount,
    IconData icon,
    String? id,
  ) {
    return Container(
      margin: const EdgeInsets.all(8),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFF1A1A1A),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.purple.withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: Colors.purple, size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  itemCount,
                  style: const TextStyle(color: Colors.white70, fontSize: 14),
                ),
              ],
            ),
          ),
          PopupMenuButton<String>(
            onSelected: (value) {
              if (value == 'edit') {
                _showEditCategoryDialog(name, id);
              } else if (value == 'delete') {
                _showDeleteCategoryDialog(name, id);
              }
            },
            itemBuilder: (context) => [
              const PopupMenuItem(
                value: 'edit',
                child: Row(
                  children: [
                    Icon(Icons.edit, color: Colors.white, size: 16),
                    SizedBox(width: 8),
                    Text('Edit', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'delete',
                child: Row(
                  children: [
                    Icon(Icons.delete, color: Colors.red, size: 16),
                    SizedBox(width: 8),
                    Text('Delete', style: TextStyle(color: Colors.red)),
                  ],
                ),
              ),
            ],
            child: const Icon(Icons.more_vert, color: Colors.white70),
          ),
        ],
      ),
    );
  }

  // Dialog Methods
  void _showAddLinkDialog() {
    // Only allow admin users to add portfolio items
    if (AuthService.instance?.isAdmin != true) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Only administrators can add portfolio items'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }
    final TextEditingController urlController = TextEditingController();
    final TextEditingController titleController = TextEditingController();
    final TextEditingController descriptionController = TextEditingController();
    bool isLoading = false;

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: const Text(
            'Add Portfolio Item',
            style: TextStyle(color: Colors.white),
          ),
          content: SizedBox(
            width: 400,
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // URL Input
                  const Text(
                    'URL',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: urlController,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'https://client-project.com',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                    onChanged: (value) {
                      // Auto-fetch preview when URL is entered
                      print('URL changed: $value');

                      // Cancel previous timer
                      _debounceTimer?.cancel();

                      if (value.isNotEmpty) {
                        // Fix common URL issues
                        String fixedUrl = value;
                        if (!value.startsWith('http://') &&
                            !value.startsWith('https://')) {
                          if (value.startsWith('s://')) {
                            fixedUrl = 'https://${value.substring(2)}';
                          } else if (value.startsWith('://')) {
                            fixedUrl = 'https://${value.substring(3)}';
                          } else {
                            fixedUrl = 'https://$value';
                          }
                        }

                        if (Uri.tryParse(fixedUrl) != null) {
                          // Debounce the API call
                          _debounceTimer = Timer(
                            const Duration(milliseconds: 500),
                            () {
                              print('Calling _fetchLinkPreview for: $fixedUrl');
                              _fetchLinkPreview(
                                fixedUrl,
                                titleController,
                                descriptionController,
                                setState,
                              );
                            },
                          );
                        } else {
                          print('URL validation failed for: $fixedUrl');
                        }
                      }
                    },
                  ),
                  const SizedBox(height: 16),

                  // Title Input
                  const Text(
                    'Title',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: titleController,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'Project title (auto-filled from URL)',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Description Input
                  const Text(
                    'Description',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: descriptionController,
                    maxLines: 3,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'Project description (auto-filled from URL)',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                  ),

                  if (isLoading) ...[
                    const SizedBox(height: 16),
                    const Center(
                      child: CircularProgressIndicator(
                        valueColor: AlwaysStoppedAnimation<Color>(
                          Color(0xFF8B0000),
                        ),
                      ),
                    ),
                  ],
                ],
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton(
              onPressed: isLoading
                  ? null
                  : () async {
                      if (urlController.text.isNotEmpty) {
                        setState(() {
                          isLoading = true;
                        });

                        try {
                          await FirebaseService.addSharedLink({
                            'url': urlController.text,
                            'title': titleController.text.isNotEmpty
                                ? titleController.text
                                : 'Untitled Link',
                            'description': descriptionController.text.isNotEmpty
                                ? descriptionController.text
                                : 'No description',
                            'image': _currentImageUrl ?? '',
                            'siteName': _currentSiteName ?? '',
                          });

                          // Send push notification to all users about new portfolio item
                          await NotificationService.sendPortfolioNotification(
                            title: titleController.text.isNotEmpty
                                ? titleController.text
                                : 'Untitled Link',
                            description: descriptionController.text.isNotEmpty
                                ? descriptionController.text
                                : 'No description',
                            imageUrl: _currentImageUrl,
                          );

                          Navigator.pop(context);
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text(
                                'Portfolio item "${titleController.text}" added successfully and users notified!',
                              ),
                              backgroundColor: const Color(0xFF8B0000),
                            ),
                          );
                        } catch (e) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text('Error adding portfolio item: $e'),
                              backgroundColor: Colors.red,
                            ),
                          );
                        } finally {
                          setState(() {
                            isLoading = false;
                          });
                        }
                      }
                    },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
              ),
              child: const Text(
                'Add Portfolio Item',
                style: TextStyle(color: Colors.white),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _fetchLinkPreview(
    String url,
    TextEditingController titleController,
    TextEditingController descriptionController,
    StateSetter setState,
  ) async {
    print('_fetchLinkPreview called with URL: $url');
    setState(() {
      // Show loading indicator
    });

    try {
      // Import the LinkPreviewService
      print('Calling LinkPreviewService.getPreview...');
      final preview = await LinkPreviewService.getPreview(url);
      print('Preview result: $preview');
      if (preview != null) {
        print('Setting title: ${preview.title}');
        print('Setting description: ${preview.description}');
        print('Setting image: ${preview.image}');
        print('Setting siteName: ${preview.siteName}');
        titleController.text = preview.title;
        descriptionController.text = preview.description;
        // Store the image URL in a variable that can be used when saving
        _currentImageUrl = preview.image;
        _currentSiteName = preview.siteName;
      } else {
        print('Preview is null');
      }
    } catch (e) {
      print('Error fetching preview: $e');
    } finally {
      setState(() {
        // Hide loading indicator
      });
    }
  }

  Future<void> _refreshPortfolioImages() async {
    // Show loading dialog
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF8B0000)),
            ),
            const SizedBox(height: 16),
            const Text(
              'Refreshing portfolio images...',
              style: TextStyle(color: Colors.white),
            ),
          ],
        ),
      ),
    );

    try {
      // Get all shared links directly from Firestore
      final snapshot = await FirebaseFirestore.instance
          .collection('shared_links')
          .orderBy('createdAt', descending: true)
          .get();

      final links = snapshot.docs.map((doc) {
        return {'id': doc.id, ...doc.data()};
      }).toList();

      int updatedCount = 0;

      for (var link in links) {
        final url = link['url'] as String?;
        if (url != null && url.isNotEmpty) {
          try {
            // Fetch fresh preview data
            final preview = await LinkPreviewService.getPreview(url);
            if (preview != null && preview.image.isNotEmpty) {
              // Update the link with new image data
              await FirebaseFirestore.instance
                  .collection('shared_links')
                  .doc(link['id'])
                  .update({
                    'image': preview.image,
                    'siteName': preview.siteName,
                    'title': preview.title,
                    'description': preview.description,
                    'updatedAt': FieldValue.serverTimestamp(),
                  });
              updatedCount++;
            }
          } catch (e) {
            print('Error refreshing link ${link['id']}: $e');
          }
        }
      }

      // Close loading dialog
      if (mounted) {
        Navigator.pop(context);

        // Show success message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Successfully refreshed $updatedCount portfolio item${updatedCount != 1 ? 's' : ''}',
            ),
            backgroundColor: const Color(0xFF8B0000),
          ),
        );
      }
    } catch (e) {
      // Close loading dialog
      if (mounted) {
        Navigator.pop(context);

        // Show error message
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error refreshing portfolio images: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  void _showDeleteLinkDialog(Map<String, dynamic> link) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Delete Portfolio Item',
          style: TextStyle(color: Colors.white),
        ),
        content: Text(
          'Are you sure you want to delete "${link['title'] ?? 'this portfolio item'}"?',
          style: const TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () async {
              try {
                await FirebaseService.deleteSharedLink(link['id']);
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Portfolio item "${link['title']}" deleted successfully',
                    ),
                    backgroundColor: const Color(0xFF8B0000),
                  ),
                );
              } catch (e) {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text('Error deleting portfolio item: $e'),
                    backgroundColor: Colors.red,
                  ),
                );
              }
            },
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Delete', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  // Show edit link dialog
  void _showEditLinkDialog(Map<String, dynamic> link) {
    final titleController = TextEditingController(text: link['title'] ?? '');
    final descriptionController = TextEditingController(
      text: link['description'] ?? '',
    );
    final urlController = TextEditingController(text: link['url'] ?? '');
    final imageController = TextEditingController(text: link['image'] ?? '');

    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        child: Container(
          width: MediaQuery.of(context).size.width * 0.9,
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                const Color(0xFF2A2A2A).withOpacity(0.95),
                const Color(0xFF1A1A1A).withOpacity(0.95),
              ],
            ),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(
              color: const Color(0xFF8B0000).withOpacity(0.3),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: Column(
            children: [
              // Header
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.1),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(20),
                    topRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Icon(Icons.edit, color: const Color(0xFF8B0000), size: 24),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Edit Portfolio Item',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.of(context).pop(),
                      icon: const Icon(Icons.close, color: Colors.white70),
                    ),
                  ],
                ),
              ),
              // Form
              Expanded(
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: SingleChildScrollView(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildAdminFormField(
                          'Title',
                          titleController,
                          'Enter portfolio item title',
                        ),
                        const SizedBox(height: 16),
                        _buildAdminFormField(
                          'Description',
                          descriptionController,
                          'Enter description',
                          maxLines: 3,
                        ),
                        const SizedBox(height: 16),
                        _buildAdminFormField('URL', urlController, 'Enter URL'),
                        const SizedBox(height: 8),
                        ElevatedButton.icon(
                          onPressed: () async {
                            if (urlController.text.isNotEmpty) {
                              try {
                                final preview =
                                    await LinkPreviewService.getPreview(
                                      urlController.text,
                                    );
                                if (preview != null) {
                                  titleController.text = preview.title;
                                  descriptionController.text =
                                      preview.description;
                                  imageController.text = preview.image;
                                  ScaffoldMessenger.of(context).showSnackBar(
                                    const SnackBar(
                                      content: Text(
                                        'Link preview fetched successfully!',
                                      ),
                                      backgroundColor: Color(0xFF4CAF50),
                                    ),
                                  );
                                }
                              } catch (e) {
                                ScaffoldMessenger.of(context).showSnackBar(
                                  SnackBar(
                                    content: Text('Error fetching preview: $e'),
                                    backgroundColor: Colors.red,
                                  ),
                                );
                              }
                            }
                          },
                          icon: const Icon(Icons.refresh, size: 18),
                          label: const Text('Fetch Link Preview'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF8B0000),
                            foregroundColor: Colors.white,
                            padding: const EdgeInsets.symmetric(
                              vertical: 12,
                              horizontal: 16,
                            ),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                        ),
                        const SizedBox(height: 16),
                        _buildAdminFormField(
                          'Image URL',
                          imageController,
                          'Enter image URL',
                        ),
                      ],
                    ),
                  ),
                ),
              ),
              // Footer with buttons
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: const Color(0xFF1A1A1A).withOpacity(0.8),
                  borderRadius: const BorderRadius.only(
                    bottomLeft: Radius.circular(20),
                    bottomRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () => Navigator.of(context).pop(),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.grey.withOpacity(0.3),
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: const Text('Cancel'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () async {
                          if (titleController.text.isNotEmpty &&
                              urlController.text.isNotEmpty) {
                            await FirebaseService.updateSharedLink(link['id'], {
                              'title': titleController.text,
                              'description': descriptionController.text,
                              'url': urlController.text,
                              'image': imageController.text,
                              'updatedAt':
                                  DateTime.now().millisecondsSinceEpoch,
                            });
                            Navigator.of(context).pop();
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text(
                                  'Portfolio item updated successfully',
                                ),
                                backgroundColor: Color(0xFF4CAF50),
                              ),
                            );
                          } else {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text('Title and URL are required'),
                                backgroundColor: Colors.red,
                              ),
                            );
                          }
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF8B0000),
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: const Text('Update'),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // Build admin form field helper
  Widget _buildAdminFormField(
    String label,
    TextEditingController controller,
    String hint, {
    int maxLines = 1,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 16,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          maxLines: maxLines,
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: TextStyle(color: Colors.white54),
            filled: true,
            fillColor: const Color(0xFF1A1A1A).withOpacity(0.8),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: BorderSide(color: Colors.white.withOpacity(0.2)),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: BorderSide(color: Colors.white.withOpacity(0.2)),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: Color(0xFF8B0000)),
            ),
          ),
        ),
      ],
    );
  }

  void _showCreateServiceDialog() {
    final TextEditingController nameController = TextEditingController();
    final TextEditingController descriptionController = TextEditingController();
    final TextEditingController priceController = TextEditingController();
    String selectedStatus = 'Active';
    String selectedCategory = 'Design Services';

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: const Text(
            'Create New Service',
            style: TextStyle(color: Colors.white),
          ),
          content: SizedBox(
            width: 400,
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Service Name
                  const Text(
                    'Service Name',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: nameController,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'Enter service name',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Description
                  const Text(
                    'Description',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: descriptionController,
                    maxLines: 3,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'Enter service description',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Price and Status Row
                  Row(
                    children: [
                      // Price
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Price',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 8),
                            TextField(
                              controller: priceController,
                              style: const TextStyle(color: Colors.white),
                              keyboardType: TextInputType.number,
                              decoration: InputDecoration(
                                hintText: 'R0.00',
                                hintStyle: const TextStyle(
                                  color: Colors.white54,
                                ),
                                prefixText: 'R',
                                prefixStyle: const TextStyle(
                                  color: Colors.white,
                                ),
                                filled: true,
                                fillColor: const Color(0xFF1A1A1A),
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                  borderSide: const BorderSide(
                                    color: Color(0xFF3A3A3A),
                                  ),
                                ),
                                enabledBorder: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                  borderSide: const BorderSide(
                                    color: Color(0xFF3A3A3A),
                                  ),
                                ),
                                focusedBorder: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                  borderSide: const BorderSide(
                                    color: Color(0xFF8B0000),
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(width: 16),
                      // Status
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Status',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                              ),
                              decoration: BoxDecoration(
                                color: const Color(0xFF1A1A1A),
                                borderRadius: BorderRadius.circular(8),
                                border: Border.all(
                                  color: const Color(0xFF3A3A3A),
                                ),
                              ),
                              child: DropdownButtonHideUnderline(
                                child: DropdownButton<String>(
                                  value: selectedStatus,
                                  isExpanded: true,
                                  style: const TextStyle(color: Colors.white),
                                  dropdownColor: const Color(0xFF2A2A2A),
                                  items: ['Active', 'Inactive', 'Draft'].map((
                                    String value,
                                  ) {
                                    return DropdownMenuItem<String>(
                                      value: value,
                                      child: Text(value),
                                    );
                                  }).toList(),
                                  onChanged: (String? newValue) {
                                    setState(() {
                                      selectedStatus = newValue!;
                                    });
                                  },
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),

                  // Category
                  const Text(
                    'Category',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1A1A1A),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: const Color(0xFF3A3A3A)),
                    ),
                    child: DropdownButtonHideUnderline(
                      child: DropdownButton<String>(
                        value: selectedCategory,
                        isExpanded: true,
                        style: const TextStyle(color: Colors.white),
                        dropdownColor: const Color(0xFF2A2A2A),
                        items:
                            [
                              'Design Services',
                              'Print Products',
                              'Digital Products',
                              'Consultation',
                              'Marketing',
                              'Web Development',
                            ].map((String value) {
                              return DropdownMenuItem<String>(
                                value: value,
                                child: Text(value),
                              );
                            }).toList(),
                        onChanged: (String? newValue) {
                          setState(() {
                            selectedCategory = newValue!;
                          });
                        },
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton(
              onPressed: () async {
                if (nameController.text.isNotEmpty) {
                  try {
                    await FirebaseService.addService({
                      'name': nameController.text,
                      'description': descriptionController.text,
                      'price': double.tryParse(priceController.text) ?? 0.0,
                      'status': selectedStatus,
                      'category': selectedCategory,
                    });
                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text(
                          'Service "${nameController.text}" created successfully',
                        ),
                        backgroundColor: const Color(0xFF8B0000),
                      ),
                    );
                  } catch (e) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Error creating service: $e'),
                        backgroundColor: Colors.red,
                      ),
                    );
                  }
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
              ),
              child: const Text(
                'Create',
                style: TextStyle(color: Colors.white),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showCreateProductDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Create New Product',
          style: TextStyle(color: Colors.white),
        ),
        content: const Text(
          'Product creation dialog will be implemented here.',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
            ),
            child: const Text('Create', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  void _showCreateCategoryDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: const Text(
          'Create New Category',
          style: TextStyle(color: Colors.white),
        ),
        content: const Text(
          'Category creation dialog will be implemented here.',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B0000),
            ),
            child: const Text('Create', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  void _showEditServiceDialog(
    String name,
    String description,
    String price,
    String? id,
  ) {
    final TextEditingController nameController = TextEditingController(
      text: name,
    );
    final TextEditingController descriptionController = TextEditingController(
      text: description,
    );
    final TextEditingController priceController = TextEditingController(
      text: price,
    );
    String selectedStatus = 'Active';
    String selectedCategory = 'Design Services';

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            'Edit Service: $name',
            style: const TextStyle(color: Colors.white),
          ),
          content: SizedBox(
            width: 400,
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Service Name
                  const Text(
                    'Service Name',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: nameController,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'Enter service name',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Description
                  const Text(
                    'Description',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: descriptionController,
                    maxLines: 3,
                    style: const TextStyle(color: Colors.white),
                    decoration: InputDecoration(
                      hintText: 'Enter service description',
                      hintStyle: const TextStyle(color: Colors.white54),
                      filled: true,
                      fillColor: const Color(0xFF1A1A1A),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: Color(0xFF8B0000)),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Price and Status Row
                  Row(
                    children: [
                      // Price
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Price',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 8),
                            TextField(
                              controller: priceController,
                              style: const TextStyle(color: Colors.white),
                              keyboardType: TextInputType.number,
                              decoration: InputDecoration(
                                hintText: 'R0.00',
                                hintStyle: const TextStyle(
                                  color: Colors.white54,
                                ),
                                prefixText: 'R',
                                prefixStyle: const TextStyle(
                                  color: Colors.white,
                                ),
                                filled: true,
                                fillColor: const Color(0xFF1A1A1A),
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                  borderSide: const BorderSide(
                                    color: Color(0xFF3A3A3A),
                                  ),
                                ),
                                enabledBorder: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                  borderSide: const BorderSide(
                                    color: Color(0xFF3A3A3A),
                                  ),
                                ),
                                focusedBorder: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                  borderSide: const BorderSide(
                                    color: Color(0xFF8B0000),
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(width: 16),
                      // Status
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Status',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                              ),
                              decoration: BoxDecoration(
                                color: const Color(0xFF1A1A1A),
                                borderRadius: BorderRadius.circular(8),
                                border: Border.all(
                                  color: const Color(0xFF3A3A3A),
                                ),
                              ),
                              child: DropdownButtonHideUnderline(
                                child: DropdownButton<String>(
                                  value: selectedStatus,
                                  isExpanded: true,
                                  style: const TextStyle(color: Colors.white),
                                  dropdownColor: const Color(0xFF2A2A2A),
                                  items: ['Active', 'Inactive', 'Draft'].map((
                                    String value,
                                  ) {
                                    return DropdownMenuItem<String>(
                                      value: value,
                                      child: Text(value),
                                    );
                                  }).toList(),
                                  onChanged: (String? newValue) {
                                    setState(() {
                                      selectedStatus = newValue!;
                                    });
                                  },
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),

                  // Category
                  const Text(
                    'Category',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1A1A1A),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: const Color(0xFF3A3A3A)),
                    ),
                    child: DropdownButtonHideUnderline(
                      child: DropdownButton<String>(
                        value: selectedCategory,
                        isExpanded: true,
                        style: const TextStyle(color: Colors.white),
                        dropdownColor: const Color(0xFF2A2A2A),
                        items:
                            [
                              'Design Services',
                              'Print Products',
                              'Digital Products',
                              'Consultation',
                              'Marketing',
                              'Web Development',
                            ].map((String value) {
                              return DropdownMenuItem<String>(
                                value: value,
                                child: Text(value),
                              );
                            }).toList(),
                        onChanged: (String? newValue) {
                          setState(() {
                            selectedCategory = newValue!;
                          });
                        },
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton(
              onPressed: () async {
                if (id != null) {
                  try {
                    await FirebaseService.updateService(id, {
                      'name': nameController.text,
                      'description': descriptionController.text,
                      'price': double.tryParse(priceController.text) ?? 0.0,
                      'status': selectedStatus,
                      'category': selectedCategory,
                    });
                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text(
                          'Service "${nameController.text}" updated successfully',
                        ),
                        backgroundColor: const Color(0xFF8B0000),
                      ),
                    );
                  } catch (e) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Error updating service: $e'),
                        backgroundColor: Colors.red,
                      ),
                    );
                  }
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
              ),
              child: const Text('Save', style: TextStyle(color: Colors.white)),
            ),
          ],
        ),
      ),
    );
  }

  void _showEditProductDialog(
    String name,
    String description,
    String price,
    String? id,
  ) {
    final TextEditingController nameController = TextEditingController(
      text: name,
    );
    final TextEditingController descriptionController = TextEditingController(
      text: description,
    );
    final TextEditingController priceController = TextEditingController(
      text: price,
    );
    String selectedStatus = 'In Stock';

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            'Edit Product: $name',
            style: const TextStyle(color: Colors.white),
          ),
          content: SizedBox(
            width: 400,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Product Name
                const Text(
                  'Product Name',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: nameController,
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'Enter product name',
                    hintStyle: const TextStyle(color: Colors.white54),
                    filled: true,
                    fillColor: const Color(0xFF1A1A1A),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF8B0000)),
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                // Description
                const Text(
                  'Description',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: descriptionController,
                  maxLines: 3,
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'Enter product description',
                    hintStyle: const TextStyle(color: Colors.white54),
                    filled: true,
                    fillColor: const Color(0xFF1A1A1A),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF8B0000)),
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                // Price and Status Row
                Row(
                  children: [
                    // Price
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Price',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          TextField(
                            controller: priceController,
                            style: const TextStyle(color: Colors.white),
                            keyboardType: TextInputType.number,
                            decoration: InputDecoration(
                              hintText: 'R0.00',
                              hintStyle: const TextStyle(color: Colors.white54),
                              prefixText: 'R',
                              prefixStyle: const TextStyle(color: Colors.white),
                              filled: true,
                              fillColor: const Color(0xFF1A1A1A),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(8),
                                borderSide: const BorderSide(
                                  color: Color(0xFF3A3A3A),
                                ),
                              ),
                              enabledBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(8),
                                borderSide: const BorderSide(
                                  color: Color(0xFF3A3A3A),
                                ),
                              ),
                              focusedBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(8),
                                borderSide: const BorderSide(
                                  color: Color(0xFF8B0000),
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(width: 16),
                    // Status
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Status',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 12),
                            decoration: BoxDecoration(
                              color: const Color(0xFF1A1A1A),
                              borderRadius: BorderRadius.circular(8),
                              border: Border.all(
                                color: const Color(0xFF3A3A3A),
                              ),
                            ),
                            child: DropdownButtonHideUnderline(
                              child: DropdownButton<String>(
                                value: selectedStatus,
                                isExpanded: true,
                                style: const TextStyle(color: Colors.white),
                                dropdownColor: const Color(0xFF2A2A2A),
                                items:
                                    [
                                      'In Stock',
                                      'Out of Stock',
                                      'Low Stock',
                                      'Discontinued',
                                    ].map((String value) {
                                      return DropdownMenuItem<String>(
                                        value: value,
                                        child: Text(value),
                                      );
                                    }).toList(),
                                onChanged: (String? newValue) {
                                  setState(() {
                                    selectedStatus = newValue!;
                                  });
                                },
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton(
              onPressed: () {
                print('Saving product: ${nameController.text}');
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Product "${nameController.text}" updated successfully',
                    ),
                    backgroundColor: const Color(0xFF8B0000),
                  ),
                );
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
              ),
              child: const Text('Save', style: TextStyle(color: Colors.white)),
            ),
          ],
        ),
      ),
    );
  }

  void _showEditCategoryDialog(String name, String? id) {
    final TextEditingController nameController = TextEditingController(
      text: name,
    );
    final TextEditingController descriptionController = TextEditingController(
      text: 'Category description',
    );
    String selectedColor = 'Red';

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Text(
            'Edit Category: $name',
            style: const TextStyle(color: Colors.white),
          ),
          content: SizedBox(
            width: 400,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Category Name
                const Text(
                  'Category Name',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: nameController,
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'Enter category name',
                    hintStyle: const TextStyle(color: Colors.white54),
                    filled: true,
                    fillColor: const Color(0xFF1A1A1A),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF8B0000)),
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                // Description
                const Text(
                  'Description',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                TextField(
                  controller: descriptionController,
                  maxLines: 2,
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'Enter category description',
                    hintStyle: const TextStyle(color: Colors.white54),
                    filled: true,
                    fillColor: const Color(0xFF1A1A1A),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF3A3A3A)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: const BorderSide(color: Color(0xFF8B0000)),
                    ),
                  ),
                ),
                const SizedBox(height: 16),

                // Color Selection
                const Text(
                  'Category Color',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  decoration: BoxDecoration(
                    color: const Color(0xFF1A1A1A),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: const Color(0xFF3A3A3A)),
                  ),
                  child: DropdownButtonHideUnderline(
                    child: DropdownButton<String>(
                      value: selectedColor,
                      isExpanded: true,
                      style: const TextStyle(color: Colors.white),
                      dropdownColor: const Color(0xFF2A2A2A),
                      items:
                          [
                            'Red',
                            'Blue',
                            'Green',
                            'Purple',
                            'Orange',
                            'Yellow',
                            'Pink',
                            'Teal',
                          ].map((String value) {
                            return DropdownMenuItem<String>(
                              value: value,
                              child: Row(
                                children: [
                                  Container(
                                    width: 16,
                                    height: 16,
                                    decoration: BoxDecoration(
                                      color: _getColorFromName(value),
                                      shape: BoxShape.circle,
                                    ),
                                  ),
                                  const SizedBox(width: 8),
                                  Text(value),
                                ],
                              ),
                            );
                          }).toList(),
                      onChanged: (String? newValue) {
                        setState(() {
                          selectedColor = newValue!;
                        });
                      },
                    ),
                  ),
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton(
              onPressed: () {
                print('Saving category: ${nameController.text}');
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Category "${nameController.text}" updated successfully',
                    ),
                    backgroundColor: const Color(0xFF8B0000),
                  ),
                );
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
              ),
              child: const Text('Save', style: TextStyle(color: Colors.white)),
            ),
          ],
        ),
      ),
    );
  }

  Color _getColorFromName(String colorName) {
    switch (colorName.toLowerCase()) {
      case 'red':
        return Colors.red;
      case 'blue':
        return Colors.blue;
      case 'green':
        return Colors.green;
      case 'purple':
        return Colors.purple;
      case 'orange':
        return Colors.orange;
      case 'yellow':
        return Colors.yellow;
      case 'pink':
        return Colors.pink;
      case 'teal':
        return Colors.teal;
      default:
        return Colors.grey;
    }
  }

  void _showDeleteServiceDialog(String name, String? id) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: Text(
          'Delete Service: $name',
          style: const TextStyle(color: Colors.white),
        ),
        content: const Text(
          'Are you sure you want to delete this service?',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () async {
              if (id != null) {
                try {
                  await FirebaseService.deleteService(id);
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Service "$name" deleted successfully'),
                      backgroundColor: const Color(0xFF8B0000),
                    ),
                  );
                } catch (e) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Error deleting service: $e'),
                      backgroundColor: Colors.red,
                    ),
                  );
                }
              }
            },
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Delete', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  void _showDeleteProductDialog(String name, String? id) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: Text(
          'Delete Product: $name',
          style: const TextStyle(color: Colors.white),
        ),
        content: const Text(
          'Are you sure you want to delete this product?',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Delete', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  void _showDeleteCategoryDialog(String name, String? id) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF2A2A2A),
        title: Text(
          'Delete Category: $name',
          style: const TextStyle(color: Colors.white),
        ),
        content: const Text(
          'Are you sure you want to delete this category?',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Cancel',
              style: TextStyle(color: Colors.white70),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('Delete', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  // Proposals List - Real-time data
  Widget _buildProposalsList() {
    return StreamBuilder<List<Proposal>>(
      stream: MarketingService.getProposalsStream(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Center(
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF8B0000)),
            ),
          );
        }

        if (snapshot.hasError) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(Icons.error_outline, color: Colors.red, size: 48),
                const SizedBox(height: 16),
                Text(
                  'Error loading proposals: ${snapshot.error}',
                  style: const TextStyle(color: Colors.red),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          );
        }

        final proposals = snapshot.data ?? [];

        if (proposals.isEmpty) {
          return const Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.email_outlined, color: Colors.grey, size: 48),
                SizedBox(height: 16),
                Text(
                  'No proposals yet',
                  style: TextStyle(color: Colors.grey, fontSize: 16),
                ),
                SizedBox(height: 8),
                Text(
                  'Create your first proposal to get started',
                  style: TextStyle(color: Colors.grey, fontSize: 14),
                ),
              ],
            ),
          );
        }

        return ListView.builder(
          itemCount: proposals.length,
          itemBuilder: (context, index) {
            final proposal = proposals[index];
            final statusColor = MarketingService.getStatusColor(
              proposal.status,
            );
            final statusIcon = MarketingService.getStatusIcon(proposal.status);

            return GestureDetector(
              onTap: () => _showProposalDetailsDialog(proposal),
              child: Container(
                margin: const EdgeInsets.only(bottom: 12),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: const Color(0xFF2A2A2A),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
                ),
                child: Row(
                  children: [
                    // Status Icon
                    Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        color: _getStatusColor(statusColor).withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Icon(
                        statusIcon,
                        color: _getStatusColor(statusColor),
                        size: 24,
                      ),
                    ),
                    const SizedBox(width: 16),

                    // Proposal Details
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            proposal.subject,
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            '${proposal.clientName} â€¢ ${proposal.type}',
                            style: const TextStyle(
                              color: Colors.white70,
                              fontSize: 14,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Row(
                            children: [
                              _buildProposalStat(
                                'Value',
                                MarketingService.formatCurrency(proposal.value),
                              ),
                              const SizedBox(width: 16),
                              _buildProposalStat(
                                'Sent',
                                MarketingService.formatDate(proposal.sentDate),
                              ),
                              if (proposal.responseDate != null) ...[
                                const SizedBox(width: 16),
                                _buildProposalStat(
                                  'Response',
                                  MarketingService.formatDate(
                                    proposal.responseDate!,
                                  ),
                                ),
                              ],
                            ],
                          ),
                        ],
                      ),
                    ),

                    // Status Badge
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: _getStatusColor(statusColor).withOpacity(0.2),
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(
                          color: _getStatusColor(statusColor),
                          width: 1,
                        ),
                      ),
                      child: Text(
                        proposal.status.toUpperCase(),
                        style: TextStyle(
                          color: _getStatusColor(statusColor),
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }

  // Show proposal details dialog with edit and resend options
  void _showProposalDetailsDialog(Proposal proposal) {
    showDialog(
      context: context,
      builder: (context) => ProposalDetailsDialog(
        proposal: proposal,
        onEdit: (editedProposal) => _updateProposal(editedProposal),
        onResend: (proposalToResend) => _resendProposal(proposalToResend),
      ),
    );
  }

  // Update proposal in Firestore
  Future<void> _updateProposal(Proposal updatedProposal) async {
    try {
      await MarketingService.updateProposal(updatedProposal);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Proposal updated successfully!'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Failed to update proposal: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Resend proposal email
  Future<void> _resendProposal(Proposal proposal) async {
    try {
      // Show loading dialog
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => const Center(child: CircularProgressIndicator()),
      );

      // Generate email body
      final emailBody =
          '''
Dear ${proposal.clientName},

I hope this email finds you well. I wanted to follow up on our recent proposal regarding ${proposal.subject}.

${(proposal.messageBody?.isNotEmpty ?? false) ? proposal.messageBody : 'Please let me know if you have any questions or would like to schedule a meeting to discuss this further.'}

Best regards,
Impact Graphics ZA Team
      ''';

      // Test Sender.net API connection first
      print('ðŸ” Testing Sender.net API connection for resend...');
      final apiTest = await EmailService.testApiConnection();
      print('ðŸ” API Test Result: $apiTest');

      // Send email using Sender.net API
      final result = await EmailService.sendProposalEmail(
        toEmail: proposal.clientEmail,
        toName: proposal.clientName,
        subject: proposal.subject,
        body: emailBody,
        proposalType: proposal.type,
        proposalValue: proposal.value.toString(),
      );

      // Update proposal status based on email result
      await MarketingService.updateProposalStatus(
        proposal.id,
        result.success ? 'sent' : 'draft',
      );

      // Close loading dialog
      Navigator.pop(context);

      // Show result
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            result.success
                ? 'Proposal resent to ${proposal.clientEmail} successfully!'
                : 'Failed to resend proposal: ${result.message}',
          ),
          backgroundColor: result.success ? Colors.green : Colors.red,
        ),
      );
    } catch (e) {
      // Close loading dialog if open
      if (Navigator.canPop(context)) {
        Navigator.pop(context);
      }

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error resending proposal: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  // Appointments List - Real-time data
  Widget _buildAppointmentsList() {
    return StreamBuilder<List<Appointment>>(
      stream: MarketingService.getAppointmentsStream(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Center(
            child: CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF8B0000)),
            ),
          );
        }

        if (snapshot.hasError) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(Icons.error_outline, color: Colors.red, size: 48),
                const SizedBox(height: 16),
                Text(
                  'Error loading appointments: ${snapshot.error}',
                  style: const TextStyle(color: Colors.red),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          );
        }

        final appointments = snapshot.data ?? [];

        if (appointments.isEmpty) {
          return const Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  Icons.calendar_today_outlined,
                  color: Colors.grey,
                  size: 48,
                ),
                SizedBox(height: 16),
                Text(
                  'No appointments scheduled',
                  style: TextStyle(color: Colors.grey, fontSize: 16),
                ),
                SizedBox(height: 8),
                Text(
                  'Schedule your first appointment to get started',
                  style: TextStyle(color: Colors.grey, fontSize: 14),
                ),
              ],
            ),
          );
        }

        return ListView.builder(
          itemCount: appointments.length,
          itemBuilder: (context, index) {
            final appointment = appointments[index];
            final statusColor = MarketingService.getStatusColor(
              appointment.status,
            );
            final statusIcon = MarketingService.getStatusIcon(
              appointment.status,
            );

            return Container(
              margin: const EdgeInsets.only(bottom: 12),
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: const Color(0xFF2A2A2A),
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
              ),
              child: Row(
                children: [
                  // Status Icon
                  Container(
                    width: 48,
                    height: 48,
                    decoration: BoxDecoration(
                      color: _getStatusColor(statusColor).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(
                      statusIcon,
                      color: _getStatusColor(statusColor),
                      size: 24,
                    ),
                  ),
                  const SizedBox(width: 16),

                  // Appointment Details
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          appointment.type,
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          '${appointment.clientName} â€¢ ${MarketingService.formatDate(appointment.date)} at ${appointment.time}',
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 14,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Row(
                          children: [
                            _buildProposalStat(
                              'Duration',
                              '${appointment.duration} min',
                            ),
                            const SizedBox(width: 16),
                            if (appointment.meetingLink != null)
                              _buildProposalStat('Meeting Link', 'Available'),
                          ],
                        ),
                      ],
                    ),
                  ),

                  // Status Badge
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 8,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      color: _getStatusColor(statusColor).withOpacity(0.2),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: _getStatusColor(statusColor),
                        width: 1,
                      ),
                    ),
                    child: Text(
                      appointment.status.toUpperCase(),
                      style: TextStyle(
                        color: _getStatusColor(statusColor),
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }

  // Templates List
  Widget _buildTemplatesList() {
    final templates = [
      {
        'name': 'Website Design Proposal',
        'type': 'Proposal',
        'lastUsed': '2024-09-15',
        'usageCount': 12,
        'category': 'Web Development',
      },
      {
        'name': 'Marketing Campaign Brief',
        'type': 'Brief',
        'lastUsed': '2024-09-10',
        'usageCount': 8,
        'category': 'Digital Marketing',
      },
      {
        'name': 'Brand Identity Package',
        'type': 'Proposal',
        'lastUsed': '2024-09-18',
        'usageCount': 5,
        'category': 'Branding',
      },
      {
        'name': 'Follow-up Email Template',
        'type': 'Email',
        'lastUsed': '2024-09-19',
        'usageCount': 25,
        'category': 'Communication',
      },
    ];

    return ListView.builder(
      itemCount: templates.length,
      itemBuilder: (context, index) {
        final template = templates[index];

        return Container(
          margin: const EdgeInsets.only(bottom: 12),
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: const Color(0xFF2A2A2A),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
          ),
          child: Row(
            children: [
              // Template Icon
              Container(
                width: 48,
                height: 48,
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.2),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Icon(
                  Icons.description,
                  color: Color(0xFF8B0000),
                  size: 24,
                ),
              ),
              const SizedBox(width: 16),

              // Template Details
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      template['name'] as String,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '${template['category'] as String} â€¢ ${template['type'] as String}',
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 14,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Row(
                      children: [
                        _buildProposalStat(
                          'Used',
                          '${template['usageCount'] as int} times',
                        ),
                        const SizedBox(width: 16),
                        _buildProposalStat(
                          'Last Used',
                          template['lastUsed'] as String,
                        ),
                      ],
                    ),
                  ],
                ),
              ),

              // Action Buttons
              Row(
                children: [
                  IconButton(
                    onPressed: () {
                      ScaffoldMessenger.of(context).showSnackBar(
                        SnackBar(
                          content: Text(
                            'Using template: ${template['name'] as String}',
                          ),
                          backgroundColor: const Color(0xFF8B0000),
                        ),
                      );
                    },
                    icon: const Icon(Icons.edit, color: Colors.white, size: 20),
                  ),
                  IconButton(
                    onPressed: () {
                      ScaffoldMessenger.of(context).showSnackBar(
                        SnackBar(
                          content: Text(
                            'Sending template: ${template['name'] as String}',
                          ),
                          backgroundColor: Colors.green,
                        ),
                      );
                    },
                    icon: const Icon(Icons.send, color: Colors.green, size: 20),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildProposalStat(String label, String value) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: Colors.white60,
            fontSize: 11,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 2),
        Text(
          value,
          style: const TextStyle(
            color: Colors.white,
            fontSize: 14,
            fontWeight: FontWeight.w600,
          ),
        ),
      ],
    );
  }

  // Marketing statistics stream
  Stream<MarketingStats> _getMarketingStatsStream() async* {
    while (true) {
      yield await MarketingService.getMarketingStats();
      await Future.delayed(
        const Duration(seconds: 30),
      ); // Update every 30 seconds
    }
  }

  // Loading card for statistics
  Widget _buildLoadingCard(String title) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: const Color(0xFF8B0000).withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: const SizedBox(
                  width: 12,
                  height: 12,
                  child: CircularProgressIndicator(
                    strokeWidth: 2,
                    valueColor: AlwaysStoppedAnimation<Color>(
                      Color(0xFF8B0000),
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 6),
              Text(
                title,
                style: const TextStyle(
                  color: Colors.white70,
                  fontSize: 10,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text(
            'Loading...',
            style: TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  // Error card for statistics
  Widget _buildErrorCard(String title) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: Colors.red.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: const Icon(Icons.error, color: Colors.red, size: 12),
              ),
              const SizedBox(width: 6),
              Text(
                title,
                style: const TextStyle(
                  color: Colors.white70,
                  fontSize: 10,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text(
            'Error',
            style: TextStyle(
              color: Colors.red,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  // Stat card widget
  Widget _buildStatCard(
    String title,
    String value,
    String subtitle,
    IconData icon,
    Color iconColor,
    Color subtitleColor,
  ) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: const Color(0xFF2A2A2A),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: const Color(0xFF3A3A3A), width: 1),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: iconColor.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Icon(icon, color: iconColor, size: 12),
              ),
              const SizedBox(width: 6),
              Text(
                title,
                style: const TextStyle(
                  color: Colors.white70,
                  fontSize: 10,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
          const SizedBox(height: 4),
          Text(
            value,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          Text(subtitle, style: TextStyle(color: subtitleColor, fontSize: 8)),
        ],
      ),
    );
  }

  // Create Proposal Dialog
  void _showCreateProposalDialog() {
    final TextEditingController clientEmailController = TextEditingController();
    final TextEditingController subjectController = TextEditingController();
    final TextEditingController messageController = TextEditingController();

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Row(
            children: [
              const Icon(Icons.email, color: Colors.white, size: 24),
              const SizedBox(width: 12),
              const Text(
                'Compose New Proposal',
                style: TextStyle(color: Colors.white),
              ),
            ],
          ),
          content: SizedBox(
            width: 600,
            height: 600,
            child: SingleChildScrollView(
              child: Column(
                children: [
                  // Email Template Fields Section
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: const Color(0xFF3A3A3A),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: const Color(0xFFE53935),
                        width: 2,
                      ),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            const Icon(
                              Icons.design_services,
                              color: Color(0xFFE53935),
                              size: 20,
                            ),
                            const SizedBox(width: 8),
                            const Text(
                              'Email Template Fields',
                              style: TextStyle(
                                color: Color(0xFFE53935),
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 16),

                        // Email Field
                        TextField(
                          controller: clientEmailController,
                          decoration: const InputDecoration(
                            labelText: 'Email',
                            hintText: 'client@company.com',
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: Color(0xFF2A2A2A),
                            prefixIcon: Icon(
                              Icons.email,
                              color: Colors.white70,
                            ),
                          ),
                          style: const TextStyle(color: Colors.white),
                        ),
                        const SizedBox(height: 16),

                        // Subject Field
                        TextField(
                          controller: subjectController,
                          decoration: const InputDecoration(
                            labelText: 'Subject',
                            hintText: 'Website Design Proposal',
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: Color(0xFF2A2A2A),
                            prefixIcon: Icon(
                              Icons.subject,
                              color: Colors.white70,
                            ),
                          ),
                          style: const TextStyle(color: Colors.white),
                        ),
                        const SizedBox(height: 16),

                        // Message Field
                        TextField(
                          controller: messageController,
                          decoration: const InputDecoration(
                            labelText: 'Message',
                            hintText:
                                'Dear [Client Name],\n\nI hope this email finds you well...',
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: Color(0xFF2A2A2A),
                            alignLabelWithHint: true,
                            prefixIcon: Icon(
                              Icons.message,
                              color: Colors.white70,
                            ),
                          ),
                          style: const TextStyle(color: Colors.white),
                          maxLines: 6,
                          textAlignVertical: TextAlignVertical.top,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton.icon(
              onPressed: () async {
                // Show loading indicator
                showDialog(
                  context: context,
                  barrierDismissible: false,
                  builder: (context) =>
                      const Center(child: CircularProgressIndicator()),
                );

                try {
                  // Create proposal in Firestore
                  final proposalId = await MarketingService.createProposal(
                    clientName: 'Client', // Default client name
                    clientEmail: clientEmailController.text,
                    subject: subjectController.text,
                    type: 'General Proposal', // Default proposal type
                    value: 0.0, // Default proposal value
                    messageBody: messageController.text.isNotEmpty
                        ? messageController.text
                        : null,
                  );

                  // Generate email body with proposal details
                  final emailBody = messageController.text.isNotEmpty
                      ? messageController.text
                      : '''
Dear Client,

I hope this email finds you well. I wanted to follow up on our recent proposal regarding ${subjectController.text}.

Please let me know if you have any questions or would like to schedule a meeting to discuss this further.

Best regards,
Impact Graphics ZA Team
                  ''';

                  // Test Sender.net API connection first
                  print('ðŸ” Testing Sender.net API connection...');
                  final apiTest = await EmailService.testApiConnection();
                  print('ðŸ” API Test Result: $apiTest');

                  // Send email using Sender.net API
                  final result = await EmailService.sendProposalEmail(
                    toEmail: clientEmailController.text,
                    toName: 'Client', // Default client name
                    subject: subjectController.text,
                    body: emailBody,
                    proposalType: 'General Proposal', // Default proposal type
                    proposalValue: '0.00', // Default proposal value
                  );

                  // Update proposal status based on email result
                  await MarketingService.updateProposalStatus(
                    proposalId,
                    result.success ? 'sent' : 'draft',
                  );

                  // Close loading dialog
                  Navigator.pop(context);
                  Navigator.pop(context);

                  // Show result
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text(
                        result.success
                            ? 'Proposal created and sent to ${clientEmailController.text} successfully!'
                            : 'Proposal created but failed to send: ${result.message}',
                      ),
                      backgroundColor: result.success
                          ? Colors.green
                          : Colors.orange,
                    ),
                  );
                } catch (e) {
                  // Close loading dialog
                  Navigator.pop(context);
                  Navigator.pop(context);

                  // Show error
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Error: $e'),
                      backgroundColor: Colors.red,
                    ),
                  );
                }
              },
              icon: const Icon(Icons.send, color: Colors.white, size: 16),
              label: const Text('Send Proposal'),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
              ),
            ),
          ],
        ),
      ),
    );
  }

  // Schedule Appointment Dialog
  void _showScheduleAppointmentDialog() {
    final clientNameController = TextEditingController();
    final clientEmailController = TextEditingController();
    final meetingLinkController = TextEditingController();
    final notesController = TextEditingController();
    String selectedType = 'Discovery Call';
    DateTime selectedDate = DateTime.now().add(const Duration(days: 1));
    TimeOfDay selectedTime = const TimeOfDay(hour: 10, minute: 0);
    int selectedDuration = 30;

    showDialog(
      context: context,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          backgroundColor: const Color(0xFF2A2A2A),
          title: Row(
            children: [
              const Icon(Icons.calendar_today, color: Colors.white, size: 24),
              const SizedBox(width: 12),
              const Text(
                'Schedule Appointment',
                style: TextStyle(color: Colors.white),
              ),
            ],
          ),
          content: SizedBox(
            width: 500,
            height: 500,
            child: SingleChildScrollView(
              child: Column(
                children: [
                  // Client Information Section
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: const Color(0xFF3A3A3A),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Client Information',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(
                              child: TextField(
                                controller: clientNameController,
                                decoration: const InputDecoration(
                                  labelText: 'Client Name',
                                  hintText: 'ABC Company',
                                  border: OutlineInputBorder(),
                                  filled: true,
                                  fillColor: Color(0xFF2A2A2A),
                                ),
                                style: const TextStyle(color: Colors.white),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: TextField(
                                controller: clientEmailController,
                                decoration: const InputDecoration(
                                  labelText: 'Client Email',
                                  hintText: 'contact@abccompany.com',
                                  border: OutlineInputBorder(),
                                  filled: true,
                                  fillColor: Color(0xFF2A2A2A),
                                ),
                                style: const TextStyle(color: Colors.white),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Appointment Details Section
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: const Color(0xFF3A3A3A),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Appointment Details',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                        const SizedBox(height: 12),
                        DropdownButtonFormField<String>(
                          initialValue: selectedType,
                          decoration: const InputDecoration(
                            labelText: 'Meeting Type',
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: Color(0xFF2A2A2A),
                          ),
                          dropdownColor: const Color(0xFF2A2A2A),
                          style: const TextStyle(color: Colors.white),
                          items: const [
                            DropdownMenuItem(
                              value: 'Discovery Call',
                              child: Text('Discovery Call'),
                            ),
                            DropdownMenuItem(
                              value: 'Proposal Presentation',
                              child: Text('Proposal Presentation'),
                            ),
                            DropdownMenuItem(
                              value: 'Follow-up',
                              child: Text('Follow-up'),
                            ),
                            DropdownMenuItem(
                              value: 'Other',
                              child: Text('Other'),
                            ),
                          ],
                          onChanged: (String? newValue) {
                            setState(() {
                              selectedType = newValue!;
                            });
                          },
                        ),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(
                              child: InkWell(
                                onTap: () async {
                                  final date = await showDatePicker(
                                    context: context,
                                    initialDate: selectedDate,
                                    firstDate: DateTime.now(),
                                    lastDate: DateTime.now().add(
                                      const Duration(days: 365),
                                    ),
                                  );
                                  if (date != null) {
                                    setState(() {
                                      selectedDate = date;
                                    });
                                  }
                                },
                                child: Container(
                                  padding: const EdgeInsets.all(16),
                                  decoration: BoxDecoration(
                                    border: Border.all(color: Colors.grey),
                                    borderRadius: BorderRadius.circular(4),
                                    color: const Color(0xFF2A2A2A),
                                  ),
                                  child: Row(
                                    children: [
                                      const Icon(
                                        Icons.calendar_today,
                                        color: Colors.white,
                                        size: 20,
                                      ),
                                      const SizedBox(width: 8),
                                      Text(
                                        '${selectedDate.day}/${selectedDate.month}/${selectedDate.year}',
                                        style: const TextStyle(
                                          color: Colors.white,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: InkWell(
                                onTap: () async {
                                  final time = await showTimePicker(
                                    context: context,
                                    initialTime: selectedTime,
                                  );
                                  if (time != null) {
                                    setState(() {
                                      selectedTime = time;
                                    });
                                  }
                                },
                                child: Container(
                                  padding: const EdgeInsets.all(16),
                                  decoration: BoxDecoration(
                                    border: Border.all(color: Colors.grey),
                                    borderRadius: BorderRadius.circular(4),
                                    color: const Color(0xFF2A2A2A),
                                  ),
                                  child: Row(
                                    children: [
                                      const Icon(
                                        Icons.access_time,
                                        color: Colors.white,
                                        size: 20,
                                      ),
                                      const SizedBox(width: 8),
                                      Text(
                                        selectedTime.format(context),
                                        style: const TextStyle(
                                          color: Colors.white,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(
                              child: DropdownButtonFormField<int>(
                                initialValue: selectedDuration,
                                decoration: const InputDecoration(
                                  labelText: 'Duration (minutes)',
                                  border: OutlineInputBorder(),
                                  filled: true,
                                  fillColor: Color(0xFF2A2A2A),
                                ),
                                dropdownColor: const Color(0xFF2A2A2A),
                                style: const TextStyle(color: Colors.white),
                                items: const [
                                  DropdownMenuItem(
                                    value: 15,
                                    child: Text('15 minutes'),
                                  ),
                                  DropdownMenuItem(
                                    value: 30,
                                    child: Text('30 minutes'),
                                  ),
                                  DropdownMenuItem(
                                    value: 45,
                                    child: Text('45 minutes'),
                                  ),
                                  DropdownMenuItem(
                                    value: 60,
                                    child: Text('1 hour'),
                                  ),
                                  DropdownMenuItem(
                                    value: 90,
                                    child: Text('1.5 hours'),
                                  ),
                                  DropdownMenuItem(
                                    value: 120,
                                    child: Text('2 hours'),
                                  ),
                                ],
                                onChanged: (int? newValue) {
                                  setState(() {
                                    selectedDuration = newValue!;
                                  });
                                },
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: TextField(
                                controller: meetingLinkController,
                                decoration: const InputDecoration(
                                  labelText: 'Meeting Link (Optional)',
                                  hintText:
                                      'https://meet.google.com/abc-xyz-def',
                                  border: OutlineInputBorder(),
                                  filled: true,
                                  fillColor: Color(0xFF2A2A2A),
                                ),
                                style: const TextStyle(color: Colors.white),
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),
                        TextField(
                          controller: notesController,
                          decoration: const InputDecoration(
                            labelText: 'Notes (Optional)',
                            hintText:
                                'Any additional notes about this appointment...',
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: Color(0xFF2A2A2A),
                          ),
                          maxLines: 3,
                          style: const TextStyle(color: Colors.white),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: Colors.white70),
              ),
            ),
            ElevatedButton.icon(
              onPressed: () async {
                if (clientNameController.text.isNotEmpty &&
                    clientEmailController.text.isNotEmpty) {
                  // Show loading indicator
                  showDialog(
                    context: context,
                    barrierDismissible: false,
                    builder: (context) =>
                        const Center(child: CircularProgressIndicator()),
                  );

                  try {
                    // Create appointment in Firestore
                    final appointmentId =
                        await MarketingService.createAppointment(
                          clientName: clientNameController.text,
                          clientEmail: clientEmailController.text,
                          type: selectedType,
                          date: selectedDate,
                          time: selectedTime.format(context),
                          duration: selectedDuration,
                          meetingLink: meetingLinkController.text.isNotEmpty
                              ? meetingLinkController.text
                              : null,
                          notes: notesController.text.isNotEmpty
                              ? notesController.text
                              : null,
                        );

                    // Test Sender.net API connection first
                    print(
                      'ðŸ” Testing Sender.net API connection for appointment...',
                    );
                    final apiTest = await EmailService.testApiConnection();
                    print('ðŸ” API Test Result: $apiTest');

                    // Send appointment reminder email
                    final result = await EmailService.sendAppointmentReminder(
                      toEmail: clientEmailController.text,
                      toName: clientNameController.text,
                      appointmentType: selectedType,
                      appointmentDate: MarketingService.formatDate(
                        selectedDate,
                      ),
                      appointmentTime: selectedTime.format(context),
                      meetingLink: meetingLinkController.text.isNotEmpty
                          ? meetingLinkController.text
                          : null,
                    );

                    // Update appointment status based on email result
                    await MarketingService.updateAppointmentStatus(
                      appointmentId,
                      result.success ? 'confirmed' : 'pending',
                    );

                    // Close loading dialog
                    Navigator.pop(context);
                    Navigator.pop(context);

                    // Show result
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text(
                          result.success
                              ? 'Appointment scheduled and reminder sent!'
                              : 'Appointment scheduled but failed to send reminder: ${result.message}',
                        ),
                        backgroundColor: result.success
                            ? Colors.green
                            : Colors.orange,
                      ),
                    );
                  } catch (e) {
                    // Close loading dialog
                    Navigator.pop(context);
                    Navigator.pop(context);

                    // Show error
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Error: $e'),
                        backgroundColor: Colors.red,
                      ),
                    );
                  }
                } else {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Please fill in client name and email'),
                      backgroundColor: Colors.orange,
                    ),
                  );
                }
              },
              icon: const Icon(
                Icons.calendar_today,
                color: Colors.white,
                size: 16,
              ),
              label: const Text('Schedule'),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF8B0000),
                foregroundColor: Colors.white,
              ),
            ),
          ],
        ),
      ),
    );
  }

  // Create wallet for user if it doesn't exist
  Future<void> _createWalletForUser(String userId) async {
    try {
      final now = DateTime.now();
      await FirebaseFirestore.instance.collection('wallets').doc(userId).set({
        'balance': 0.0,
        'status': 'active',
        'createdAt': Timestamp.fromDate(now),
        'updatedAt': Timestamp.fromDate(now),
        'userId': userId,
      });
      print('Wallet created for user: $userId');
    } catch (e) {
      print('Error creating wallet for user $userId: $e');
    }
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final difference = now.difference(date);

    if (difference.inDays == 0) {
      return 'Today';
    } else if (difference.inDays == 1) {
      return 'Yesterday';
    } else if (difference.inDays < 7) {
      return '${difference.inDays} days ago';
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }

  @override
  void dispose() {
    _searchController.dispose();
    _adminTabController.dispose();
    _debounceTimer?.cancel();
    super.dispose();
  }
}

class YocoPaymentDialog extends StatefulWidget {
  final double amount;
  final String serviceName;
  final String customerEmail;
  final String customerName;
  final VoidCallback? onPaymentSuccess;
  final VoidCallback? onPaymentFailed;

  const YocoPaymentDialog({
    super.key,
    required this.amount,
    required this.serviceName,
    required this.customerEmail,
    required this.customerName,
    this.onPaymentSuccess,
    this.onPaymentFailed,
  });

  @override
  State<YocoPaymentDialog> createState() => _YocoPaymentDialogState();
}

class _YocoPaymentDialogState extends State<YocoPaymentDialog>
    with TickerProviderStateMixin {
  final _formKey = GlobalKey<FormState>();
  final _cardNumberController = TextEditingController();
  final _expiryController = TextEditingController();
  final _cvvController = TextEditingController();
  final _nameController = TextEditingController();

  bool _isProcessing = false;
  bool _isCardNumberValid = false;
  bool _isExpiryValid = false;
  bool _isCvvValid = false;

  late AnimationController _animationController;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;

  @override
  void initState() {
    super.initState();
    _nameController.text = widget.customerName;

    _animationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    _slideAnimation =
        Tween<Offset>(begin: const Offset(0, 0.3), end: Offset.zero).animate(
          CurvedAnimation(
            parent: _animationController,
            curve: Curves.easeOutCubic,
          ),
        );

    _animationController.forward();
  }

  @override
  void dispose() {
    _animationController.dispose();
    _cardNumberController.dispose();
    _expiryController.dispose();
    _cvvController.dispose();
    _nameController.dispose();
    super.dispose();
  }

  void _formatCardNumber(String value) {
    if (value.isEmpty) return;

    // Remove all non-digits
    String numbers = value.replaceAll(RegExp(r'[^\d]'), '');

    // Format as XXXX XXXX XXXX XXXX
    String formatted = '';
    for (int i = 0; i < numbers.length && i < 16; i++) {
      if (i > 0 && i % 4 == 0) {
        formatted += ' ';
      }
      formatted += numbers[i];
    }

    _cardNumberController.value = TextEditingValue(
      text: formatted,
      selection: TextSelection.collapsed(offset: formatted.length),
    );

    setState(() {
      _isCardNumberValid = numbers.length >= 13 && numbers.length <= 19;
    });
  }

  void _formatExpiry(String value) {
    if (value.isEmpty) return;

    // Remove all non-digits
    String numbers = value.replaceAll(RegExp(r'[^\d]'), '');

    // Format as MM/YY
    String formatted = '';
    if (numbers.isNotEmpty) {
      formatted += numbers[0];
    }
    if (numbers.length >= 2) {
      formatted += numbers[1];
      if (numbers.length > 2) {
        formatted += '/';
        formatted += numbers[2];
      }
    }
    if (numbers.length >= 3) {
      if (numbers.length > 3) {
        formatted += numbers[3];
      }
    }

    _expiryController.value = TextEditingValue(
      text: formatted,
      selection: TextSelection.collapsed(offset: formatted.length),
    );

    setState(() {
      _isExpiryValid = numbers.length == 4;
    });
  }

  void _formatCvv(String value) {
    // Remove all non-digits
    String numbers = value.replaceAll(RegExp(r'[^\d]'), '');

    _cvvController.value = TextEditingValue(
      text: numbers,
      selection: TextSelection.collapsed(offset: numbers.length),
    );

    setState(() {
      _isCvvValid = numbers.length >= 3 && numbers.length <= 4;
    });
  }

  Future<void> _processPayment() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      _isProcessing = true;
    });

    try {
      // Simulate payment processing
      await Future.delayed(const Duration(seconds: 2));

      // Here you would integrate with Yoco's API
      // For now, we'll simulate a successful payment
      bool paymentSuccess =
          true; // This would be determined by Yoco API response

      if (paymentSuccess) {
        if (mounted) {
          Navigator.of(context).pop();
          widget.onPaymentSuccess?.call();

          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                'Payment successful! R${widget.amount.toStringAsFixed(2)} paid for ${widget.serviceName}',
              ),
              backgroundColor: Colors.green,
              duration: const Duration(seconds: 4),
            ),
          );
        }
      } else {
        throw Exception('Payment failed');
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          _isProcessing = false;
        });

        widget.onPaymentFailed?.call();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Payment failed: ${e.toString()}'),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 4),
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return FadeTransition(
      opacity: _fadeAnimation,
      child: SlideTransition(
        position: _slideAnimation,
        child: Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          child: Container(
            constraints: const BoxConstraints(maxWidth: 400),
            padding: const EdgeInsets.all(24),
            child: Form(
              key: _formKey,
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Header
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: const Color(0xFF8B0000).withOpacity(0.1),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: const Icon(
                          Icons.payment,
                          color: Color(0xFF8B0000),
                          size: 24,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Secure Payment',
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white
                                    : Colors.black87,
                              ),
                            ),
                            Text(
                              'Powered by Yoco',
                              style: TextStyle(
                                fontSize: 14,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                          ],
                        ),
                      ),
                      IconButton(
                        onPressed: () => Navigator.of(context).pop(),
                        icon: const Icon(Icons.close),
                        style: IconButton.styleFrom(
                          backgroundColor: Colors.grey.withOpacity(0.1),
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 24),

                  // Payment Details
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Theme.of(context).brightness == Brightness.dark
                          ? const Color(0xFF2A2A2A)
                          : const Color(0xFFF8F9FA),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.white10
                            : const Color(0xFFE0E0E0),
                      ),
                    ),
                    child: Column(
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Text(
                              'Service:',
                              style: TextStyle(
                                fontSize: 14,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                            Text(
                              widget.serviceName,
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white
                                    : Colors.black87,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 8),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Text(
                              'Amount:',
                              style: TextStyle(
                                fontSize: 14,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                            Text(
                              'R${widget.amount.toStringAsFixed(2)}',
                              style: const TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF8B0000),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),

                  // Card Number
                  TextFormField(
                    controller: _cardNumberController,
                    onChanged: _formatCardNumber,
                    keyboardType: TextInputType.number,
                    decoration: InputDecoration(
                      labelText: 'Card Number',
                      hintText: '1234 5678 9012 3456',
                      prefixIcon: const Icon(Icons.credit_card),
                      suffixIcon: _isCardNumberValid
                          ? const Icon(Icons.check_circle, color: Colors.green)
                          : null,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter card number';
                      }
                      if (!_isCardNumberValid) {
                        return 'Please enter a valid card number';
                      }
                      return null;
                    },
                  ),

                  const SizedBox(height: 16),

                  // Expiry and CVV Row
                  Row(
                    children: [
                      Expanded(
                        child: TextFormField(
                          controller: _expiryController,
                          onChanged: _formatExpiry,
                          keyboardType: TextInputType.number,
                          decoration: InputDecoration(
                            labelText: 'Expiry',
                            hintText: 'MM/YY',
                            prefixIcon: const Icon(Icons.calendar_today),
                            suffixIcon: _isExpiryValid
                                ? const Icon(
                                    Icons.check_circle,
                                    color: Colors.green,
                                  )
                                : null,
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Required';
                            }
                            if (!_isExpiryValid) {
                              return 'Invalid';
                            }
                            return null;
                          },
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: TextFormField(
                          controller: _cvvController,
                          onChanged: _formatCvv,
                          keyboardType: TextInputType.number,
                          decoration: InputDecoration(
                            labelText: 'CVV',
                            hintText: '123',
                            prefixIcon: const Icon(Icons.security),
                            suffixIcon: _isCvvValid
                                ? const Icon(
                                    Icons.check_circle,
                                    color: Colors.green,
                                  )
                                : null,
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          validator: (value) {
                            if (value == null || value.isEmpty) {
                              return 'Required';
                            }
                            if (!_isCvvValid) {
                              return 'Invalid';
                            }
                            return null;
                          },
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 16),

                  // Cardholder Name
                  TextFormField(
                    controller: _nameController,
                    decoration: InputDecoration(
                      labelText: 'Cardholder Name',
                      hintText: 'John Doe',
                      prefixIcon: const Icon(Icons.person),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter cardholder name';
                      }
                      return null;
                    },
                  ),

                  const SizedBox(height: 24),

                  // Security Notice
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.blue.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: Colors.blue.withOpacity(0.3)),
                    ),
                    child: Row(
                      children: [
                        const Icon(
                          Icons.security,
                          color: Colors.blue,
                          size: 20,
                        ),
                        const SizedBox(width: 8),
                        Expanded(
                          child: Text(
                            'Your payment information is encrypted and secure',
                            style: TextStyle(
                              fontSize: 12,
                              color: Colors.blue[700],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),

                  // Pay Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      onPressed: _isProcessing ? null : _processPayment,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        foregroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: _isProcessing
                          ? const Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                SizedBox(
                                  width: 20,
                                  height: 20,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    valueColor: AlwaysStoppedAnimation<Color>(
                                      Colors.white,
                                    ),
                                  ),
                                ),
                                SizedBox(width: 12),
                                Text('Processing...'),
                              ],
                            )
                          : Text(
                              'Pay R${widget.amount.toStringAsFixed(2)}',
                              style: const TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class WalletFundingDialog extends StatefulWidget {
  final Function(double amount)? onPaymentSuccess;
  final VoidCallback? onPaymentFailed;

  const WalletFundingDialog({
    super.key,
    this.onPaymentSuccess,
    this.onPaymentFailed,
  });

  @override
  State<WalletFundingDialog> createState() => _WalletFundingDialogState();
}

class _WalletFundingDialogState extends State<WalletFundingDialog>
    with TickerProviderStateMixin {
  final _formKey = GlobalKey<FormState>();
  final _amountController = TextEditingController();

  bool _isProcessing = false;

  late AnimationController _animationController;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;

  @override
  void initState() {
    super.initState();
    _amountController.text = '100.00'; // Default amount

    _animationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    _slideAnimation =
        Tween<Offset>(begin: const Offset(0, 0.3), end: Offset.zero).animate(
          CurvedAnimation(
            parent: _animationController,
            curve: Curves.easeOutCubic,
          ),
        );

    _animationController.forward();
  }

  @override
  void dispose() {
    _animationController.dispose();
    _amountController.dispose();
    super.dispose();
  }

  Future<void> _processPayment() async {
    if (!_formKey.currentState!.validate()) return;

    final amount = double.tryParse(_amountController.text) ?? 0.0;
    if (amount <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please enter a valid amount'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    setState(() {
      _isProcessing = true;
    });

    try {
      // Get user email for payment
      final user = FirebaseAuth.instance.currentUser;
      if (user?.email == null) {
        throw Exception('User email not available');
      }

      // Generate a unique transaction ID for this wallet funding
      final transactionId = 'WALLET-${DateTime.now().millisecondsSinceEpoch}';
      final amountInKobo = (amount * 100).round(); // Convert to kobo

      // Process payment with Paystack
      final response = await PaystackService.instance.processPayment(
        email: user!.email!,
        amount: amountInKobo,
        reference: transactionId,
        phoneNumber: user.phoneNumber,
        firstName: user.displayName?.split(' ').first,
        lastName: (user.displayName?.split(' ').length ?? 0) > 1
            ? user.displayName!.split(' ').last
            : null,
      );

      if (response.status && response.authorizationUrl != null) {
        // Navigate to Paystack payment screen and wait for completion
        final result = await Navigator.of(context).push(
          MaterialPageRoute(
            builder: (context) => PaystackPaymentScreen(
              cartItems: [], // Empty cart for wallet funding
              totalAmount: amount,
              userEmail: user.email!,
              userName: user.displayName,
              userPhone: user.phoneNumber,
              paymentType: 'wallet_funding', // Specify this is wallet funding
            ),
          ),
        );

        // Close dialog and show success message only if payment was actually successful
        if (mounted) {
          Navigator.of(context).pop();
          // Only call success callback if result indicates successful payment
          if (result == true || result == 'success') {
            widget.onPaymentSuccess?.call(amount);
          } else {
            widget.onPaymentFailed?.call();
          }
        }
      } else {
        throw Exception(response.message);
      }
    } catch (e) {
      print('Payment error: $e');
      if (mounted) {
        setState(() {
          _isProcessing = false;
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Payment failed: ${e.toString()}'),
            backgroundColor: Colors.red,
          ),
        );

        widget.onPaymentFailed?.call();
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return FadeTransition(
      opacity: _fadeAnimation,
      child: SlideTransition(
        position: _slideAnimation,
        child: Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          child: Container(
            constraints: const BoxConstraints(maxWidth: 400),
            padding: const EdgeInsets.all(24),
            child: Form(
              key: _formKey,
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Header
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: const Color(0xFF8B0000).withOpacity(0.1),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: const Icon(
                          Icons.account_balance_wallet,
                          color: Color(0xFF8B0000),
                          size: 24,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Add Funds to Wallet',
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white
                                    : Colors.black87,
                              ),
                            ),
                            Text(
                              'Powered by Paystack',
                              style: TextStyle(
                                fontSize: 14,
                                color:
                                    Theme.of(context).brightness ==
                                        Brightness.dark
                                    ? Colors.white70
                                    : Colors.black54,
                              ),
                            ),
                          ],
                        ),
                      ),
                      IconButton(
                        onPressed: () => Navigator.of(context).pop(),
                        icon: const Icon(Icons.close),
                        style: IconButton.styleFrom(
                          backgroundColor: Colors.grey.withOpacity(0.1),
                        ),
                      ),
                    ],
                  ),

                  const SizedBox(height: 24),

                  // Amount Input
                  TextFormField(
                    controller: _amountController,
                    keyboardType: TextInputType.number,
                    decoration: InputDecoration(
                      labelText: 'Amount (R)',
                      hintText: '100.00',
                      prefixIcon: const Icon(Icons.attach_money),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter an amount';
                      }
                      final amount = double.tryParse(value);
                      if (amount == null || amount <= 0) {
                        return 'Please enter a valid amount';
                      }
                      return null;
                    },
                  ),

                  const SizedBox(height: 24),

                  // Payment Description
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: const Color(0xFF8B0000).withOpacity(0.1),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: const Color(0xFF8B0000).withOpacity(0.3),
                      ),
                    ),
                    child: Row(
                      children: [
                        const Icon(
                          Icons.info_outline,
                          color: Color(0xFF8B0000),
                          size: 20,
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Secure Payment',
                                style: TextStyle(
                                  fontSize: 14,
                                  fontWeight: FontWeight.w600,
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white
                                      : Colors.black87,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                'You will be redirected to Paystack for secure payment processing',
                                style: TextStyle(
                                  fontSize: 12,
                                  color:
                                      Theme.of(context).brightness ==
                                          Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),

                  // Pay Button
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      onPressed: _isProcessing ? null : _processPayment,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF8B0000),
                        foregroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: _isProcessing
                          ? const Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                SizedBox(
                                  width: 20,
                                  height: 20,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    valueColor: AlwaysStoppedAnimation<Color>(
                                      Colors.white,
                                    ),
                                  ),
                                ),
                                SizedBox(width: 12),
                                Text('Processing...'),
                              ],
                            )
                          : const Text(
                              'Add Funds',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
